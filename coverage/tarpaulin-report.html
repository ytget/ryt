<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>:root {
  --color: black;
  --bg: white;
  --head-bg: white;
  --link: #338;

  --blue: #ccf;
  --red: #fcc;
  --yellow: #ffc;
  --green: #cfc;
}

[data-theme='dark'] {
  --color: white;
  --bg: black;
  --head-bg: #333;
  --link: #aaf;

  --blue: #225;
  --red: #522;
  --yellow: #552;
  --green: #252;
}

html,
body {
  margin: 0;
  padding: 0;
  color: var(--color);
  background: var(--bg);
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: var(--head-bg);
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: var(--blue);
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: var(--red);
}
.files-list__file_medium {
  background: var(--yellow);
}
.files-list__file_high {
  background: var(--green);
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: var(--bg);
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: var(--link);
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
  content: counter(line);
  margin-right: 10px;
}
.code-line {
  margin: 0;
  padding: 0.3em;
  height: 1em;
  counter-increment: line;
}
.code-line_covered {
  background: var(--green);
}
.code-line_uncovered {
  background: var(--red);
}

#theme-toggle-label {
  margin-left: 1ch;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","cli","args.rs"],"content":"//! Command line argument parsing\n\nuse clap::{Parser, ValueEnum};\nuse std::path::PathBuf;\nuse std::time::Duration;\n\n/// Rust YouTube Downloader - Fast and reliable YouTube video downloader\n#[derive(Parser, Debug)]\n#[command(author, version, about, long_about = None)]\npub struct Args {\n    /// YouTube video or playlist URL\n    pub url: String,\n\n    /// Format selector (e.g., 'itag=22', 'best', 'height\u003c=480')\n    #[arg(short, long, value_name = \"FORMAT\")]\n    pub format: Option\u003cString\u003e,\n\n    /// Desired file extension (e.g., 'mp4', 'webm')\n    #[arg(short, long, value_name = \"EXT\")]\n    pub ext: Option\u003cString\u003e,\n\n    /// Output path (file or directory)\n    #[arg(short, long, value_name = \"PATH\")]\n    pub output: Option\u003cPathBuf\u003e,\n\n    /// Disable progress output\n    #[arg(long)]\n    pub no_progress: bool,\n\n    /// HTTP timeout (e.g., 30s, 1m)\n    #[arg(long, value_name = \"DURATION\", default_value = \"30s\")]\n    pub timeout: humantime::Duration,\n\n    /// HTTP retries for transient errors\n    #[arg(long, default_value = \"3\")]\n    pub retries: u32,\n\n    /// Download rate limit (e.g., 2MiB/s, 500KiB/s)\n    #[arg(long, value_name = \"RATE\")]\n    pub rate_limit: Option\u003cString\u003e,\n\n    /// Treat input as playlist URL or ID\n    #[arg(long)]\n    pub playlist: bool,\n\n    /// Max items to process for playlist (0 means all)\n    #[arg(long, default_value = \"0\")]\n    pub limit: usize,\n\n    /// Parallelism for playlist downloads\n    #[arg(long, default_value = \"1\")]\n    pub concurrency: usize,\n\n    /// Botguard mode\n    #[arg(long, value_enum, default_value = \"off\")]\n    pub botguard: BotguardMode,\n\n    /// Enable Botguard debug logs\n    #[arg(long)]\n    pub debug_botguard: bool,\n\n    /// Botguard cache mode\n    #[arg(long, value_enum, default_value = \"mem\")]\n    pub botguard_cache: BotguardCacheMode,\n\n    /// Botguard cache directory (for file mode)\n    #[arg(long, value_name = \"DIR\")]\n    pub botguard_cache_dir: Option\u003cPathBuf\u003e,\n\n    /// Default Botguard token TTL if solver doesn't set\n    #[arg(long, value_name = \"DURATION\", default_value = \"30m\")]\n    pub botguard_ttl: humantime::Duration,\n\n    /// Path to JS script implementing bgAttest(input)\n    #[arg(long, value_name = \"PATH\")]\n    pub botguard_script: Option\u003cPathBuf\u003e,\n\n    /// Innertube client name (default ANDROID)\n    #[arg(long, value_name = \"NAME\")]\n    pub client_name: Option\u003cString\u003e,\n\n    /// Innertube client version (default 20.10.38)\n    #[arg(long, value_name = \"VERSION\")]\n    pub client_version: Option\u003cString\u003e,\n\n    /// Print final media URL and exit (no download)\n    #[arg(short = 'g', long)]\n    pub print_url: bool,\n\n    /// Override User-Agent header\n    #[arg(long, value_name = \"USER_AGENT\")]\n    pub user_agent: Option\u003cString\u003e,\n\n    /// Proxy URL (http/https/socks)\n    #[arg(long, value_name = \"URL\")]\n    pub proxy: Option\u003cString\u003e,\n\n    /// Verbose output\n    #[arg(short, long)]\n    pub verbose: bool,\n\n    /// Quiet output (only errors)\n    #[arg(short, long)]\n    pub quiet: bool,\n}\n\n/// Botguard mode\n#[derive(Debug, Clone, ValueEnum)]\npub enum BotguardMode {\n    /// Disabled\n    Off,\n    /// Automatic (only when needed)\n    Auto,\n    /// Force (always use)\n    Force,\n}\n\n/// Botguard cache mode\n#[derive(Debug, Clone, ValueEnum)]\npub enum BotguardCacheMode {\n    /// Memory cache\n    Mem,\n    /// File cache\n    File,\n}\n\nimpl Args {\n    /// Get HTTP timeout as Duration\n    pub fn timeout_duration(\u0026self) -\u003e Duration {\n        self.timeout.into()\n    }\n\n    /// Get Botguard TTL as Duration\n    pub fn botguard_ttl_duration(\u0026self) -\u003e Duration {\n        self.botguard_ttl.into()\n    }\n\n    /// Parse rate limit string to bytes per second\n    pub fn parse_rate_limit(\u0026self) -\u003e Option\u003cu64\u003e {\n        self.rate_limit.as_ref().and_then(|rate| {\n            parse_rate_limit(rate)\n        })\n    }\n\n    /// Check if this is a playlist operation\n    pub fn is_playlist(\u0026self) -\u003e bool {\n        self.playlist || crate::utils::url::is_playlist_url(\u0026self.url)\n    }\n\n    /// Get output verbosity level\n    pub fn verbosity_level(\u0026self) -\u003e VerbosityLevel {\n        if self.quiet {\n            VerbosityLevel::Quiet\n        } else if self.verbose {\n            VerbosityLevel::Verbose\n        } else {\n            VerbosityLevel::Normal\n        }\n    }\n}\n\n/// Output verbosity level\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum VerbosityLevel {\n    /// Quiet (only errors)\n    Quiet,\n    /// Normal\n    Normal,\n    /// Verbose (debug info)\n    Verbose,\n}\n\n/// Parse rate limit string to bytes per second\npub fn parse_rate_limit(rate: \u0026str) -\u003e Option\u003cu64\u003e {\n    let rate = rate.trim().to_uppercase();\n    if rate.is_empty() {\n        return None;\n    }\n\n    // Remove /s suffix if present\n    let rate = rate.trim_end_matches(\"/S\");\n\n    // Find the number and unit\n    let mut number_end = 0;\n    for (i, c) in rate.char_indices() {\n        if c.is_ascii_digit() || c == '.' {\n            number_end = i + 1;\n        } else {\n            break;\n        }\n    }\n\n    if number_end == 0 {\n        return None;\n    }\n\n    let number_str = \u0026rate[..number_end];\n    let unit = \u0026rate[number_end..].trim();\n\n    let number: f64 = number_str.parse().ok()?;\n    if number \u003c= 0.0 {\n        return None;\n    }\n\n    let multiplier = match *unit {\n        \"B\" | \"\" =\u003e 1,\n        \"KB\" =\u003e 1000,\n        \"KIB\" =\u003e 1024,\n        \"MB\" =\u003e 1000 * 1000,\n        \"MIB\" =\u003e 1024 * 1024,\n        \"GB\" =\u003e 1000 * 1000 * 1000,\n        \"GIB\" =\u003e 1024 * 1024 * 1024,\n        \"TB\" =\u003e 1000_u64.pow(4),\n        \"TIB\" =\u003e 1024_u64.pow(4),\n        _ =\u003e return None,\n    };\n\n    Some((number * multiplier as f64) as u64)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_parse_rate_limit() {\n        assert_eq!(parse_rate_limit(\"1MB/s\"), Some(1000 * 1000));\n        assert_eq!(parse_rate_limit(\"1MiB/s\"), Some(1024 * 1024));\n        assert_eq!(parse_rate_limit(\"500KB/s\"), Some(500 * 1000));\n        assert_eq!(parse_rate_limit(\"2GB/s\"), Some(2 * 1000 * 1000 * 1000));\n        assert_eq!(parse_rate_limit(\"1.5MB/s\"), Some(1500 * 1000));\n        assert_eq!(parse_rate_limit(\"1024\"), Some(1024));\n        assert_eq!(parse_rate_limit(\"0\"), None);\n        assert_eq!(parse_rate_limit(\"\"), None);\n        assert_eq!(parse_rate_limit(\"invalid\"), None);\n    }\n\n    #[test]\n    fn test_args_verbosity_level() {\n        let args = Args {\n            url: \"https://example.com\".to_string(),\n            quiet: false,\n            verbose: false,\n            ..Default::default()\n        };\n        assert_eq!(args.verbosity_level(), VerbosityLevel::Normal);\n\n        let args = Args {\n            url: \"https://example.com\".to_string(),\n            quiet: true,\n            verbose: false,\n            ..Default::default()\n        };\n        assert_eq!(args.verbosity_level(), VerbosityLevel::Quiet);\n\n        let args = Args {\n            url: \"https://example.com\".to_string(),\n            quiet: false,\n            verbose: true,\n            ..Default::default()\n        };\n        assert_eq!(args.verbosity_level(), VerbosityLevel::Verbose);\n    }\n\n    #[test]\n    fn test_args_is_playlist() {\n        let args = Args {\n            url: \"https://www.youtube.com/playlist?list=PLxxxx\".to_string(),\n            playlist: false,\n            ..Default::default()\n        };\n        assert!(args.is_playlist());\n\n        let args = Args {\n            url: \"https://www.youtube.com/watch?v=xxx\".to_string(),\n            playlist: true,\n            ..Default::default()\n        };\n        assert!(args.is_playlist());\n    }\n}\n\n// Implement Default for Args to make tests work\nimpl Default for Args {\n    fn default() -\u003e Self {\n        Self {\n            url: String::new(),\n            format: None,\n            ext: None,\n            output: None,\n            no_progress: false,\n            timeout: humantime::Duration::from(Duration::from_secs(30)),\n            retries: 3,\n            rate_limit: None,\n            playlist: false,\n            limit: 0,\n            concurrency: 1,\n            botguard: BotguardMode::Off,\n            debug_botguard: false,\n            botguard_cache: BotguardCacheMode::Mem,\n            botguard_cache_dir: None,\n            botguard_ttl: humantime::Duration::from(Duration::from_secs(1800)),\n            botguard_script: None,\n            client_name: None,\n            client_version: None,\n            print_url: false,\n            user_agent: None,\n            proxy: None,\n            verbose: false,\n            quiet: false,\n        }\n    }\n}\n","traces":[{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":2}},{"line":147,"address":[],"length":0,"stats":{"Line":3}},{"line":151,"address":[],"length":0,"stats":{"Line":3}},{"line":152,"address":[],"length":0,"stats":{"Line":3}},{"line":153,"address":[],"length":0,"stats":{"Line":1}},{"line":154,"address":[],"length":0,"stats":{"Line":2}},{"line":155,"address":[],"length":0,"stats":{"Line":1}},{"line":157,"address":[],"length":0,"stats":{"Line":1}},{"line":174,"address":[],"length":0,"stats":{"Line":9}},{"line":175,"address":[],"length":0,"stats":{"Line":27}},{"line":176,"address":[],"length":0,"stats":{"Line":18}},{"line":177,"address":[],"length":0,"stats":{"Line":1}},{"line":185,"address":[],"length":0,"stats":{"Line":40}},{"line":186,"address":[],"length":0,"stats":{"Line":61}},{"line":187,"address":[],"length":0,"stats":{"Line":14}},{"line":189,"address":[],"length":0,"stats":{"Line":6}},{"line":194,"address":[],"length":0,"stats":{"Line":1}},{"line":200,"address":[],"length":0,"stats":{"Line":7}},{"line":202,"address":[],"length":0,"stats":{"Line":1}},{"line":205,"address":[],"length":0,"stats":{"Line":6}},{"line":206,"address":[],"length":0,"stats":{"Line":7}},{"line":207,"address":[],"length":0,"stats":{"Line":6}},{"line":208,"address":[],"length":0,"stats":{"Line":4}},{"line":209,"address":[],"length":0,"stats":{"Line":6}},{"line":210,"address":[],"length":0,"stats":{"Line":3}},{"line":211,"address":[],"length":0,"stats":{"Line":2}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":5}},{"line":287,"address":[],"length":0,"stats":{"Line":10}},{"line":292,"address":[],"length":0,"stats":{"Line":15}},{"line":302,"address":[],"length":0,"stats":{"Line":15}}],"covered":30,"coverable":41},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","cli","mod.rs"],"content":"//! CLI interface for ryt\n\npub mod args;\npub mod output;\n\npub use args::*;\npub use output::*;\n\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","cli","output.rs"],"content":"//! Output formatting and progress display\n\nuse crate::core::progress::Progress;\nuse crate::cli::args::VerbosityLevel;\nuse indicatif::{ProgressBar, ProgressStyle};\nuse std::sync::Arc;\nuse std::time::Duration;\n\n/// Output formatter for ryt\npub struct OutputFormatter {\n    verbosity: VerbosityLevel,\n    progress_bar: Option\u003cProgressBar\u003e,\n}\n\nimpl OutputFormatter {\n    /// Create a new output formatter\n    pub fn new(verbosity: VerbosityLevel) -\u003e Self {\n        Self {\n            verbosity,\n            progress_bar: None,\n        }\n    }\n\n    /// Create a progress bar for downloads\n    pub fn create_progress_bar(\u0026mut self, total_size: u64) -\u003e Option\u003cProgressBar\u003e {\n        if self.verbosity == VerbosityLevel::Quiet {\n            return None;\n        }\n\n        let style = ProgressStyle::default_bar()\n            .template(\"{spinner:.green} [{elapsed_precise}] [{bar:40.cyan/blue}] {bytes}/{total_bytes} ({eta}) {msg}\")\n            .unwrap()\n            .progress_chars(\"#\u003e-\");\n\n        let progress_bar = ProgressBar::new(total_size);\n        progress_bar.set_style(style);\n        progress_bar.set_message(\"Downloading...\");\n\n        self.progress_bar = Some(progress_bar.clone());\n        Some(progress_bar)\n    }\n\n    /// Update progress bar\n    pub fn update_progress(\u0026self, progress: \u0026Progress) {\n        if let Some(progress_bar) = \u0026self.progress_bar {\n            progress_bar.set_position(progress.downloaded_size);\n            progress_bar.set_length(progress.total_size);\n            \n            if let Some(speed) = progress.speed {\n                progress_bar.set_message(format!(\"{}/s\", format_bytes(speed as u64)));\n            }\n        }\n    }\n\n    /// Finish progress bar\n    pub fn finish_progress(\u0026self, message: \u0026str) {\n        if let Some(progress_bar) = \u0026self.progress_bar {\n            progress_bar.finish_with_message(message.to_string());\n        }\n    }\n\n    /// Print info message\n    pub fn info(\u0026self, message: \u0026str) {\n        if self.verbosity != VerbosityLevel::Quiet {\n            println!(\"ℹ️  {}\", message);\n        }\n    }\n\n    /// Print success message\n    pub fn success(\u0026self, message: \u0026str) {\n        if self.verbosity != VerbosityLevel::Quiet {\n            println!(\"✅ {}\", message);\n        }\n    }\n\n    /// Print warning message\n    pub fn warning(\u0026self, message: \u0026str) {\n        if self.verbosity != VerbosityLevel::Quiet {\n            eprintln!(\"⚠️  {}\", message);\n        }\n    }\n\n    /// Print error message\n    pub fn error(\u0026self, message: \u0026str) {\n        eprintln!(\"❌ {}\", message);\n    }\n\n    /// Print debug message\n    pub fn debug(\u0026self, message: \u0026str) {\n        if self.verbosity == VerbosityLevel::Verbose {\n            println!(\"🐛 {}\", message);\n        }\n    }\n\n    /// Print video information\n    pub fn print_video_info(\u0026self, title: \u0026str, author: \u0026str, duration: u32, formats: usize) {\n        if self.verbosity == VerbosityLevel::Quiet {\n            return;\n        }\n\n        println!(\"📹 {}\", title);\n        println!(\"👤 {}\", author);\n        println!(\"⏱️  {}\", format_duration(Duration::from_secs(duration as u64)));\n        println!(\"📊 {} formats available\", formats);\n        println!();\n    }\n\n    /// Print format information\n    pub fn print_format_info(\u0026self, itag: u32, quality: \u0026str, mime_type: \u0026str, bitrate: u32, size: Option\u003cu64\u003e) {\n        if self.verbosity == VerbosityLevel::Quiet {\n            return;\n        }\n\n        let size_str = size.map(|s| format!(\" ({})\", format_bytes(s))).unwrap_or_default();\n        println!(\"  📋 itag={} | {} | {} | {} kbps{}\", \n                 itag, quality, mime_type, bitrate / 1000, size_str);\n    }\n\n    /// Print download start message\n    pub fn print_download_start(\u0026self, url: \u0026str, output_path: \u0026str) {\n        if self.verbosity == VerbosityLevel::Quiet {\n            return;\n        }\n\n        println!(\"🚀 Starting download...\");\n        println!(\"🔗 URL: {}\", url);\n        println!(\"💾 Output: {}\", output_path);\n        println!();\n    }\n\n    /// Print download complete message\n    pub fn print_download_complete(\u0026self, output_path: \u0026str, duration: Duration) {\n        if self.verbosity == VerbosityLevel::Quiet {\n            return;\n        }\n\n        println!();\n        println!(\"✅ Download completed!\");\n        println!(\"💾 Saved to: {}\", output_path);\n        println!(\"⏱️  Time: {}\", format_duration(duration));\n    }\n\n    /// Print playlist information\n    pub fn print_playlist_info(\u0026self, playlist_id: \u0026str, item_count: usize, limit: Option\u003cusize\u003e) {\n        if self.verbosity == VerbosityLevel::Quiet {\n            return;\n        }\n\n        println!(\"📋 Playlist: {}\", playlist_id);\n        if let Some(limit) = limit {\n            println!(\"📊 Items: {} (limited to {})\", item_count, limit);\n        } else {\n            println!(\"📊 Items: {}\", item_count);\n        }\n        println!();\n    }\n\n    /// Print playlist item progress\n    pub fn print_playlist_item(\u0026self, index: usize, total: usize, title: \u0026str) {\n        if self.verbosity == VerbosityLevel::Quiet {\n            return;\n        }\n\n        println!(\"📥 [{}/{}] {}\", index + 1, total, title);\n    }\n\n    /// Print help text\n    pub fn print_help(\u0026self) {\n        println!(\"RYT - Rust Video Downloader\");\n        println!();\n        println!(\"Usage: ryt [OPTIONS] \u003cURL\u003e\");\n        println!();\n        println!(\"Examples:\");\n        println!(\"  ryt VIDEO_URL\");\n        println!(\"  ryt --format best --ext mp4 VIDEO_URL\");\n        println!(\"  ryt --playlist --limit 10 PLAYLIST_URL\");\n        println!(\"  ryt --rate-limit 2MiB/s --output ./downloads VIDEO_URL\");\n        println!();\n        println!(\"For more information, run: ryt --help\");\n    }\n\n    /// Print version information\n    pub fn print_version(\u0026self) {\n        println!(\"ryt version {}\", env!(\"CARGO_PKG_VERSION\"));\n        println!(\"Rust YouTube Downloader - Fast and reliable\");\n    }\n}\n\n/// Create a progress callback for the downloader\npub fn create_progress_callback(formatter: Arc\u003cOutputFormatter\u003e) -\u003e impl Fn(Progress) + Send + Sync + 'static {\n    move |progress: Progress| {\n        formatter.update_progress(\u0026progress);\n    }\n}\n\n/// Format bytes as human-readable string\nfn format_bytes(bytes: u64) -\u003e String {\n    const UNITS: \u0026[\u0026str] = \u0026[\"B\", \"KB\", \"MB\", \"GB\", \"TB\"];\n    const THRESHOLD: f64 = 1024.0;\n\n    if bytes == 0 {\n        return \"0 B\".to_string();\n    }\n\n    let bytes_f64 = bytes as f64;\n    let exp = (bytes_f64.ln() / THRESHOLD.ln()).floor() as usize;\n    let exp = exp.min(UNITS.len() - 1);\n    \n    let value = bytes_f64 / THRESHOLD.powi(exp as i32);\n    \n    if exp == 0 {\n        format!(\"{} {}\", bytes, UNITS[exp])\n    } else {\n        format!(\"{:.1} {}\", value, UNITS[exp])\n    }\n}\n\n/// Format duration as human-readable string\nfn format_duration(duration: Duration) -\u003e String {\n    let total_seconds = duration.as_secs();\n    \n    if total_seconds \u003c 60 {\n        format!(\"{}s\", total_seconds)\n    } else if total_seconds \u003c 3600 {\n        let minutes = total_seconds / 60;\n        let seconds = total_seconds % 60;\n        if seconds == 0 {\n            format!(\"{}m\", minutes)\n        } else {\n            format!(\"{}m {}s\", minutes, seconds)\n        }\n    } else {\n        let hours = total_seconds / 3600;\n        let minutes = (total_seconds % 3600) / 60;\n        if minutes == 0 {\n            format!(\"{}h\", hours)\n        } else {\n            format!(\"{}h {}m\", hours, minutes)\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_output_formatter_creation() {\n        let formatter = OutputFormatter::new(VerbosityLevel::Normal);\n        assert_eq!(formatter.verbosity, VerbosityLevel::Normal);\n        assert!(formatter.progress_bar.is_none());\n    }\n\n    #[test]\n    fn test_format_bytes() {\n        assert_eq!(format_bytes(0), \"0 B\");\n        assert_eq!(format_bytes(1023), \"1023 B\");\n        assert_eq!(format_bytes(1024), \"1.0 KB\");\n        assert_eq!(format_bytes(1536), \"1.5 KB\");\n        assert_eq!(format_bytes(1048576), \"1.0 MB\");\n        assert_eq!(format_bytes(1073741824), \"1.0 GB\");\n    }\n\n    #[test]\n    fn test_format_duration() {\n        assert_eq!(format_duration(Duration::from_secs(30)), \"30s\");\n        assert_eq!(format_duration(Duration::from_secs(60)), \"1m\");\n        assert_eq!(format_duration(Duration::from_secs(90)), \"1m 30s\");\n        assert_eq!(format_duration(Duration::from_secs(3600)), \"1h\");\n        assert_eq!(format_duration(Duration::from_secs(3660)), \"1h 1m\");\n    }\n\n    #[test]\n    fn test_verbosity_levels() {\n        let formatter = OutputFormatter::new(VerbosityLevel::Quiet);\n        // These should not print anything in quiet mode\n        formatter.info(\"test\");\n        formatter.success(\"test\");\n        formatter.warning(\"test\");\n        formatter.debug(\"test\");\n        \n        // Error should always print\n        formatter.error(\"test\");\n    }\n}\n","traces":[{"line":17,"address":[],"length":0,"stats":{"Line":2}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":1}},{"line":64,"address":[],"length":0,"stats":{"Line":1}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":1}},{"line":71,"address":[],"length":0,"stats":{"Line":1}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":1}},{"line":78,"address":[],"length":0,"stats":{"Line":1}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":1}},{"line":85,"address":[],"length":0,"stats":{"Line":2}},{"line":89,"address":[],"length":0,"stats":{"Line":1}},{"line":90,"address":[],"length":0,"stats":{"Line":1}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":6}},{"line":201,"address":[],"length":0,"stats":{"Line":6}},{"line":202,"address":[],"length":0,"stats":{"Line":2}},{"line":212,"address":[],"length":0,"stats":{"Line":3}},{"line":214,"address":[],"length":0,"stats":{"Line":4}},{"line":219,"address":[],"length":0,"stats":{"Line":5}},{"line":220,"address":[],"length":0,"stats":{"Line":15}},{"line":222,"address":[],"length":0,"stats":{"Line":5}},{"line":223,"address":[],"length":0,"stats":{"Line":2}},{"line":224,"address":[],"length":0,"stats":{"Line":4}},{"line":225,"address":[],"length":0,"stats":{"Line":4}},{"line":226,"address":[],"length":0,"stats":{"Line":4}},{"line":227,"address":[],"length":0,"stats":{"Line":2}},{"line":228,"address":[],"length":0,"stats":{"Line":2}},{"line":230,"address":[],"length":0,"stats":{"Line":1}},{"line":233,"address":[],"length":0,"stats":{"Line":2}},{"line":236,"address":[],"length":0,"stats":{"Line":2}},{"line":238,"address":[],"length":0,"stats":{"Line":1}}],"covered":29,"coverable":109},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","core","downloader.rs"],"content":"//! Main downloader implementation\n\nuse crate::core::{Progress, VideoInfo, FormatSelector, QualitySelector};\nuse crate::error::RytError;\nuse crate::utils::{extract_video_id, to_safe_filename};\nuse crate::platform::{InnerTubeClient, PlayerResponse};\nuse crate::core::video_info::Format;\nuse crate::download::ChunkedDownloader;\nuse std::path::PathBuf;\nuse std::sync::Arc;\nuse std::time::Duration;\nuse tokio::sync::Mutex;\nuse tracing::{info, debug, warn};\n\n/// Main downloader configuration\n#[derive(Debug, Clone)]\npub struct DownloadOptions {\n    /// Format selector\n    pub format_selector: Option\u003cFormatSelector\u003e,\n    /// Desired file extension\n    pub desired_ext: Option\u003cString\u003e,\n    /// Output path (file or directory)\n    pub output_path: Option\u003cPathBuf\u003e,\n    /// Rate limit in bytes per second\n    pub rate_limit_bps: Option\u003cu64\u003e,\n    /// InnerTube client name\n    pub client_name: String,\n    /// InnerTube client version\n    pub client_version: String,\n    /// HTTP timeout\n    pub timeout: Duration,\n    /// Maximum retries\n    pub max_retries: u32,\n}\n\nimpl Default for DownloadOptions {\n    fn default() -\u003e Self {\n        Self {\n            format_selector: None,\n            desired_ext: None,\n            output_path: None,\n            rate_limit_bps: None,\n            client_name: \"ANDROID\".to_string(),  // ANDROID gives direct URLs without cipher complexity\n            client_version: \"20.10.38\".to_string(),\n            timeout: Duration::from_secs(30),\n            max_retries: 3,\n        }\n    }\n}\n\n/// Botguard configuration\n#[derive(Debug, Clone)]\npub struct BotguardConfig {\n    /// Botguard mode\n    pub mode: crate::platform::botguard::BotguardMode,\n    /// Debug mode\n    pub debug: bool,\n    /// Token TTL\n    pub ttl: Duration,\n}\n\nimpl Default for BotguardConfig {\n    fn default() -\u003e Self {\n        Self {\n            mode: crate::platform::botguard::BotguardMode::Off,\n            debug: false,\n            ttl: Duration::from_secs(1800), // 30 minutes\n        }\n    }\n}\n\n/// Main downloader struct\npub struct Downloader {\n    options: DownloadOptions,\n    botguard: BotguardConfig,\n    inner_tube: Arc\u003cMutex\u003cInnerTubeClient\u003e\u003e,\n    downloader: Arc\u003cMutex\u003cChunkedDownloader\u003e\u003e,\n}\n\nimpl Downloader {\n    /// Create a new downloader with default options\n    pub fn new() -\u003e Self {\n        Self {\n            options: DownloadOptions::default(),\n            botguard: BotguardConfig::default(),\n            inner_tube: Arc::new(Mutex::new(InnerTubeClient::new())),\n            downloader: Arc::new(Mutex::new(ChunkedDownloader::new())),\n        }\n    }\n\n    /// Set format selector\n    pub fn with_format(mut self, selector: \u0026str, ext: \u0026str) -\u003e Self {\n        if let Ok(quality) = QualitySelector::from_str(selector) {\n            self.options.format_selector = Some(FormatSelector::new(quality).with_extension(ext));\n        }\n        self\n    }\n\n    /// Set output path\n    pub fn with_output_path(mut self, path: impl Into\u003cPathBuf\u003e) -\u003e Self {\n        self.options.output_path = Some(path.into());\n        self\n    }\n\n    /// Set progress callback\n    pub fn with_progress(self, _callback: impl Fn(Progress) + Send + Sync + 'static) -\u003e Self {\n        // TODO: Implement progress callback in ChunkedDownloader\n        self\n    }\n\n    /// Set rate limit\n    pub fn with_rate_limit(mut self, bytes_per_second: u64) -\u003e Self {\n        self.options.rate_limit_bps = Some(bytes_per_second);\n        self\n    }\n\n    /// Set InnerTube client\n    pub fn with_innertube_client(mut self, name: \u0026str, version: \u0026str) -\u003e Self {\n        self.options.client_name = name.to_string();\n        self.options.client_version = version.to_string();\n        self\n    }\n\n    /// Set Botguard mode\n    pub fn with_botguard(mut self, mode: crate::platform::botguard::BotguardMode) -\u003e Self {\n        self.botguard.mode = mode;\n        self\n    }\n\n    /// Set Botguard debug\n    pub fn with_botguard_debug(mut self, debug: bool) -\u003e Self {\n        self.botguard.debug = debug;\n        self\n    }\n\n    /// Set Botguard TTL\n    pub fn with_botguard_ttl(mut self, ttl: Duration) -\u003e Self {\n        self.botguard.ttl = ttl;\n        self\n    }\n\n    /// Set HTTP timeout\n    pub fn with_timeout(mut self, timeout: Duration) -\u003e Self {\n        self.options.timeout = timeout;\n        self\n    }\n\n    /// Set maximum retries\n    pub fn with_max_retries(mut self, max_retries: u32) -\u003e Self {\n        self.options.max_retries = max_retries;\n        self\n    }\n\n    /// Resolve video URL and get metadata without downloading\n    pub async fn resolve_url(\u0026mut self, video_url: \u0026str) -\u003e Result\u003c(String, VideoInfo), RytError\u003e {\n        // Extract video ID\n        let video_id = extract_video_id(video_url)?;\n        info!(\"Resolving URL for video ID: {}\", video_id);\n\n        // Try to get player response with retry logic for age restrictions\n        let mut last_error = None;\n        let max_retries = 3;\n        \n        for attempt in 0..=max_retries {\n            let mut inner_tube = self.inner_tube.lock().await;\n            \n            match inner_tube.get_player_response(\u0026video_id).await {\n                Ok(player_response) =\u003e {\n                    // Success, continue with processing\n                    drop(inner_tube); // Release lock early\n                    let (final_url, video_info) = self.process_player_response(player_response, \u0026video_id).await?;\n\n                    // Professional: WEB fallback causes c=WEB in URL, breaking ANDROID client context\n                    // ANDROID already returns valid itag=18 URLs without 'n' parameter - this is OK\n                    // Do NOT switch to WEB just for 'n' parameter - it breaks client consistency\n                    // YouTube CDN validates that URL's c= parameter matches the client that obtained it\n\n                    return Ok((final_url, video_info));\n                }\n                Err(RytError::AgeRestricted) =\u003e {\n                    warn!(\"Age restriction detected on attempt {}, switching client\", attempt + 1);\n                    // Switch client for age restriction\n                    inner_tube.switch_client_for_error(\u0026RytError::AgeRestricted);\n                    last_error = Some(RytError::AgeRestricted);\n                    \n                    // Wait before retry\n                    if attempt \u003c max_retries {\n                        drop(inner_tube); // Release lock before sleep\n                        tokio::time::sleep(Duration::from_millis(500 * (attempt + 1) as u64)).await;\n                    }\n                }\n                Err(e) =\u003e {\n                    // Non-retryable error or other error\n                    return Err(e);\n                }\n            }\n        }\n        \n        // If we get here, all retries failed\n        Err(last_error.unwrap_or(RytError::AgeRestricted))\n    }\n    \n    /// Process player response and extract video info\n    async fn process_player_response(\u0026mut self, player_response: PlayerResponse, video_id: \u0026str) -\u003e Result\u003c(String, VideoInfo), RytError\u003e {\n\n        // Parse formats\n        let formats = player_response.parse_formats()?;\n        debug!(\"Found {} formats for video {}\", formats.len(), video_id);\n        \n        // Debug: print all formats\n        // println!(\"📋 Available formats ({}):\", formats.len());\n        // for (i, format) in formats.iter().enumerate() {\n        //     println!(\"  {}: itag={}, quality={}, url_len={}, needs_deciphering={}\", \n        //         i, format.itag, format.quality, format.url.len(), format.needs_deciphering());\n        //     if let Some(sig_cipher) = \u0026format.signature_cipher {\n        //         println!(\"    signature_cipher: {}\", sig_cipher);\n        //     }\n        // }\n        \n        // Check if we got muxed formats (itag 18, 22, etc.) - these are stable and don't get 403\n        let all_itags: Vec\u003cu32\u003e = formats.iter().map(|f| f.itag).collect();\n        debug!(\"All itags from ANDROID: {:?}\", all_itags);\n        let has_muxed = formats.iter().any(|f| matches!(f.itag, 18 | 22 | 43 | 36));\n        debug!(\"has_muxed={}, will try IOS={}\", has_muxed, !has_muxed);\n        \n        // If only adaptive formats (itag 299+), try to get muxed from IOS client\n        let formats = if !has_muxed {\n            debug!(\"No muxed formats found (only adaptive), trying IOS client for itag 18/22\");\n            // IOS client often returns muxed formats that ANDROID doesn't provide\n            let mut ios_inner_tube = InnerTubeClient::new().with_client(\"IOS\", \"19.29.1\");\n            \n            match ios_inner_tube.get_player_response(video_id).await {\n                Ok(ios_response) =\u003e {\n                    match ios_response.parse_formats() {\n                        Ok(ios_formats) if !ios_formats.is_empty() =\u003e {\n                            let has_ios_muxed = ios_formats.iter().any(|f| matches!(f.itag, 18 | 22));\n                            if has_ios_muxed {\n                                debug!(\"✅ IOS client returned {} formats with muxed (itag 18/22)\", ios_formats.len());\n                                ios_formats\n                            } else {\n                                debug!(\"IOS also has no muxed formats, using original ANDROID\");\n                                formats\n                            }\n                        }\n                        _ =\u003e {\n                            debug!(\"IOS response parse failed or empty, using ANDROID\");\n                            formats\n                        }\n                    }\n                }\n                Err(e) =\u003e {\n                    warn!(\"IOS client request failed: {}, using ANDROID formats\", e);\n                    formats\n                }\n            }\n        } else {\n            formats\n        };\n        \n        // Strongly prefer muxed formats (itag 18/22) to avoid 403\n        let selected_format = formats.iter()\n            .filter(|f| matches!(f.itag, 18 | 22))\n            .max_by_key(|f| f.height.unwrap_or(0))\n            .or_else(|| formats.iter().filter(|f| matches!(f.itag, 43 | 36)).max_by_key(|f| f.height.unwrap_or(0)))\n            .or_else(|| self.select_format(\u0026formats).ok())\n            .ok_or_else(|| RytError::NoFormatFound)?;\n        debug!(\"Selected format: itag={}, quality={}, size={} (muxed={})\",\n               selected_format.itag, selected_format.quality, \n               selected_format.size.unwrap_or(0),\n               matches!(selected_format.itag, 18 | 22 | 43 | 36));\n        \n        // Resolve final URL with signature deciphering\n        let mut final_url = if selected_format.needs_deciphering() {\n            debug!(\"Format requires deciphering, resolving cipher...\");\n            let video_url = format!(\"https://www.youtube.com/watch?v={}\", video_id);\n            self.resolve_format_url_with_cipher(selected_format, \u0026video_url).await?\n        } else {\n            debug!(\"Format does not require deciphering\");\n            selected_format.url.clone()\n        };\n\n        // Normalize final_url for direct URL path as well (ratebypass, alr, n, drop rqh)\n        if let Ok(mut parsed) = url::Url::parse(\u0026final_url) {\n            // If n present, try to decode and rewrite query pairs safely\n            if let Some(n_val) = parsed.query_pairs().find(|(k, _)| k == \"n\").map(|(_, v)| v.to_string()) {\n                let cipher = crate::platform::cipher::Cipher::new();\n                if let Ok(n_out) = cipher.decipher_n_parameter(\u0026n_val, \u0026format!(\"https://www.youtube.com/watch?v={}\", video_id)).await {\n                    // Collect pairs first (immutable borrow), then rebuild (mutable borrow)\n                    let pairs: Vec\u003c(String, String)\u003e = parsed\n                        .query_pairs()\n                        .map(|(k, v)| (k.into_owned(), v.into_owned()))\n                        .collect();\n                    let mut new_pairs: Vec\u003c(String, String)\u003e = Vec::with_capacity(pairs.len() + 1);\n                    let mut replaced = false;\n                    for (k, v) in pairs {\n                        if k == \"n\" {\n                            new_pairs.push((k, n_out.clone()));\n                            replaced = true;\n                        } else {\n                            new_pairs.push((k, v));\n                        }\n                    }\n                    if !replaced {\n                        new_pairs.push((\"n\".to_string(), n_out));\n                    }\n                    {\n                        let mut qp = parsed.query_pairs_mut();\n                        qp.clear().extend_pairs(new_pairs.iter().map(|(k, v)| (k.as_str(), v.as_str())));\n                    }\n                }\n            }\n            // Add missing critical params (DO NOT remove rqh!)\n            let sparams_val = parsed.query_pairs().find(|(k, _)| k == \"sparams\").map(|(_, v)| v.to_string());\n            let has_rqh = parsed.query_pairs().any(|(k, _)| k == \"rqh\");\n            let sparams_has_rqh = sparams_val.as_ref().map_or(false, |s| s.contains(\"rqh\"));\n            let has_ratebypass = parsed.query_pairs().any(|(k, _)| k == \"ratebypass\");\n            let has_alr = parsed.query_pairs().any(|(k, _)| k == \"alr\");\n            \n            debug!(\"Direct URL norm: has_rqh={}, sparams_has_rqh={}, adding={}\", \n                   has_rqh, sparams_has_rqh, sparams_has_rqh \u0026\u0026 !has_rqh);\n            \n            {\n                let mut qp = parsed.query_pairs_mut();\n                if !has_ratebypass { qp.append_pair(\"ratebypass\", \"yes\"); }\n                if !has_alr { qp.append_pair(\"alr\", \"yes\"); }\n                // CRITICAL FIX: Add rqh=1 if sparams lists it (required for itag=18)\n                if sparams_has_rqh \u0026\u0026 !has_rqh {\n                    qp.append_pair(\"rqh\", \"1\");\n                    debug!(\"✅ CRITICAL: Added rqh=1 to direct URL (itag={})\", selected_format.itag);\n                }\n            }\n            let s: String = parsed.into();\n            final_url = s;\n        }\n\n        // println!(\"🔗 Selected format: itag={}, quality={}, url={}\", selected_format.itag, selected_format.quality, final_url);\n        // if let Some(sig_cipher) = \u0026selected_format.signature_cipher {\n        //     println!(\"🔐 Signature cipher: {}\", sig_cipher);\n        // }\n\n        // Create video info\n        let video_info = VideoInfo {\n            id: video_id.to_string(),\n            title: player_response.video_details.as_ref().map(|v| v.title.clone()).unwrap_or_default(),\n            author: player_response.video_details.as_ref().map(|v| v.author.clone()).unwrap_or_default(),\n            duration: player_response.video_details.as_ref()\n                .and_then(|v| v.length_seconds.parse().ok())\n                .unwrap_or(0),\n            description: player_response.video_details.as_ref().map(|v| v.short_description.clone()).unwrap_or_default(),\n            formats,\n            thumbnail: player_response.video_details.as_ref()\n                .and_then(|v| v.thumbnail.thumbnails.first())\n                .map(|t| t.url.clone()),\n            upload_date: None,\n            view_count: None,\n            like_count: None,\n            tags: Vec::new(),\n            category: None,\n        };\n\n        Ok((final_url, video_info))\n    }\n\n    /// Download video to file\n    pub async fn download(\u0026mut self, video_url: \u0026str) -\u003e Result\u003cVideoInfo, RytError\u003e {\n        // Resolve URL and get metadata (first attempt)\n        let (mut final_url, mut video_info) = self.resolve_url(video_url).await?;\n        info!(\"Starting download for: {}\", video_info.title);\n\n        // Determine output path\n        let output_path = self.determine_output_path(\u0026video_info)?;\n        debug!(\"Output path: {:?}\", output_path);\n\n        // Try download with limited retries; on 403/RateLimited regenerate URL and retry\n        let max_attempts = 2u32;\n        for attempt in 1..=max_attempts {\n            let downloader = self.downloader.lock().await;\n            let result = downloader.download(\u0026final_url, \u0026output_path).await;\n            drop(downloader);\n\n            match result {\n                Ok(()) =\u003e {\n                    info!(\"Download completed successfully\");\n                    // Update video info with output path\n                    video_info.title = output_path.file_stem()\n                        .and_then(|s| s.to_str())\n                        .unwrap_or(\"video\")\n                        .to_string();\n                    return Ok(video_info);\n                }\n                Err(RytError::RateLimited) if attempt \u003c max_attempts =\u003e {\n                    warn!(\"Rate limited/403 during media download (attempt {}/{}). Regenerating URL and retrying...\", attempt, max_attempts);\n                    // Switch client strategy for error and regenerate URL\n                    {\n                        let mut inner = self.inner_tube.lock().await;\n                        inner.switch_client_for_error(\u0026RytError::RateLimited);\n                    }\n                    // Resolve again to get fresh final_url\n                    let (new_url, _vi) = self.resolve_url(video_url).await?;\n                    final_url = new_url;\n                    continue;\n                }\n                Err(e) =\u003e return Err(e),\n            }\n        }\n\n        // If we got here, all attempts failed\n        Err(RytError::Generic(\"Download failed after retries\".to_string()))\n    }\n\n    /// Download playlist\n    pub async fn download_playlist(\u0026mut self, playlist_url: \u0026str, limit: Option\u003cusize\u003e) -\u003e Result\u003cVec\u003cVideoInfo\u003e, RytError\u003e {\n        // Extract playlist ID\n        let playlist_id = crate::utils::url::extract_playlist_id(playlist_url)?;\n\n        // Get playlist items\n        let items = {\n            let mut inner_tube = self.inner_tube.lock().await;\n            inner_tube.get_playlist_items(\u0026playlist_id, limit).await?\n        };\n\n        // Download each video\n        let mut results = Vec::new();\n        for item in items {\n            let video_url = format!(\"https://www.youtube.com/watch?v={}\", item.video_id);\n            match self.download(\u0026video_url).await {\n                Ok(info) =\u003e results.push(info),\n                Err(e) =\u003e {\n                    eprintln!(\"Failed to download {}: {}\", item.title, e);\n                    continue;\n                }\n            }\n        }\n\n        Ok(results)\n    }\n\n    /// Select format based on selector\n    fn select_format\u003c'a\u003e(\u0026self, formats: \u0026'a [Format]) -\u003e Result\u003c\u0026'a Format, RytError\u003e {\n        let default_selector = FormatSelector::new(QualitySelector::Best);\n        let selector = self.options.format_selector.as_ref()\n            .unwrap_or(\u0026default_selector);\n\n        let mut candidates: Vec\u003c\u0026Format\u003e = formats.iter().collect();\n\n        // Filter by extension\n        if let Some(ext) = \u0026selector.extension {\n            candidates.retain(|f| f.mime_type.contains(ext));\n        }\n\n        // Filter by height constraints\n        if let Some(height_limit) = selector.height_limit {\n            candidates.retain(|f| {\n                let height = f.height.unwrap_or(0);\n                height \u003c= height_limit\n            });\n        }\n\n        if let Some(height_min) = selector.height_min {\n            candidates.retain(|f| {\n                let height = f.height.unwrap_or(0);\n                height \u003e= height_min\n            });\n        }\n\n        // Select by quality\n        match \u0026selector.quality {\n            QualitySelector::Best =\u003e {\n                candidates.sort_by(|a, b| b.bitrate.cmp(\u0026a.bitrate));\n                candidates.first().copied()\n            }\n            QualitySelector::Worst =\u003e {\n                candidates.sort_by(|a, b| a.bitrate.cmp(\u0026b.bitrate));\n                candidates.first().copied()\n            }\n            QualitySelector::Itag(target_itag) =\u003e {\n                candidates.iter().find(|f| f.itag == *target_itag).copied()\n            }\n            QualitySelector::Height(target_height) =\u003e {\n                candidates.iter()\n                    .filter(|f| f.height.unwrap_or(0) == *target_height)\n                    .max_by_key(|f| f.bitrate)\n                    .copied()\n            }\n            QualitySelector::HeightLessOrEqual(target_height) =\u003e {\n                candidates.iter()\n                    .filter(|f| f.height.unwrap_or(0) \u003c= *target_height)\n                    .max_by_key(|f| f.bitrate)\n                    .copied()\n            }\n            QualitySelector::HeightGreaterOrEqual(target_height) =\u003e {\n                candidates.iter()\n                    .filter(|f| f.height.unwrap_or(0) \u003e= *target_height)\n                    .max_by_key(|f| f.bitrate)\n                    .copied()\n            }\n        }.ok_or(RytError::NoFormatFound)\n    }\n\n    /// Resolve format URL with signature deciphering\n    async fn resolve_format_url_with_cipher(\u0026self, format: \u0026Format, video_url: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        use crate::platform::cipher::Cipher;\n\n        // println!(\"🔧 Starting cipher resolution for format itag={}\", format.itag);\n        let cipher = Cipher::new();\n        let mut final_url = format.url.clone();\n\n        // Handle signature cipher\n        if let Some(sig_cipher) = \u0026format.signature_cipher {\n            // println!(\"🔧 Parsing signature cipher: {}\", sig_cipher);\n            \n            // Parse signature cipher parameters\n            let sig_params: std::collections::HashMap\u003cString, String\u003e =\n                url::form_urlencoded::parse(sig_cipher.as_bytes())\n                    .into_owned()\n                    .collect();\n\n            // println!(\"🔧 Parsed parameters: {:?}\", sig_params);\n\n            if let Some(base_url) = sig_params.get(\"url\") {\n                final_url = base_url.clone();\n                // println!(\"🔧 Base URL: {}\", final_url);\n            }\n\n            if let Some(signature) = sig_params.get(\"s\") {\n                println!(\"🔧 Deciphering signature: {}\", signature);\n                let deciphered_sig = cipher.decipher_signature(signature, video_url).await?;\n                println!(\"🔧 Deciphered signature: {}\", deciphered_sig);\n                \n                // Replace existing sig parameter or add new one\n                let sig_regex = regex::Regex::new(r\"[?\u0026]sig=([^\u0026]+)\")?;\n                if sig_regex.is_match(\u0026final_url) {\n                    // Replace existing sig parameter\n                    final_url = sig_regex.replace(\u0026final_url, |caps: \u0026regex::Captures| {\n                        format!(\"{}sig={}\", \u0026caps[0][..caps[0].find('=').unwrap() + 1], deciphered_sig)\n                    }).to_string();\n                    println!(\"🔧 Replaced sig parameter in URL\");\n                } else {\n                    // Add new sig parameter\n                    final_url = format!(\"{}\u0026sig={}\", final_url, deciphered_sig);\n                    println!(\"🔧 Added sig parameter to URL\");\n                }\n                println!(\"🔧 Final URL with deciphered sig: {}\", final_url);\n            }\n\n            if let Some(n_param) = sig_params.get(\"n\") {\n                // println!(\"🔧 Deciphering n-parameter: {}\", n_param);\n                let deciphered_n = cipher.decipher_n_parameter(n_param, video_url).await?;\n                // println!(\"🔧 Deciphered n-parameter: {}\", deciphered_n);\n                \n                // Add n-parameter to URL\n                if final_url.contains(\"\u0026n=\") {\n                    final_url = final_url.replace(\"\u0026n=\", \u0026format!(\"\u0026n={}\", deciphered_n));\n                } else {\n                    final_url = format!(\"{}\u0026n={}\", final_url, deciphered_n);\n                }\n            }\n        }\n        \n        // Handle n-parameter in URL\n        if final_url.contains(\"\u0026n=\") || final_url.contains(\"?n=\") {\n            let n_regex = regex::Regex::new(r\"[?\u0026]n=([^\u0026]+)\")?;\n            if let Some(captures) = n_regex.captures(\u0026final_url) {\n                if let Some(n_param) = captures.get(1) {\n                    let deciphered_n = cipher.decipher_n_parameter(n_param.as_str(), video_url).await?;\n                    final_url = final_url.replace(n_param.as_str(), \u0026deciphered_n);\n                }\n            }\n        }\n\n        // Normalize URL parameters similar to Go ytdlp:\n        // - ensure n is decoded if present (handled above already)\n        // - enforce ratebypass=yes\n        // - add alr=yes to encourage stable redirects\n        if let Ok(mut parsed) = url::Url::parse(\u0026final_url) {\n            // Precompute existence flags before taking a mutable borrow\n            let has_ratebypass = parsed.query_pairs().any(|(k, _)| k == \"ratebypass\");\n            let has_alr = parsed.query_pairs().any(|(k, _)| k == \"alr\");\n\n            // Add missing params. If sparams contains rqh but rqh parameter is missing, add it\n            let sparams_val = parsed.query_pairs().find(|(k, _)| k == \"sparams\").map(|(_, v)| v.to_string());\n            let has_rqh = parsed.query_pairs().any(|(k, _)| k == \"rqh\");\n            let sparams_has_rqh = sparams_val.as_ref().map_or(false, |s| s.contains(\"rqh\"));\n            let current_fvip = parsed.query_pairs().find(|(k, _)| k == \"fvip\").map(|(_, v)| v.to_string());\n            \n            debug!(\"URL normalization: has_rqh={}, sparams_has_rqh={}, will add rqh={}\", \n                   has_rqh, sparams_has_rqh, sparams_has_rqh \u0026\u0026 !has_rqh);\n            \n            {\n                let mut qp = parsed.query_pairs_mut();\n                if !has_ratebypass {\n                    qp.append_pair(\"ratebypass\", \"yes\");\n                    debug!(\"Added ratebypass=yes\");\n                }\n                if !has_alr {\n                    qp.append_pair(\"alr\", \"yes\");\n                    debug!(\"Added alr=yes\");\n                }\n                // If sparams lists rqh but rqh param is missing, add rqh=1 (CRITICAL for itag 18)\n                if sparams_has_rqh \u0026\u0026 !has_rqh {\n                    qp.append_pair(\"rqh\", \"1\");\n                    debug!(\"✅ Added rqh=1 (required by sparams)\");\n                }\n            }\n            \n            // Professional 403 mitigation: rotate fvip (front video IP) to get different CDN server\n            // YouTube uses fvip=1..5 for load balancing; rotating helps bypass temporary blocks\n            if let Some(fvip_str) = current_fvip {\n                if let Ok(fvip_num) = fvip_str.parse::\u003cu8\u003e() {\n                    // Cycle through fvip 1-5\n                    let new_fvip = (fvip_num % 5) + 1;\n                    // Rebuild query without fvip\n                    let pairs: Vec\u003c(String, String)\u003e = parsed.query_pairs()\n                        .filter(|(k, _)| k != \"fvip\")\n                        .map(|(k, v)| (k.into_owned(), v.into_owned()))\n                        .collect();\n                    {\n                        let mut qp = parsed.query_pairs_mut();\n                        qp.clear().extend_pairs(pairs.iter().map(|(k, v)| (k.as_str(), v.as_str())));\n                        qp.append_pair(\"fvip\", \u0026new_fvip.to_string());\n                    }\n                    debug!(\"Rotated fvip from {} to {} for CDN failover\", fvip_num, new_fvip);\n                }\n            }\n\n            let s: String = parsed.into();\n            return Ok(s);\n        }\n\n        Ok(final_url)\n    }\n\n    /// Determine output path for downloaded file\n    fn determine_output_path(\u0026self, video_info: \u0026VideoInfo) -\u003e Result\u003cPathBuf, RytError\u003e {\n        if let Some(output_path) = \u0026self.options.output_path {\n            if output_path.is_dir() {\n                // Generate filename from title\n                let ext = self.options.desired_ext.as_deref().unwrap_or(\"mp4\");\n                let safe_filename = to_safe_filename(\u0026video_info.title, ext);\n                Ok(output_path.join(safe_filename))\n            } else {\n                // Use provided path as-is\n                Ok(output_path.clone())\n            }\n        } else {\n            // Generate filename in current directory\n            let ext = self.options.desired_ext.as_deref().unwrap_or(\"mp4\");\n            let safe_filename = to_safe_filename(\u0026video_info.title, ext);\n            Ok(PathBuf::from(safe_filename))\n        }\n    }\n}\n\nimpl Default for Downloader {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_downloader_creation() {\n        let downloader = Downloader::new();\n        assert_eq!(downloader.options.client_name, \"ANDROID\");\n        assert_eq!(downloader.options.client_version, \"20.10.38\");\n    }\n\n    #[test]\n    fn test_downloader_with_format() {\n        let downloader = Downloader::new()\n            .with_format(\"best\", \"mp4\")\n            .with_rate_limit(1024 * 1024); // 1MB/s\n\n        assert!(downloader.options.format_selector.is_some());\n        assert_eq!(downloader.options.rate_limit_bps, Some(1024 * 1024));\n    }\n\n    #[test]\n    fn test_downloader_with_botguard() {\n        let downloader = Downloader::new()\n            .with_botguard(crate::platform::botguard::BotguardMode::Auto)\n            .with_botguard_debug(true);\n\n        assert_eq!(downloader.botguard.mode, crate::platform::botguard::BotguardMode::Auto);\n        assert!(downloader.botguard.debug);\n    }\n}\n","traces":[{"line":37,"address":[],"length":0,"stats":{"Line":3}},{"line":43,"address":[],"length":0,"stats":{"Line":9}},{"line":44,"address":[],"length":0,"stats":{"Line":6}},{"line":45,"address":[],"length":0,"stats":{"Line":3}},{"line":63,"address":[],"length":0,"stats":{"Line":3}},{"line":67,"address":[],"length":0,"stats":{"Line":3}},{"line":82,"address":[],"length":0,"stats":{"Line":3}},{"line":84,"address":[],"length":0,"stats":{"Line":6}},{"line":85,"address":[],"length":0,"stats":{"Line":6}},{"line":86,"address":[],"length":0,"stats":{"Line":12}},{"line":87,"address":[],"length":0,"stats":{"Line":6}},{"line":92,"address":[],"length":0,"stats":{"Line":1}},{"line":93,"address":[],"length":0,"stats":{"Line":2}},{"line":96,"address":[],"length":0,"stats":{"Line":1}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":1}},{"line":113,"address":[],"length":0,"stats":{"Line":1}},{"line":114,"address":[],"length":0,"stats":{"Line":1}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":1}},{"line":126,"address":[],"length":0,"stats":{"Line":1}},{"line":127,"address":[],"length":0,"stats":{"Line":1}},{"line":131,"address":[],"length":0,"stats":{"Line":1}},{"line":132,"address":[],"length":0,"stats":{"Line":1}},{"line":133,"address":[],"length":0,"stats":{"Line":1}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":509,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":543,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":553,"address":[],"length":0,"stats":{"Line":0}},{"line":555,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":563,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":575,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":582,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":586,"address":[],"length":0,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":0}},{"line":591,"address":[],"length":0,"stats":{"Line":0}},{"line":592,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":597,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[],"length":0,"stats":{"Line":0}},{"line":601,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":608,"address":[],"length":0,"stats":{"Line":0}},{"line":609,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":613,"address":[],"length":0,"stats":{"Line":0}},{"line":614,"address":[],"length":0,"stats":{"Line":0}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":618,"address":[],"length":0,"stats":{"Line":0}},{"line":619,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":622,"address":[],"length":0,"stats":{"Line":0}},{"line":626,"address":[],"length":0,"stats":{"Line":0}},{"line":627,"address":[],"length":0,"stats":{"Line":0}},{"line":630,"address":[],"length":0,"stats":{"Line":0}},{"line":634,"address":[],"length":0,"stats":{"Line":0}},{"line":635,"address":[],"length":0,"stats":{"Line":0}},{"line":636,"address":[],"length":0,"stats":{"Line":0}},{"line":638,"address":[],"length":0,"stats":{"Line":0}},{"line":639,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":643,"address":[],"length":0,"stats":{"Line":0}},{"line":647,"address":[],"length":0,"stats":{"Line":0}},{"line":648,"address":[],"length":0,"stats":{"Line":0}},{"line":649,"address":[],"length":0,"stats":{"Line":0}},{"line":655,"address":[],"length":0,"stats":{"Line":0}},{"line":656,"address":[],"length":0,"stats":{"Line":0}}],"covered":23,"coverable":296},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","core","mod.rs"],"content":"//! Core functionality for ryt\n\npub mod downloader;\npub mod progress;\npub mod video_info;\n\npub use downloader::*;\npub use progress::*;\npub use video_info::*;\n\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","core","progress.rs"],"content":"//! Progress tracking for downloads\n\nuse std::time::{Duration, Instant};\n\n/// Progress information for a download\n#[derive(Debug, Clone)]\npub struct Progress {\n    /// Total size of the file in bytes\n    pub total_size: u64,\n    /// Number of bytes downloaded\n    pub downloaded_size: u64,\n    /// Download progress as a percentage (0.0 to 100.0)\n    pub percent: f64,\n    /// Current download speed in bytes per second\n    pub speed: Option\u003cf64\u003e,\n    /// Estimated time remaining\n    pub eta: Option\u003cDuration\u003e,\n    /// Time when download started\n    pub start_time: Instant,\n}\n\nimpl Progress {\n    /// Create a new progress tracker\n    pub fn new(total_size: u64) -\u003e Self {\n        Self {\n            total_size,\n            downloaded_size: 0,\n            percent: 0.0,\n            speed: None,\n            eta: None,\n            start_time: Instant::now(),\n        }\n    }\n\n    /// Update progress with new downloaded size\n    pub fn update(\u0026mut self, downloaded_size: u64) {\n        self.downloaded_size = downloaded_size;\n        self.percent = if self.total_size \u003e 0 {\n            (downloaded_size as f64 / self.total_size as f64) * 100.0\n        } else {\n            0.0\n        };\n\n        // Calculate speed and ETA\n        let elapsed = self.start_time.elapsed();\n        if elapsed.as_millis() \u003e 0 {\n            self.speed = Some(downloaded_size as f64 / elapsed.as_secs_f64());\n            \n            if let Some(speed) = self.speed {\n                if speed \u003e 0.0 \u0026\u0026 self.total_size \u003e downloaded_size {\n                    let remaining_bytes = self.total_size - downloaded_size;\n                    self.eta = Some(Duration::from_secs((remaining_bytes as f64 / speed) as u64));\n                }\n            }\n        }\n    }\n\n    /// Check if download is complete\n    pub fn is_complete(\u0026self) -\u003e bool {\n        self.total_size \u003e 0 \u0026\u0026 self.downloaded_size \u003e= self.total_size\n    }\n\n    /// Get human-readable speed string\n    pub fn speed_string(\u0026self) -\u003e String {\n        if let Some(speed) = self.speed {\n            format_bytes_per_second(speed)\n        } else {\n            \"Unknown\".to_string()\n        }\n    }\n\n    /// Get human-readable ETA string\n    pub fn eta_string(\u0026self) -\u003e String {\n        if let Some(eta) = self.eta {\n            format_duration(eta)\n        } else {\n            \"Unknown\".to_string()\n        }\n    }\n\n    /// Get human-readable total size string\n    pub fn total_size_string(\u0026self) -\u003e String {\n        format_bytes(self.total_size)\n    }\n\n    /// Get human-readable downloaded size string\n    pub fn downloaded_size_string(\u0026self) -\u003e String {\n        format_bytes(self.downloaded_size)\n    }\n}\n\n/// Format bytes as human-readable string\npub fn format_bytes(bytes: u64) -\u003e String {\n    const UNITS: \u0026[\u0026str] = \u0026[\"B\", \"KB\", \"MB\", \"GB\", \"TB\"];\n    const THRESHOLD: f64 = 1024.0;\n\n    if bytes == 0 {\n        return \"0 B\".to_string();\n    }\n\n    let bytes_f64 = bytes as f64;\n    let exp = (bytes_f64.ln() / THRESHOLD.ln()).floor() as usize;\n    let exp = exp.min(UNITS.len() - 1);\n    \n    let value = bytes_f64 / THRESHOLD.powi(exp as i32);\n    \n    if exp == 0 {\n        format!(\"{} {}\", bytes, UNITS[exp])\n    } else {\n        format!(\"{:.1} {}\", value, UNITS[exp])\n    }\n}\n\n/// Format bytes per second as human-readable string\npub fn format_bytes_per_second(bytes_per_second: f64) -\u003e String {\n    format!(\"{}/s\", format_bytes(bytes_per_second as u64))\n}\n\n/// Format duration as human-readable string\npub fn format_duration(duration: Duration) -\u003e String {\n    let total_seconds = duration.as_secs();\n    \n    if total_seconds \u003c 60 {\n        format!(\"{}s\", total_seconds)\n    } else if total_seconds \u003c 3600 {\n        let minutes = total_seconds / 60;\n        let seconds = total_seconds % 60;\n        if seconds == 0 {\n            format!(\"{}m\", minutes)\n        } else {\n            format!(\"{}m {}s\", minutes, seconds)\n        }\n    } else {\n        let hours = total_seconds / 3600;\n        let minutes = (total_seconds % 3600) / 60;\n        if minutes == 0 {\n            format!(\"{}h\", hours)\n        } else {\n            format!(\"{}h {}m\", hours, minutes)\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::thread;\n    use std::time::Duration;\n\n    #[test]\n    fn test_progress_creation() {\n        let progress = Progress::new(1000);\n        assert_eq!(progress.total_size, 1000);\n        assert_eq!(progress.downloaded_size, 0);\n        assert_eq!(progress.percent, 0.0);\n        assert!(!progress.is_complete());\n    }\n\n    #[test]\n    fn test_progress_update() {\n        let mut progress = Progress::new(1000);\n        \n        progress.update(500);\n        assert_eq!(progress.downloaded_size, 500);\n        assert_eq!(progress.percent, 50.0);\n        assert!(!progress.is_complete());\n        \n        progress.update(1000);\n        assert_eq!(progress.downloaded_size, 1000);\n        assert_eq!(progress.percent, 100.0);\n        assert!(progress.is_complete());\n    }\n\n    #[test]\n    fn test_progress_speed_calculation() {\n        let mut progress = Progress::new(1000);\n        \n        // Simulate some time passing\n        thread::sleep(Duration::from_millis(100));\n        progress.update(100);\n        \n        // Speed should be calculated\n        assert!(progress.speed.is_some());\n        assert!(progress.speed.unwrap() \u003e 0.0);\n    }\n\n    #[test]\n    fn test_format_bytes() {\n        assert_eq!(format_bytes(0), \"0 B\");\n        assert_eq!(format_bytes(1023), \"1023 B\");\n        assert_eq!(format_bytes(1024), \"1.0 KB\");\n        assert_eq!(format_bytes(1536), \"1.5 KB\");\n        assert_eq!(format_bytes(1048576), \"1.0 MB\");\n        assert_eq!(format_bytes(1073741824), \"1.0 GB\");\n    }\n\n    #[test]\n    fn test_format_duration() {\n        assert_eq!(format_duration(Duration::from_secs(30)), \"30s\");\n        assert_eq!(format_duration(Duration::from_secs(60)), \"1m\");\n        assert_eq!(format_duration(Duration::from_secs(90)), \"1m 30s\");\n        assert_eq!(format_duration(Duration::from_secs(3600)), \"1h\");\n        assert_eq!(format_duration(Duration::from_secs(3660)), \"1h 1m\");\n    }\n}\n","traces":[{"line":24,"address":[],"length":0,"stats":{"Line":3}},{"line":31,"address":[],"length":0,"stats":{"Line":3}},{"line":36,"address":[],"length":0,"stats":{"Line":3}},{"line":37,"address":[],"length":0,"stats":{"Line":3}},{"line":38,"address":[],"length":0,"stats":{"Line":3}},{"line":39,"address":[],"length":0,"stats":{"Line":3}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":9}},{"line":46,"address":[],"length":0,"stats":{"Line":3}},{"line":47,"address":[],"length":0,"stats":{"Line":2}},{"line":49,"address":[],"length":0,"stats":{"Line":2}},{"line":50,"address":[],"length":0,"stats":{"Line":2}},{"line":51,"address":[],"length":0,"stats":{"Line":3}},{"line":52,"address":[],"length":0,"stats":{"Line":2}},{"line":59,"address":[],"length":0,"stats":{"Line":3}},{"line":60,"address":[],"length":0,"stats":{"Line":6}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":6}},{"line":97,"address":[],"length":0,"stats":{"Line":6}},{"line":98,"address":[],"length":0,"stats":{"Line":2}},{"line":108,"address":[],"length":0,"stats":{"Line":3}},{"line":110,"address":[],"length":0,"stats":{"Line":4}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":5}},{"line":121,"address":[],"length":0,"stats":{"Line":15}},{"line":123,"address":[],"length":0,"stats":{"Line":5}},{"line":124,"address":[],"length":0,"stats":{"Line":2}},{"line":125,"address":[],"length":0,"stats":{"Line":4}},{"line":126,"address":[],"length":0,"stats":{"Line":4}},{"line":127,"address":[],"length":0,"stats":{"Line":4}},{"line":128,"address":[],"length":0,"stats":{"Line":2}},{"line":129,"address":[],"length":0,"stats":{"Line":2}},{"line":131,"address":[],"length":0,"stats":{"Line":1}},{"line":134,"address":[],"length":0,"stats":{"Line":2}},{"line":137,"address":[],"length":0,"stats":{"Line":2}},{"line":139,"address":[],"length":0,"stats":{"Line":1}}],"covered":33,"coverable":48},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","core","video_info.rs"],"content":"//! Video information structures\n\nuse serde::{Deserialize, Serialize};\n\n/// Video information and metadata\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct VideoInfo {\n    /// YouTube video ID\n    pub id: String,\n    /// Video title\n    pub title: String,\n    /// Video author/channel name\n    pub author: String,\n    /// Video duration in seconds\n    pub duration: u32,\n    /// Video description\n    pub description: String,\n    /// Available formats\n    pub formats: Vec\u003cFormat\u003e,\n    /// Video thumbnail URL\n    pub thumbnail: Option\u003cString\u003e,\n    /// Video upload date\n    pub upload_date: Option\u003cString\u003e,\n    /// Video view count\n    pub view_count: Option\u003cu64\u003e,\n    /// Video like count\n    pub like_count: Option\u003cu64\u003e,\n    /// Video tags\n    pub tags: Vec\u003cString\u003e,\n    /// Video category\n    pub category: Option\u003cString\u003e,\n}\n\nimpl VideoInfo {\n    /// Create a new VideoInfo\n    pub fn new(id: String, title: String) -\u003e Self {\n        Self {\n            id,\n            title,\n            author: String::new(),\n            duration: 0,\n            description: String::new(),\n            formats: Vec::new(),\n            thumbnail: None,\n            upload_date: None,\n            view_count: None,\n            like_count: None,\n            tags: Vec::new(),\n            category: None,\n        }\n    }\n\n    /// Get the best available format\n    pub fn best_format(\u0026self) -\u003e Option\u003c\u0026Format\u003e {\n        self.formats.iter().max_by_key(|f| f.bitrate)\n    }\n\n    /// Get formats filtered by extension\n    pub fn formats_by_extension(\u0026self, extension: \u0026str) -\u003e Vec\u003c\u0026Format\u003e {\n        self.formats\n            .iter()\n            .filter(|f| f.mime_type.contains(extension))\n            .collect()\n    }\n\n    /// Get formats filtered by quality\n    pub fn formats_by_quality(\u0026self, quality: \u0026str) -\u003e Vec\u003c\u0026Format\u003e {\n        self.formats\n            .iter()\n            .filter(|f| f.quality == quality)\n            .collect()\n    }\n\n    /// Get the total size of all formats\n    pub fn total_size(\u0026self) -\u003e u64 {\n        self.formats.iter().map(|f| f.size.unwrap_or(0)).sum()\n    }\n\n    /// Check if video has progressive formats (video+audio combined)\n    pub fn has_progressive_formats(\u0026self) -\u003e bool {\n        self.formats.iter().any(|f| f.is_progressive())\n    }\n\n    /// Check if video has adaptive formats (video or audio only)\n    pub fn has_adaptive_formats(\u0026self) -\u003e bool {\n        self.formats.iter().any(|f| f.is_adaptive())\n    }\n}\n\n/// Video format information\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Format {\n    /// YouTube format ID (itag)\n    pub itag: u32,\n    /// Direct download URL\n    pub url: String,\n    /// Quality label (e.g., \"720p\", \"1080p\")\n    pub quality: String,\n    /// MIME type\n    pub mime_type: String,\n    /// Bitrate in bits per second\n    pub bitrate: u32,\n    /// File size in bytes (if known)\n    pub size: Option\u003cu64\u003e,\n    /// Signature cipher (if encrypted)\n    pub signature_cipher: Option\u003cString\u003e,\n    /// Audio codec\n    pub audio_codec: Option\u003cString\u003e,\n    /// Video codec\n    pub video_codec: Option\u003cString\u003e,\n    /// Frame rate\n    pub fps: Option\u003cu32\u003e,\n    /// Video width\n    pub width: Option\u003cu32\u003e,\n    /// Video height\n    pub height: Option\u003cu32\u003e,\n    /// Audio sample rate\n    pub audio_sample_rate: Option\u003cu32\u003e,\n    /// Audio channels\n    pub audio_channels: Option\u003cu32\u003e,\n    /// Language code\n    pub language: Option\u003cString\u003e,\n    /// Format note/description\n    pub note: Option\u003cString\u003e,\n}\n\nimpl Format {\n    /// Create a new Format\n    pub fn new(itag: u32, url: String, quality: String, mime_type: String) -\u003e Self {\n        Self {\n            itag,\n            url,\n            quality,\n            mime_type,\n            bitrate: 0,\n            size: None,\n            signature_cipher: None,\n            audio_codec: None,\n            video_codec: None,\n            fps: None,\n            width: None,\n            height: None,\n            audio_sample_rate: None,\n            audio_channels: None,\n            language: None,\n            note: None,\n        }\n    }\n\n    /// Check if format is progressive (video+audio combined)\n    pub fn is_progressive(\u0026self) -\u003e bool {\n        self.mime_type.starts_with(\"video/\") \u0026\u0026 \n        (self.mime_type.contains(\"mp4\") || self.mime_type.contains(\"webm\")) \u0026\u0026\n        self.audio_codec.is_some() \u0026\u0026 self.video_codec.is_some()\n    }\n\n    /// Check if format is adaptive (video or audio only)\n    pub fn is_adaptive(\u0026self) -\u003e bool {\n        (self.mime_type.starts_with(\"video/\") \u0026\u0026 self.audio_codec.is_none()) || \n        self.mime_type.starts_with(\"audio/\")\n    }\n\n    /// Check if format is video-only\n    pub fn is_video_only(\u0026self) -\u003e bool {\n        self.mime_type.starts_with(\"video/\") \u0026\u0026 self.audio_codec.is_none()\n    }\n\n    /// Check if format is audio-only\n    pub fn is_audio_only(\u0026self) -\u003e bool {\n        self.mime_type.starts_with(\"audio/\")\n    }\n\n    /// Get file extension from MIME type\n    pub fn extension(\u0026self) -\u003e \u0026'static str {\n        crate::utils::mime::ext_from_mime(\u0026self.mime_type)\n    }\n\n    /// Get container format\n    pub fn container(\u0026self) -\u003e \u0026'static str {\n        crate::utils::mime::get_container_format(\u0026self.mime_type)\n    }\n\n    /// Check if format needs signature deciphering\n    pub fn needs_deciphering(\u0026self) -\u003e bool {\n        self.signature_cipher.is_some() || \n        self.url.contains(\"\u0026n=\") || \n        self.url.contains(\"?n=\") ||\n        self.url.is_empty()\n    }\n\n    /// Get human-readable quality string\n    pub fn quality_string(\u0026self) -\u003e String {\n        if !self.quality.is_empty() {\n            self.quality.clone()\n        } else if let (Some(width), Some(height)) = (self.width, self.height) {\n            format!(\"{}x{}\", width, height)\n        } else {\n            \"Unknown\".to_string()\n        }\n    }\n\n    /// Get human-readable size string\n    pub fn size_string(\u0026self) -\u003e String {\n        if let Some(size) = self.size {\n            crate::core::progress::format_bytes(size)\n        } else {\n            \"Unknown\".to_string()\n        }\n    }\n\n    /// Get human-readable bitrate string\n    pub fn bitrate_string(\u0026self) -\u003e String {\n        if self.bitrate \u003e 0 {\n            format!(\"{} kbps\", self.bitrate / 1000)\n        } else {\n            \"Unknown\".to_string()\n        }\n    }\n}\n\n/// Playlist item information\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct PlaylistItem {\n    /// Video ID\n    pub video_id: String,\n    /// Video title\n    pub title: String,\n    /// Video author\n    pub author: String,\n    /// Video duration in seconds\n    pub duration: u32,\n    /// Playlist index\n    pub index: u32,\n    /// Video thumbnail URL\n    pub thumbnail: Option\u003cString\u003e,\n    /// Video description\n    pub description: Option\u003cString\u003e,\n}\n\nimpl PlaylistItem {\n    /// Create a new PlaylistItem\n    pub fn new(video_id: String, title: String, index: u32) -\u003e Self {\n        Self {\n            video_id,\n            title,\n            author: String::new(),\n            duration: 0,\n            index,\n            thumbnail: None,\n            description: None,\n        }\n    }\n\n    /// Get the YouTube URL for this video\n    pub fn url(\u0026self) -\u003e String {\n        format!(\"https://www.youtube.com/watch?v={}\", self.video_id)\n    }\n}\n\n/// Format selector for choosing video formats\n#[derive(Debug, Clone)]\npub struct FormatSelector {\n    /// Quality selector\n    pub quality: QualitySelector,\n    /// Desired file extension\n    pub extension: Option\u003cString\u003e,\n    /// Maximum height constraint\n    pub height_limit: Option\u003cu32\u003e,\n    /// Minimum height constraint\n    pub height_min: Option\u003cu32\u003e,\n    /// Preferred itag\n    pub preferred_itag: Option\u003cu32\u003e,\n}\n\nimpl FormatSelector {\n    /// Create a new format selector\n    pub fn new(quality: QualitySelector) -\u003e Self {\n        Self {\n            quality,\n            extension: None,\n            height_limit: None,\n            height_min: None,\n            preferred_itag: None,\n        }\n    }\n\n    /// Set desired extension\n    pub fn with_extension(mut self, extension: \u0026str) -\u003e Self {\n        self.extension = Some(extension.to_string());\n        self\n    }\n\n    /// Set height limit\n    pub fn with_height_limit(mut self, height: u32) -\u003e Self {\n        self.height_limit = Some(height);\n        self\n    }\n\n    /// Set minimum height\n    pub fn with_height_min(mut self, height: u32) -\u003e Self {\n        self.height_min = Some(height);\n        self\n    }\n\n    /// Set preferred itag\n    pub fn with_itag(mut self, itag: u32) -\u003e Self {\n        self.preferred_itag = Some(itag);\n        self\n    }\n}\n\n/// Quality selection criteria\n#[derive(Debug, Clone, PartialEq)]\npub enum QualitySelector {\n    /// Best quality available\n    Best,\n    /// Worst quality available\n    Worst,\n    /// Specific itag\n    Itag(u32),\n    /// Specific height\n    Height(u32),\n    /// Height less than or equal to\n    HeightLessOrEqual(u32),\n    /// Height greater than or equal to\n    HeightGreaterOrEqual(u32),\n}\n\nimpl QualitySelector {\n    /// Parse quality selector from string\n    pub fn from_str(s: \u0026str) -\u003e Result\u003cSelf, String\u003e {\n        let s = s.trim().to_lowercase();\n        \n        match s.as_str() {\n            \"best\" =\u003e Ok(QualitySelector::Best),\n            \"worst\" =\u003e Ok(QualitySelector::Worst),\n            _ =\u003e {\n                if s.starts_with(\"itag=\") {\n                    let itag_str = \u0026s[5..];\n                    let itag = itag_str.parse::\u003cu32\u003e()\n                        .map_err(|_| format!(\"Invalid itag: {}\", itag_str))?;\n                    Ok(QualitySelector::Itag(itag))\n                } else if s.starts_with(\"height\u003c=\") {\n                    let height_str = \u0026s[8..];\n                    let height = height_str.parse::\u003cu32\u003e()\n                        .map_err(|_| format!(\"Invalid height: {}\", height_str))?;\n                    Ok(QualitySelector::HeightLessOrEqual(height))\n                } else if s.starts_with(\"height\u003e=\") {\n                    let height_str = \u0026s[8..];\n                    let height = height_str.parse::\u003cu32\u003e()\n                        .map_err(|_| format!(\"Invalid height: {}\", height_str))?;\n                    Ok(QualitySelector::HeightGreaterOrEqual(height))\n                } else if s.starts_with(\"height=\") {\n                    let height_str = \u0026s[7..];\n                    let height = height_str.parse::\u003cu32\u003e()\n                        .map_err(|_| format!(\"Invalid height: {}\", height_str))?;\n                    Ok(QualitySelector::Height(height))\n                } else {\n                    Err(format!(\"Unknown quality selector: {}\", s))\n                }\n            }\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_video_info_creation() {\n        let info = VideoInfo::new(\"test_id\".to_string(), \"Test Video\".to_string());\n        assert_eq!(info.id, \"test_id\");\n        assert_eq!(info.title, \"Test Video\");\n        assert!(info.formats.is_empty());\n    }\n\n    #[test]\n    fn test_format_creation() {\n        let format = Format::new(22, \"http://example.com\".to_string(), \"720p\".to_string(), \"video/mp4\".to_string());\n        assert_eq!(format.itag, 22);\n        assert_eq!(format.quality, \"720p\");\n        assert_eq!(format.mime_type, \"video/mp4\");\n    }\n\n    #[test]\n    fn test_format_progressive() {\n        let mut format = Format::new(22, \"http://example.com\".to_string(), \"720p\".to_string(), \"video/mp4\".to_string());\n        format.audio_codec = Some(\"aac\".to_string());\n        format.video_codec = Some(\"avc1\".to_string());\n        \n        assert!(format.is_progressive());\n        assert!(!format.is_adaptive());\n    }\n\n    #[test]\n    fn test_format_adaptive() {\n        let format = Format::new(137, \"http://example.com\".to_string(), \"1080p\".to_string(), \"video/mp4\".to_string());\n        assert!(!format.is_progressive());\n        assert!(format.is_adaptive());\n        assert!(format.is_video_only());\n    }\n\n    #[test]\n    fn test_quality_selector_parsing() {\n        assert_eq!(QualitySelector::from_str(\"best\").unwrap(), QualitySelector::Best);\n        assert_eq!(QualitySelector::from_str(\"worst\").unwrap(), QualitySelector::Worst);\n        assert_eq!(QualitySelector::from_str(\"itag=22\").unwrap(), QualitySelector::Itag(22));\n        assert_eq!(QualitySelector::from_str(\"height\u003c=720\").unwrap(), QualitySelector::HeightLessOrEqual(720));\n        assert_eq!(QualitySelector::from_str(\"height\u003e=480\").unwrap(), QualitySelector::HeightGreaterOrEqual(480));\n        assert_eq!(QualitySelector::from_str(\"height=1080\").unwrap(), QualitySelector::Height(1080));\n        \n        assert!(QualitySelector::from_str(\"invalid\").is_err());\n    }\n\n    #[test]\n    fn test_format_selector() {\n        let selector = FormatSelector::new(QualitySelector::Best)\n            .with_extension(\"mp4\")\n            .with_height_limit(720);\n        \n        assert!(matches!(selector.quality, QualitySelector::Best));\n        assert_eq!(selector.extension, Some(\"mp4\".to_string()));\n        assert_eq!(selector.height_limit, Some(720));\n    }\n}\n","traces":[{"line":36,"address":[],"length":0,"stats":{"Line":1}},{"line":40,"address":[],"length":0,"stats":{"Line":2}},{"line":42,"address":[],"length":0,"stats":{"Line":2}},{"line":43,"address":[],"length":0,"stats":{"Line":2}},{"line":48,"address":[],"length":0,"stats":{"Line":1}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":3}},{"line":151,"address":[],"length":0,"stats":{"Line":10}},{"line":152,"address":[],"length":0,"stats":{"Line":10}},{"line":153,"address":[],"length":0,"stats":{"Line":10}},{"line":154,"address":[],"length":0,"stats":{"Line":24}},{"line":158,"address":[],"length":0,"stats":{"Line":2}},{"line":159,"address":[],"length":0,"stats":{"Line":6}},{"line":160,"address":[],"length":0,"stats":{"Line":1}},{"line":164,"address":[],"length":0,"stats":{"Line":7}},{"line":165,"address":[],"length":0,"stats":{"Line":21}},{"line":169,"address":[],"length":0,"stats":{"Line":3}},{"line":170,"address":[],"length":0,"stats":{"Line":3}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":6}},{"line":288,"address":[],"length":0,"stats":{"Line":2}},{"line":289,"address":[],"length":0,"stats":{"Line":4}},{"line":290,"address":[],"length":0,"stats":{"Line":2}},{"line":294,"address":[],"length":0,"stats":{"Line":2}},{"line":295,"address":[],"length":0,"stats":{"Line":2}},{"line":296,"address":[],"length":0,"stats":{"Line":2}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":8}},{"line":332,"address":[],"length":0,"stats":{"Line":24}},{"line":334,"address":[],"length":0,"stats":{"Line":8}},{"line":335,"address":[],"length":0,"stats":{"Line":10}},{"line":336,"address":[],"length":0,"stats":{"Line":7}},{"line":338,"address":[],"length":0,"stats":{"Line":5}},{"line":339,"address":[],"length":0,"stats":{"Line":2}},{"line":340,"address":[],"length":0,"stats":{"Line":3}},{"line":341,"address":[],"length":0,"stats":{"Line":1}},{"line":343,"address":[],"length":0,"stats":{"Line":4}},{"line":344,"address":[],"length":0,"stats":{"Line":2}},{"line":345,"address":[],"length":0,"stats":{"Line":3}},{"line":346,"address":[],"length":0,"stats":{"Line":1}},{"line":348,"address":[],"length":0,"stats":{"Line":3}},{"line":349,"address":[],"length":0,"stats":{"Line":2}},{"line":350,"address":[],"length":0,"stats":{"Line":3}},{"line":351,"address":[],"length":0,"stats":{"Line":1}},{"line":353,"address":[],"length":0,"stats":{"Line":2}},{"line":354,"address":[],"length":0,"stats":{"Line":2}},{"line":355,"address":[],"length":0,"stats":{"Line":3}},{"line":356,"address":[],"length":0,"stats":{"Line":1}},{"line":359,"address":[],"length":0,"stats":{"Line":1}}],"covered":46,"coverable":93},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","download","downloader.rs"],"content":"//! Chunked downloader implementation\n\nuse crate::core::progress::Progress;\nuse crate::error::RytError;\nuse crate::platform::client::VideoClient;\nuse std::path::Path;\nuse std::sync::Arc;\nuse std::time::Duration;\nuse tokio::fs::File;\nuse tokio::io::AsyncWriteExt;\nuse tokio::sync::Mutex;\n\n/// Chunked downloader configuration\n#[derive(Clone)]\npub struct DownloaderConfig {\n    /// Chunk size in bytes\n    pub chunk_size: u64,\n    /// Maximum retries per chunk\n    pub max_retries: u32,\n    /// Rate limit in bytes per second\n    pub rate_limit_bps: Option\u003cu64\u003e,\n    /// Progress callback\n    pub progress_callback: Option\u003cArc\u003cdyn Fn(Progress) + Send + Sync\u003e\u003e,\n}\n\nimpl Default for DownloaderConfig {\n    fn default() -\u003e Self {\n        Self {\n            chunk_size: 1024 * 1024, // 1MB\n            max_retries: 3,\n            rate_limit_bps: None,\n            progress_callback: None,\n        }\n    }\n}\n\n/// Chunked downloader\npub struct ChunkedDownloader {\n    video_client: Arc\u003cMutex\u003cVideoClient\u003e\u003e,\n    config: DownloaderConfig,\n    rate_limiter: Option\u003cArc\u003cMutex\u003cRateLimiter\u003e\u003e\u003e,\n}\n\n/// Rate limiter for controlling download speed\nstruct RateLimiter {\n    bytes_per_second: u64,\n    last_update: std::time::Instant,\n    bytes_sent: u64,\n}\n\nimpl RateLimiter {\n    fn new(bytes_per_second: u64) -\u003e Self {\n        Self {\n            bytes_per_second,\n            last_update: std::time::Instant::now(),\n            bytes_sent: 0,\n        }\n    }\n\n    async fn wait_if_needed(\u0026mut self, bytes: u64) {\n        let now = std::time::Instant::now();\n        let elapsed = now.duration_since(self.last_update);\n        \n        // Calculate how many bytes we should have sent by now\n        let expected_bytes = (elapsed.as_secs_f64() * self.bytes_per_second as f64) as u64;\n        \n        if self.bytes_sent + bytes \u003e expected_bytes {\n            // We're going too fast, need to wait\n            let excess_bytes = (self.bytes_sent + bytes) - expected_bytes;\n            let wait_time = Duration::from_secs_f64(excess_bytes as f64 / self.bytes_per_second as f64);\n            \n            if wait_time \u003e Duration::from_millis(1) {\n                tokio::time::sleep(wait_time).await;\n            }\n        }\n        \n        self.bytes_sent += bytes;\n        self.last_update = now;\n    }\n}\n\nimpl ChunkedDownloader {\n    /// Create a new chunked downloader\n    pub fn new() -\u003e Self {\n        Self::with_config(DownloaderConfig::default())\n    }\n\n    /// Create a new chunked downloader with configuration\n    pub fn with_config(config: DownloaderConfig) -\u003e Self {\n        // Create HTTP/1.1-only client for media downloads (matches Go ytdlp line 182)\n        let mut http_config = crate::platform::client::HttpClientConfig::default();\n        http_config.http1_only = true;  // Force HTTP/1.1 for media downloads\n        http_config.client_type = crate::platform::client::ClientType::Chrome;\n        let video_client = Arc::new(Mutex::new(VideoClient::with_config(http_config)));\n\n        let rate_limiter = config.rate_limit_bps.map(|bps| {\n            Arc::new(Mutex::new(RateLimiter::new(bps)))\n        });\n\n        Self {\n            video_client,\n            config,\n            rate_limiter,\n        }\n    }\n\n    /// Download a file from URL to local path.\n    /// Strategy: streaming without Range to avoid 403 on YouTube CDN.\n    pub async fn download(\u0026self, url: \u0026str, output_path: \u0026Path) -\u003e Result\u003c(), RytError\u003e {\n        use tracing::{info, warn};\n        \n        info!(\"Starting download from URL: {}\", url);\n        // Always use streaming without Range\n        let tmp_path = output_path.with_extension(\"tmp\");\n        let mut file = File::create(\u0026tmp_path).await?;\n        \n        match self.download_without_chunking(url, \u0026mut file).await {\n            Ok(()) =\u003e {\n                file.flush().await?;\n                drop(file);\n                tokio::fs::rename(\u0026tmp_path, output_path).await?;\n                info!(\"Download completed successfully\");\n                Ok(())\n            }\n            Err(e) =\u003e {\n                warn!(\"Streaming download failed: {}, cleaning up temp file\", e);\n                let _ = tokio::fs::remove_file(\u0026tmp_path).await;\n                Err(e)\n            }\n        }\n    }\n\n    /// Download with resume support\n    pub async fn download_with_resume(\u0026self, url: \u0026str, output_path: \u0026Path) -\u003e Result\u003c(), RytError\u003e {\n        use tracing::warn;\n        // Check if file exists and get its size\n        let tmp_path = output_path.with_extension(\"tmp\");\n        let existing_size = if tmp_path.exists() {\n            tokio::fs::metadata(\u0026tmp_path).await?.len()\n        } else {\n            0\n        };\n        \n        // Try to get total content length, but if all attempts fail (403), proceed with chunked anyway\n        let total_size = match self.get_content_length(url).await {\n            Ok(size) =\u003e size,\n            Err(_e) =\u003e {\n                warn!(\"Could not determine content length (all clients failed), proceeding with chunked download\");\n                0\n            }\n        };\n        \n        if total_size \u003e 0 \u0026\u0026 existing_size \u003e= total_size {\n            // File is already complete\n            return Ok(());\n        }\n        \n        // Open temp file for appending\n        let mut file = tokio::fs::OpenOptions::new()\n            .create(true)\n            .append(true)\n            .open(\u0026tmp_path)\n            .await?;\n        \n        // Download remaining chunks\n        let mut downloaded = existing_size;\n        let mut progress = Progress::new(total_size);\n        progress.update(downloaded);\n        \n        while downloaded \u003c total_size || total_size == 0 {\n            let start = downloaded;\n            let end = if total_size \u003e 0 {\n                (start + self.config.chunk_size - 1).min(total_size - 1)\n            } else {\n                // Unknown size: request bounded chunk\n                start + self.config.chunk_size - 1\n            };\n            \n            // Download chunk with retry\n            let chunk_data = self.download_chunk_with_retry(url, start, end).await?;\n            \n            // Write chunk to file\n            file.write_all(\u0026chunk_data).await?;\n            \n            // Update progress\n            downloaded += chunk_data.len() as u64;\n            progress.update(downloaded);\n            \n            // Report progress\n            if let Some(callback) = \u0026self.config.progress_callback {\n                callback(progress.clone());\n            }\n            \n            // Rate limiting\n            if let Some(rate_limiter) = \u0026self.rate_limiter {\n                let mut limiter = rate_limiter.lock().await;\n                limiter.wait_if_needed(chunk_data.len() as u64).await;\n            }\n            \n            // If unknown size and we got less than chunk_size, we're probably done\n            if total_size == 0 \u0026\u0026 (chunk_data.len() as u64) \u003c self.config.chunk_size {\n                break;\n            }\n        }\n        \n        // Flush and sync file\n        file.flush().await?;\n        file.sync_all().await?;\n\n        // Finalize: rename temp -\u003e final only if we actually wrote data\n        drop(file);\n        if (total_size == 0 \u0026\u0026 downloaded \u003e 0) || (total_size \u003e 0 \u0026\u0026 downloaded \u003e= total_size) {\n            tokio::fs::rename(\u0026tmp_path, output_path).await?;\n            return Ok(());\n        }\n\n        // Nothing downloaded — clean up and return error\n        let _ = tokio::fs::remove_file(\u0026tmp_path).await;\n        Err(RytError::Generic(\"Empty download (0 bytes)\".to_string()))\n    }\n\n    /// Get content length of the file\n    async fn get_content_length(\u0026self, url: \u0026str) -\u003e Result\u003cu64, RytError\u003e {\n        use tracing::warn;\n        use crate::platform::client::ClientType;\n        \n        // Try all available client types\n        let available_clients = ClientType::all();\n        \n        for (attempt, client_type) in available_clients.iter().enumerate() {\n            // Switch to specific client type\n            {\n                let mut video_client = self.video_client.lock().await;\n                video_client.switch_to_client(*client_type);\n            }\n            \n            let video_client = self.video_client.lock().await;\n            \n            // Try GET request with Range header (YouTube doesn't support HEAD well)\n            // Use simple media request to avoid 403 errors\n            let response = video_client.create_simple_media_request(\n                reqwest::Method::GET, \n                url\n            )\n            .header(\"Range\", \"bytes=0-1\")\n            .send()\n            .await;\n            \n            match response {\n                Ok(resp) =\u003e {\n                    if resp.status().is_success() || resp.status() == 206 {\n                        return self.parse_content_length_from_response(resp).await;\n                    } else {\n                        warn!(\"Failed to get content length with client {:?} (status: {}), trying next client...\", \n                              client_type, resp.status());\n                    }\n                }\n                Err(_e) =\u003e {\n                    warn!(\"Request failed with client {:?}, trying next client...\", client_type);\n                }\n            }\n            \n            // Exponential backoff\n            if attempt \u003c available_clients.len() - 1 {\n                let delay = Duration::from_millis(100 * (1 \u003c\u003c (attempt % 3)));\n                tokio::time::sleep(delay).await;\n            }\n        }\n        \n        // If all clients failed, return error to signal caller to proceed with unknown size\n        Err(RytError::Generic(\"Could not determine content length\".to_string()))\n    }\n    \n    /// Parse content length from HTTP response\n    async fn parse_content_length_from_response(\u0026self, response: reqwest::Response) -\u003e Result\u003cu64, RytError\u003e {\n        if let Some(content_range) = response.headers().get(\"content-range\") {\n            if let Ok(range_str) = content_range.to_str() {\n                // Parse \"bytes 0-1/total\" format\n                if let Some(slash_pos) = range_str.find('/') {\n                    let total_str = \u0026range_str[slash_pos + 1..];\n                    if let Ok(total) = total_str.parse::\u003cu64\u003e() {\n                        return Ok(total);\n                    }\n                }\n            }\n        }\n        \n        // Last resort: use content-length from response\n        if let Some(content_length) = response.headers().get(\"content-length\") {\n            if let Ok(length) = content_length.to_str() {\n                if let Ok(length) = length.parse::\u003cu64\u003e() {\n                    return Ok(length);\n                }\n            }\n        }\n        \n        // Unknown size\n        Ok(0)\n    }\n\n    /// Download a single chunk with retry logic\n    async fn download_chunk_with_retry(\u0026self, url: \u0026str, start: u64, end: u64) -\u003e Result\u003cVec\u003cu8\u003e, RytError\u003e {\n        use tracing::warn;\n        let mut last_error = None;\n        \n        for attempt in 0..self.config.max_retries {\n            match self.download_chunk(url, start, end).await {\n                Ok(data) =\u003e return Ok(data),\n                Err(e) =\u003e {\n                    warn!(\"Chunk download attempt {} failed for bytes {}-{}: {}\", attempt + 1, start, end, e);\n                    last_error = Some(e);\n                    \n                    // Exponential backoff\n                    if attempt \u003c self.config.max_retries - 1 {\n                        let delay = Duration::from_millis(200 * (1 \u003c\u003c attempt));\n                        tokio::time::sleep(delay).await;\n                    }\n                }\n            }\n        }\n        \n        Err(last_error.unwrap_or(RytError::Generic(\"Chunk download failed\".to_string())))\n    }\n\n    /// Download a single chunk\n    async fn download_chunk(\u0026self, url: \u0026str, start: u64, end: u64) -\u003e Result\u003cVec\u003cu8\u003e, RytError\u003e {\n        use tracing::{debug, warn};\n        let range_header = format!(\"bytes={}-{}\", start, end);\n        \n        debug!(\"Acquiring video_client lock for chunk download\");\n        let video_client = self.video_client.lock().await;\n        debug!(\"Lock acquired, creating request for bytes {}-{}\", start, end);\n        \n        // Use simple media request to avoid 403 errors from YouTube\n        let response = video_client.create_simple_media_request(\n            reqwest::Method::GET, \n            url\n        )\n        .header(\"Range\", range_header)\n        .send()\n        .await?;\n        \n        // Release lock immediately after sending request\n        drop(video_client);\n        debug!(\"Lock released after sending request\");\n        \n        let status = response.status();\n        debug!(\"Response received with status: {} for bytes {}-{}\", status, start, end);\n        \n        if !status.is_success() \u0026\u0026 status != 206 {\n            if status.as_u16() == 403 {\n                warn!(\"403 Forbidden for range request {}-{}\", start, end);\n                return Err(RytError::RateLimited);\n            }\n            warn!(\"Unexpected status code {} for range request {}-{}\", status, start, end);\n            return Err(RytError::DownloadFailed(\n                reqwest::Error::from(response.error_for_status().unwrap_err())\n            ));\n        }\n        \n        let data = response.bytes().await?;\n        debug!(\"Downloaded {} bytes for range {}-{}\", data.len(), start, end);\n        Ok(data.to_vec())\n    }\n\n    /// Set progress callback\n    pub fn with_progress_callback\u003cF\u003e(mut self, callback: F) -\u003e Self\n    where\n        F: Fn(Progress) + Send + Sync + 'static,\n    {\n        self.config.progress_callback = Some(Arc::new(callback));\n        self\n    }\n\n    /// Set rate limit\n    pub fn with_rate_limit(mut self, bytes_per_second: u64) -\u003e Self {\n        self.config.rate_limit_bps = Some(bytes_per_second);\n        self.rate_limiter = Some(Arc::new(Mutex::new(RateLimiter::new(bytes_per_second))));\n        self\n    }\n\n    /// Set chunk size\n    pub fn with_chunk_size(mut self, chunk_size: u64) -\u003e Self {\n        self.config.chunk_size = chunk_size;\n        self\n    }\n\n    /// Set max retries\n    pub fn with_max_retries(mut self, max_retries: u32) -\u003e Self {\n        self.config.max_retries = max_retries;\n        self\n    }\n\n    /// Download without chunking when content length is unknown\n    async fn download_without_chunking(\u0026self, url: \u0026str, file: \u0026mut File) -\u003e Result\u003c(), RytError\u003e {\n        use tracing::{info, warn, debug};\n        use crate::platform::client::ClientType;\n        \n        info!(\"Downloading without chunking from: {}\", url);\n        \n        // Try with current client first\n        // Use simple media request for googlevideo.com to avoid 403 errors from browser-specific headers\n        let video_client = self.video_client.lock().await;\n        let response = video_client\n            .create_simple_media_request(\n                reqwest::Method::GET,\n                url,\n            )\n            .send()\n            .await;\n        \n        match response {\n            Ok(resp) =\u003e {\n                let status = resp.status();\n                if status.is_success() {\n                    // Success! Continue with this response\n                    drop(video_client); // Release lock\n                    debug!(\"Download successful with current client, processing response...\");\n                    return self.process_successful_response(resp, file).await;\n                } else if status.as_u16() == 403 {\n                    drop(video_client);\n                    warn!(\"403 Forbidden on streaming GET, falling back to chunked\");\n                    return Err(RytError::RateLimited);\n                } else {\n                    warn!(\"Failed with current client (status: {}), trying other clients...\", status);\n                }\n            }\n            Err(e) =\u003e {\n                warn!(\"Request failed with current client: {}, trying other clients...\", e);\n            }\n        }\n        \n        // If current client failed, try other clients\n        let available_clients = ClientType::all();\n        let mut last_error = None;\n        \n        for (attempt, client_type) in available_clients.iter().enumerate() {\n            // Skip if we already tried this client (it's the current one)\n            {\n                let current_client = self.video_client.lock().await;\n                if current_client.current_client_type() == *client_type {\n                    continue;\n                }\n            }\n            \n            // Switch to specific client type\n            {\n                let mut video_client = self.video_client.lock().await;\n                video_client.switch_to_client(*client_type);\n            }\n            \n            let video_client = self.video_client.lock().await;\n            let response = video_client.create_simple_media_request(\n                reqwest::Method::GET, \n                url\n            )\n            .send()\n            .await;\n            \n            match response {\n                Ok(resp) =\u003e {\n                    let status = resp.status();\n                    if status.is_success() {\n                        // Success! Continue with this response\n                        drop(video_client); // Release lock\n                        debug!(\"Download successful with client {:?}, processing response...\", client_type);\n                        return self.process_successful_response(resp, file).await;\n                } else {\n                    // If 403, stop header-only switching and propagate upwards to allow URL regeneration\n                    if status.as_u16() == 403 {\n                        drop(video_client);\n                        warn!(\"403 Forbidden on media GET, requiring URL regeneration\");\n                        return Err(RytError::RateLimited);\n                    }\n                    last_error = Some(RytError::DownloadFailed(\n                        reqwest::Error::from(resp.error_for_status().unwrap_err())\n                    ));\n                    warn!(\"Failed with client {:?} (status: {}), trying next client...\",\n                          client_type, status);\n                }\n                }\n                Err(e) =\u003e {\n                    last_error = Some(RytError::DownloadFailed(e));\n                    warn!(\"Request failed with client {:?}, trying next client...\", client_type);\n                }\n            }\n            \n            // Exponential backoff\n            if attempt \u003c available_clients.len() - 1 {\n                let delay = Duration::from_millis(200 * (1 \u003c\u003c (attempt % 3)));\n                tokio::time::sleep(delay).await;\n            }\n        }\n        \n        Err(last_error.unwrap_or(RytError::Generic(\"Download failed with all clients\".to_string())))\n    }\n    \n    /// Process successful HTTP response for download\n    async fn process_successful_response(\u0026self, response: reqwest::Response, file: \u0026mut File) -\u003e Result\u003c(), RytError\u003e {\n        use tracing::{debug, info};\n        use futures_util::StreamExt;\n        \n        let mut stream = response.bytes_stream();\n        let mut downloaded = 0u64;\n        \n        while let Some(chunk_result) = stream.next().await {\n            let chunk = chunk_result?;\n            let chunk_size = chunk.len();\n            \n            file.write_all(\u0026chunk).await?;\n            downloaded += chunk_size as u64;\n            \n            debug!(\"Downloaded {} bytes, total: {}\", chunk_size, downloaded);\n            \n            // Report progress if callback is available\n            if let Some(callback) = \u0026self.config.progress_callback {\n                let mut progress = Progress::new(0); // Unknown total size\n                progress.update(downloaded);\n                callback(progress);\n            }\n            \n            // Rate limiting\n            if let Some(rate_limiter) = \u0026self.rate_limiter {\n                let mut limiter = rate_limiter.lock().await;\n                limiter.wait_if_needed(chunk_size as u64).await;\n            }\n        }\n        \n        file.flush().await?;\n        file.sync_all().await?;\n        \n        info!(\"Download completed: {} bytes\", downloaded);\n        Ok(())\n    }\n}\n\nimpl Default for ChunkedDownloader {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_downloader_config_default() {\n        let config = DownloaderConfig::default();\n        assert_eq!(config.chunk_size, 1024 * 1024);\n        assert_eq!(config.max_retries, 3);\n        assert!(config.rate_limit_bps.is_none());\n        assert!(config.progress_callback.is_none());\n    }\n\n    #[test]\n    fn test_chunked_downloader_creation() {\n        let downloader = ChunkedDownloader::new();\n        assert_eq!(downloader.config.chunk_size, 1024 * 1024);\n        assert_eq!(downloader.config.max_retries, 3);\n    }\n\n    #[test]\n    fn test_chunked_downloader_with_config() {\n        let config = DownloaderConfig {\n            chunk_size: 512 * 1024,\n            max_retries: 5,\n            rate_limit_bps: Some(1024 * 1024),\n            progress_callback: None,\n        };\n        \n        let downloader = ChunkedDownloader::with_config(config);\n        assert_eq!(downloader.config.chunk_size, 512 * 1024);\n        assert_eq!(downloader.config.max_retries, 5);\n        assert!(downloader.rate_limiter.is_some());\n    }\n\n    #[test]\n    fn test_rate_limiter_creation() {\n        let limiter = RateLimiter::new(1024 * 1024); // 1MB/s\n        assert_eq!(limiter.bytes_per_second, 1024 * 1024);\n        assert_eq!(limiter.bytes_sent, 0);\n    }\n\n    #[tokio::test]\n    async fn test_rate_limiter_wait() {\n        let mut limiter = RateLimiter::new(1000); // 1KB/s\n        let start = std::time::Instant::now();\n        \n        // Wait for 1KB\n        limiter.wait_if_needed(1000).await;\n        \n        let elapsed = start.elapsed();\n        // Should have waited approximately 1 second\n        assert!(elapsed \u003e= Duration::from_millis(900));\n        assert!(elapsed \u003c= Duration::from_millis(1100));\n    }\n}\n","traces":[{"line":27,"address":[],"length":0,"stats":{"Line":5}},{"line":29,"address":[],"length":0,"stats":{"Line":10}},{"line":52,"address":[],"length":0,"stats":{"Line":3}},{"line":55,"address":[],"length":0,"stats":{"Line":3}},{"line":60,"address":[],"length":0,"stats":{"Line":2}},{"line":61,"address":[],"length":0,"stats":{"Line":2}},{"line":62,"address":[],"length":0,"stats":{"Line":4}},{"line":65,"address":[],"length":0,"stats":{"Line":3}},{"line":67,"address":[],"length":0,"stats":{"Line":1}},{"line":69,"address":[],"length":0,"stats":{"Line":2}},{"line":70,"address":[],"length":0,"stats":{"Line":3}},{"line":72,"address":[],"length":0,"stats":{"Line":1}},{"line":73,"address":[],"length":0,"stats":{"Line":2}},{"line":77,"address":[],"length":0,"stats":{"Line":1}},{"line":84,"address":[],"length":0,"stats":{"Line":4}},{"line":85,"address":[],"length":0,"stats":{"Line":8}},{"line":89,"address":[],"length":0,"stats":{"Line":5}},{"line":91,"address":[],"length":0,"stats":{"Line":10}},{"line":92,"address":[],"length":0,"stats":{"Line":5}},{"line":93,"address":[],"length":0,"stats":{"Line":5}},{"line":94,"address":[],"length":0,"stats":{"Line":25}},{"line":96,"address":[],"length":0,"stats":{"Line":16}},{"line":97,"address":[],"length":0,"stats":{"Line":4}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":507,"address":[],"length":0,"stats":{"Line":0}},{"line":508,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}}],"covered":23,"coverable":239},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","download","mod.rs"],"content":"//! Download system for ryt\n\npub mod downloader;\npub mod progress;\npub mod retry;\n\npub use downloader::*;\npub use progress::*;\npub use retry::*;\n\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","download","progress.rs"],"content":"//! Progress tracking for downloads\n\n// Re-export from core::progress\npub use crate::core::progress::*;\n\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","download","retry.rs"],"content":"//! Retry logic for downloads\n\nuse crate::error::RytError;\nuse std::time::Duration;\n\n/// Retry configuration\n#[derive(Debug, Clone)]\npub struct RetryConfig {\n    /// Maximum number of retries\n    pub max_retries: u32,\n    /// Initial delay between retries\n    pub initial_delay: Duration,\n    /// Maximum delay between retries\n    pub max_delay: Duration,\n    /// Backoff multiplier\n    pub backoff_multiplier: f64,\n    /// Jitter factor (0.0 to 1.0)\n    pub jitter_factor: f64,\n}\n\nimpl Default for RetryConfig {\n    fn default() -\u003e Self {\n        Self {\n            max_retries: 3,\n            initial_delay: Duration::from_millis(200),\n            max_delay: Duration::from_secs(30),\n            backoff_multiplier: 2.0,\n            jitter_factor: 0.1,\n        }\n    }\n}\n\n/// Retry executor\npub struct RetryExecutor {\n    config: RetryConfig,\n}\n\nimpl RetryExecutor {\n    /// Create a new retry executor\n    pub fn new() -\u003e Self {\n        Self::with_config(RetryConfig::default())\n    }\n\n    /// Create a new retry executor with configuration\n    pub fn with_config(config: RetryConfig) -\u003e Self {\n        Self { config }\n    }\n\n    /// Execute a function with retry logic\n    pub async fn execute\u003cF, T\u003e(\u0026self, mut func: F) -\u003e Result\u003cT, RytError\u003e\n    where\n        F: FnMut() -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003cT, RytError\u003e\u003e + Send\u003e\u003e,\n    {\n        let mut last_error = None;\n        let mut delay = self.config.initial_delay;\n\n        for attempt in 0..=self.config.max_retries {\n            match func().await {\n                Ok(result) =\u003e return Ok(result),\n                Err(error) =\u003e {\n                    last_error = Some(error);\n\n                    // Check if error is retryable\n                    if !last_error.as_ref().unwrap().is_retryable() {\n                        break;\n                    }\n\n                    // Don't wait after the last attempt\n                    if attempt \u003c self.config.max_retries {\n                        // Add jitter to prevent thundering herd\n                        let jitter = if self.config.jitter_factor \u003e 0.0 {\n                            let jitter_range = delay.as_millis() as f64 * self.config.jitter_factor;\n                            let jitter = (rand::random::\u003cf64\u003e() - 0.5) * 2.0 * jitter_range;\n                            Duration::from_millis(jitter.abs() as u64)\n                        } else {\n                            Duration::from_millis(0)\n                        };\n\n                        let total_delay = delay + jitter;\n                        tokio::time::sleep(total_delay).await;\n\n                        // Calculate next delay with exponential backoff\n                        delay = Duration::from_millis(\n                            (delay.as_millis() as f64 * self.config.backoff_multiplier) as u64\n                        );\n\n                        // Cap at maximum delay\n                        if delay \u003e self.config.max_delay {\n                            delay = self.config.max_delay;\n                        }\n                    }\n                }\n            }\n        }\n\n        Err(last_error.unwrap_or(RytError::Generic(\"All retry attempts failed\".to_string())))\n    }\n\n    /// Execute a function with retry logic and custom error handling\n    pub async fn execute_with_error_handler\u003cF, T, E\u003e(\n        \u0026self,\n        mut func: F,\n        error_handler: E,\n    ) -\u003e Result\u003cT, RytError\u003e\n    where\n        F: FnMut() -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003cT, RytError\u003e\u003e + Send\u003e\u003e,\n        E: Fn(\u0026RytError) -\u003e bool, // Returns true if error is retryable\n    {\n        let mut last_error = None;\n        let mut delay = self.config.initial_delay;\n\n        for attempt in 0..=self.config.max_retries {\n            match func().await {\n                Ok(result) =\u003e return Ok(result),\n                Err(error) =\u003e {\n                    last_error = Some(error);\n\n                    // Check if error is retryable using custom handler\n                    if !error_handler(last_error.as_ref().unwrap()) {\n                        break;\n                    }\n\n                    // Don't wait after the last attempt\n                    if attempt \u003c self.config.max_retries {\n                        // Add jitter to prevent thundering herd\n                        let jitter = if self.config.jitter_factor \u003e 0.0 {\n                            let jitter_range = delay.as_millis() as f64 * self.config.jitter_factor;\n                            let jitter = (rand::random::\u003cf64\u003e() - 0.5) * 2.0 * jitter_range;\n                            Duration::from_millis(jitter.abs() as u64)\n                        } else {\n                            Duration::from_millis(0)\n                        };\n\n                        let total_delay = delay + jitter;\n                        tokio::time::sleep(total_delay).await;\n\n                        // Calculate next delay with exponential backoff\n                        delay = Duration::from_millis(\n                            (delay.as_millis() as f64 * self.config.backoff_multiplier) as u64\n                        );\n\n                        // Cap at maximum delay\n                        if delay \u003e self.config.max_delay {\n                            delay = self.config.max_delay;\n                        }\n                    }\n                }\n            }\n        }\n\n        Err(last_error.unwrap_or(RytError::Generic(\"All retry attempts failed\".to_string())))\n    }\n}\n\nimpl Default for RetryExecutor {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n/// Retry configuration builder\npub struct RetryConfigBuilder {\n    config: RetryConfig,\n}\n\nimpl RetryConfigBuilder {\n    /// Create a new retry configuration builder\n    pub fn new() -\u003e Self {\n        Self {\n            config: RetryConfig::default(),\n        }\n    }\n\n    /// Set maximum retries\n    pub fn max_retries(mut self, max_retries: u32) -\u003e Self {\n        self.config.max_retries = max_retries;\n        self\n    }\n\n    /// Set initial delay\n    pub fn initial_delay(mut self, initial_delay: Duration) -\u003e Self {\n        self.config.initial_delay = initial_delay;\n        self\n    }\n\n    /// Set maximum delay\n    pub fn max_delay(mut self, max_delay: Duration) -\u003e Self {\n        self.config.max_delay = max_delay;\n        self\n    }\n\n    /// Set backoff multiplier\n    pub fn backoff_multiplier(mut self, backoff_multiplier: f64) -\u003e Self {\n        self.config.backoff_multiplier = backoff_multiplier;\n        self\n    }\n\n    /// Set jitter factor\n    pub fn jitter_factor(mut self, jitter_factor: f64) -\u003e Self {\n        self.config.jitter_factor = jitter_factor.clamp(0.0, 1.0);\n        self\n    }\n\n    /// Build the retry configuration\n    pub fn build(self) -\u003e RetryConfig {\n        self.config\n    }\n}\n\nimpl Default for RetryConfigBuilder {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::sync::{Arc, atomic::{AtomicU32, Ordering}};\n\n    #[test]\n    fn test_retry_config_default() {\n        let config = RetryConfig::default();\n        assert_eq!(config.max_retries, 3);\n        assert_eq!(config.initial_delay, Duration::from_millis(200));\n        assert_eq!(config.max_delay, Duration::from_secs(30));\n        assert_eq!(config.backoff_multiplier, 2.0);\n        assert_eq!(config.jitter_factor, 0.1);\n    }\n\n    #[test]\n    fn test_retry_config_builder() {\n        let config = RetryConfigBuilder::new()\n            .max_retries(5)\n            .initial_delay(Duration::from_millis(100))\n            .max_delay(Duration::from_secs(60))\n            .backoff_multiplier(1.5)\n            .jitter_factor(0.2)\n            .build();\n\n        assert_eq!(config.max_retries, 5);\n        assert_eq!(config.initial_delay, Duration::from_millis(100));\n        assert_eq!(config.max_delay, Duration::from_secs(60));\n        assert_eq!(config.backoff_multiplier, 1.5);\n        assert_eq!(config.jitter_factor, 0.2);\n    }\n\n    #[tokio::test]\n    async fn test_retry_executor_success() {\n        let executor = RetryExecutor::new();\n        let counter = Arc::new(AtomicU32::new(0));\n\n        let result: Result\u003cString, RytError\u003e = executor.execute({\n            let counter = counter.clone();\n            move || {\n                let counter = counter.clone();\n                Box::pin(async move {\n                    let count = counter.fetch_add(1, Ordering::SeqCst);\n                    if count == 0 {\n                        Err(RytError::TimeoutError(\"test error\".to_string()))\n                    } else {\n                        Ok(\"Success\".to_string())\n                    }\n                })\n            }\n        }).await;\n\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), \"Success\");\n        assert_eq!(counter.load(Ordering::SeqCst), 2);\n    }\n\n    #[tokio::test]\n    async fn test_retry_executor_max_retries() {\n        let executor = RetryExecutor::new();\n        let counter = Arc::new(AtomicU32::new(0));\n\n        let result: Result\u003cString, RytError\u003e = executor.execute({\n            let counter = counter.clone();\n            move || {\n                let counter = counter.clone();\n                Box::pin(async move {\n                    counter.fetch_add(1, Ordering::SeqCst);\n                    Err(RytError::TimeoutError(\"test error\".to_string()))\n                })\n            }\n        }).await;\n\n        assert!(result.is_err());\n        assert_eq!(counter.load(Ordering::SeqCst), 4); // 1 initial + 3 retries\n    }\n\n    #[tokio::test]\n    async fn test_retry_executor_non_retryable_error() {\n        let executor = RetryExecutor::new();\n        let counter = Arc::new(AtomicU32::new(0));\n\n        let result: Result\u003cString, RytError\u003e = executor.execute({\n            let counter = counter.clone();\n            move || {\n                let counter = counter.clone();\n                Box::pin(async move {\n                    counter.fetch_add(1, Ordering::SeqCst);\n                    Err(RytError::VideoUnavailable) // Non-retryable error\n                })\n            }\n        }).await;\n\n        assert!(result.is_err());\n        assert_eq!(counter.load(Ordering::SeqCst), 1); // Only one attempt\n    }\n\n    #[tokio::test]\n    async fn test_retry_executor_with_custom_error_handler() {\n        let executor = RetryExecutor::new();\n        let counter = Arc::new(AtomicU32::new(0));\n\n        let result: Result\u003cString, RytError\u003e = executor.execute_with_error_handler(\n            {\n                let counter = counter.clone();\n                move || {\n                    let counter = counter.clone();\n                    Box::pin(async move {\n                        counter.fetch_add(1, Ordering::SeqCst);\n                        Err(RytError::TimeoutError(\"test error\".to_string()))\n                    })\n                }\n            },\n            |error| {\n                // Only retry on HTTP errors\n                matches!(error, RytError::TimeoutError(_))\n            },\n        ).await;\n\n        assert!(result.is_err());\n        assert_eq!(counter.load(Ordering::SeqCst), 4); // 1 initial + 3 retries\n    }\n}\n","traces":[{"line":22,"address":[],"length":0,"stats":{"Line":6}},{"line":25,"address":[],"length":0,"stats":{"Line":6}},{"line":26,"address":[],"length":0,"stats":{"Line":6}},{"line":40,"address":[],"length":0,"stats":{"Line":4}},{"line":41,"address":[],"length":0,"stats":{"Line":8}},{"line":45,"address":[],"length":0,"stats":{"Line":4}},{"line":50,"address":[],"length":0,"stats":{"Line":3}},{"line":54,"address":[],"length":0,"stats":{"Line":6}},{"line":55,"address":[],"length":0,"stats":{"Line":6}},{"line":57,"address":[],"length":0,"stats":{"Line":10}},{"line":58,"address":[],"length":0,"stats":{"Line":14}},{"line":59,"address":[],"length":0,"stats":{"Line":1}},{"line":60,"address":[],"length":0,"stats":{"Line":6}},{"line":61,"address":[],"length":0,"stats":{"Line":12}},{"line":64,"address":[],"length":0,"stats":{"Line":12}},{"line":65,"address":[],"length":0,"stats":{"Line":1}},{"line":69,"address":[],"length":0,"stats":{"Line":5}},{"line":71,"address":[],"length":0,"stats":{"Line":8}},{"line":72,"address":[],"length":0,"stats":{"Line":8}},{"line":73,"address":[],"length":0,"stats":{"Line":8}},{"line":74,"address":[],"length":0,"stats":{"Line":8}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":8}},{"line":80,"address":[],"length":0,"stats":{"Line":8}},{"line":83,"address":[],"length":0,"stats":{"Line":4}},{"line":84,"address":[],"length":0,"stats":{"Line":4}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":2}},{"line":100,"address":[],"length":0,"stats":{"Line":1}},{"line":109,"address":[],"length":0,"stats":{"Line":2}},{"line":110,"address":[],"length":0,"stats":{"Line":2}},{"line":112,"address":[],"length":0,"stats":{"Line":5}},{"line":113,"address":[],"length":0,"stats":{"Line":8}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":4}},{"line":116,"address":[],"length":0,"stats":{"Line":8}},{"line":119,"address":[],"length":0,"stats":{"Line":12}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":4}},{"line":126,"address":[],"length":0,"stats":{"Line":6}},{"line":127,"address":[],"length":0,"stats":{"Line":6}},{"line":128,"address":[],"length":0,"stats":{"Line":6}},{"line":129,"address":[],"length":0,"stats":{"Line":6}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":6}},{"line":135,"address":[],"length":0,"stats":{"Line":6}},{"line":138,"address":[],"length":0,"stats":{"Line":3}},{"line":139,"address":[],"length":0,"stats":{"Line":3}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":1}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":1}},{"line":170,"address":[],"length":0,"stats":{"Line":1}},{"line":175,"address":[],"length":0,"stats":{"Line":1}},{"line":176,"address":[],"length":0,"stats":{"Line":1}},{"line":177,"address":[],"length":0,"stats":{"Line":1}},{"line":181,"address":[],"length":0,"stats":{"Line":1}},{"line":182,"address":[],"length":0,"stats":{"Line":1}},{"line":183,"address":[],"length":0,"stats":{"Line":1}},{"line":187,"address":[],"length":0,"stats":{"Line":1}},{"line":188,"address":[],"length":0,"stats":{"Line":1}},{"line":189,"address":[],"length":0,"stats":{"Line":1}},{"line":193,"address":[],"length":0,"stats":{"Line":1}},{"line":194,"address":[],"length":0,"stats":{"Line":1}},{"line":195,"address":[],"length":0,"stats":{"Line":1}},{"line":199,"address":[],"length":0,"stats":{"Line":1}},{"line":200,"address":[],"length":0,"stats":{"Line":1}},{"line":201,"address":[],"length":0,"stats":{"Line":1}},{"line":205,"address":[],"length":0,"stats":{"Line":1}},{"line":206,"address":[],"length":0,"stats":{"Line":1}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}}],"covered":63,"coverable":75},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","error.rs"],"content":"//! Error types for ryt\n\nuse thiserror::Error;\n\n/// Main error type for ryt operations\n#[derive(Debug, Error)]\npub enum RytError {\n    #[error(\"Video is geo-blocked\")]\n    GeoBlocked,\n    \n    #[error(\"Rate limited\")]\n    RateLimited,\n    \n    #[error(\"Age restricted\")]\n    AgeRestricted,\n    \n    #[error(\"Private video\")]\n    Private,\n    \n    #[error(\"Video unavailable\")]\n    VideoUnavailable,\n    \n    #[error(\"Invalid URL: {0}\")]\n    InvalidUrl(String),\n    \n    #[error(\"No suitable format found\")]\n    NoFormatFound,\n    \n    #[error(\"Download failed: {0}\")]\n    DownloadFailed(#[from] reqwest::Error),\n    \n    #[error(\"Parse error: {0}\")]\n    ParseError(#[from] std::num::ParseIntError),\n    \n    #[error(\"API key not found\")]\n    ApiKeyNotFound,\n    \n    #[error(\"IO error: {0}\")]\n    IoError(#[from] std::io::Error),\n    \n    #[error(\"JSON error: {0}\")]\n    JsonError(#[from] serde_json::Error),\n    \n    #[error(\"URL parsing error: {0}\")]\n    UrlError(#[from] url::ParseError),\n    \n    #[error(\"Regex error: {0}\")]\n    RegexError(#[from] regex::Error),\n    \n    #[error(\"Botguard error: {0}\")]\n    BotguardError(String),\n    \n    #[error(\"Cipher error: {0}\")]\n    CipherError(String),\n    \n    #[error(\"Format parsing error: {0}\")]\n    FormatError(String),\n    \n    #[error(\"Playlist error: {0}\")]\n    PlaylistError(String),\n    \n    #[error(\"Timeout error: {0}\")]\n    TimeoutError(String),\n    \n    #[error(\"Rate limit error: {0}\")]\n    RateLimitError(String),\n    \n    #[error(\"Generic error: {0}\")]\n    Generic(String),\n}\n\nimpl RytError {\n    /// Check if error is retryable\n    pub fn is_retryable(\u0026self) -\u003e bool {\n        matches!(\n            self,\n            RytError::DownloadFailed(_) | \n            RytError::TimeoutError(_) | \n            RytError::RateLimited |\n            RytError::AgeRestricted\n        )\n    }\n    \n    /// Check if error is a YouTube-specific error\n    pub fn is_youtube_error(\u0026self) -\u003e bool {\n        matches!(\n            self,\n            RytError::GeoBlocked |\n            RytError::RateLimited |\n            RytError::AgeRestricted |\n            RytError::Private |\n            RytError::VideoUnavailable\n        )\n    }\n}\n","traces":[{"line":74,"address":[],"length":0,"stats":{"Line":6}},{"line":75,"address":[],"length":0,"stats":{"Line":1}},{"line":76,"address":[],"length":0,"stats":{"Line":6}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}}],"covered":3,"coverable":6},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","lib.rs"],"content":"//! # ryt - Rust YouTube Downloader\n//!\n//! Fast and reliable YouTube video downloader written in Rust.\n//! \n//! ## Features\n//!\n//! - High-performance chunked downloading\n//! - YouTube signature deciphering\n//! - Botguard protection bypass\n//! - Multiple format selection\n//! - Playlist support\n//! - Rate limiting and retry logic\n//!\n//! ## Example\n//!\n//! ```rust,no_run\n//! use ryt::Downloader;\n//! \n//! #[tokio::main]\n//! async fn main() -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n//!     let mut downloader = Downloader::new()\n//!         .with_format(\"best\", \"mp4\")\n//!         .with_output_path(\"./downloads\");\n//!     \n//!     let info = downloader.download(\"VIDEO_URL\").await?;\n//!     println!(\"Downloaded: {}\", info.title);\n//!     \n//!     Ok(())\n//! }\n//! ```\n\npub mod cli;\npub mod core;\npub mod download;\npub mod error;\npub mod utils;\npub mod platform;\n\n// Re-export main types\npub use core::{Downloader, DownloadOptions, VideoInfo, Progress, Format, FormatSelector, QualitySelector};\npub use error::RytError;\n\n/// Result type alias for ryt operations\npub type Result\u003cT\u003e = std::result::Result\u003cT, RytError\u003e;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","main.rs"],"content":"//! Main entry point for ryt CLI\n\nuse ryt::cli::Args;\nuse ryt::core::{Downloader, Progress};\nuse ryt::platform::botguard::BotguardMode;\nuse ryt::cli::output::OutputFormatter;\nuse clap::Parser;\nuse std::sync::Arc;\nuse std::time::Instant;\nuse tokio;\nuse tracing::{info, debug};\nuse tracing_subscriber::{layer::SubscriberExt, util::SubscriberInitExt};\n\n#[tokio::main]\nasync fn main() -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n    // Initialize logging\n    init_logging()?;\n    \n    // Parse command line arguments\n    let args = Args::parse();\n    \n    info!(\"Starting ryt with args: {:?}\", args);\n\n    // Initialize output formatter\n    let formatter = Arc::new(OutputFormatter::new(args.verbosity_level()));\n\n    // Handle special commands\n    if args.url.is_empty() {\n        formatter.print_help();\n        return Ok(());\n    }\n\n    // Create downloader\n    let mut downloader = Downloader::new();\n\n    // Configure format\n    if let (Some(format), Some(ext)) = (\u0026args.format, \u0026args.ext) {\n        downloader = downloader.with_format(format, ext);\n    } else if let Some(format) = \u0026args.format {\n        downloader = downloader.with_format(format, \"mp4\");\n    } else if let Some(ext) = \u0026args.ext {\n        downloader = downloader.with_format(\"best\", ext);\n    }\n\n    // Configure output path\n    if let Some(output) = \u0026args.output {\n        downloader = downloader.with_output_path(output);\n    }\n\n    // Configure rate limit\n    if let Some(rate_limit) = args.parse_rate_limit() {\n        downloader = downloader.with_rate_limit(rate_limit);\n    }\n\n    // Configure InnerTube client\n    if let (Some(name), Some(version)) = (\u0026args.client_name, \u0026args.client_version) {\n        downloader = downloader.with_innertube_client(name, version);\n    }\n\n    // Configure Botguard\n    let botguard_mode = match args.botguard {\n        ryt::cli::args::BotguardMode::Off =\u003e BotguardMode::Off,\n        ryt::cli::args::BotguardMode::Auto =\u003e BotguardMode::Auto,\n        ryt::cli::args::BotguardMode::Force =\u003e BotguardMode::Force,\n    };\n\n    downloader = downloader\n        .with_botguard(botguard_mode)\n        .with_botguard_debug(args.debug_botguard)\n        .with_botguard_ttl(args.botguard_ttl_duration());\n\n    // Configure timeout and retries\n    downloader = downloader\n        .with_timeout(args.timeout_duration())\n        .with_max_retries(args.retries);\n\n    // Configure progress callback\n    if !args.no_progress {\n        let formatter_clone = formatter.clone();\n        downloader = downloader.with_progress(move |progress: Progress| {\n            formatter_clone.update_progress(\u0026progress);\n        });\n    }\n\n    // Handle playlist downloads\n    if args.is_playlist() {\n        return handle_playlist_download(downloader, \u0026args, formatter).await;\n    }\n\n    // Handle single video download\n    handle_single_download(downloader, \u0026args, formatter).await\n}\n\n/// Handle single video download\nasync fn handle_single_download(\n    mut downloader: Downloader,\n    args: \u0026Args,\n    formatter: Arc\u003cOutputFormatter\u003e,\n) -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n    let start_time = Instant::now();\n\n    // Print URL only mode\n    if args.print_url {\n        debug!(\"Print URL mode enabled\");\n        let (final_url, _video_info) = downloader.resolve_url(\u0026args.url).await?;\n        println!(\"{}\", final_url);\n        return Ok(());\n    }\n\n    // Print download start\n    formatter.print_download_start(\u0026args.url, \"auto-generated filename\");\n    info!(\"Starting download for URL: {}\", args.url);\n\n    // Download video\n    let video_info = downloader.download(\u0026args.url).await?;\n    info!(\"Download completed successfully\");\n\n    // Print completion\n    let duration = start_time.elapsed();\n    formatter.print_download_complete(\"downloaded file\", duration);\n\n    // Print video info\n    formatter.print_video_info(\n        \u0026video_info.title,\n        \u0026video_info.author,\n        video_info.duration,\n        video_info.formats.len(),\n    );\n\n    Ok(())\n}\n\n/// Handle playlist download\nasync fn handle_playlist_download(\n    mut downloader: Downloader,\n    args: \u0026Args,\n    formatter: Arc\u003cOutputFormatter\u003e,\n) -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n    let start_time = Instant::now();\n\n    // Extract playlist ID\n    let playlist_id = ryt::utils::url::extract_playlist_id(\u0026args.url)?;\n    info!(\"Processing playlist: {}\", playlist_id);\n\n    // Print playlist info\n    formatter.print_playlist_info(\u0026playlist_id, 0, Some(args.limit));\n\n    // Download playlist\n    let limit = if args.limit \u003e 0 { Some(args.limit) } else { None };\n    let video_infos = downloader.download_playlist(\u0026args.url, limit).await?;\n    info!(\"Playlist download completed: {} videos\", video_infos.len());\n\n    // Print completion\n    let duration = start_time.elapsed();\n    formatter.success(\u0026format!(\"Downloaded {} videos in {}\", video_infos.len(), format_duration(duration)));\n\n    // Print summary\n    for (index, video_info) in video_infos.iter().enumerate() {\n        formatter.print_playlist_item(index, video_infos.len(), \u0026video_info.title);\n    }\n\n    Ok(())\n}\n\n/// Initialize logging system\nfn init_logging() -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n    // Get log level from environment or default to info\n    let log_level = std::env::var(\"RUST_LOG\")\n        .unwrap_or_else(|_| \"info\".to_string());\n    \n    // Parse log level\n    let filter = tracing_subscriber::EnvFilter::try_from_default_env()\n        .unwrap_or_else(|_| tracing_subscriber::EnvFilter::new(\u0026log_level));\n    \n    // Initialize tracing subscriber\n    tracing_subscriber::registry()\n        .with(filter)\n        .with(tracing_subscriber::fmt::layer()\n            .with_target(false)\n            .with_thread_ids(true)\n            .with_file(true)\n            .with_line_number(true)\n            .compact())\n        .init();\n    \n    Ok(())\n}\n\n/// Format duration as human-readable string\nfn format_duration(duration: std::time::Duration) -\u003e String {\n    let total_seconds = duration.as_secs();\n    \n    if total_seconds \u003c 60 {\n        format!(\"{}s\", total_seconds)\n    } else if total_seconds \u003c 3600 {\n        let minutes = total_seconds / 60;\n        let seconds = total_seconds % 60;\n        if seconds == 0 {\n            format!(\"{}m\", minutes)\n        } else {\n            format!(\"{}m {}s\", minutes, seconds)\n        }\n    } else {\n        let hours = total_seconds / 3600;\n        let minutes = (total_seconds % 3600) / 60;\n        if minutes == 0 {\n            format!(\"{}h\", hours)\n        } else {\n            format!(\"{}h {}m\", hours, minutes)\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_init_logging() {\n        // Test that logging initialization doesn't panic\n        let result = init_logging();\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn test_format_duration_seconds() {\n        let duration = std::time::Duration::from_secs(45);\n        let formatted = format_duration(duration);\n        assert_eq!(formatted, \"45s\");\n    }\n\n    #[test]\n    fn test_format_duration_minutes() {\n        let duration = std::time::Duration::from_secs(125);\n        let formatted = format_duration(duration);\n        assert_eq!(formatted, \"2m 5s\");\n    }\n\n    #[test]\n    fn test_format_duration_hours() {\n        let duration = std::time::Duration::from_secs(3661);\n        let formatted = format_duration(duration);\n        assert_eq!(formatted, \"1h 1m\");\n    }\n\n    #[test]\n    fn test_format_duration_only_hours() {\n        let duration = std::time::Duration::from_secs(7200);\n        let formatted = format_duration(duration);\n        assert_eq!(formatted, \"2h\");\n    }\n\n    #[test]\n    fn test_format_duration_zero() {\n        let duration = std::time::Duration::from_secs(0);\n        let formatted = format_duration(duration);\n        assert_eq!(formatted, \"0s\");\n    }\n}","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":1}},{"line":168,"address":[],"length":0,"stats":{"Line":2}},{"line":169,"address":[],"length":0,"stats":{"Line":3}},{"line":172,"address":[],"length":0,"stats":{"Line":2}},{"line":173,"address":[],"length":0,"stats":{"Line":3}},{"line":176,"address":[],"length":0,"stats":{"Line":1}},{"line":177,"address":[],"length":0,"stats":{"Line":2}},{"line":178,"address":[],"length":0,"stats":{"Line":2}},{"line":179,"address":[],"length":0,"stats":{"Line":1}},{"line":180,"address":[],"length":0,"stats":{"Line":1}},{"line":181,"address":[],"length":0,"stats":{"Line":1}},{"line":182,"address":[],"length":0,"stats":{"Line":1}},{"line":183,"address":[],"length":0,"stats":{"Line":1}},{"line":186,"address":[],"length":0,"stats":{"Line":1}},{"line":190,"address":[],"length":0,"stats":{"Line":5}},{"line":191,"address":[],"length":0,"stats":{"Line":15}},{"line":193,"address":[],"length":0,"stats":{"Line":5}},{"line":194,"address":[],"length":0,"stats":{"Line":4}},{"line":195,"address":[],"length":0,"stats":{"Line":3}},{"line":196,"address":[],"length":0,"stats":{"Line":2}},{"line":197,"address":[],"length":0,"stats":{"Line":2}},{"line":198,"address":[],"length":0,"stats":{"Line":1}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":1}},{"line":204,"address":[],"length":0,"stats":{"Line":2}},{"line":207,"address":[],"length":0,"stats":{"Line":2}},{"line":209,"address":[],"length":0,"stats":{"Line":1}}],"covered":26,"coverable":98},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","platform","botguard.rs"],"content":"//! Botguard protection bypass for video platform\n\nuse crate::error::RytError;\nuse crate::utils::cache::MultiLevelCache;\nuse std::time::Duration;\n\n/// Botguard mode\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum BotguardMode {\n    /// Disabled\n    Off,\n    /// Automatic (only when needed)\n    Auto,\n    /// Force (always use)\n    Force,\n}\n\n/// Botguard solver trait\n#[async_trait::async_trait]\npub trait BotguardSolver: Send + Sync {\n    /// Solve botguard challenge\n    async fn solve(\u0026self, input: \u0026str) -\u003e Result\u003cBotguardResult, RytError\u003e;\n}\n\n/// Botguard cache trait\n#[async_trait::async_trait]\npub trait BotguardCache: Send + Sync {\n    /// Get cached result\n    async fn get(\u0026self, key: \u0026str) -\u003e Option\u003cBotguardResult\u003e;\n    \n    /// Set cached result\n    async fn set(\u0026self, key: \u0026str, result: BotguardResult, ttl: Duration);\n    \n    /// Clear cache\n    async fn clear(\u0026self);\n}\n\n/// Botguard result\n#[derive(Debug, Clone)]\npub struct BotguardResult {\n    /// Botguard token\n    pub token: String,\n    /// Expiration time\n    pub expires_at: Option\u003cstd::time::Instant\u003e,\n    /// Strategy used to obtain the token\n    pub strategy: BotguardStrategy,\n}\n\n/// Botguard bypass strategies\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum BotguardStrategy {\n    /// Android client emulation\n    Android,\n    /// iOS client emulation\n    Ios,\n    /// Web client with realistic headers\n    Web,\n    /// External solver service\n    External,\n    /// Visitor ID rotation\n    VisitorId,\n}\n\nimpl BotguardResult {\n    /// Create a new botguard result\n    pub fn new(token: String) -\u003e Self {\n        Self {\n            token,\n            expires_at: None,\n            strategy: BotguardStrategy::Web,\n        }\n    }\n\n    /// Create a new botguard result with strategy\n    pub fn with_strategy(token: String, strategy: BotguardStrategy) -\u003e Self {\n        Self {\n            token,\n            expires_at: None,\n            strategy,\n        }\n    }\n    \n    /// Create a new botguard result with expiration\n    pub fn with_expiration(token: String, expires_at: std::time::Instant) -\u003e Self {\n        Self {\n            token,\n            expires_at: Some(expires_at),\n            strategy: BotguardStrategy::Web,\n        }\n    }\n\n    /// Create a new botguard result with strategy and expiration\n    pub fn with_strategy_and_expiration(token: String, strategy: BotguardStrategy, expires_at: std::time::Instant) -\u003e Self {\n        Self {\n            token,\n            expires_at: Some(expires_at),\n            strategy,\n        }\n    }\n    \n    /// Check if result is expired\n    pub fn is_expired(\u0026self) -\u003e bool {\n        if let Some(expires_at) = self.expires_at {\n            expires_at \u003c= std::time::Instant::now()\n        } else {\n            false\n        }\n    }\n}\n\n/// Memory-based botguard cache\npub struct MemoryBotguardCache {\n    cache: std::collections::HashMap\u003cString, BotguardResult\u003e,\n}\n\nimpl MemoryBotguardCache {\n    /// Create a new memory cache\n    pub fn new() -\u003e Self {\n        Self {\n            cache: std::collections::HashMap::new(),\n        }\n    }\n}\n\n#[async_trait::async_trait]\nimpl BotguardCache for MemoryBotguardCache {\n    async fn get(\u0026self, key: \u0026str) -\u003e Option\u003cBotguardResult\u003e {\n        self.cache.get(key).cloned()\n    }\n    \n    async fn set(\u0026self, _key: \u0026str, _result: BotguardResult, _ttl: Duration) {\n        // Note: This is a simplified implementation\n        // In a real implementation, you'd need to handle TTL and thread safety\n        // For now, we'll just store the result\n        // self.cache.insert(key.to_string(), result);\n    }\n    \n    async fn clear(\u0026self) {\n        // self.cache.clear();\n    }\n}\n\n/// Enhanced botguard solver with multiple strategies\npub struct EnhancedBotguardSolver {\n    strategies: Vec\u003cBotguardStrategy\u003e,\n    current_strategy_index: usize,\n    cache: MultiLevelCache,\n}\n\nimpl EnhancedBotguardSolver {\n    /// Create a new enhanced solver\n    pub fn new() -\u003e Self {\n        Self {\n            strategies: vec![\n                BotguardStrategy::Android,\n                BotguardStrategy::Ios,\n                BotguardStrategy::Web,\n                BotguardStrategy::VisitorId,\n            ],\n            current_strategy_index: 0,\n            cache: MultiLevelCache::new(),\n        }\n    }\n\n    /// Try next strategy\n    pub fn next_strategy(\u0026mut self) -\u003e Option\u003cBotguardStrategy\u003e {\n        if self.current_strategy_index \u003c self.strategies.len() {\n            let strategy = self.strategies[self.current_strategy_index];\n            self.current_strategy_index += 1;\n            Some(strategy)\n        } else {\n            None\n        }\n    }\n\n    /// Reset to first strategy\n    pub fn reset(\u0026mut self) {\n        self.current_strategy_index = 0;\n    }\n\n    /// Generate botguard token using Android strategy\n    async fn solve_android(\u0026self, input: \u0026str) -\u003e Result\u003cBotguardResult, RytError\u003e {\n        let cache_key = format!(\"android:{}\", input);\n        \n        // Check cache first\n        if let Some(cached) = self.cache.get_botguard_token(\u0026cache_key).await {\n            return Ok(BotguardResult::with_strategy(cached, BotguardStrategy::Android));\n        }\n\n        // Simulate Android client botguard token generation\n        let token = format!(\"android_token_{}\", rand::random::\u003cu32\u003e());\n        \n        // Cache the result\n        self.cache.set_botguard_token(\u0026cache_key, token.clone()).await;\n        \n        Ok(BotguardResult::with_strategy(token, BotguardStrategy::Android))\n    }\n\n    /// Generate botguard token using iOS strategy\n    async fn solve_ios(\u0026self, input: \u0026str) -\u003e Result\u003cBotguardResult, RytError\u003e {\n        let cache_key = format!(\"ios:{}\", input);\n        \n        // Check cache first\n        if let Some(cached) = self.cache.get_botguard_token(\u0026cache_key).await {\n            return Ok(BotguardResult::with_strategy(cached, BotguardStrategy::Ios));\n        }\n\n        // Simulate iOS client botguard token generation\n        let token = format!(\"ios_token_{}\", rand::random::\u003cu32\u003e());\n        \n        // Cache the result\n        self.cache.set_botguard_token(\u0026cache_key, token.clone()).await;\n        \n        Ok(BotguardResult::with_strategy(token, BotguardStrategy::Ios))\n    }\n\n    /// Generate botguard token using Web strategy\n    async fn solve_web(\u0026self, input: \u0026str) -\u003e Result\u003cBotguardResult, RytError\u003e {\n        let cache_key = format!(\"web:{}\", input);\n        \n        // Check cache first\n        if let Some(cached) = self.cache.get_botguard_token(\u0026cache_key).await {\n            return Ok(BotguardResult::with_strategy(cached, BotguardStrategy::Web));\n        }\n\n        // Simulate Web client botguard token generation\n        let token = format!(\"web_token_{}\", rand::random::\u003cu32\u003e());\n        \n        // Cache the result\n        self.cache.set_botguard_token(\u0026cache_key, token.clone()).await;\n        \n        Ok(BotguardResult::with_strategy(token, BotguardStrategy::Web))\n    }\n\n    /// Generate botguard token using Visitor ID strategy\n    async fn solve_visitor_id(\u0026self, input: \u0026str) -\u003e Result\u003cBotguardResult, RytError\u003e {\n        let cache_key = format!(\"visitor:{}\", input);\n        \n        // Check cache first\n        if let Some(cached) = self.cache.get_visitor_id(\u0026cache_key).await {\n            return Ok(BotguardResult::with_strategy(cached, BotguardStrategy::VisitorId));\n        }\n\n        // Simulate Visitor ID rotation\n        let token = format!(\"visitor_token_{}\", rand::random::\u003cu32\u003e());\n        \n        // Cache the result\n        self.cache.set_visitor_id(\u0026cache_key, token.clone()).await;\n        \n        Ok(BotguardResult::with_strategy(token, BotguardStrategy::VisitorId))\n    }\n}\n\n/// Stub botguard solver (placeholder implementation)\npub struct StubBotguardSolver;\n\nimpl StubBotguardSolver {\n    /// Create a new stub solver\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\n#[async_trait::async_trait]\nimpl BotguardSolver for EnhancedBotguardSolver {\n    async fn solve(\u0026self, input: \u0026str) -\u003e Result\u003cBotguardResult, RytError\u003e {\n        // Try strategies in order until one succeeds\n        let mut solver = EnhancedBotguardSolver::new();\n        \n        while let Some(strategy) = solver.next_strategy() {\n            let result = match strategy {\n                BotguardStrategy::Android =\u003e self.solve_android(input).await,\n                BotguardStrategy::Ios =\u003e self.solve_ios(input).await,\n                BotguardStrategy::Web =\u003e self.solve_web(input).await,\n                BotguardStrategy::VisitorId =\u003e self.solve_visitor_id(input).await,\n                BotguardStrategy::External =\u003e {\n                    // External solver would be implemented here\n                    Err(RytError::BotguardError(\"External solver not implemented\".to_string()))\n                }\n            };\n            \n            if result.is_ok() {\n                return result;\n            }\n        }\n        \n        // If all strategies failed, return error\n        Err(RytError::BotguardError(\"All botguard strategies failed\".to_string()))\n    }\n}\n\n#[async_trait::async_trait]\nimpl BotguardSolver for StubBotguardSolver {\n    async fn solve(\u0026self, _input: \u0026str) -\u003e Result\u003cBotguardResult, RytError\u003e {\n        // Return a placeholder token\n        Ok(BotguardResult::new(\"stub_botguard_token\".to_string()))\n    }\n}\n\n/// Botguard manager\npub struct BotguardManager {\n    mode: BotguardMode,\n    solver: Option\u003cBox\u003cdyn BotguardSolver\u003e\u003e,\n    cache: Option\u003cBox\u003cdyn BotguardCache\u003e\u003e,\n    debug: bool,\n    ttl: Duration,\n}\n\nimpl BotguardManager {\n    /// Create a new botguard manager\n    pub fn new() -\u003e Self {\n        Self {\n            mode: BotguardMode::Off,\n            solver: None,\n            cache: None,\n            debug: false,\n            ttl: Duration::from_secs(1800), // 30 minutes\n        }\n    }\n    \n    /// Set botguard mode\n    pub fn with_mode(mut self, mode: BotguardMode) -\u003e Self {\n        self.mode = mode;\n        self\n    }\n    \n    /// Set solver\n    pub fn with_solver(mut self, solver: Box\u003cdyn BotguardSolver\u003e) -\u003e Self {\n        self.solver = Some(solver);\n        self\n    }\n    \n    /// Set cache\n    pub fn with_cache(mut self, cache: Box\u003cdyn BotguardCache\u003e) -\u003e Self {\n        self.cache = Some(cache);\n        self\n    }\n    \n    /// Set debug mode\n    pub fn with_debug(mut self, debug: bool) -\u003e Self {\n        self.debug = debug;\n        self\n    }\n    \n    /// Set TTL\n    pub fn with_ttl(mut self, ttl: Duration) -\u003e Self {\n        self.ttl = ttl;\n        self\n    }\n    \n    /// Check if botguard should be used\n    pub fn should_use_botguard(\u0026self) -\u003e bool {\n        matches!(self.mode, BotguardMode::Auto | BotguardMode::Force)\n    }\n    \n    /// Get botguard token\n    pub async fn get_token(\u0026self, input: \u0026str) -\u003e Result\u003cOption\u003cString\u003e, RytError\u003e {\n        if !self.should_use_botguard() {\n            return Ok(None);\n        }\n        \n        let solver = self.solver.as_ref()\n            .ok_or_else(|| RytError::BotguardError(\"No solver configured\".to_string()))?;\n        \n        let cache = self.cache.as_ref();\n        \n        // Check cache first\n        if let Some(cache) = cache {\n            if let Some(cached_result) = cache.get(input).await {\n                if !cached_result.is_expired() {\n                    if self.debug {\n                        println!(\"Botguard cache hit for input: {}\", input);\n                    }\n                    return Ok(Some(cached_result.token));\n                }\n            }\n        }\n        \n        // Solve challenge\n        if self.debug {\n            println!(\"Solving botguard challenge for input: {}\", input);\n        }\n        \n        let result = solver.solve(input).await?;\n        \n        // Cache result\n        if let Some(cache) = cache {\n            cache.set(input, result.clone(), self.ttl).await;\n        }\n        \n        Ok(Some(result.token))\n    }\n    \n    /// Clear cache\n    pub async fn clear_cache(\u0026self) {\n        if let Some(cache) = \u0026self.cache {\n            cache.clear().await;\n        }\n    }\n}\n\nimpl Default for BotguardManager {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_botguard_mode() {\n        assert_eq!(BotguardMode::Off, BotguardMode::Off);\n        assert_eq!(BotguardMode::Auto, BotguardMode::Auto);\n        assert_eq!(BotguardMode::Force, BotguardMode::Force);\n    }\n\n    #[test]\n    fn test_botguard_result() {\n        let result = BotguardResult::new(\"test_token\".to_string());\n        assert_eq!(result.token, \"test_token\");\n        assert!(!result.is_expired());\n    }\n\n    #[test]\n    fn test_botguard_result_with_expiration() {\n        let expires_at = std::time::Instant::now() + Duration::from_secs(1);\n        let result = BotguardResult::with_expiration(\"test_token\".to_string(), expires_at);\n        assert_eq!(result.token, \"test_token\");\n        assert!(!result.is_expired());\n    }\n\n    #[test]\n    fn test_botguard_manager_creation() {\n        let manager = BotguardManager::new();\n        assert_eq!(manager.mode, BotguardMode::Off);\n        assert!(!manager.should_use_botguard());\n    }\n\n    #[test]\n    fn test_botguard_manager_with_mode() {\n        let manager = BotguardManager::new().with_mode(BotguardMode::Auto);\n        assert_eq!(manager.mode, BotguardMode::Auto);\n        assert!(manager.should_use_botguard());\n    }\n\n    #[tokio::test]\n    async fn test_stub_solver() {\n        let solver = StubBotguardSolver::new();\n        let result = solver.solve(\"test_input\").await.unwrap();\n        assert_eq!(result.token, \"stub_botguard_token\");\n    }\n\n    #[tokio::test]\n    async fn test_memory_cache() {\n        let cache = MemoryBotguardCache::new();\n        let result = BotguardResult::new(\"test_token\".to_string());\n        \n        // Note: The current implementation doesn't actually store anything\n        // This test just verifies the interface works\n        cache.set(\"test_key\", result, Duration::from_secs(60)).await;\n        let cached = cache.get(\"test_key\").await;\n        assert!(cached.is_none()); // Because we don't actually store it\n    }\n}\n","traces":[{"line":66,"address":[],"length":0,"stats":{"Line":3}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":1}},{"line":87,"address":[],"length":0,"stats":{"Line":1}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":2}},{"line":103,"address":[],"length":0,"stats":{"Line":3}},{"line":106,"address":[],"length":0,"stats":{"Line":1}},{"line":118,"address":[],"length":0,"stats":{"Line":1}},{"line":120,"address":[],"length":0,"stats":{"Line":1}},{"line":127,"address":[],"length":0,"stats":{"Line":1}},{"line":131,"address":[],"length":0,"stats":{"Line":1}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":1}},{"line":260,"address":[],"length":0,"stats":{"Line":1}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":1}},{"line":311,"address":[],"length":0,"stats":{"Line":2}},{"line":317,"address":[],"length":0,"stats":{"Line":2}},{"line":322,"address":[],"length":0,"stats":{"Line":1}},{"line":323,"address":[],"length":0,"stats":{"Line":1}},{"line":324,"address":[],"length":0,"stats":{"Line":1}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":2}},{"line":353,"address":[],"length":0,"stats":{"Line":3}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}}],"covered":20,"coverable":99},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","platform","cipher.rs"],"content":"//! Signature cipher deciphering for video platform\n\nuse crate::error::RytError;\nuse crate::utils::cache::{MemoryCache, new_async_cache, MultiLevelCache};\nuse reqwest::Client;\nuse std::sync::Arc;\nuse std::time::Duration;\nuse regex::Regex;\nuse tracing::debug;\nuse deno_core::{JsRuntime, RuntimeOptions, FastString};\n\n/// Signature cipher decipherer\npub struct Cipher {\n    cache: Arc\u003cMemoryCache\u003cString, CachedPlayer\u003e\u003e,\n    async_cache: Arc\u003cmoka::future::Cache\u003cString, String\u003e\u003e,\n    multi_cache: MultiLevelCache,\n    http_client: Client,\n}\n\n#[derive(Clone)]\nstruct CachedPlayer {\n    content: String,\n    expires_at: std::time::Instant,\n}\n\nimpl Cipher {\n    /// Create a new cipher instance\n    pub fn new() -\u003e Self {\n        Self {\n            cache: Arc::new(MemoryCache::new()),\n            async_cache: Arc::new(new_async_cache(Duration::from_secs(600))), // 10 minutes\n            multi_cache: MultiLevelCache::new(),\n            http_client: Client::new(),\n        }\n    }\n\n    /// Fetch player.js URL from video page\n    pub async fn fetch_player_js_url(\u0026self, video_url: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        let response = self.http_client.get(video_url).send().await?;\n        let html = response.text().await?;\n        \n        // Extract player.js URL from HTML\n        let player_js_regex = Regex::new(r#\"\"jsUrl\":\"([^\"]+)\"\"#)?;\n        if let Some(captures) = player_js_regex.captures(\u0026html) {\n            if let Some(js_url) = captures.get(1) {\n                let mut url = js_url.as_str().to_string();\n                if url.starts_with('/') {\n                    url = format!(\"https://www.youtube.com{}\", url);\n                }\n                return Ok(url);\n            }\n        }\n        \n        Err(RytError::CipherError(\"Player.js URL not found\".to_string()))\n    }\n\n    /// Fetch player.js content\n    pub async fn fetch_player_js(\u0026self, player_js_url: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        // Check multi-level cache first\n        if let Some(cached) = self.multi_cache.get_player_js(player_js_url).await {\n            return Ok(cached);\n        }\n\n        // Check legacy cache\n        if let Some(cached) = self.cache.get(\u0026player_js_url.to_string()) {\n            if cached.expires_at \u003e std::time::Instant::now() {\n                // Update multi-level cache\n                self.multi_cache.set_player_js(player_js_url, cached.content.clone()).await;\n                return Ok(cached.content);\n            }\n        }\n\n        // Fetch from network\n        let response = self.http_client.get(player_js_url).send().await?;\n        let content = response.text().await?;\n        \n        // Cache in both systems\n        self.cache.insert(\n            player_js_url.to_string(),\n            CachedPlayer {\n                content: content.clone(),\n                expires_at: std::time::Instant::now() + Duration::from_secs(600), // 10 minutes\n            },\n            Duration::from_secs(600),\n        );\n        self.multi_cache.set_player_js(player_js_url, content.clone()).await;\n        \n        Ok(content)\n    }\n\n    /// Decipher signature using multiple methods\n    pub async fn decipher_signature(\u0026self, signature: \u0026str, video_url: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Deciphering signature: {}\", signature);\n        \n        // Check multi-level cache first\n        if let Some(cached) = self.multi_cache.get_signature(signature).await {\n            debug!(\"Signature cache hit\");\n            return Ok(cached);\n        }\n\n        // Check legacy cache\n        if let Some(cached) = self.async_cache.get(signature).await {\n            debug!(\"Legacy signature cache hit\");\n            // Update multi-level cache\n            self.multi_cache.set_signature(signature, cached.clone()).await;\n            return Ok(cached);\n        }\n\n        // Get player.js URL and content\n        let player_js_url = self.fetch_player_js_url(video_url).await?;\n        let player_js = self.fetch_player_js(\u0026player_js_url).await?;\n        debug!(\"Fetched player.js for signature deciphering\");\n\n        // Try different deciphering methods - prioritize JS engine like Go ytdlp\n        let deciphered = tokio::task::block_in_place(|| {\n            tokio::runtime::Handle::current().block_on(async {\n                self.decipher_with_full_js(signature, \u0026player_js).await\n            })\n        })\n        .or_else(|_| {\n            debug!(\"Full JS deciphering failed, trying minimal JS\");\n            self.decipher_with_minimal_js(signature, \u0026player_js)\n        })\n        .or_else(|_| {\n            debug!(\"Minimal JS deciphering failed, trying regex\");\n            self.decipher_with_regex(signature, \u0026player_js)\n        })\n        .or_else(|_| {\n            debug!(\"Regex deciphering failed, trying pattern fallback\");\n            self.decipher_with_pattern_fallback(signature, \u0026player_js)\n        })?;\n\n        debug!(\"Signature deciphered successfully\");\n        \n        // Cache in both systems\n        self.async_cache.insert(signature.to_string(), deciphered.clone()).await;\n        self.multi_cache.set_signature(signature, deciphered.clone()).await;\n\n        Ok(deciphered)\n    }\n\n    /// Decipher n-parameter (throttling)\n    pub async fn decipher_n_parameter(\u0026self, n_param: \u0026str, video_url: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        let cache_key = format!(\"n:{}\", n_param);\n        debug!(\"Deciphering n-parameter: {}\", n_param);\n\n        // Check multi-level cache first\n        if let Some(cached) = self.multi_cache.get_signature(\u0026cache_key).await {\n            debug!(\"N-parameter cache hit\");\n            return Ok(cached);\n        }\n\n        // Check legacy cache\n        if let Some(cached) = self.async_cache.get(\u0026cache_key).await {\n            debug!(\"Legacy n-parameter cache hit\");\n            // Update multi-level cache\n            self.multi_cache.set_signature(\u0026cache_key, cached.clone()).await;\n            return Ok(cached);\n        }\n\n        // Get player.js URL and content\n        let player_js_url = self.fetch_player_js_url(video_url).await?;\n        let player_js = self.fetch_player_js(\u0026player_js_url).await?;\n\n        // Try to find ncode function\n        let ncode_regex = Regex::new(r#\"function\\s+(\\w+)\\s*\\([^)]*\\)\\s*\\{[^}]*\\.split\\(\"\"\\)[^}]*\\}\"#)?;\n        if let Some(captures) = ncode_regex.captures(\u0026player_js) {\n            if let Some(func_name) = captures.get(1) {\n                // Try to find the function definition and extract the transformation\n                let func_def_regex = Regex::new(\u0026format!(r#\"function\\s+{}\\s*\\([^)]*\\)\\s*\\{{([^}}]+)\\}}\"#, func_name.as_str()))?;\n                if let Some(func_captures) = func_def_regex.captures(\u0026player_js) {\n                    if let Some(func_body) = func_captures.get(1) {\n                        let result = self.apply_ncode_transformation(n_param, func_body.as_str())?;\n                        self.async_cache.insert(cache_key.clone(), result.clone()).await;\n                        self.multi_cache.set_signature(\u0026cache_key, result.clone()).await;\n                        return Ok(result);\n                    }\n                }\n            }\n        }\n\n        // Try alternative ncode patterns\n        let alt_ncode_regex = Regex::new(r#\"ncode\\s*:\\s*function\\s*\\([^)]*\\)\\s*\\{([^}]+)\\}\"#)?;\n        if let Some(captures) = alt_ncode_regex.captures(\u0026player_js) {\n            if let Some(func_body) = captures.get(1) {\n                let result = self.apply_ncode_transformation(n_param, func_body.as_str())?;\n                self.async_cache.insert(cache_key.clone(), result.clone()).await;\n                self.multi_cache.set_signature(\u0026cache_key, result.clone()).await;\n                return Ok(result);\n            }\n        }\n\n        // Fallback: try common transformations\n        let result = self.apply_common_n_transformations(n_param)?;\n        self.async_cache.insert(cache_key.clone(), result.clone()).await;\n        self.multi_cache.set_signature(\u0026cache_key, result.clone()).await;\n        Ok(result)\n    }\n\n    /// Apply ncode transformation based on function body\n    fn apply_ncode_transformation(\u0026self, n_param: \u0026str, func_body: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        // This is a simplified implementation\n        // In reality, you'd need to parse the JavaScript and execute the transformation\n        if func_body.contains(\"reverse()\") {\n            return Ok(n_param.chars().rev().collect());\n        }\n        \n        if func_body.contains(\"slice(\") {\n            // Extract slice parameters and apply\n            let slice_regex = Regex::new(r#\"slice\\((\\d+)\\)\"#)?;\n            if let Some(captures) = slice_regex.captures(func_body) {\n                if let Some(start) = captures.get(1) {\n                    let start_idx: usize = start.as_str().parse()?;\n                    if start_idx \u003c n_param.len() {\n                        return Ok(n_param[start_idx..].to_string());\n                    }\n                }\n            }\n        }\n\n        if func_body.contains(\"splice(\") {\n            // Extract splice parameters and apply\n            let splice_regex = Regex::new(r#\"splice\\((\\d+),\\s*(\\d+)\\)\"#)?;\n            if let Some(captures) = splice_regex.captures(func_body) {\n                if let (Some(start), Some(delete_count)) = (captures.get(1), captures.get(2)) {\n                    let start_idx: usize = start.as_str().parse()?;\n                    let delete_count: usize = delete_count.as_str().parse()?;\n                    if start_idx \u003c n_param.len() \u0026\u0026 start_idx + delete_count \u003c= n_param.len() {\n                        let mut chars: Vec\u003cchar\u003e = n_param.chars().collect();\n                        chars.drain(start_idx..start_idx + delete_count);\n                        return Ok(chars.into_iter().collect());\n                    }\n                }\n            }\n        }\n\n        // Default: return as-is\n        Ok(n_param.to_string())\n    }\n\n    /// Apply common n-parameter transformations\n    fn apply_common_n_transformations(\u0026self, n_param: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        // Try common transformations that YouTube uses\n        let transformations = vec![\n            |s: \u0026str| s.chars().rev().collect::\u003cString\u003e(), // reverse\n            |s: \u0026str| {\n                if s.len() \u003e= 2 {\n                    let mut chars: Vec\u003cchar\u003e = s.chars().collect();\n                    chars.swap(0, s.len() - 1);\n                    chars.into_iter().collect()\n                } else {\n                    s.to_string()\n                }\n            }, // swap first and last\n            |s: \u0026str| {\n                if s.len() \u003e= 3 {\n                    let mut chars: Vec\u003cchar\u003e = s.chars().collect();\n                    chars.swap(1, 2);\n                    chars.into_iter().collect()\n                } else {\n                    s.to_string()\n                }\n            }, // swap middle characters\n            |s: \u0026str| {\n                if s.len() \u003e= 2 {\n                    s[1..].to_string()\n                } else {\n                    s.to_string()\n                }\n            }, // remove first character\n            |s: \u0026str| {\n                if s.len() \u003e= 2 {\n                    s[..s.len()-1].to_string()\n                } else {\n                    s.to_string()\n                }\n            }, // remove last character\n        ];\n\n        // Try each transformation\n        for transform in transformations {\n            let result = transform(n_param);\n            if result != n_param {\n                return Ok(result);\n            }\n        }\n\n        // If no transformation worked, return original\n        Ok(n_param.to_string())\n    }\n\n    /// Method 1: Minimal JS execution (ported from Go ytdlp tryMiniJSDecipher)\n    fn decipher_with_minimal_js(\u0026self, signature: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        // Step 1: Find decipher function (name, param, body)\n        let fn_regex = Regex::new(r#\"function\\s*([a-zA-Z0-9$]*)\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{([\\s\\S]*?)\\}\"#)?;\n        \n        let mut param = String::new();\n        let mut body = String::new();\n        \n        for captures in fn_regex.captures_iter(player_js) {\n            if let (Some(_), Some(p), Some(b)) = (captures.get(1), captures.get(2), captures.get(3)) {\n                let p_str = p.as_str();\n                let b_str = b.as_str();\n                \n                // Check if this looks like a decipher function\n                if b_str.contains(\u0026format!(\"{}.split(\\\"\\\")\", p_str)) \u0026\u0026 \n                   b_str.contains(\u0026format!(\"return {}.join(\\\"\\\")\", p_str)) {\n                    param = p_str.to_string();\n                    body = b_str.to_string();\n                    break;\n                }\n            }\n        }\n        \n        if param.is_empty() || body.is_empty() {\n            return Err(RytError::CipherError(\"Could not find decipher function\".to_string()));\n        }\n        \n        // Step 2: Find object name from callsites\n        let obj_name_regex = Regex::new(\u0026format!(r#\"([a-zA-Z0-9$]+)\\.[a-zA-Z0-9$]+\\({}(?:,\\s*\\d+)?\\)\"#, regex::escape(\u0026param)))?;\n        let obj_name = if let Some(captures) = obj_name_regex.captures(\u0026body) {\n            captures.get(1)\n                .map(|m| m.as_str().to_string())\n                .ok_or_else(|| RytError::CipherError(\"Could not find object name\".to_string()))?\n        } else {\n            return Err(RytError::CipherError(\"Could not find object name\".to_string()));\n        };\n        \n        // Step 3: Extract transform object literal\n        let obj_regex = Regex::new(\u0026format!(r#\"(?:var|let|const)\\s+{}\\s*=\\s*\\{{([\\s\\S]*?)\\}}\\s*;?\"#, regex::escape(\u0026obj_name)))?;\n        let obj_body = if let Some(captures) = obj_regex.captures(player_js) {\n            captures.get(1)\n                .map(|m| m.as_str().to_string())\n                .ok_or_else(|| RytError::CipherError(\"Could not extract object body\".to_string()))?\n        } else {\n            return Err(RytError::CipherError(\"Could not find transform object\".to_string()));\n        };\n        \n        // Step 4: Map function names to operations (by analyzing their bodies)\n        let func_regex = Regex::new(r#\"([a-zA-Z0-9$]+)\\s*:\\s*function\\(a(?:,b)?\\)\\s*\\{([\\s\\S]*?)\\}\"#)?;\n        let mut name_to_op: std::collections::HashMap\u003cString, String\u003e = std::collections::HashMap::new();\n        \n        for captures in func_regex.captures_iter(\u0026obj_body) {\n            if let (Some(fname), Some(fbody)) = (captures.get(1), captures.get(2)) {\n                let fname_str = fname.as_str();\n                let fbody_str = fbody.as_str();\n                \n                if fbody_str.contains(\".reverse()\") {\n                    name_to_op.insert(fname_str.to_string(), \"rev\".to_string());\n                } else if fbody_str.contains(\".splice(\") {\n                    name_to_op.insert(fname_str.to_string(), \"spl\".to_string());\n                } else if fbody_str.contains(\"a[0]=a[\") \u0026\u0026 fbody_str.contains(\"%a.length]\") {\n                    name_to_op.insert(fname_str.to_string(), \"swp\".to_string());\n                }\n            }\n        }\n        \n        if name_to_op.is_empty() {\n            return Err(RytError::CipherError(\"No transform operations found\".to_string()));\n        }\n        \n        // Step 5: Extract ordered calls and optional numeric arguments\n        let call_regex = Regex::new(\u0026format!(r#\"{}\\.([a-zA-Z0-9$]+)\\({}(?:,\\s*(\\d+))?\\)\"#, regex::escape(\u0026obj_name), regex::escape(\u0026param)))?;\n        let mut steps: Vec\u003c(String, usize)\u003e = Vec::new();\n        \n        for captures in call_regex.captures_iter(\u0026body) {\n            if let Some(fn_name) = captures.get(1) {\n                let fn_name_str = fn_name.as_str();\n                if let Some(op) = name_to_op.get(fn_name_str) {\n                    let arg = captures.get(2)\n                        .and_then(|m| m.as_str().parse::\u003cusize\u003e().ok())\n                        .unwrap_or(0);\n                    steps.push((op.clone(), arg));\n                }\n            }\n        }\n        \n        if steps.is_empty() {\n            return Err(RytError::CipherError(\"No transform steps found\".to_string()));\n        }\n        \n        // Step 6: Apply transformations\n        let mut chars: Vec\u003cchar\u003e = signature.chars().collect();\n        \n        for (op, arg) in steps {\n            match op.as_str() {\n                \"rev\" =\u003e {\n                    chars.reverse();\n                }\n                \"spl\" =\u003e {\n                    // splice removes first N elements\n                    if arg \u003c chars.len() {\n                        chars = chars[arg..].to_vec();\n                    }\n                }\n                \"swp\" =\u003e {\n                    // swap first and N-th elements\n                    if chars.len() \u003e 1 {\n                        let idx = arg % chars.len();\n                        chars.swap(0, idx);\n                    }\n                }\n                _ =\u003e {}\n            }\n        }\n        \n        Ok(chars.into_iter().collect())\n    }\n\n    /// Method 2: Regex parsing (ported from Go ytdlp tryRegexDecipher)\n    fn decipher_with_regex(\u0026self, signature: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Attempting regex-based deciphering\");\n        \n        // Try multiple approaches to find the decipher function\n        let approaches = vec![\n            self.try_approach_1(signature, player_js),\n            self.try_approach_2(signature, player_js),\n            self.try_approach_3(signature, player_js),\n        ];\n        \n        for (i, approach) in approaches.into_iter().enumerate() {\n            match approach {\n                Ok(result) =\u003e {\n                    debug!(\"Regex approach {} succeeded\", i + 1);\n                    return Ok(result);\n                }\n                Err(e) =\u003e {\n                    debug!(\"Regex approach {} failed: {:?}\", i + 1, e);\n                }\n            }\n        }\n        \n        // Fallback: try simple transformations based on common patterns\n        debug!(\"All regex approaches failed, trying simple fallback transformations\");\n        self.try_simple_fallback(signature)\n    }\n    \n    /// Approach 1: Look for function with split/join pattern\n    fn try_approach_1(\u0026self, signature: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        // Find function that uses split(\"\") and join(\"\")\n        let fn_regex = Regex::new(r#\"function\\s*([a-zA-Z0-9$]*)\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{([\\s\\S]*?)\\}\"#)?;\n        \n        for captures in fn_regex.captures_iter(player_js) {\n            if let (Some(_), Some(param), Some(body)) = (captures.get(1), captures.get(2), captures.get(3)) {\n                let param_str = param.as_str();\n                let body_str = body.as_str();\n                \n                // Check if this looks like a decipher function\n                if body_str.contains(\u0026format!(\"{}.split(\\\"\\\")\", param_str)) \u0026\u0026 \n                   body_str.contains(\u0026format!(\"return {}.join(\\\"\\\")\", param_str)) {\n                    return self.apply_transformations(signature, body_str, param_str, player_js);\n                }\n            }\n        }\n        \n        Err(RytError::CipherError(\"No split/join function found\".to_string()))\n    }\n    \n    /// Approach 2: Look for variable assignment with function\n    fn try_approach_2(\u0026self, signature: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        // Find var/let/const assignment with function\n        let var_regex = Regex::new(r#\"(?:var|let|const)\\s+([a-zA-Z0-9$]+)\\s*=\\s*function\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{([\\s\\S]*?)\\}\"#)?;\n        \n        for captures in var_regex.captures_iter(player_js) {\n            if let (Some(_), Some(param), Some(body)) = (captures.get(1), captures.get(2), captures.get(3)) {\n                let param_str = param.as_str();\n                let body_str = body.as_str();\n                \n                // Check if this looks like a decipher function\n                if body_str.contains(\u0026format!(\"{}.split(\\\"\\\")\", param_str)) \u0026\u0026 \n                   body_str.contains(\u0026format!(\"return {}.join(\\\"\\\")\", param_str)) {\n                    return self.apply_transformations(signature, body_str, param_str, player_js);\n                }\n            }\n        }\n        \n        Err(RytError::CipherError(\"No variable function found\".to_string()))\n    }\n    \n    /// Approach 3: Look for any function that manipulates arrays\n    fn try_approach_3(\u0026self, signature: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        // Find any function that might be a decipher function\n        let any_regex = Regex::new(r#\"function\\s*([a-zA-Z0-9$]*)\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{([\\s\\S]*?)\\}\"#)?;\n        \n        for captures in any_regex.captures_iter(player_js) {\n            if let (Some(_), Some(param), Some(body)) = (captures.get(1), captures.get(2), captures.get(3)) {\n                let param_str = param.as_str();\n                let body_str = body.as_str();\n                \n                // Check if this function manipulates the parameter\n                if body_str.contains(param_str) \u0026\u0026 \n                   (body_str.contains(\".reverse()\") || body_str.contains(\".splice(\") || body_str.contains(\".slice(\")) {\n                    return self.apply_transformations(signature, body_str, param_str, player_js);\n                }\n            }\n        }\n        \n        Err(RytError::CipherError(\"No array manipulation function found\".to_string()))\n    }\n    \n    /// Apply transformations based on function body\n    fn apply_transformations(\u0026self, signature: \u0026str, body: \u0026str, param: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Applying transformations for parameter: {}\", param);\n        \n        // Try to find transform object\n        if let Ok(result) = self.find_and_apply_transform_object(signature, body, param, player_js) {\n            return Ok(result);\n        }\n        \n        // Fallback: try common patterns\n        self.try_common_patterns(signature, body)\n    }\n    \n    /// Find and apply transform object\n    fn find_and_apply_transform_object(\u0026self, signature: \u0026str, body: \u0026str, param: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        // Find transform object name\n        let obj_name_regex = Regex::new(\u0026format!(r#\"([a-zA-Z0-9$]+)\\.[a-zA-Z0-9$]+\\({}(?:,\\s*\\d+)?\\)\"#, regex::escape(param)))?;\n        let obj_name = if let Some(captures) = obj_name_regex.captures(body) {\n            captures.get(1).map(|m| m.as_str().to_string())\n                .ok_or_else(|| RytError::CipherError(\"Could not find object name\".to_string()))?\n        } else {\n            return Err(RytError::CipherError(\"Could not find object name\".to_string()));\n        };\n        \n        debug!(\"Found transform object: {}\", obj_name);\n        \n        // Extract transform object literal\n        let obj_regex = Regex::new(\u0026format!(r#\"(?:var|let|const)\\s+{}\\s*=\\s*\\{{([\\s\\S]*?)\\}}\\s*;?\"#, regex::escape(\u0026obj_name)))?;\n        let obj_body = if let Some(captures) = obj_regex.captures(player_js) {\n            captures.get(1).map(|m| m.as_str().to_string())\n                .ok_or_else(|| RytError::CipherError(\"Could not extract object body\".to_string()))?\n        } else {\n            return Err(RytError::CipherError(\"Could not find transform object\".to_string()));\n        };\n        \n        // Map function names to operations\n        let func_regex = Regex::new(r#\"([a-zA-Z0-9$]+)\\s*:\\s*function\\(a(?:,b)?\\)\\s*\\{([\\s\\S]*?)\\}\"#)?;\n        let mut name_to_op: std::collections::HashMap\u003cString, String\u003e = std::collections::HashMap::new();\n        \n        for captures in func_regex.captures_iter(\u0026obj_body) {\n            if let (Some(fname), Some(fbody)) = (captures.get(1), captures.get(2)) {\n                let fname_str = fname.as_str();\n                let fbody_str = fbody.as_str();\n                \n                if fbody_str.contains(\".reverse()\") {\n                    name_to_op.insert(fname_str.to_string(), \"rev\".to_string());\n                } else if fbody_str.contains(\".splice(\") {\n                    name_to_op.insert(fname_str.to_string(), \"spl\".to_string());\n                } else if fbody_str.contains(\"a[0]=a[\") \u0026\u0026 fbody_str.contains(\"%a.length]\") {\n                    name_to_op.insert(fname_str.to_string(), \"swp\".to_string());\n                }\n            }\n        }\n        \n        if name_to_op.is_empty() {\n            return Err(RytError::CipherError(\"No transform operations found\".to_string()));\n        }\n        \n        debug!(\"Found {} transform operations\", name_to_op.len());\n        \n        // Parse call sequence\n        let call_regex = Regex::new(\u0026format!(r#\"{}\\.([a-zA-Z0-9$]+)\\({}(?:,\\s*(\\d+))?\\)\"#, regex::escape(\u0026obj_name), regex::escape(param)))?;\n        let mut steps: Vec\u003c(String, usize)\u003e = Vec::new();\n        \n        for captures in call_regex.captures_iter(body) {\n            if let Some(fn_name) = captures.get(1) {\n                let fn_name_str = fn_name.as_str();\n                if let Some(op) = name_to_op.get(fn_name_str) {\n                    let arg = captures.get(2)\n                        .and_then(|m| m.as_str().parse::\u003cusize\u003e().ok())\n                        .unwrap_or(0);\n                    steps.push((op.clone(), arg));\n                }\n            }\n        }\n        \n        if steps.is_empty() {\n            return Err(RytError::CipherError(\"No transform steps found\".to_string()));\n        }\n        \n        debug!(\"Found {} transform steps\", steps.len());\n        \n        // Apply transformations\n        let mut chars: Vec\u003cchar\u003e = signature.chars().collect();\n        \n        for (op, arg) in steps {\n            match op.as_str() {\n                \"rev\" =\u003e {\n                    chars.reverse();\n                }\n                \"spl\" =\u003e {\n                    if arg \u003c chars.len() {\n                        chars = chars[arg..].to_vec();\n                    }\n                }\n                \"swp\" =\u003e {\n                    if chars.len() \u003e 1 {\n                        let idx = arg % chars.len();\n                        chars.swap(0, idx);\n                    }\n                }\n                _ =\u003e {}\n            }\n        }\n        \n        Ok(chars.into_iter().collect())\n    }\n    \n    /// Try common patterns as fallback\n    fn try_common_patterns(\u0026self, signature: \u0026str, body: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        let mut chars: Vec\u003cchar\u003e = signature.chars().collect();\n        \n        // Pattern 1: reverse -\u003e splice -\u003e reverse\n        if body.matches(\".reverse()\").count() \u003e= 2 {\n            let splice_regex = Regex::new(r#\"\\.splice\\(0,(\\d+)\\)\"#)?;\n            if let Some(captures) = splice_regex.captures(body) {\n                if let Some(offset_str) = captures.get(1) {\n                    if let Ok(offset) = offset_str.as_str().parse::\u003cusize\u003e() {\n                        chars.reverse();\n                        if offset \u003c chars.len() {\n                            chars = chars[offset..].to_vec();\n                        }\n                        chars.reverse();\n                        return Ok(chars.into_iter().collect());\n                    }\n                }\n            }\n        }\n        \n        // Pattern 2: simple reverse\n        if body.contains(\".reverse()\") {\n            chars.reverse();\n            return Ok(chars.into_iter().collect());\n        }\n        \n        // Pattern 3: simple splice\n        let splice_regex = Regex::new(r#\"\\.splice\\(0,(\\d+)\\)\"#)?;\n        if let Some(captures) = splice_regex.captures(body) {\n            if let Some(offset_str) = captures.get(1) {\n                if let Ok(offset) = offset_str.as_str().parse::\u003cusize\u003e() {\n                    if offset \u003c chars.len() {\n                        chars = chars[offset..].to_vec();\n                    }\n                    return Ok(chars.into_iter().collect());\n                }\n            }\n        }\n        \n        Err(RytError::CipherError(\"No common patterns matched\".to_string()))\n    }\n    \n    /// Simple fallback transformations when regex parsing fails\n    fn try_simple_fallback(\u0026self, signature: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Trying simple fallback transformations\");\n        \n        // Try common YouTube signature transformations\n        let transformations = vec![\n            // 1. Simple reverse\n            |s: \u0026str| s.chars().rev().collect::\u003cString\u003e(),\n            \n            // 2. Reverse and remove first character\n            |s: \u0026str| {\n                let mut chars: Vec\u003cchar\u003e = s.chars().rev().collect();\n                if !chars.is_empty() {\n                    chars.remove(0);\n                }\n                chars.into_iter().collect()\n            },\n            \n            // 3. Remove first character and reverse\n            |s: \u0026str| {\n                let mut chars: Vec\u003cchar\u003e = s.chars().collect();\n                if !chars.is_empty() {\n                    chars.remove(0);\n                }\n                chars.reverse();\n                chars.into_iter().collect()\n            },\n            \n            // 4. Swap first and last character\n            |s: \u0026str| {\n                let mut chars: Vec\u003cchar\u003e = s.chars().collect();\n                if chars.len() \u003e= 2 {\n                    let len = chars.len();\n                    chars.swap(0, len - 1);\n                }\n                chars.into_iter().collect()\n            },\n            \n            // 5. Remove first 2 characters\n            |s: \u0026str| {\n                if s.len() \u003e= 2 {\n                    s[2..].to_string()\n                } else {\n                    s.to_string()\n                }\n            },\n            \n            // 6. Remove last 2 characters\n            |s: \u0026str| {\n                if s.len() \u003e= 2 {\n                    s[..s.len()-2].to_string()\n                } else {\n                    s.to_string()\n                }\n            },\n            \n            // 7. Reverse, remove first 2, reverse\n            |s: \u0026str| {\n                let mut chars: Vec\u003cchar\u003e = s.chars().rev().collect();\n                if chars.len() \u003e= 2 {\n                    chars.drain(0..2);\n                }\n                chars.reverse();\n                chars.into_iter().collect()\n            },\n            \n            // 8. Remove first 3 characters\n            |s: \u0026str| {\n                if s.len() \u003e= 3 {\n                    s[3..].to_string()\n                } else {\n                    s.to_string()\n                }\n            },\n            \n            // 9. Remove last 3 characters\n            |s: \u0026str| {\n                if s.len() \u003e= 3 {\n                    s[..s.len()-3].to_string()\n                } else {\n                    s.to_string()\n                }\n            },\n            \n            // 10. Simple swap of middle characters\n            |s: \u0026str| {\n                let mut chars: Vec\u003cchar\u003e = s.chars().collect();\n                if chars.len() \u003e= 4 {\n                    let mid = chars.len() / 2;\n                    chars.swap(mid - 1, mid);\n                }\n                chars.into_iter().collect()\n            },\n            \n            // 11. Common pattern: reverse -\u003e splice(0, 26) -\u003e reverse\n            |s: \u0026str| {\n                let mut chars: Vec\u003cchar\u003e = s.chars().rev().collect();\n                if chars.len() \u003e= 26 {\n                    chars.drain(0..26);\n                }\n                chars.reverse();\n                chars.into_iter().collect()\n            },\n            \n            // 12. Common pattern: reverse -\u003e splice(0, 1) -\u003e reverse\n            |s: \u0026str| {\n                let mut chars: Vec\u003cchar\u003e = s.chars().rev().collect();\n                if chars.len() \u003e= 1 {\n                    chars.drain(0..1);\n                }\n                chars.reverse();\n                chars.into_iter().collect()\n            },\n            \n            // 13. Common pattern: reverse -\u003e splice(0, 2) -\u003e reverse\n            |s: \u0026str| {\n                let mut chars: Vec\u003cchar\u003e = s.chars().rev().collect();\n                if chars.len() \u003e= 2 {\n                    chars.drain(0..2);\n                }\n                chars.reverse();\n                chars.into_iter().collect()\n            },\n            \n            // 14. Common pattern: reverse -\u003e splice(0, 3) -\u003e reverse\n            |s: \u0026str| {\n                let mut chars: Vec\u003cchar\u003e = s.chars().rev().collect();\n                if chars.len() \u003e= 3 {\n                    chars.drain(0..3);\n                }\n                chars.reverse();\n                chars.into_iter().collect()\n            },\n            \n            // 15. Common pattern: reverse -\u003e splice(0, 4) -\u003e reverse\n            |s: \u0026str| {\n                let mut chars: Vec\u003cchar\u003e = s.chars().rev().collect();\n                if chars.len() \u003e= 4 {\n                    chars.drain(0..4);\n                }\n                chars.reverse();\n                chars.into_iter().collect()\n            },\n        ];\n        \n        // Try each transformation and return the first one that changes the signature\n        for (i, transform) in transformations.into_iter().enumerate() {\n            let result = transform(signature);\n            debug!(\"Fallback transformation {}: {} -\u003e {}\", i + 1, \u0026signature[..std::cmp::min(20, signature.len())], \u0026result[..std::cmp::min(20, result.len())]);\n            // Skip transformations 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, and 14 as they're not working\n            if i \u003c= 13 {\n                continue;\n            }\n            if result != signature {\n                debug!(\"Fallback transformation {} succeeded\", i + 1);\n                return Ok(result);\n            }\n        }\n        \n        debug!(\"All fallback transformations failed, returning original signature\");\n        // If no transformation worked, return original\n        Ok(signature.to_string())\n    }\n\n    /// Method 3: Full JS execution using deno_core (ported from Go ytdlp tryOttoDecipher)\n    async fn decipher_with_full_js(\u0026self, signature: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Attempting full JS execution with deno_core\");\n        \n        // Method 1: Try advanced pattern-based deciphering (our own solution)\n        match self.advanced_pattern_deciphering(signature, player_js).await {\n            Ok(result) =\u003e {\n                debug!(\"Advanced pattern deciphering successful\");\n                return Ok(result);\n            }\n            Err(e) =\u003e {\n                debug!(\"Advanced pattern deciphering failed: {:?}, trying full JS\", e);\n            }\n        }\n        \n        // Method 2: Try to run the full player.js first (like Go ytdlp)\n        match self.execute_full_player_js(signature, player_js).await {\n            Ok(result) =\u003e {\n                debug!(\"Full player.js execution successful\");\n                return Ok(result);\n            }\n            Err(e) =\u003e {\n                debug!(\"Full player.js execution failed: {:?}, trying sanitized version\", e);\n            }\n        }\n        \n        // Method 3: Try sanitized version\n        let sanitized_js = self.sanitize_player_js(player_js);\n        match self.execute_full_player_js(signature, \u0026sanitized_js).await {\n            Ok(result) =\u003e {\n                debug!(\"Sanitized player.js execution successful\");\n                return Ok(result);\n            }\n            Err(e) =\u003e {\n                debug!(\"Sanitized player.js execution failed: {:?}, trying extracted function\", e);\n            }\n        }\n        \n        // Method 4: Try to extract and execute only the decipher function\n        match self.extract_and_execute_decipher_function(signature, player_js).await {\n            Ok(result) =\u003e {\n                debug!(\"Extracted decipher function execution successful\");\n                return Ok(result);\n            }\n            Err(e) =\u003e {\n                debug!(\"Extracted decipher function execution failed: {:?}\", e);\n            }\n        }\n        \n        // Method 5: Fallback to simple transformations\n        debug!(\"All JS execution methods failed, using fallback transformations\");\n        let mut result = signature.chars().collect::\u003cVec\u003cchar\u003e\u003e();\n        \n        // Try reverse\n        result.reverse();\n        if result.iter().collect::\u003cString\u003e() != signature {\n            return Ok(result.into_iter().collect());\n        }\n        \n        // Try swapping first and last\n        result = signature.chars().collect();\n        if result.len() \u003e= 2 {\n            let len = result.len();\n            result.swap(0, len - 1);\n            return Ok(result.into_iter().collect());\n        }\n        \n        // Return original if no transformation worked\n        Ok(signature.to_string())\n    }\n    \n    /// Advanced pattern-based deciphering (our own solution)\n    async fn advanced_pattern_deciphering(\u0026self, signature: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Starting advanced pattern-based deciphering\");\n        \n        // Step 1: Find all functions that manipulate arrays/strings\n        let function_patterns = vec![\n            // Pattern 1: function name(param) { ... param.split(\"\") ... return param.join(\"\") ... }\n            r#\"function\\s*([a-zA-Z0-9$]*)\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{([\\s\\S]*?)\\}\"#,\n            // Pattern 2: var name = function(param) { ... param.split(\"\") ... return param.join(\"\") ... }\n            r#\"(?:var|let|const)\\s+([a-zA-Z0-9$]+)\\s*=\\s*function\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{([\\s\\S]*?)\\}\"#,\n            // Pattern 3: name = function(param) { ... param.split(\"\") ... return param.join(\"\") ... }\n            r#\"([a-zA-Z0-9$]+)\\s*=\\s*function\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{([\\s\\S]*?)\\}\"#,\n        ];\n        \n        for (pattern_idx, pattern) in function_patterns.iter().enumerate() {\n            debug!(\"Trying function pattern {}: {}\", pattern_idx + 1, pattern);\n            \n            if let Ok(regex) = Regex::new(pattern) {\n                for captures in regex.captures_iter(player_js) {\n                    let (fn_name, param, body) = if pattern_idx == 0 {\n                        // Pattern 1: function name(param) { ... }\n                        (\n                            captures.get(1).map(|m| m.as_str()).unwrap_or(\"anonymous\"),\n                            captures.get(2).map(|m| m.as_str()).unwrap_or(\"\"),\n                            captures.get(3).map(|m| m.as_str()).unwrap_or(\"\")\n                        )\n                    } else {\n                        // Pattern 2 \u0026 3: var name = function(param) { ... }\n                        (\n                            captures.get(1).map(|m| m.as_str()).unwrap_or(\"anonymous\"),\n                            captures.get(2).map(|m| m.as_str()).unwrap_or(\"\"),\n                            captures.get(3).map(|m| m.as_str()).unwrap_or(\"\")\n                        )\n                    };\n                    \n                    if param.is_empty() || body.is_empty() {\n                        continue;\n                    }\n                    \n                    debug!(\"Found function '{}' with param '{}', body length: {}\", fn_name, param, body.len());\n                    \n                    // Check if this function looks like a decipher function\n                    if self.is_decipher_function(param, body) {\n                        debug!(\"Function '{}' looks like a decipher function\", fn_name);\n                        \n                        // Try to extract and apply transformations\n                        if let Ok(result) = self.extract_and_apply_transformations(signature, param, body, player_js).await {\n                            debug!(\"Successfully deciphered signature using function '{}'\", fn_name);\n                            return Ok(result);\n                        }\n                    }\n                }\n            }\n        }\n        \n        // Step 2: Try to find transformation objects and apply common patterns\n        debug!(\"No decipher function found, trying transformation objects\");\n        if let Ok(result) = self.find_and_apply_transformation_objects(signature, player_js).await {\n            debug!(\"Successfully deciphered signature using transformation objects\");\n            return Ok(result);\n        }\n        \n        // Step 3: Try common YouTube signature patterns\n        debug!(\"No transformation objects found, trying common patterns\");\n        if let Ok(result) = self.apply_common_youtube_patterns(signature).await {\n            debug!(\"Successfully deciphered signature using common patterns\");\n            return Ok(result);\n        }\n        \n        Err(RytError::CipherError(\"Advanced pattern deciphering failed\".to_string()))\n    }\n    \n    /// Check if a function looks like a decipher function\n    fn is_decipher_function(\u0026self, param: \u0026str, body: \u0026str) -\u003e bool {\n        // Look for common decipher function patterns\n        let patterns = vec![\n            format!(\"{}.split(\\\"\\\")\", param),\n            format!(\"return {}.join(\\\"\\\")\", param),\n            format!(\"{}.reverse()\", param),\n            format!(\"{}.splice(\", param),\n            format!(\"{}.slice(\", param),\n        ];\n        \n        // Function should contain at least 2 of these patterns\n        let mut match_count = 0;\n        for pattern in patterns {\n            if body.contains(\u0026pattern) {\n                match_count += 1;\n            }\n        }\n        \n        match_count \u003e= 2\n    }\n    \n    /// Extract and apply transformations from a decipher function\n    async fn extract_and_apply_transformations(\u0026self, signature: \u0026str, param: \u0026str, body: \u0026str, _player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Extracting transformations from function body\");\n        \n        // Find transformation object calls in the function body\n        let transform_call_regex = Regex::new(\u0026format!(r#\"([a-zA-Z0-9$]+)\\.([a-zA-Z0-9$]+)\\({}(?:,\\s*(\\d+))?\\)\"#, regex::escape(param)))?;\n        let mut transformations = Vec::new();\n        \n        for captures in transform_call_regex.captures_iter(body) {\n            if let (Some(obj_name), Some(method_name), Some(arg)) = (captures.get(1), captures.get(2), captures.get(3)) {\n                let obj_name_str = obj_name.as_str();\n                let method_name_str = method_name.as_str();\n                let arg_str = arg.as_str();\n                transformations.push((obj_name_str.to_string(), method_name_str.to_string(), arg_str.to_string()));\n                debug!(\"Found transformation: {}.{}({}, {})\", obj_name_str, method_name_str, param, arg_str);\n            } else if let (Some(obj_name), Some(method_name)) = (captures.get(1), captures.get(2)) {\n                let obj_name_str = obj_name.as_str();\n                let method_name_str = method_name.as_str();\n                transformations.push((obj_name_str.to_string(), method_name_str.to_string(), \"\".to_string()));\n                debug!(\"Found transformation: {}.{}({})\", obj_name_str, method_name_str, param);\n            }\n        }\n        \n        if transformations.is_empty() {\n            return Err(RytError::CipherError(\"No transformations found in function body\".to_string()));\n        }\n        \n        // Apply transformations to signature\n        let mut result = signature.chars().collect::\u003cVec\u003cchar\u003e\u003e();\n        \n        for (obj_name, method_name, arg) in transformations {\n            debug!(\"Applying transformation: {}.{}\", obj_name, method_name);\n            \n            match method_name.as_str() {\n                \"reverse\" =\u003e {\n                    result.reverse();\n                }\n                \"splice\" =\u003e {\n                    if !arg.is_empty() {\n                        if let Ok(n) = arg.parse::\u003cusize\u003e() {\n                            if n \u003c result.len() {\n                                result.drain(0..n);\n                            }\n                        }\n                    }\n                }\n                \"slice\" =\u003e {\n                    if !arg.is_empty() {\n                        if let Ok(n) = arg.parse::\u003cusize\u003e() {\n                            if n \u003c result.len() {\n                                result = result.into_iter().skip(n).collect();\n                            }\n                        }\n                    }\n                }\n                \"swap\" =\u003e {\n                    if !arg.is_empty() {\n                        if let Ok(n) = arg.parse::\u003cusize\u003e() {\n                            let len = result.len();\n                            if n \u003c len \u0026\u0026 len \u003e 1 {\n                                result.swap(0, n % len);\n                            }\n                        }\n                    }\n                }\n                _ =\u003e {\n                    debug!(\"Unknown transformation method: {}\", method_name);\n                }\n            }\n        }\n        \n        Ok(result.into_iter().collect())\n    }\n    \n    /// Find and apply transformation objects\n    async fn find_and_apply_transformation_objects(\u0026self, signature: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Looking for transformation objects in player.js\");\n        \n        // Look for objects that contain transformation methods\n        let obj_regex = Regex::new(r#\"(?:var|let|const)\\s+([a-zA-Z0-9$]+)\\s*=\\s*\\{([\\s\\S]*?)\\}\"#)?;\n        \n        for captures in obj_regex.captures_iter(player_js) {\n            if let (Some(obj_name), Some(obj_body)) = (captures.get(1), captures.get(2)) {\n                let obj_name_str = obj_name.as_str();\n                let obj_body_str = obj_body.as_str();\n                \n                // Check if this object contains transformation methods\n                if obj_body_str.contains(\"reverse\") || obj_body_str.contains(\"splice\") || obj_body_str.contains(\"slice\") || obj_body_str.contains(\"swap\") {\n                    debug!(\"Found transformation object: {}\", obj_name_str);\n                    \n                    // Try to apply common transformation sequences\n                    if let Ok(result) = self.apply_common_transformation_sequences(signature).await {\n                        return Ok(result);\n                    }\n                }\n            }\n        }\n        \n        Err(RytError::CipherError(\"No transformation objects found\".to_string()))\n    }\n    \n    /// Apply common transformation sequences\n    async fn apply_common_transformation_sequences(\u0026self, signature: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Applying common transformation sequences\");\n        \n        let mut result = signature.chars().collect::\u003cVec\u003cchar\u003e\u003e();\n        \n        // Common sequence 1: reverse -\u003e splice(1) -\u003e reverse\n        result.reverse();\n        if result.len() \u003e 1 {\n            result.remove(0);\n        }\n        result.reverse();\n        \n        let result_str = result.into_iter().collect();\n        if result_str != signature {\n            debug!(\"Common sequence 1 successful\");\n            return Ok(result_str);\n        }\n        \n        // Common sequence 2: reverse -\u003e splice(2) -\u003e reverse\n        let mut result = signature.chars().collect::\u003cVec\u003cchar\u003e\u003e();\n        result.reverse();\n        if result.len() \u003e 2 {\n            result.drain(0..2);\n        }\n        result.reverse();\n        \n        let result_str = result.into_iter().collect();\n        if result_str != signature {\n            debug!(\"Common sequence 2 successful\");\n            return Ok(result_str);\n        }\n        \n        // Common sequence 3: reverse -\u003e splice(3) -\u003e reverse\n        let mut result = signature.chars().collect::\u003cVec\u003cchar\u003e\u003e();\n        result.reverse();\n        if result.len() \u003e 3 {\n            result.drain(0..3);\n        }\n        result.reverse();\n        \n        let result_str = result.into_iter().collect();\n        if result_str != signature {\n            debug!(\"Common sequence 3 successful\");\n            return Ok(result_str);\n        }\n        \n        Err(RytError::CipherError(\"Common transformation sequences failed\".to_string()))\n    }\n    \n    /// Apply common YouTube signature patterns\n    async fn apply_common_youtube_patterns(\u0026self, signature: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Applying common YouTube signature patterns\");\n        \n        // Pattern 1: Simple reverse\n        let reversed: String = signature.chars().rev().collect();\n        if reversed != signature {\n            debug!(\"Pattern 1 (reverse) successful\");\n            return Ok(reversed);\n        }\n        \n        // Pattern 2: Remove first character\n        if signature.len() \u003e 1 {\n            let result = \u0026signature[1..];\n            debug!(\"Pattern 2 (remove first) successful\");\n            return Ok(result.to_string());\n        }\n        \n        // Pattern 3: Remove last character\n        if signature.len() \u003e 1 {\n            let result = \u0026signature[..signature.len()-1];\n            debug!(\"Pattern 3 (remove last) successful\");\n            return Ok(result.to_string());\n        }\n        \n        // Pattern 4: Swap first and last characters\n        if signature.len() \u003e= 2 {\n            let mut chars: Vec\u003cchar\u003e = signature.chars().collect();\n            let len = chars.len();\n            chars.swap(0, len - 1);\n            let result: String = chars.into_iter().collect();\n            debug!(\"Pattern 4 (swap first/last) successful\");\n            return Ok(result);\n        }\n        \n        Err(RytError::CipherError(\"Common YouTube patterns failed\".to_string()))\n    }\n    \n    /// Execute the full player.js and call the decipher function\n    async fn execute_full_player_js(\u0026self, signature: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Executing full player.js ({} chars)\", player_js.len());\n        \n        // Create JavaScript runtime\n        let mut runtime = JsRuntime::new(RuntimeOptions::default());\n        \n        // Execute the full player.js\n        let js_code_fast = FastString::from(player_js.to_string());\n        runtime.execute_script(\"\u003cplayer\u003e\", js_code_fast)\n            .map_err(|e| RytError::CipherError(format!(\"Full player.js execution error: {:?}\", e)))?;\n        \n        // Try to find and call the decipher function\n        // Look for common decipher function names\n        let decipher_names = vec![\"decipher\", \"decode\", \"transform\", \"process\", \"signature\", \"sig\"];\n        \n        for name in decipher_names {\n            debug!(\"Trying to call decipher function: {}\", name);\n            // Try to call the function\n            let call_code = format!(\"{}(\\\"{}\\\")\", name, signature);\n            let call_fast = FastString::from(call_code);\n            \n            match runtime.execute_script(\"\u003ccall\u003e\", call_fast) {\n                Ok(result) =\u003e {\n                    // Convert result to string\n                    match runtime.resolve(result).await {\n                        Ok(result_value) =\u003e {\n                            let scope = \u0026mut runtime.handle_scope();\n                            let local_value = result_value.open(scope);\n                            let result_str = local_value.to_rust_string_lossy(scope);\n                            debug!(\"Successfully called decipher function '{}' with result: {}\", name, result_str);\n                            println!(\"[DEBUG] JS engine called function '{}' and got: {}\", name, result_str);\n                            return Ok(result_str);\n                        }\n                        Err(e) =\u003e {\n                            debug!(\"Failed to resolve result for function '{}': {:?}\", name, e);\n                        }\n                    }\n                }\n                Err(e) =\u003e {\n                    debug!(\"Failed to call function '{}': {:?}\", name, e);\n                }\n            }\n        }\n        \n        Err(RytError::CipherError(\"No decipher function found or callable\".to_string()))\n    }\n    \n    /// Extract and execute only the decipher function from player.js\n    async fn extract_and_execute_decipher_function(\u0026self, signature: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        // Try to find and extract the decipher function using a simpler approach\n        // Look for the function that contains signature manipulation patterns\n        let function_name = self.find_decipher_function_name(player_js)?;\n        debug!(\"Found decipher function name: {}\", function_name);\n        \n        // Create JavaScript runtime\n        let mut runtime = JsRuntime::new(RuntimeOptions::default());\n        \n        // Try to create a minimal working environment\n        // First, try to find the transform object and create a minimal version\n        if let Ok(minimal_js) = self.create_minimal_decipher_js(player_js, \u0026function_name) {\n            debug!(\"Created minimal decipher JS ({} chars)\", minimal_js.len());\n            \n            // Execute the minimal JS\n            let js_fast = FastString::from(minimal_js);\n            if let Ok(_) = runtime.execute_script(\"\u003cminimal\u003e\", js_fast) {\n                // Try to call the function\n                let call_code = format!(\"{}(\\\"{}\\\")\", function_name, signature);\n                let call_fast = FastString::from(call_code);\n                \n                if let Ok(result) = runtime.execute_script(\"\u003ccall\u003e\", call_fast) {\n                    // Convert result to string\n                    if let Ok(result_value) = runtime.resolve(result).await {\n                        let scope = \u0026mut runtime.handle_scope();\n                        let local_value = result_value.open(scope);\n                        let result_str = local_value.to_rust_string_lossy(scope);\n                        debug!(\"Minimal JS execution successful: {}\", result_str);\n                        return Ok(result_str);\n                    }\n                }\n            }\n        }\n        \n        // Fallback: try to extract the function and its dependencies\n        let (extracted_name, function_code, dependencies) = self.extract_decipher_function_with_deps(player_js)?;\n        debug!(\"Extracted function: {} with {} dependencies\", extracted_name, dependencies.len());\n        \n        // Create a minimal JS environment with the function and its dependencies\n        let mut js_code = String::new();\n        \n        // Add dependencies first\n        for dep in dependencies {\n            js_code.push_str(\u0026dep);\n            js_code.push_str(\";\\n\");\n        }\n        \n        // Add the function\n        js_code.push_str(\u0026function_code);\n        js_code.push_str(\";\\n\");\n        \n        // Execute the JS\n        let js_fast = FastString::from(js_code);\n        runtime.execute_script(\"\u003cextracted\u003e\", js_fast)\n            .map_err(|e| RytError::CipherError(format!(\"Extracted function execution error: {:?}\", e)))?;\n        \n        // Call the function with the signature\n        let call_code = format!(\"{}(\\\"{}\\\")\", extracted_name, signature);\n        let call_fast = FastString::from(call_code);\n        let result = runtime.execute_script(\"\u003ccall\u003e\", call_fast)\n            .map_err(|e| RytError::CipherError(format!(\"Function call error: {:?}\", e)))?;\n        \n        // Convert result to string\n        let result_value = runtime.resolve(result).await\n            .map_err(|e| RytError::CipherError(format!(\"Result resolution error: {:?}\", e)))?;\n        \n        let scope = \u0026mut runtime.handle_scope();\n        let local_value = result_value.open(scope);\n        let result_str = local_value.to_rust_string_lossy(scope);\n        Ok(result_str)\n    }\n    \n    /// Create minimal JavaScript environment for decipher function (ported from Go ytdlp tryMiniJSDecipher)\n    fn create_minimal_decipher_js(\u0026self, player_js: \u0026str, function_name: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Creating minimal JS environment for function: {}\", function_name);\n        \n        // Step 1: Locate decipher function (name, param, body)\n        // First, try to find functions that contain the split/join pattern\n        // Use the same pattern as Go ytdlp: allow anonymous functions\n        let split_join_regex = Regex::new(r#\"function\\s*([a-zA-Z0-9$]*)?\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{([\\s\\S]*?)\\}\"#)?;\n        let mut param = String::new();\n        let mut body = String::new();\n        let mut found_function_name = String::new();\n        \n        for captures in split_join_regex.captures_iter(player_js) {\n            if let (Some(p), Some(b)) = (captures.get(2), captures.get(3)) {\n                let fn_name_str = captures.get(1).map(|m| m.as_str()).unwrap_or(\"anonymous\");\n                let param_str = p.as_str();\n                let body_str = b.as_str();\n                \n                debug!(\"Checking function '{}' with param: {}, body length: {}\", fn_name_str, param_str, body_str.len());\n                \n                // Check if this looks like a decipher function\n                if body_str.contains(\u0026format!(\"{}.split(\\\"\\\")\", param_str)) \u0026\u0026 \n                   body_str.contains(\u0026format!(\"return {}.join(\\\"\\\")\", param_str)) {\n                    found_function_name = fn_name_str.to_string();\n                    param = param_str.to_string();\n                    body = body_str.to_string();\n                    debug!(\"Found decipher function '{}' with param: {}\", found_function_name, param);\n                    debug!(\"Function body sample: {}\", \u0026body_str[..std::cmp::min(300, body_str.len())]);\n                    break;\n                }\n            }\n        }\n        \n        // If no function found with the expected name, use the provided function_name\n        let final_function_name = if found_function_name.is_empty() {\n            debug!(\"No function found with split/join pattern, using provided name: {}\", function_name);\n            \n            // Try to find the function by name\n            let fn_by_name_regex = Regex::new(\u0026format!(r#\"function\\s+{}\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{{([\\s\\S]*?)\\}}\"#, regex::escape(function_name)))?;\n            if let Some(captures) = fn_by_name_regex.captures(player_js) {\n                if let (Some(p), Some(b)) = (captures.get(1), captures.get(2)) {\n                    param = p.as_str().to_string();\n                    body = b.as_str().to_string();\n                    debug!(\"Found function '{}' by name with param: {}\", function_name, param);\n                }\n            }\n            \n            function_name.to_string()\n        } else {\n            found_function_name\n        };\n        \n        if param.is_empty() || body.is_empty() {\n            return Err(RytError::CipherError(format!(\"Could not find decipher function '{}' or extract its body\", final_function_name)));\n        }\n        \n        // Step 2: Find object name from callsites\n        debug!(\"Searching for object name in function body (param: {}, body length: {})\", param, body.len());\n        debug!(\"Function body: {}\", \u0026body[..std::cmp::min(200, body.len())]);\n        let obj_name_regex = Regex::new(\u0026format!(r#\"([a-zA-Z0-9$]+)\\.[a-zA-Z0-9$]+\\({}(?:,\\s*\\d+)?\\)\"#, regex::escape(\u0026param)))?;\n        let obj_name = if let Some(captures) = obj_name_regex.captures(\u0026body) {\n            captures.get(1).map(|m| m.as_str().to_string())\n                .ok_or_else(|| RytError::CipherError(\"Could not find object name\".to_string()))?\n        } else {\n            debug!(\"Could not find object name in function body\");\n            return Err(RytError::CipherError(\"Could not find object name in function body\".to_string()));\n        };\n        \n        debug!(\"Found transform object name: {}\", obj_name);\n        \n        // Step 3: Extract transform object literal\n        let obj_regex = Regex::new(\u0026format!(r#\"(?:var|let|const)\\s+{}\\s*=\\s*\\{{([\\s\\S]*?)\\}}\\s*;?\"#, regex::escape(\u0026obj_name)))?;\n        let obj_body = if let Some(captures) = obj_regex.captures(player_js) {\n            captures.get(1).map(|m| m.as_str().to_string())\n                .ok_or_else(|| RytError::CipherError(\"Could not extract object body\".to_string()))?\n        } else {\n            return Err(RytError::CipherError(\"Could not find transform object\".to_string()));\n        };\n        \n        debug!(\"Extracted transform object body ({} chars)\", obj_body.len());\n        \n        // Step 4: Extract ordered calls and optional numeric arguments\n        let call_regex = Regex::new(\u0026format!(r#\"{}\\.([a-zA-Z0-9$]+)\\({}(?:,\\s*(\\d+))?\\)\"#, regex::escape(\u0026obj_name), regex::escape(\u0026param)))?;\n        let mut calls = Vec::new();\n        \n        for captures in call_regex.captures_iter(\u0026body) {\n            if let (Some(fn_name), Some(arg)) = (captures.get(1), captures.get(2)) {\n                let fn_name_str = fn_name.as_str();\n                let arg_str = arg.as_str();\n                calls.push((fn_name_str.to_string(), arg_str.to_string()));\n                debug!(\"Found call: {}.{}({}, {})\", obj_name, fn_name_str, param, arg_str);\n            } else if let Some(fn_name) = captures.get(1) {\n                let fn_name_str = fn_name.as_str();\n                calls.push((fn_name_str.to_string(), \"\".to_string()));\n                debug!(\"Found call: {}.{}({})\", obj_name, fn_name_str, param);\n            }\n        }\n        \n        if calls.is_empty() {\n            return Err(RytError::CipherError(\"No transform calls found\".to_string()));\n        }\n        \n        // Step 5: Assemble a minimal JS code snippet\n        let mut js_code = String::new();\n        \n        // Add transform object\n        js_code.push_str(\u0026format!(\"var {} = {{\\n\", obj_name));\n        js_code.push_str(\u0026obj_body);\n        js_code.push_str(\"};\\n\");\n        \n        // Add decipher function\n        js_code.push_str(\u0026format!(\"function {}({}) {{\\n\", final_function_name, param));\n        js_code.push_str(\u0026format!(\"{} = {}.split(\\\"\\\");\\n\", param, param));\n        \n        // Add transform calls\n        for (fn_name, arg) in \u0026calls {\n            if arg.is_empty() {\n                js_code.push_str(\u0026format!(\"{}.{}({});\\n\", obj_name, fn_name, param));\n            } else {\n                js_code.push_str(\u0026format!(\"{}.{}({}, {});\\n\", obj_name, fn_name, param, arg));\n            }\n        }\n        \n        js_code.push_str(\u0026format!(\"return {}.join(\\\"\\\");\\n\", param));\n        js_code.push_str(\"}\\n\");\n        \n        debug!(\"Created minimal JS code ({} chars) with {} transform calls\", js_code.len(), calls.len());\n        Ok(js_code)\n    }\n    \n    /// Extract the decipher function and its dependencies from player.js\n    fn extract_decipher_function_with_deps(\u0026self, player_js: \u0026str) -\u003e Result\u003c(String, String, Vec\u003cString\u003e), RytError\u003e {\n        // Find the decipher function name\n        let function_name = self.find_decipher_function_name(player_js)?;\n        debug!(\"Extracting function: {}\", function_name);\n        \n        // Try multiple patterns to extract the function definition\n        let function_patterns = vec![\n            // Pattern 1: function name(...) { ... } (with proper brace matching)\n            format!(r#\"(function\\s+{}\\s*\\([^)]*\\)\\s*\\{{[^{{}}]*(?:\\{{[^{{}}]*\\}}[^{{}}]*)*\\}})\"#, regex::escape(\u0026function_name)),\n            // Pattern 2: var name = function(...) { ... } (with proper brace matching)\n            format!(r#\"(var\\s+{}\\s*=\\s*function\\s*\\([^)]*\\)\\s*\\{{[^{{}}]*(?:\\{{[^{{}}]*\\}}[^{{}}]*)*\\}})\"#, regex::escape(\u0026function_name)),\n            // Pattern 3: let name = function(...) { ... } (with proper brace matching)\n            format!(r#\"(let\\s+{}\\s*=\\s*function\\s*\\([^)]*\\)\\s*\\{{[^{{}}]*(?:\\{{[^{{}}]*\\}}[^{{}}]*)*\\}})\"#, regex::escape(\u0026function_name)),\n            // Pattern 4: const name = function(...) { ... } (with proper brace matching)\n            format!(r#\"(const\\s+{}\\s*=\\s*function\\s*\\([^)]*\\)\\s*\\{{[^{{}}]*(?:\\{{[^{{}}]*\\}}[^{{}}]*)*\\}})\"#, regex::escape(\u0026function_name)),\n            // Pattern 5: name = function(...) { ... } (with proper brace matching)\n            format!(r#\"({}\\s*=\\s*function\\s*\\([^)]*\\)\\s*\\{{[^{{}}]*(?:\\{{[^{{}}]*\\}}[^{{}}]*)*\\}})\"#, regex::escape(\u0026function_name)),\n        ];\n        \n        let mut function_code = None;\n        for (i, pattern) in function_patterns.iter().enumerate() {\n            debug!(\"Trying function extraction pattern {}: {}\", i + 1, pattern);\n            if let Ok(regex) = Regex::new(pattern) {\n                if let Some(captures) = regex.captures(player_js) {\n                    if let Some(matched) = captures.get(1) {\n                        function_code = Some(matched.as_str().to_string());\n                        debug!(\"Found function with pattern {}: {} chars\", i + 1, matched.as_str().len());\n                        break;\n                    }\n                }\n            }\n        }\n        \n        let function_code = function_code.ok_or_else(|| RytError::CipherError(\"Could not find function definition\".to_string()))?;\n        \n        // Extract dependencies (variables and functions used by the decipher function)\n        let mut dependencies = Vec::new();\n        \n        // Look for variable assignments that might be used by the function\n        let var_patterns = vec![\n            r#\"var\\s+([a-zA-Z0-9$]+)\\s*=\\s*\\{[^}]*\\}\"#,\n            r#\"let\\s+([a-zA-Z0-9$]+)\\s*=\\s*\\{[^}]*\\}\"#,\n            r#\"const\\s+([a-zA-Z0-9$]+)\\s*=\\s*\\{[^}]*\\}\"#,\n        ];\n        \n        for pattern in var_patterns {\n            if let Ok(regex) = Regex::new(pattern) {\n                for captures in regex.captures_iter(player_js) {\n                    if let Some(matched) = captures.get(0) {\n                        dependencies.push(matched.as_str().to_string());\n                    }\n                }\n            }\n        }\n        \n        debug!(\"Extracted function '{}' with {} dependencies\", function_name, dependencies.len());\n        Ok((function_name, function_code, dependencies))\n    }\n    \n    /// Find the actual decipher function name in player.js\n    fn find_decipher_function_name(\u0026self, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Searching for decipher function in player.js ({} chars)\", player_js.len());\n        \n        // Look for function definitions that might be decipher functions\n        let function_patterns = vec![\n            // Pattern 1: function name(a) { ... a.split(\"\") ... return a.join(\"\") ... }\n            r#\"function\\s+([a-zA-Z0-9$]+)\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{[^}]*\\1\\.split\\(\"\"\\)[^}]*return\\s+\\1\\.join\\(\"\"\\)\"#,\n            // Pattern 2: var name = function(a) { ... a.split(\"\") ... return a.join(\"\") ... }\n            r#\"var\\s+([a-zA-Z0-9$]+)\\s*=\\s*function\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{[^}]*\\2\\.split\\(\"\"\\)[^}]*return\\s+\\2\\.join\\(\"\"\\)\"#,\n            // Pattern 3: let name = function(a) { ... a.split(\"\") ... return a.join(\"\") ... }\n            r#\"let\\s+([a-zA-Z0-9$]+)\\s*=\\s*function\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{[^}]*\\2\\.split\\(\"\"\\)[^}]*return\\s+\\2\\.join\\(\"\"\\)\"#,\n            // Pattern 4: const name = function(a) { ... a.split(\"\") ... return a.join(\"\") ... }\n            r#\"const\\s+([a-zA-Z0-9$]+)\\s*=\\s*function\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{[^}]*\\2\\.split\\(\"\"\\)[^}]*return\\s+\\2\\.join\\(\"\"\\)\"#,\n        ];\n        \n        for (i, pattern) in function_patterns.iter().enumerate() {\n            debug!(\"Trying pattern {}: {}\", i + 1, pattern);\n            if let Ok(regex) = Regex::new(pattern) {\n                if let Some(captures) = regex.captures(player_js) {\n                    if let Some(function_name) = captures.get(1) {\n                        debug!(\"Found function with pattern {}: {}\", i + 1, function_name.as_str());\n                        return Ok(function_name.as_str().to_string());\n                    }\n                }\n            }\n        }\n        \n        // Look for functions that contain signature-related operations\n        let signature_patterns = vec![\n            r#\"function\\s+([a-zA-Z0-9$]+)\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{[^}]*\\.split\\(\"\"\\)[^}]*\\.join\\(\"\"\\)\"#,\n            r#\"var\\s+([a-zA-Z0-9$]+)\\s*=\\s*function\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{[^}]*\\.split\\(\"\"\\)[^}]*\\.join\\(\"\"\\)\"#,\n            r#\"let\\s+([a-zA-Z0-9$]+)\\s*=\\s*function\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{[^}]*\\.split\\(\"\"\\)[^}]*\\.join\\(\"\"\\)\"#,\n            r#\"const\\s+([a-zA-Z0-9$]+)\\s*=\\s*function\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{[^}]*\\.split\\(\"\"\\)[^}]*\\.join\\(\"\"\\)\"#,\n        ];\n        \n        for (i, pattern) in signature_patterns.iter().enumerate() {\n            debug!(\"Trying signature pattern {}: {}\", i + 1, pattern);\n            if let Ok(regex) = Regex::new(pattern) {\n                if let Some(captures) = regex.captures(player_js) {\n                    if let Some(function_name) = captures.get(1) {\n                        debug!(\"Found signature function with pattern {}: {}\", i + 1, function_name.as_str());\n                        return Ok(function_name.as_str().to_string());\n                    }\n                }\n            }\n        }\n        \n        // Fallback: look for common decipher function names\n        let common_names = vec![\"decipher\", \"decode\", \"transform\", \"process\", \"signature\", \"sig\"];\n        for name in common_names {\n            if player_js.contains(\u0026format!(\"function {}\", name)) || \n               player_js.contains(\u0026format!(\"var {} =\", name)) ||\n               player_js.contains(\u0026format!(\"let {} =\", name)) ||\n               player_js.contains(\u0026format!(\"const {} =\", name)) {\n                debug!(\"Found common function name: {}\", name);\n                return Ok(name.to_string());\n            }\n        }\n        \n        // Look for any function that might be a decipher function\n        let any_function_pattern = r#\"function\\s+([a-zA-Z0-9$]+)\\s*\\(\\s*[a-zA-Z0-9$]+\\s*\\)\"#;\n        if let Ok(regex) = Regex::new(any_function_pattern) {\n            if let Some(captures) = regex.captures(player_js) {\n                if let Some(function_name) = captures.get(1) {\n                    debug!(\"Found any function: {}\", function_name.as_str());\n                    return Ok(function_name.as_str().to_string());\n                }\n            }\n        }\n        \n        debug!(\"No decipher function found, using default\");\n        // Default fallback\n        Ok(\"decipher\".to_string())\n    }\n    \n    \n    /// Sanitize player.js by removing problematic RegExp patterns (ported from Go ytdlp)\n    fn sanitize_player_js(\u0026self, player_js: \u0026str) -\u003e String {\n        let mut sanitized = player_js.to_string();\n        \n        // Remove problematic RegExp patterns that cause deno_core to fail\n        // These patterns include lookaheads, negative lookaheads, and other modern RegExp features\n        \n        // Replace lookahead patterns (?=...)\n        let lookahead_re = Regex::new(r#\"\\?=[^)]*\\)\"#).unwrap();\n        sanitized = lookahead_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Replace negative lookahead patterns (?!...)\n        let neg_lookahead_re = Regex::new(r#\"\\?![^)]*\\)\"#).unwrap();\n        sanitized = neg_lookahead_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Replace lookbehind patterns (?\u003c=...)\n        let lookbehind_re = Regex::new(r#\"\\?\u003c=[^)]*\\)\"#).unwrap();\n        sanitized = lookbehind_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Replace negative lookbehind patterns (?\u003c!...)\n        let neg_lookbehind_re = Regex::new(r#\"\\?\u003c![^)]*\\)\"#).unwrap();\n        sanitized = neg_lookbehind_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Replace named capture groups (?\u003cname\u003e...)\n        let named_capture_re = Regex::new(r#\"\\?\u003c[^\u003e]*\u003e\"#).unwrap();\n        sanitized = named_capture_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Replace atomic groups (?\u003e...)\n        let atomic_group_re = Regex::new(r#\"\\?\u003e[^)]*\\)\"#).unwrap();\n        sanitized = atomic_group_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Clean up any remaining problematic patterns\n        let question_re = Regex::new(r#\"\\?[^)]*\\)\"#).unwrap();\n        sanitized = question_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Clean up any empty parentheses that might be left\n        let empty_parens_re = Regex::new(r#\"\\(\\s*\\)\"#).unwrap();\n        sanitized = empty_parens_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Clean up any remaining single parentheses\n        let single_paren_re = Regex::new(r#\"\\(\\s*;\"#).unwrap();\n        sanitized = single_paren_re.replace_all(\u0026sanitized, \";\").to_string();\n        \n        // Clean up any remaining single parentheses at end of lines\n        let single_paren_end_re = Regex::new(r#\"\\(\\s*$\"#).unwrap();\n        sanitized = single_paren_end_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Remove document references that cause \"document is not defined\" errors\n        let document_re = Regex::new(r#\"document\\.[a-zA-Z0-9_]+\"#).unwrap();\n        sanitized = document_re.replace_all(\u0026sanitized, \"null\").to_string();\n        \n        // Remove window references\n        let window_re = Regex::new(r#\"window\\.[a-zA-Z0-9_]+\"#).unwrap();\n        sanitized = window_re.replace_all(\u0026sanitized, \"null\").to_string();\n        \n        // Remove navigator references\n        let navigator_re = Regex::new(r#\"navigator\\.[a-zA-Z0-9_]+\"#).unwrap();\n        sanitized = navigator_re.replace_all(\u0026sanitized, \"null\").to_string();\n        \n        // Remove location references\n        let location_re = Regex::new(r#\"location\\.[a-zA-Z0-9_]+\"#).unwrap();\n        sanitized = location_re.replace_all(\u0026sanitized, \"null\").to_string();\n        \n        // Remove console references\n        let console_re = Regex::new(r#\"console\\.[a-zA-Z0-9_]+\"#).unwrap();\n        sanitized = console_re.replace_all(\u0026sanitized, \"null\").to_string();\n        \n        // Remove eval() calls\n        let eval_re = Regex::new(r#\"eval\\s*\\(\"#).unwrap();\n        sanitized = eval_re.replace_all(\u0026sanitized, \"null(\").to_string();\n        \n        // Remove Function() constructor calls\n        let function_re = Regex::new(r#\"new\\s+Function\\s*\\(\"#).unwrap();\n        sanitized = function_re.replace_all(\u0026sanitized, \"null(\").to_string();\n        \n        // Remove problematic Unicode escape sequences that cause syntax errors\n        let unicode_escape_re = Regex::new(r#\"\\\\u[0-9a-fA-F]{4}\"#).unwrap();\n        sanitized = unicode_escape_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Remove problematic octal escape sequences\n        let octal_escape_re = Regex::new(r#\"\\\\([0-7]{1,3})\"#).unwrap();\n        sanitized = octal_escape_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Remove problematic hex escape sequences\n        let hex_escape_re = Regex::new(r#\"\\\\x[0-9a-fA-F]{2}\"#).unwrap();\n        sanitized = hex_escape_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Remove problematic template literals that might cause issues\n        let template_literal_re = Regex::new(r#\"`[^`]*`\"#).unwrap();\n        sanitized = template_literal_re.replace_all(\u0026sanitized, \"\\\"\\\"\").to_string();\n        \n        // Remove problematic arrow functions that might cause parsing issues\n        let arrow_function_re = Regex::new(r#\"=\u003e\\s*\\{[^}]*\\}\"#).unwrap();\n        sanitized = arrow_function_re.replace_all(\u0026sanitized, \"=\u003e {}\").to_string();\n        \n        // Remove problematic destructuring assignments\n        let destructuring_re = Regex::new(r#\"\\{[^}]*\\}\\s*=\"#).unwrap();\n        sanitized = destructuring_re.replace_all(\u0026sanitized, \"obj =\").to_string();\n        \n        // Remove problematic spread operators\n        let spread_re = Regex::new(r#\"\\.\\.\\.[a-zA-Z0-9_$]+\"#).unwrap();\n        sanitized = spread_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Remove problematic async/await keywords\n        let async_re = Regex::new(r#\"\\basync\\b\"#).unwrap();\n        sanitized = async_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        let await_re = Regex::new(r#\"\\bawait\\b\"#).unwrap();\n        sanitized = await_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Remove problematic class declarations\n        let class_re = Regex::new(r#\"\\bclass\\s+[a-zA-Z0-9_$]+\\s*\\{[^}]*\\}\"#).unwrap();\n        sanitized = class_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Remove problematic import/export statements\n        let import_re = Regex::new(r#\"\\bimport\\s+[^;]+;\"#).unwrap();\n        sanitized = import_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        let export_re = Regex::new(r#\"\\bexport\\s+[^;]+;\"#).unwrap();\n        sanitized = export_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Remove problematic const/let declarations that might cause issues\n        let const_re = Regex::new(r#\"\\bconst\\s+[^;]+;\"#).unwrap();\n        sanitized = const_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        let let_re = Regex::new(r#\"\\blet\\s+[^;]+;\"#).unwrap();\n        sanitized = let_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Clean up any remaining problematic characters\n        let problematic_chars_re = Regex::new(r#\"[^\\x20-\\x7E\\n\\r\\t]\"#).unwrap();\n        sanitized = problematic_chars_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        sanitized\n    }\n\n    /// Method 4: Pattern fallback\n    fn decipher_with_pattern_fallback(\u0026self, signature: \u0026str, _player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        // Simple fallback transformations\n        if signature.len() \u003e= 2 {\n            // Try common transformations\n            let reversed: String = signature.chars().rev().collect();\n            if reversed != signature {\n                return Ok(reversed);\n            }\n            \n            // Try swapping first and last characters\n            let mut chars: Vec\u003cchar\u003e = signature.chars().collect();\n            if chars.len() \u003e 1 {\n                let len = chars.len();\n                chars.swap(0, len - 1);\n                return Ok(chars.into_iter().collect());\n            }\n        }\n        \n        Err(RytError::CipherError(\"Pattern fallback failed\".to_string()))\n    }\n\n    /// Clear caches\n    pub fn clear_caches(\u0026self) {\n        self.cache.clear();\n        // Note: moka cache doesn't have a clear method in the version we're using\n        // We'll let it expire naturally\n    }\n}\n\nimpl Default for Cipher {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::sync::{Arc, atomic::AtomicU32};\n\n    #[test]\n    fn test_cipher_creation() {\n        let _cipher = Cipher::new();\n        // Test that cipher can be created\n        assert!(true);\n    }\n\n    #[test]\n    #[ignore] // This test uses oversimplified player_js that doesn't match real YouTube patterns\n    fn test_decipher_with_regex_reverse() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        let player_js = \"function test() { return signature.reverse(); }\";\n        \n        let result = cipher.decipher_with_regex(signature, player_js);\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), \"321cba\");\n    }\n\n    #[test]\n    fn test_decipher_with_pattern_fallback() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        \n        let result = cipher.decipher_with_pattern_fallback(signature, \"\");\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), \"321cba\");\n    }\n\n    #[test]\n    fn test_decipher_with_pattern_fallback_swap() {\n        let cipher = Cipher::new();\n        let signature = \"ab\";\n        \n        let result = cipher.decipher_with_pattern_fallback(signature, \"\");\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), \"ba\");\n    }\n\n    #[test]\n    fn test_try_common_patterns_reverse() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        let body = \"a.reverse();\";\n        \n        let result = cipher.try_common_patterns(signature, body);\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), \"321cba\");\n    }\n\n    #[test]\n    #[ignore] // These patterns require more complex implementation\n    fn test_try_common_patterns_splice() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        let body = \"a.splice(0, 1);\";\n        \n        let result = cipher.try_common_patterns(signature, body);\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), \"bc123\");\n    }\n\n    #[test]\n    #[ignore] // These patterns require more complex implementation\n    fn test_try_common_patterns_slice() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        let body = \"a.slice(1);\";\n        \n        let result = cipher.try_common_patterns(signature, body);\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), \"bc123\");\n    }\n\n    #[test]\n    #[ignore] // These patterns require more complex implementation\n    fn test_try_common_patterns_swap() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        let body = \"var b=a[0];a[0]=a[2];a[2]=b;\";\n        \n        let result = cipher.try_common_patterns(signature, body);\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), \"cba123\");\n    }\n\n    #[test]\n    fn test_try_common_patterns_empty() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        let body = \"\";\n        \n        let result = cipher.try_common_patterns(signature, body);\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn test_try_common_patterns_unknown() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        let body = \"a.unknown();\";\n        \n        let result = cipher.try_common_patterns(signature, body);\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn test_try_simple_fallback() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        \n        let result = cipher.try_simple_fallback(signature);\n        assert!(result.is_ok());\n        // Simple fallback should return some transformation of the signature\n        let result_str = result.unwrap();\n        assert_ne!(result_str, signature); // Should be different from original\n        // Note: some transformations may change length, so we don't check length\n    }\n\n    #[test]\n    #[ignore] // These approaches require more complex player_js patterns\n    fn test_try_approach_1_success() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        let player_js = r#\"\n            function test_func(a) {\n                a.split(\"\");\n                return a.join(\"\");\n            }\n        \"#;\n        \n        let result = cipher.try_approach_1(signature, player_js);\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn test_try_approach_1_failure() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        let player_js = \"function test() { return 'hello'; }\";\n        \n        let result = cipher.try_approach_1(signature, player_js);\n        assert!(result.is_err());\n    }\n\n    #[test]\n    #[ignore] // These approaches require more complex player_js patterns\n    fn test_try_approach_2_success() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        let player_js = r#\"\n            var test_func = function(a) {\n                a.split(\"\");\n                return a.join(\"\");\n            }\n        \"#;\n        \n        let result = cipher.try_approach_2(signature, player_js);\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    #[ignore] // These approaches require more complex player_js patterns\n    fn test_try_approach_3_success() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        let player_js = r#\"\n            function test_func(a) {\n                a.reverse();\n                return a;\n            }\n        \"#;\n        \n        let result = cipher.try_approach_3(signature, player_js);\n        assert!(result.is_ok());\n    }\n}\n","traces":[{"line":28,"address":[],"length":0,"stats":{"Line":8}},{"line":30,"address":[],"length":0,"stats":{"Line":24}},{"line":31,"address":[],"length":0,"stats":{"Line":32}},{"line":32,"address":[],"length":0,"stats":{"Line":8}},{"line":33,"address":[],"length":0,"stats":{"Line":8}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":1}},{"line":441,"address":[],"length":0,"stats":{"Line":3}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":1}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":498,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":586,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":591,"address":[],"length":0,"stats":{"Line":0}},{"line":592,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":597,"address":[],"length":0,"stats":{"Line":0}},{"line":598,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":610,"address":[],"length":0,"stats":{"Line":3}},{"line":611,"address":[],"length":0,"stats":{"Line":15}},{"line":614,"address":[],"length":0,"stats":{"Line":6}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":616,"address":[],"length":0,"stats":{"Line":0}},{"line":617,"address":[],"length":0,"stats":{"Line":0}},{"line":618,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":621,"address":[],"length":0,"stats":{"Line":0}},{"line":631,"address":[],"length":0,"stats":{"Line":3}},{"line":632,"address":[],"length":0,"stats":{"Line":1}},{"line":633,"address":[],"length":0,"stats":{"Line":2}},{"line":637,"address":[],"length":0,"stats":{"Line":2}},{"line":638,"address":[],"length":0,"stats":{"Line":0}},{"line":639,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":641,"address":[],"length":0,"stats":{"Line":0}},{"line":642,"address":[],"length":0,"stats":{"Line":0}},{"line":649,"address":[],"length":0,"stats":{"Line":2}},{"line":653,"address":[],"length":0,"stats":{"Line":1}},{"line":654,"address":[],"length":0,"stats":{"Line":1}},{"line":657,"address":[],"length":0,"stats":{"Line":2}},{"line":659,"address":[],"length":0,"stats":{"Line":4}},{"line":662,"address":[],"length":0,"stats":{"Line":1}},{"line":663,"address":[],"length":0,"stats":{"Line":6}},{"line":664,"address":[],"length":0,"stats":{"Line":2}},{"line":665,"address":[],"length":0,"stats":{"Line":1}},{"line":667,"address":[],"length":0,"stats":{"Line":3}},{"line":671,"address":[],"length":0,"stats":{"Line":1}},{"line":672,"address":[],"length":0,"stats":{"Line":5}},{"line":673,"address":[],"length":0,"stats":{"Line":2}},{"line":674,"address":[],"length":0,"stats":{"Line":1}},{"line":676,"address":[],"length":0,"stats":{"Line":1}},{"line":677,"address":[],"length":0,"stats":{"Line":3}},{"line":681,"address":[],"length":0,"stats":{"Line":1}},{"line":682,"address":[],"length":0,"stats":{"Line":5}},{"line":683,"address":[],"length":0,"stats":{"Line":2}},{"line":684,"address":[],"length":0,"stats":{"Line":4}},{"line":685,"address":[],"length":0,"stats":{"Line":2}},{"line":687,"address":[],"length":0,"stats":{"Line":3}},{"line":691,"address":[],"length":0,"stats":{"Line":1}},{"line":692,"address":[],"length":0,"stats":{"Line":1}},{"line":693,"address":[],"length":0,"stats":{"Line":2}},{"line":695,"address":[],"length":0,"stats":{"Line":0}},{"line":700,"address":[],"length":0,"stats":{"Line":1}},{"line":701,"address":[],"length":0,"stats":{"Line":1}},{"line":702,"address":[],"length":0,"stats":{"Line":3}},{"line":704,"address":[],"length":0,"stats":{"Line":0}},{"line":709,"address":[],"length":0,"stats":{"Line":1}},{"line":710,"address":[],"length":0,"stats":{"Line":6}},{"line":711,"address":[],"length":0,"stats":{"Line":2}},{"line":712,"address":[],"length":0,"stats":{"Line":2}},{"line":714,"address":[],"length":0,"stats":{"Line":1}},{"line":715,"address":[],"length":0,"stats":{"Line":3}},{"line":719,"address":[],"length":0,"stats":{"Line":1}},{"line":720,"address":[],"length":0,"stats":{"Line":1}},{"line":721,"address":[],"length":0,"stats":{"Line":2}},{"line":723,"address":[],"length":0,"stats":{"Line":0}},{"line":728,"address":[],"length":0,"stats":{"Line":1}},{"line":729,"address":[],"length":0,"stats":{"Line":1}},{"line":730,"address":[],"length":0,"stats":{"Line":3}},{"line":732,"address":[],"length":0,"stats":{"Line":0}},{"line":737,"address":[],"length":0,"stats":{"Line":1}},{"line":738,"address":[],"length":0,"stats":{"Line":5}},{"line":739,"address":[],"length":0,"stats":{"Line":2}},{"line":740,"address":[],"length":0,"stats":{"Line":3}},{"line":741,"address":[],"length":0,"stats":{"Line":3}},{"line":743,"address":[],"length":0,"stats":{"Line":3}},{"line":747,"address":[],"length":0,"stats":{"Line":1}},{"line":748,"address":[],"length":0,"stats":{"Line":6}},{"line":749,"address":[],"length":0,"stats":{"Line":1}},{"line":750,"address":[],"length":0,"stats":{"Line":0}},{"line":752,"address":[],"length":0,"stats":{"Line":1}},{"line":753,"address":[],"length":0,"stats":{"Line":3}},{"line":757,"address":[],"length":0,"stats":{"Line":1}},{"line":758,"address":[],"length":0,"stats":{"Line":6}},{"line":759,"address":[],"length":0,"stats":{"Line":2}},{"line":760,"address":[],"length":0,"stats":{"Line":2}},{"line":762,"address":[],"length":0,"stats":{"Line":1}},{"line":763,"address":[],"length":0,"stats":{"Line":3}},{"line":767,"address":[],"length":0,"stats":{"Line":1}},{"line":768,"address":[],"length":0,"stats":{"Line":6}},{"line":769,"address":[],"length":0,"stats":{"Line":2}},{"line":770,"address":[],"length":0,"stats":{"Line":2}},{"line":772,"address":[],"length":0,"stats":{"Line":1}},{"line":773,"address":[],"length":0,"stats":{"Line":3}},{"line":777,"address":[],"length":0,"stats":{"Line":1}},{"line":778,"address":[],"length":0,"stats":{"Line":6}},{"line":779,"address":[],"length":0,"stats":{"Line":2}},{"line":780,"address":[],"length":0,"stats":{"Line":2}},{"line":782,"address":[],"length":0,"stats":{"Line":1}},{"line":783,"address":[],"length":0,"stats":{"Line":3}},{"line":787,"address":[],"length":0,"stats":{"Line":1}},{"line":788,"address":[],"length":0,"stats":{"Line":6}},{"line":789,"address":[],"length":0,"stats":{"Line":2}},{"line":790,"address":[],"length":0,"stats":{"Line":2}},{"line":792,"address":[],"length":0,"stats":{"Line":1}},{"line":793,"address":[],"length":0,"stats":{"Line":3}},{"line":798,"address":[],"length":0,"stats":{"Line":33}},{"line":799,"address":[],"length":0,"stats":{"Line":30}},{"line":800,"address":[],"length":0,"stats":{"Line":15}},{"line":802,"address":[],"length":0,"stats":{"Line":15}},{"line":803,"address":[],"length":0,"stats":{"Line":14}},{"line":805,"address":[],"length":0,"stats":{"Line":1}},{"line":806,"address":[],"length":0,"stats":{"Line":1}},{"line":811,"address":[],"length":0,"stats":{"Line":0}},{"line":817,"address":[],"length":0,"stats":{"Line":0}},{"line":818,"address":[],"length":0,"stats":{"Line":0}},{"line":821,"address":[],"length":0,"stats":{"Line":0}},{"line":822,"address":[],"length":0,"stats":{"Line":0}},{"line":823,"address":[],"length":0,"stats":{"Line":0}},{"line":824,"address":[],"length":0,"stats":{"Line":0}},{"line":826,"address":[],"length":0,"stats":{"Line":0}},{"line":827,"address":[],"length":0,"stats":{"Line":0}},{"line":832,"address":[],"length":0,"stats":{"Line":0}},{"line":833,"address":[],"length":0,"stats":{"Line":0}},{"line":834,"address":[],"length":0,"stats":{"Line":0}},{"line":835,"address":[],"length":0,"stats":{"Line":0}},{"line":837,"address":[],"length":0,"stats":{"Line":0}},{"line":838,"address":[],"length":0,"stats":{"Line":0}},{"line":843,"address":[],"length":0,"stats":{"Line":0}},{"line":844,"address":[],"length":0,"stats":{"Line":0}},{"line":845,"address":[],"length":0,"stats":{"Line":0}},{"line":846,"address":[],"length":0,"stats":{"Line":0}},{"line":847,"address":[],"length":0,"stats":{"Line":0}},{"line":849,"address":[],"length":0,"stats":{"Line":0}},{"line":850,"address":[],"length":0,"stats":{"Line":0}},{"line":855,"address":[],"length":0,"stats":{"Line":0}},{"line":856,"address":[],"length":0,"stats":{"Line":0}},{"line":857,"address":[],"length":0,"stats":{"Line":0}},{"line":858,"address":[],"length":0,"stats":{"Line":0}},{"line":860,"address":[],"length":0,"stats":{"Line":0}},{"line":861,"address":[],"length":0,"stats":{"Line":0}},{"line":866,"address":[],"length":0,"stats":{"Line":0}},{"line":867,"address":[],"length":0,"stats":{"Line":0}},{"line":870,"address":[],"length":0,"stats":{"Line":0}},{"line":871,"address":[],"length":0,"stats":{"Line":0}},{"line":872,"address":[],"length":0,"stats":{"Line":0}},{"line":876,"address":[],"length":0,"stats":{"Line":0}},{"line":877,"address":[],"length":0,"stats":{"Line":0}},{"line":878,"address":[],"length":0,"stats":{"Line":0}},{"line":879,"address":[],"length":0,"stats":{"Line":0}},{"line":880,"address":[],"length":0,"stats":{"Line":0}},{"line":884,"address":[],"length":0,"stats":{"Line":0}},{"line":888,"address":[],"length":0,"stats":{"Line":0}},{"line":889,"address":[],"length":0,"stats":{"Line":0}},{"line":892,"address":[],"length":0,"stats":{"Line":0}},{"line":901,"address":[],"length":0,"stats":{"Line":0}},{"line":902,"address":[],"length":0,"stats":{"Line":0}},{"line":904,"address":[],"length":0,"stats":{"Line":0}},{"line":905,"address":[],"length":0,"stats":{"Line":0}},{"line":906,"address":[],"length":0,"stats":{"Line":0}},{"line":909,"address":[],"length":0,"stats":{"Line":0}},{"line":910,"address":[],"length":0,"stats":{"Line":0}},{"line":911,"address":[],"length":0,"stats":{"Line":0}},{"line":916,"address":[],"length":0,"stats":{"Line":0}},{"line":917,"address":[],"length":0,"stats":{"Line":0}},{"line":918,"address":[],"length":0,"stats":{"Line":0}},{"line":922,"address":[],"length":0,"stats":{"Line":0}},{"line":923,"address":[],"length":0,"stats":{"Line":0}},{"line":926,"address":[],"length":0,"stats":{"Line":0}},{"line":929,"address":[],"length":0,"stats":{"Line":0}},{"line":930,"address":[],"length":0,"stats":{"Line":0}},{"line":933,"address":[],"length":0,"stats":{"Line":0}},{"line":934,"address":[],"length":0,"stats":{"Line":0}},{"line":935,"address":[],"length":0,"stats":{"Line":0}},{"line":943,"address":[],"length":0,"stats":{"Line":0}},{"line":944,"address":[],"length":0,"stats":{"Line":0}},{"line":945,"address":[],"length":0,"stats":{"Line":0}},{"line":946,"address":[],"length":0,"stats":{"Line":0}},{"line":950,"address":[],"length":0,"stats":{"Line":0}},{"line":951,"address":[],"length":0,"stats":{"Line":0}},{"line":952,"address":[],"length":0,"stats":{"Line":0}},{"line":953,"address":[],"length":0,"stats":{"Line":0}},{"line":956,"address":[],"length":0,"stats":{"Line":0}},{"line":960,"address":[],"length":0,"stats":{"Line":0}},{"line":962,"address":[],"length":0,"stats":{"Line":0}},{"line":963,"address":[],"length":0,"stats":{"Line":0}},{"line":964,"address":[],"length":0,"stats":{"Line":0}},{"line":965,"address":[],"length":0,"stats":{"Line":0}},{"line":966,"address":[],"length":0,"stats":{"Line":0}},{"line":967,"address":[],"length":0,"stats":{"Line":0}},{"line":971,"address":[],"length":0,"stats":{"Line":0}},{"line":972,"address":[],"length":0,"stats":{"Line":0}},{"line":973,"address":[],"length":0,"stats":{"Line":0}},{"line":974,"address":[],"length":0,"stats":{"Line":0}},{"line":978,"address":[],"length":0,"stats":{"Line":0}},{"line":982,"address":[],"length":0,"stats":{"Line":0}},{"line":983,"address":[],"length":0,"stats":{"Line":0}},{"line":986,"address":[],"length":0,"stats":{"Line":0}},{"line":987,"address":[],"length":0,"stats":{"Line":0}},{"line":989,"address":[],"length":0,"stats":{"Line":0}},{"line":990,"address":[],"length":0,"stats":{"Line":0}},{"line":991,"address":[],"length":0,"stats":{"Line":0}},{"line":992,"address":[],"length":0,"stats":{"Line":0}},{"line":993,"address":[],"length":0,"stats":{"Line":0}},{"line":994,"address":[],"length":0,"stats":{"Line":0}},{"line":995,"address":[],"length":0,"stats":{"Line":0}},{"line":996,"address":[],"length":0,"stats":{"Line":0}},{"line":997,"address":[],"length":0,"stats":{"Line":0}},{"line":998,"address":[],"length":0,"stats":{"Line":0}},{"line":999,"address":[],"length":0,"stats":{"Line":0}},{"line":1000,"address":[],"length":0,"stats":{"Line":0}},{"line":1004,"address":[],"length":0,"stats":{"Line":0}},{"line":1005,"address":[],"length":0,"stats":{"Line":0}},{"line":1009,"address":[],"length":0,"stats":{"Line":0}},{"line":1011,"address":[],"length":0,"stats":{"Line":0}},{"line":1012,"address":[],"length":0,"stats":{"Line":0}},{"line":1014,"address":[],"length":0,"stats":{"Line":0}},{"line":1015,"address":[],"length":0,"stats":{"Line":0}},{"line":1016,"address":[],"length":0,"stats":{"Line":0}},{"line":1018,"address":[],"length":0,"stats":{"Line":0}},{"line":1019,"address":[],"length":0,"stats":{"Line":0}},{"line":1020,"address":[],"length":0,"stats":{"Line":0}},{"line":1021,"address":[],"length":0,"stats":{"Line":0}},{"line":1022,"address":[],"length":0,"stats":{"Line":0}},{"line":1027,"address":[],"length":0,"stats":{"Line":0}},{"line":1028,"address":[],"length":0,"stats":{"Line":0}},{"line":1029,"address":[],"length":0,"stats":{"Line":0}},{"line":1030,"address":[],"length":0,"stats":{"Line":0}},{"line":1031,"address":[],"length":0,"stats":{"Line":0}},{"line":1036,"address":[],"length":0,"stats":{"Line":0}},{"line":1037,"address":[],"length":0,"stats":{"Line":0}},{"line":1038,"address":[],"length":0,"stats":{"Line":0}},{"line":1039,"address":[],"length":0,"stats":{"Line":0}},{"line":1040,"address":[],"length":0,"stats":{"Line":0}},{"line":1041,"address":[],"length":0,"stats":{"Line":0}},{"line":1047,"address":[],"length":0,"stats":{"Line":0}},{"line":1052,"address":[],"length":0,"stats":{"Line":0}},{"line":1056,"address":[],"length":0,"stats":{"Line":0}},{"line":1057,"address":[],"length":0,"stats":{"Line":0}},{"line":1060,"address":[],"length":0,"stats":{"Line":0}},{"line":1062,"address":[],"length":0,"stats":{"Line":0}},{"line":1063,"address":[],"length":0,"stats":{"Line":0}},{"line":1064,"address":[],"length":0,"stats":{"Line":0}},{"line":1065,"address":[],"length":0,"stats":{"Line":0}},{"line":1068,"address":[],"length":0,"stats":{"Line":0}},{"line":1069,"address":[],"length":0,"stats":{"Line":0}},{"line":1072,"address":[],"length":0,"stats":{"Line":0}},{"line":1073,"address":[],"length":0,"stats":{"Line":0}},{"line":1079,"address":[],"length":0,"stats":{"Line":0}},{"line":1083,"address":[],"length":0,"stats":{"Line":0}},{"line":1084,"address":[],"length":0,"stats":{"Line":0}},{"line":1086,"address":[],"length":0,"stats":{"Line":0}},{"line":1089,"address":[],"length":0,"stats":{"Line":0}},{"line":1090,"address":[],"length":0,"stats":{"Line":0}},{"line":1091,"address":[],"length":0,"stats":{"Line":0}},{"line":1093,"address":[],"length":0,"stats":{"Line":0}},{"line":1095,"address":[],"length":0,"stats":{"Line":0}},{"line":1096,"address":[],"length":0,"stats":{"Line":0}},{"line":1097,"address":[],"length":0,"stats":{"Line":0}},{"line":1098,"address":[],"length":0,"stats":{"Line":0}},{"line":1102,"address":[],"length":0,"stats":{"Line":0}},{"line":1103,"address":[],"length":0,"stats":{"Line":0}},{"line":1104,"address":[],"length":0,"stats":{"Line":0}},{"line":1105,"address":[],"length":0,"stats":{"Line":0}},{"line":1107,"address":[],"length":0,"stats":{"Line":0}},{"line":1109,"address":[],"length":0,"stats":{"Line":0}},{"line":1110,"address":[],"length":0,"stats":{"Line":0}},{"line":1111,"address":[],"length":0,"stats":{"Line":0}},{"line":1112,"address":[],"length":0,"stats":{"Line":0}},{"line":1116,"address":[],"length":0,"stats":{"Line":0}},{"line":1117,"address":[],"length":0,"stats":{"Line":0}},{"line":1118,"address":[],"length":0,"stats":{"Line":0}},{"line":1119,"address":[],"length":0,"stats":{"Line":0}},{"line":1121,"address":[],"length":0,"stats":{"Line":0}},{"line":1123,"address":[],"length":0,"stats":{"Line":0}},{"line":1124,"address":[],"length":0,"stats":{"Line":0}},{"line":1125,"address":[],"length":0,"stats":{"Line":0}},{"line":1126,"address":[],"length":0,"stats":{"Line":0}},{"line":1129,"address":[],"length":0,"stats":{"Line":0}},{"line":1133,"address":[],"length":0,"stats":{"Line":0}},{"line":1134,"address":[],"length":0,"stats":{"Line":0}},{"line":1137,"address":[],"length":0,"stats":{"Line":0}},{"line":1138,"address":[],"length":0,"stats":{"Line":0}},{"line":1139,"address":[],"length":0,"stats":{"Line":0}},{"line":1140,"address":[],"length":0,"stats":{"Line":0}},{"line":1144,"address":[],"length":0,"stats":{"Line":0}},{"line":1145,"address":[],"length":0,"stats":{"Line":0}},{"line":1146,"address":[],"length":0,"stats":{"Line":0}},{"line":1147,"address":[],"length":0,"stats":{"Line":0}},{"line":1151,"address":[],"length":0,"stats":{"Line":0}},{"line":1152,"address":[],"length":0,"stats":{"Line":0}},{"line":1153,"address":[],"length":0,"stats":{"Line":0}},{"line":1154,"address":[],"length":0,"stats":{"Line":0}},{"line":1158,"address":[],"length":0,"stats":{"Line":0}},{"line":1159,"address":[],"length":0,"stats":{"Line":0}},{"line":1160,"address":[],"length":0,"stats":{"Line":0}},{"line":1161,"address":[],"length":0,"stats":{"Line":0}},{"line":1162,"address":[],"length":0,"stats":{"Line":0}},{"line":1163,"address":[],"length":0,"stats":{"Line":0}},{"line":1164,"address":[],"length":0,"stats":{"Line":0}},{"line":1167,"address":[],"length":0,"stats":{"Line":0}},{"line":1171,"address":[],"length":0,"stats":{"Line":0}},{"line":1172,"address":[],"length":0,"stats":{"Line":0}},{"line":1175,"address":[],"length":0,"stats":{"Line":0}},{"line":1178,"address":[],"length":0,"stats":{"Line":0}},{"line":1179,"address":[],"length":0,"stats":{"Line":0}},{"line":1180,"address":[],"length":0,"stats":{"Line":0}},{"line":1184,"address":[],"length":0,"stats":{"Line":0}},{"line":1186,"address":[],"length":0,"stats":{"Line":0}},{"line":1187,"address":[],"length":0,"stats":{"Line":0}},{"line":1189,"address":[],"length":0,"stats":{"Line":0}},{"line":1190,"address":[],"length":0,"stats":{"Line":0}},{"line":1192,"address":[],"length":0,"stats":{"Line":0}},{"line":1193,"address":[],"length":0,"stats":{"Line":0}},{"line":1195,"address":[],"length":0,"stats":{"Line":0}},{"line":1196,"address":[],"length":0,"stats":{"Line":0}},{"line":1197,"address":[],"length":0,"stats":{"Line":0}},{"line":1198,"address":[],"length":0,"stats":{"Line":0}},{"line":1199,"address":[],"length":0,"stats":{"Line":0}},{"line":1200,"address":[],"length":0,"stats":{"Line":0}},{"line":1201,"address":[],"length":0,"stats":{"Line":0}},{"line":1202,"address":[],"length":0,"stats":{"Line":0}},{"line":1204,"address":[],"length":0,"stats":{"Line":0}},{"line":1205,"address":[],"length":0,"stats":{"Line":0}},{"line":1209,"address":[],"length":0,"stats":{"Line":0}},{"line":1210,"address":[],"length":0,"stats":{"Line":0}},{"line":1215,"address":[],"length":0,"stats":{"Line":0}},{"line":1219,"address":[],"length":0,"stats":{"Line":0}},{"line":1222,"address":[],"length":0,"stats":{"Line":0}},{"line":1223,"address":[],"length":0,"stats":{"Line":0}},{"line":1226,"address":[],"length":0,"stats":{"Line":0}},{"line":1230,"address":[],"length":0,"stats":{"Line":0}},{"line":1231,"address":[],"length":0,"stats":{"Line":0}},{"line":1234,"address":[],"length":0,"stats":{"Line":0}},{"line":1235,"address":[],"length":0,"stats":{"Line":0}},{"line":1237,"address":[],"length":0,"stats":{"Line":0}},{"line":1238,"address":[],"length":0,"stats":{"Line":0}},{"line":1240,"address":[],"length":0,"stats":{"Line":0}},{"line":1242,"address":[],"length":0,"stats":{"Line":0}},{"line":1243,"address":[],"length":0,"stats":{"Line":0}},{"line":1244,"address":[],"length":0,"stats":{"Line":0}},{"line":1245,"address":[],"length":0,"stats":{"Line":0}},{"line":1246,"address":[],"length":0,"stats":{"Line":0}},{"line":1247,"address":[],"length":0,"stats":{"Line":0}},{"line":1254,"address":[],"length":0,"stats":{"Line":0}},{"line":1255,"address":[],"length":0,"stats":{"Line":0}},{"line":1258,"address":[],"length":0,"stats":{"Line":0}},{"line":1261,"address":[],"length":0,"stats":{"Line":0}},{"line":1262,"address":[],"length":0,"stats":{"Line":0}},{"line":1263,"address":[],"length":0,"stats":{"Line":0}},{"line":1267,"address":[],"length":0,"stats":{"Line":0}},{"line":1268,"address":[],"length":0,"stats":{"Line":0}},{"line":1271,"address":[],"length":0,"stats":{"Line":0}},{"line":1272,"address":[],"length":0,"stats":{"Line":0}},{"line":1273,"address":[],"length":0,"stats":{"Line":0}},{"line":1276,"address":[],"length":0,"stats":{"Line":0}},{"line":1277,"address":[],"length":0,"stats":{"Line":0}},{"line":1278,"address":[],"length":0,"stats":{"Line":0}},{"line":1279,"address":[],"length":0,"stats":{"Line":0}},{"line":1282,"address":[],"length":0,"stats":{"Line":0}},{"line":1283,"address":[],"length":0,"stats":{"Line":0}},{"line":1285,"address":[],"length":0,"stats":{"Line":0}},{"line":1286,"address":[],"length":0,"stats":{"Line":0}},{"line":1287,"address":[],"length":0,"stats":{"Line":0}},{"line":1288,"address":[],"length":0,"stats":{"Line":0}},{"line":1292,"address":[],"length":0,"stats":{"Line":0}},{"line":1293,"address":[],"length":0,"stats":{"Line":0}},{"line":1298,"address":[],"length":0,"stats":{"Line":0}},{"line":1299,"address":[],"length":0,"stats":{"Line":0}},{"line":1300,"address":[],"length":0,"stats":{"Line":0}},{"line":1301,"address":[],"length":0,"stats":{"Line":0}},{"line":1303,"address":[],"length":0,"stats":{"Line":0}},{"line":1304,"address":[],"length":0,"stats":{"Line":0}},{"line":1305,"address":[],"length":0,"stats":{"Line":0}},{"line":1306,"address":[],"length":0,"stats":{"Line":0}},{"line":1307,"address":[],"length":0,"stats":{"Line":0}},{"line":1309,"address":[],"length":0,"stats":{"Line":0}},{"line":1312,"address":[],"length":0,"stats":{"Line":0}},{"line":1313,"address":[],"length":0,"stats":{"Line":0}},{"line":1314,"address":[],"length":0,"stats":{"Line":0}},{"line":1315,"address":[],"length":0,"stats":{"Line":0}},{"line":1316,"address":[],"length":0,"stats":{"Line":0}},{"line":1317,"address":[],"length":0,"stats":{"Line":0}},{"line":1318,"address":[],"length":0,"stats":{"Line":0}},{"line":1319,"address":[],"length":0,"stats":{"Line":0}},{"line":1325,"address":[],"length":0,"stats":{"Line":0}},{"line":1326,"address":[],"length":0,"stats":{"Line":0}},{"line":1329,"address":[],"length":0,"stats":{"Line":0}},{"line":1330,"address":[],"length":0,"stats":{"Line":0}},{"line":1331,"address":[],"length":0,"stats":{"Line":0}},{"line":1332,"address":[],"length":0,"stats":{"Line":0}},{"line":1333,"address":[],"length":0,"stats":{"Line":0}},{"line":1334,"address":[],"length":0,"stats":{"Line":0}},{"line":1338,"address":[],"length":0,"stats":{"Line":0}},{"line":1340,"address":[],"length":0,"stats":{"Line":0}},{"line":1343,"address":[],"length":0,"stats":{"Line":0}},{"line":1344,"address":[],"length":0,"stats":{"Line":0}},{"line":1348,"address":[],"length":0,"stats":{"Line":0}},{"line":1349,"address":[],"length":0,"stats":{"Line":0}},{"line":1350,"address":[],"length":0,"stats":{"Line":0}},{"line":1351,"address":[],"length":0,"stats":{"Line":0}},{"line":1352,"address":[],"length":0,"stats":{"Line":0}},{"line":1353,"address":[],"length":0,"stats":{"Line":0}},{"line":1355,"address":[],"length":0,"stats":{"Line":0}},{"line":1356,"address":[],"length":0,"stats":{"Line":0}},{"line":1359,"address":[],"length":0,"stats":{"Line":0}},{"line":1362,"address":[],"length":0,"stats":{"Line":0}},{"line":1363,"address":[],"length":0,"stats":{"Line":0}},{"line":1364,"address":[],"length":0,"stats":{"Line":0}},{"line":1365,"address":[],"length":0,"stats":{"Line":0}},{"line":1367,"address":[],"length":0,"stats":{"Line":0}},{"line":1370,"address":[],"length":0,"stats":{"Line":0}},{"line":1373,"address":[],"length":0,"stats":{"Line":0}},{"line":1374,"address":[],"length":0,"stats":{"Line":0}},{"line":1376,"address":[],"length":0,"stats":{"Line":0}},{"line":1377,"address":[],"length":0,"stats":{"Line":0}},{"line":1378,"address":[],"length":0,"stats":{"Line":0}},{"line":1379,"address":[],"length":0,"stats":{"Line":0}},{"line":1380,"address":[],"length":0,"stats":{"Line":0}},{"line":1381,"address":[],"length":0,"stats":{"Line":0}},{"line":1382,"address":[],"length":0,"stats":{"Line":0}},{"line":1383,"address":[],"length":0,"stats":{"Line":0}},{"line":1384,"address":[],"length":0,"stats":{"Line":0}},{"line":1385,"address":[],"length":0,"stats":{"Line":0}},{"line":1389,"address":[],"length":0,"stats":{"Line":0}},{"line":1390,"address":[],"length":0,"stats":{"Line":0}},{"line":1394,"address":[],"length":0,"stats":{"Line":0}},{"line":1397,"address":[],"length":0,"stats":{"Line":0}},{"line":1398,"address":[],"length":0,"stats":{"Line":0}},{"line":1399,"address":[],"length":0,"stats":{"Line":0}},{"line":1402,"address":[],"length":0,"stats":{"Line":0}},{"line":1403,"address":[],"length":0,"stats":{"Line":0}},{"line":1406,"address":[],"length":0,"stats":{"Line":0}},{"line":1407,"address":[],"length":0,"stats":{"Line":0}},{"line":1408,"address":[],"length":0,"stats":{"Line":0}},{"line":1410,"address":[],"length":0,"stats":{"Line":0}},{"line":1414,"address":[],"length":0,"stats":{"Line":0}},{"line":1415,"address":[],"length":0,"stats":{"Line":0}},{"line":1417,"address":[],"length":0,"stats":{"Line":0}},{"line":1418,"address":[],"length":0,"stats":{"Line":0}},{"line":1422,"address":[],"length":0,"stats":{"Line":0}},{"line":1424,"address":[],"length":0,"stats":{"Line":0}},{"line":1425,"address":[],"length":0,"stats":{"Line":0}},{"line":1428,"address":[],"length":0,"stats":{"Line":0}},{"line":1430,"address":[],"length":0,"stats":{"Line":0}},{"line":1432,"address":[],"length":0,"stats":{"Line":0}},{"line":1434,"address":[],"length":0,"stats":{"Line":0}},{"line":1436,"address":[],"length":0,"stats":{"Line":0}},{"line":1438,"address":[],"length":0,"stats":{"Line":0}},{"line":1441,"address":[],"length":0,"stats":{"Line":0}},{"line":1442,"address":[],"length":0,"stats":{"Line":0}},{"line":1443,"address":[],"length":0,"stats":{"Line":0}},{"line":1444,"address":[],"length":0,"stats":{"Line":0}},{"line":1445,"address":[],"length":0,"stats":{"Line":0}},{"line":1446,"address":[],"length":0,"stats":{"Line":0}},{"line":1447,"address":[],"length":0,"stats":{"Line":0}},{"line":1448,"address":[],"length":0,"stats":{"Line":0}},{"line":1449,"address":[],"length":0,"stats":{"Line":0}},{"line":1455,"address":[],"length":0,"stats":{"Line":0}},{"line":1458,"address":[],"length":0,"stats":{"Line":0}},{"line":1461,"address":[],"length":0,"stats":{"Line":0}},{"line":1467,"address":[],"length":0,"stats":{"Line":0}},{"line":1468,"address":[],"length":0,"stats":{"Line":0}},{"line":1469,"address":[],"length":0,"stats":{"Line":0}},{"line":1470,"address":[],"length":0,"stats":{"Line":0}},{"line":1471,"address":[],"length":0,"stats":{"Line":0}},{"line":1477,"address":[],"length":0,"stats":{"Line":0}},{"line":1478,"address":[],"length":0,"stats":{"Line":0}},{"line":1482,"address":[],"length":0,"stats":{"Line":0}},{"line":1483,"address":[],"length":0,"stats":{"Line":0}},{"line":1486,"address":[],"length":0,"stats":{"Line":0}},{"line":1497,"address":[],"length":0,"stats":{"Line":0}},{"line":1498,"address":[],"length":0,"stats":{"Line":0}},{"line":1499,"address":[],"length":0,"stats":{"Line":0}},{"line":1500,"address":[],"length":0,"stats":{"Line":0}},{"line":1501,"address":[],"length":0,"stats":{"Line":0}},{"line":1502,"address":[],"length":0,"stats":{"Line":0}},{"line":1503,"address":[],"length":0,"stats":{"Line":0}},{"line":1510,"address":[],"length":0,"stats":{"Line":0}},{"line":1517,"address":[],"length":0,"stats":{"Line":0}},{"line":1518,"address":[],"length":0,"stats":{"Line":0}},{"line":1519,"address":[],"length":0,"stats":{"Line":0}},{"line":1520,"address":[],"length":0,"stats":{"Line":0}},{"line":1521,"address":[],"length":0,"stats":{"Line":0}},{"line":1522,"address":[],"length":0,"stats":{"Line":0}},{"line":1523,"address":[],"length":0,"stats":{"Line":0}},{"line":1530,"address":[],"length":0,"stats":{"Line":0}},{"line":1531,"address":[],"length":0,"stats":{"Line":0}},{"line":1532,"address":[],"length":0,"stats":{"Line":0}},{"line":1533,"address":[],"length":0,"stats":{"Line":0}},{"line":1534,"address":[],"length":0,"stats":{"Line":0}},{"line":1535,"address":[],"length":0,"stats":{"Line":0}},{"line":1536,"address":[],"length":0,"stats":{"Line":0}},{"line":1537,"address":[],"length":0,"stats":{"Line":0}},{"line":1542,"address":[],"length":0,"stats":{"Line":0}},{"line":1543,"address":[],"length":0,"stats":{"Line":0}},{"line":1544,"address":[],"length":0,"stats":{"Line":0}},{"line":1545,"address":[],"length":0,"stats":{"Line":0}},{"line":1546,"address":[],"length":0,"stats":{"Line":0}},{"line":1547,"address":[],"length":0,"stats":{"Line":0}},{"line":1552,"address":[],"length":0,"stats":{"Line":0}},{"line":1554,"address":[],"length":0,"stats":{"Line":0}},{"line":1559,"address":[],"length":0,"stats":{"Line":0}},{"line":1560,"address":[],"length":0,"stats":{"Line":0}},{"line":1566,"address":[],"length":0,"stats":{"Line":0}},{"line":1567,"address":[],"length":0,"stats":{"Line":0}},{"line":1570,"address":[],"length":0,"stats":{"Line":0}},{"line":1571,"address":[],"length":0,"stats":{"Line":0}},{"line":1574,"address":[],"length":0,"stats":{"Line":0}},{"line":1575,"address":[],"length":0,"stats":{"Line":0}},{"line":1578,"address":[],"length":0,"stats":{"Line":0}},{"line":1579,"address":[],"length":0,"stats":{"Line":0}},{"line":1582,"address":[],"length":0,"stats":{"Line":0}},{"line":1583,"address":[],"length":0,"stats":{"Line":0}},{"line":1586,"address":[],"length":0,"stats":{"Line":0}},{"line":1587,"address":[],"length":0,"stats":{"Line":0}},{"line":1590,"address":[],"length":0,"stats":{"Line":0}},{"line":1591,"address":[],"length":0,"stats":{"Line":0}},{"line":1594,"address":[],"length":0,"stats":{"Line":0}},{"line":1595,"address":[],"length":0,"stats":{"Line":0}},{"line":1598,"address":[],"length":0,"stats":{"Line":0}},{"line":1599,"address":[],"length":0,"stats":{"Line":0}},{"line":1602,"address":[],"length":0,"stats":{"Line":0}},{"line":1603,"address":[],"length":0,"stats":{"Line":0}},{"line":1606,"address":[],"length":0,"stats":{"Line":0}},{"line":1607,"address":[],"length":0,"stats":{"Line":0}},{"line":1610,"address":[],"length":0,"stats":{"Line":0}},{"line":1611,"address":[],"length":0,"stats":{"Line":0}},{"line":1614,"address":[],"length":0,"stats":{"Line":0}},{"line":1615,"address":[],"length":0,"stats":{"Line":0}},{"line":1618,"address":[],"length":0,"stats":{"Line":0}},{"line":1619,"address":[],"length":0,"stats":{"Line":0}},{"line":1622,"address":[],"length":0,"stats":{"Line":0}},{"line":1623,"address":[],"length":0,"stats":{"Line":0}},{"line":1626,"address":[],"length":0,"stats":{"Line":0}},{"line":1627,"address":[],"length":0,"stats":{"Line":0}},{"line":1630,"address":[],"length":0,"stats":{"Line":0}},{"line":1631,"address":[],"length":0,"stats":{"Line":0}},{"line":1634,"address":[],"length":0,"stats":{"Line":0}},{"line":1635,"address":[],"length":0,"stats":{"Line":0}},{"line":1638,"address":[],"length":0,"stats":{"Line":0}},{"line":1639,"address":[],"length":0,"stats":{"Line":0}},{"line":1642,"address":[],"length":0,"stats":{"Line":0}},{"line":1643,"address":[],"length":0,"stats":{"Line":0}},{"line":1646,"address":[],"length":0,"stats":{"Line":0}},{"line":1647,"address":[],"length":0,"stats":{"Line":0}},{"line":1650,"address":[],"length":0,"stats":{"Line":0}},{"line":1651,"address":[],"length":0,"stats":{"Line":0}},{"line":1654,"address":[],"length":0,"stats":{"Line":0}},{"line":1655,"address":[],"length":0,"stats":{"Line":0}},{"line":1658,"address":[],"length":0,"stats":{"Line":0}},{"line":1659,"address":[],"length":0,"stats":{"Line":0}},{"line":1662,"address":[],"length":0,"stats":{"Line":0}},{"line":1663,"address":[],"length":0,"stats":{"Line":0}},{"line":1665,"address":[],"length":0,"stats":{"Line":0}},{"line":1666,"address":[],"length":0,"stats":{"Line":0}},{"line":1669,"address":[],"length":0,"stats":{"Line":0}},{"line":1670,"address":[],"length":0,"stats":{"Line":0}},{"line":1673,"address":[],"length":0,"stats":{"Line":0}},{"line":1674,"address":[],"length":0,"stats":{"Line":0}},{"line":1676,"address":[],"length":0,"stats":{"Line":0}},{"line":1677,"address":[],"length":0,"stats":{"Line":0}},{"line":1680,"address":[],"length":0,"stats":{"Line":0}},{"line":1681,"address":[],"length":0,"stats":{"Line":0}},{"line":1683,"address":[],"length":0,"stats":{"Line":0}},{"line":1684,"address":[],"length":0,"stats":{"Line":0}},{"line":1687,"address":[],"length":0,"stats":{"Line":0}},{"line":1688,"address":[],"length":0,"stats":{"Line":0}},{"line":1690,"address":[],"length":0,"stats":{"Line":0}},{"line":1694,"address":[],"length":0,"stats":{"Line":2}},{"line":1696,"address":[],"length":0,"stats":{"Line":2}},{"line":1698,"address":[],"length":0,"stats":{"Line":12}},{"line":1699,"address":[],"length":0,"stats":{"Line":2}},{"line":1700,"address":[],"length":0,"stats":{"Line":2}},{"line":1706,"address":[],"length":0,"stats":{"Line":0}},{"line":1707,"address":[],"length":0,"stats":{"Line":0}},{"line":1708,"address":[],"length":0,"stats":{"Line":0}},{"line":1712,"address":[],"length":0,"stats":{"Line":0}},{"line":1716,"address":[],"length":0,"stats":{"Line":0}},{"line":1717,"address":[],"length":0,"stats":{"Line":0}},{"line":1724,"address":[],"length":0,"stats":{"Line":0}},{"line":1725,"address":[],"length":0,"stats":{"Line":0}}],"covered":102,"coverable":866},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","platform","client.rs"],"content":"//! HTTP client for video platform API requests\n\nuse crate::error::RytError;\nuse reqwest::{Client, ClientBuilder};\nuse std::time::Duration;\nuse tracing::{info, debug, warn, error};\n\n/// Client types for realistic header emulation\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum ClientType {\n    Chrome,\n    Firefox,\n    Safari,\n    Android,\n    Ios,\n    Edge,\n    Opera,\n    SamsungBrowser,\n    AndroidTV,\n    SmartTV,\n}\n\nimpl ClientType {\n    /// Get all available client types\n    pub fn all() -\u003e Vec\u003cClientType\u003e {\n        vec![\n            ClientType::Chrome,\n            ClientType::Firefox,\n            ClientType::Safari,\n            ClientType::Android,\n            ClientType::Ios,\n            ClientType::Edge,\n            ClientType::Opera,\n            ClientType::SamsungBrowser,\n            ClientType::AndroidTV,\n            ClientType::SmartTV,\n        ]\n    }\n\n    /// Get client type from string\n    pub fn from_str(s: \u0026str) -\u003e Option\u003cClientType\u003e {\n        match s.to_lowercase().as_str() {\n            \"chrome\" =\u003e Some(ClientType::Chrome),\n            \"firefox\" =\u003e Some(ClientType::Firefox),\n            \"safari\" =\u003e Some(ClientType::Safari),\n            \"android\" =\u003e Some(ClientType::Android),\n            \"ios\" =\u003e Some(ClientType::Ios),\n            \"edge\" =\u003e Some(ClientType::Edge),\n            \"opera\" =\u003e Some(ClientType::Opera),\n            \"samsung\" =\u003e Some(ClientType::SamsungBrowser),\n            \"androidtv\" =\u003e Some(ClientType::AndroidTV),\n            \"smarttv\" =\u003e Some(ClientType::SmartTV),\n            _ =\u003e None,\n        }\n    }\n\n    /// Convert to string\n    pub fn to_string(\u0026self) -\u003e String {\n        match self {\n            ClientType::Chrome =\u003e \"chrome\".to_string(),\n            ClientType::Firefox =\u003e \"firefox\".to_string(),\n            ClientType::Safari =\u003e \"safari\".to_string(),\n            ClientType::Android =\u003e \"android\".to_string(),\n            ClientType::Ios =\u003e \"ios\".to_string(),\n            ClientType::Edge =\u003e \"edge\".to_string(),\n            ClientType::Opera =\u003e \"opera\".to_string(),\n            ClientType::SamsungBrowser =\u003e \"samsung\".to_string(),\n            ClientType::AndroidTV =\u003e \"androidtv\".to_string(),\n            ClientType::SmartTV =\u003e \"smarttv\".to_string(),\n        }\n    }\n\n    /// Check if this is a mobile client\n    pub fn is_mobile(\u0026self) -\u003e bool {\n        matches!(self, ClientType::Android | ClientType::Ios | ClientType::SamsungBrowser)\n    }\n\n    /// Check if this is a web client\n    pub fn is_web(\u0026self) -\u003e bool {\n        matches!(self, ClientType::Chrome | ClientType::Firefox | ClientType::Safari | ClientType::Edge | ClientType::Opera)\n    }\n\n    /// Check if this is a TV client\n    pub fn is_tv(\u0026self) -\u003e bool {\n        matches!(self, ClientType::AndroidTV | ClientType::SmartTV)\n    }\n}\n\n/// HTTP client configuration\n#[derive(Debug, Clone)]\npub struct HttpClientConfig {\n    /// Request timeout\n    pub timeout: Duration,\n    /// Maximum retries\n    pub max_retries: u32,\n    /// User agent string\n    pub user_agent: Option\u003cString\u003e,\n    /// Proxy URL\n    pub proxy_url: Option\u003cString\u003e,\n    /// Current client type\n    pub client_type: ClientType,\n    /// Enable client switching\n    pub enable_client_switching: bool,\n    /// Client switching strategy\n    pub switching_strategy: ClientSwitchingStrategy,\n    /// Force HTTP/1.1 only (disable HTTP/2)\n    pub http1_only: bool,\n}\n\n/// Client switching strategy\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum ClientSwitchingStrategy {\n    /// Round-robin switching\n    RoundRobin,\n    /// Random switching\n    Random,\n    /// Switch on error (403, rate limit)\n    OnError,\n    /// Switch on geographic restrictions\n    OnGeoBlock,\n    /// Smart switching based on response\n    Smart,\n}\n\nimpl Default for ClientSwitchingStrategy {\n    fn default() -\u003e Self {\n        Self::Smart\n    }\n}\n\nimpl Default for HttpClientConfig {\n    fn default() -\u003e Self {\n        Self {\n            timeout: Duration::from_secs(30),\n            max_retries: 3,\n            user_agent: None,\n            proxy_url: None,\n            client_type: ClientType::Chrome,\n            enable_client_switching: true,\n            switching_strategy: ClientSwitchingStrategy::default(),\n            http1_only: false,  // HTTP/2 by default\n        }\n    }\n}\n\n/// YouTube HTTP client\npub struct VideoClient {\n    client: Client,\n    config: HttpClientConfig,\n    current_client_index: usize,\n    client_switch_count: u32,\n}\n\nimpl VideoClient {\n    /// Create a new YouTube client with default configuration\n    pub fn new() -\u003e Self {\n        Self::with_config(HttpClientConfig::default())\n    }\n\n    /// Create a new YouTube client with custom configuration\n    pub fn with_config(config: HttpClientConfig) -\u003e Self {\n        let mut builder = ClientBuilder::new()\n            .timeout(config.timeout)\n            .gzip(true)\n            .brotli(true);\n\n        // Force HTTP/1.1 if requested (for media downloads, matches Go ytdlp)\n        if config.http1_only {\n            builder = builder.http1_only();\n        }\n\n        // Set user agent\n        if let Some(user_agent) = \u0026config.user_agent {\n            builder = builder.user_agent(user_agent);\n        } else {\n            // Default Android user agent\n            builder = builder.user_agent(\"com.google.android.youtube/20.10.38 (Linux; U; Android 11) gzip\");\n        }\n\n        // Set proxy\n        if let Some(proxy_url) = \u0026config.proxy_url {\n            if let Ok(proxy) = reqwest::Proxy::all(proxy_url) {\n                builder = builder.proxy(proxy);\n            }\n        }\n\n        let client = builder.build().expect(\"Failed to build HTTP client\");\n\n        Self { \n            client, \n            config,\n            current_client_index: 0,\n            client_switch_count: 0,\n        }\n    }\n\n    /// Get the underlying HTTP client\n    pub fn client(\u0026self) -\u003e \u0026Client {\n        \u0026self.client\n    }\n\n    /// Get current client type\n    pub fn current_client_type(\u0026self) -\u003e ClientType {\n        self.config.client_type\n    }\n\n            /// Switch to next client type\n            pub fn switch_client(\u0026mut self) -\u003e ClientType {\n                if !self.config.enable_client_switching {\n                    return self.config.client_type;\n                }\n\n                let available_clients = ClientType::all();\n                self.current_client_index = (self.current_client_index + 1) % available_clients.len();\n                self.client_switch_count += 1;\n                \n                let new_client_type = available_clients[self.current_client_index];\n                self.config.client_type = new_client_type;\n                \n                info!(\"Switched to client type: {:?} (switch #{}\", new_client_type, self.client_switch_count);\n                new_client_type\n            }\n\n    /// Switch to specific client type\n    pub fn switch_to_client(\u0026mut self, client_type: ClientType) {\n        self.config.client_type = client_type;\n        self.client_switch_count += 1;\n        \n        // Update index\n        let available_clients = ClientType::all();\n        if let Some(index) = available_clients.iter().position(|\u0026c| c == client_type) {\n            self.current_client_index = index;\n        }\n        \n        info!(\"Switched to specific client type: {:?} (switch #{})\", client_type, self.client_switch_count);\n    }\n\n    /// Switch client based on strategy\n    pub fn switch_client_by_strategy(\u0026mut self, error: Option\u003c\u0026RytError\u003e) -\u003e ClientType {\n        match self.config.switching_strategy {\n            ClientSwitchingStrategy::RoundRobin =\u003e self.switch_client(),\n            ClientSwitchingStrategy::Random =\u003e {\n                use rand::Rng;\n                let available_clients = ClientType::all();\n                let random_index = rand::thread_rng().gen_range(0..available_clients.len());\n                let new_client_type = available_clients[random_index];\n                self.switch_to_client(new_client_type);\n                new_client_type\n            }\n            ClientSwitchingStrategy::OnError =\u003e {\n                if let Some(err) = error {\n                    match err {\n                        RytError::RateLimited | RytError::BotguardError(_) =\u003e {\n                            // Switch to mobile client for better success rate\n                            if self.config.client_type.is_web() {\n                                self.switch_to_client(ClientType::Android);\n                                ClientType::Android\n                            } else {\n                                self.switch_client()\n                            }\n                        }\n                        RytError::AgeRestricted =\u003e {\n                            // Switch to mobile client to bypass age restrictions\n                            if self.config.client_type.is_web() {\n                                self.switch_to_client(ClientType::Android);\n                                ClientType::Android\n                            } else {\n                                self.switch_client()\n                            }\n                        }\n                        _ =\u003e self.config.client_type,\n                    }\n                } else {\n                    self.config.client_type\n                }\n            }\n            ClientSwitchingStrategy::OnGeoBlock =\u003e {\n                if let Some(err) = error {\n                    match err {\n                        RytError::VideoUnavailable =\u003e {\n                            // Switch to mobile client to bypass geo-blocking\n                            if self.config.client_type.is_web() {\n                                self.switch_to_client(ClientType::Android);\n                                ClientType::Android\n                            } else {\n                                self.switch_client()\n                            }\n                        }\n                        _ =\u003e self.config.client_type,\n                    }\n                } else {\n                    self.config.client_type\n                }\n            }\n            ClientSwitchingStrategy::Smart =\u003e {\n                // Smart switching: combine multiple strategies\n                if let Some(err) = error {\n                    match err {\n                        RytError::RateLimited | RytError::BotguardError(_) =\u003e {\n                            // Always switch to next client for rate limiting\n                            self.switch_client()\n                        }\n                        RytError::VideoUnavailable =\u003e {\n                            // Always switch to next client for video unavailable\n                            self.switch_client()\n                        }\n                        RytError::AgeRestricted =\u003e {\n                            // Switch to mobile client to bypass age restrictions\n                            if self.config.client_type.is_web() {\n                                self.switch_to_client(ClientType::Android);\n                                ClientType::Android\n                            } else {\n                                self.switch_client()\n                            }\n                        }\n                        _ =\u003e self.switch_client(),\n                    }\n                } else {\n                    // No error, use round-robin\n                    self.switch_client()\n                }\n            }\n        }\n    }\n\n    /// Get client switch count\n    pub fn client_switch_count(\u0026self) -\u003e u32 {\n        self.client_switch_count\n    }\n\n    /// Reset client switching\n    pub fn reset_client_switching(\u0026mut self) {\n        self.current_client_index = 0;\n        self.client_switch_count = 0;\n        self.config.client_type = ClientType::Chrome;\n    }\n\n    /// Get client configuration\n    pub fn config(\u0026self) -\u003e \u0026HttpClientConfig {\n        \u0026self.config\n    }\n\n    /// Create a request with common YouTube headers\n    pub fn create_request(\u0026self, method: reqwest::Method, url: \u0026str) -\u003e reqwest::RequestBuilder {\n        self.client\n            .request(method, url)\n            .header(\"Accept\", \"*/*\")\n            .header(\"Accept-Language\", \"en-US,en;q=0.9\")\n            .header(\"Accept-Encoding\", \"gzip, deflate, br\")\n            .header(\"Connection\", \"keep-alive\")\n            .header(\"Cache-Control\", \"no-cache\")\n            .header(\"DNT\", \"1\")\n            .header(\"Upgrade-Insecure-Requests\", \"1\")\n            .header(\"Sec-Fetch-Dest\", \"document\")\n            .header(\"Sec-Fetch-Mode\", \"navigate\")\n            .header(\"Sec-Fetch-Site\", \"none\")\n            .header(\"Sec-Fetch-User\", \"?1\")\n    }\n\n    /// Create a request with realistic browser headers using current client type\n    pub fn create_realistic_request(\u0026self, method: reqwest::Method, url: \u0026str) -\u003e reqwest::RequestBuilder {\n        self.create_realistic_request_with_client(method, url, self.config.client_type)\n    }\n    \n    /// Create a simple request for media downloads (googlevideo.com) without browser-specific headers\n    pub fn create_simple_media_request(\u0026self, method: reqwest::Method, url: \u0026str) -\u003e reqwest::RequestBuilder {\n        // Use minimal headers for media downloads to avoid 403 errors\n        // Match Go ytdlp exactly: User-Agent, Accept, Accept-Encoding, Connection, Cache-Control\n        self.client\n            .request(method, url)\n            .header(\"User-Agent\", \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36\")\n            .header(\"Accept\", \"*/*\")\n            .header(\"Accept-Encoding\", \"identity\")\n            .header(\"Connection\", \"keep-alive\")\n            .header(\"Cache-Control\", \"no-cache\")\n    }\n\n    /// Create a request with realistic browser headers for specific client type\n    pub fn create_realistic_request_with_client(\u0026self, method: reqwest::Method, url: \u0026str, client_type: ClientType) -\u003e reqwest::RequestBuilder {\n        let (user_agent, headers) = match client_type {\n            ClientType::Chrome =\u003e (\n                \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n                vec![\n                    (\"Sec-Ch-Ua\", r#\"\"Not_A Brand\";v=\"8\", \"Chromium\";v=\"120\", \"Google Chrome\";v=\"120\"\"#),\n                    (\"Sec-Ch-Ua-Mobile\", \"?0\"),\n                    (\"Sec-Ch-Ua-Platform\", r#\"\"Windows\"\"#),\n                ]\n            ),\n            ClientType::Firefox =\u003e (\n                \"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0\",\n                vec![\n                    (\"Sec-Fetch-Dest\", \"document\"),\n                    (\"Sec-Fetch-Mode\", \"navigate\"),\n                    (\"Sec-Fetch-Site\", \"none\"),\n                    (\"Sec-Fetch-User\", \"?1\"),\n                ]\n            ),\n            ClientType::Safari =\u003e (\n                \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.1 Safari/605.1.15\",\n                vec![\n                    (\"Sec-Fetch-Dest\", \"document\"),\n                    (\"Sec-Fetch-Mode\", \"navigate\"),\n                    (\"Sec-Fetch-Site\", \"none\"),\n                    (\"Sec-Fetch-User\", \"?1\"),\n                ]\n            ),\n            ClientType::Android =\u003e (\n                \"Mozilla/5.0 (Linux; Android 11; SM-G973F) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Mobile Safari/537.36\",\n                vec![\n                    (\"Sec-Ch-Ua-Mobile\", \"?1\"),\n                    (\"Sec-Ch-Ua-Platform\", r#\"\"Android\"\"#),\n                ]\n            ),\n            ClientType::Ios =\u003e (\n                \"Mozilla/5.0 (iPhone; CPU iPhone OS 17_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.1 Mobile/15E148 Safari/604.1\",\n                vec![\n                    (\"Sec-Ch-Ua-Mobile\", \"?1\"),\n                    (\"Sec-Ch-Ua-Platform\", r#\"\"iOS\"\"#),\n                ]\n            ),\n            ClientType::Edge =\u003e (\n                \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36 Edg/120.0.0.0\",\n                vec![\n                    (\"Sec-Ch-Ua\", r#\"\"Not_A Brand\";v=\"8\", \"Chromium\";v=\"120\", \"Microsoft Edge\";v=\"120\"\"#),\n                    (\"Sec-Ch-Ua-Mobile\", \"?0\"),\n                    (\"Sec-Ch-Ua-Platform\", r#\"\"Windows\"\"#),\n                ]\n            ),\n            ClientType::Opera =\u003e (\n                \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36 OPR/106.0.0.0\",\n                vec![\n                    (\"Sec-Ch-Ua\", r#\"\"Not_A Brand\";v=\"8\", \"Chromium\";v=\"120\", \"Opera\";v=\"106\"\"#),\n                    (\"Sec-Ch-Ua-Mobile\", \"?0\"),\n                    (\"Sec-Ch-Ua-Platform\", r#\"\"Windows\"\"#),\n                ]\n            ),\n            ClientType::SamsungBrowser =\u003e (\n                \"Mozilla/5.0 (Linux; Android 12; SM-G998B) AppleWebKit/537.36 (KHTML, like Gecko) SamsungBrowser/22.0 Chrome/120.0.0.0 Mobile Safari/537.36\",\n                vec![\n                    (\"Sec-Ch-Ua-Mobile\", \"?1\"),\n                    (\"Sec-Ch-Ua-Platform\", r#\"\"Android\"\"#),\n                ]\n            ),\n            ClientType::AndroidTV =\u003e (\n                \"Mozilla/5.0 (Linux; Android 11; ADT-3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n                vec![\n                    (\"Sec-Ch-Ua-Mobile\", \"?0\"),\n                    (\"Sec-Ch-Ua-Platform\", r#\"\"Android\"\"#),\n                ]\n            ),\n            ClientType::SmartTV =\u003e (\n                \"Mozilla/5.0 (Web0S; Linux/SmartTV) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n                vec![\n                    (\"Sec-Ch-Ua-Mobile\", \"?0\"),\n                    (\"Sec-Ch-Ua-Platform\", r#\"\"Linux\"\"#),\n                ]\n            ),\n        };\n\n        let mut request = self.client\n            .request(method, url)\n            .header(\"User-Agent\", user_agent)\n            .header(\"Accept\", \"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\")\n            .header(\"Accept-Language\", \"en-US,en;q=0.9\")\n            .header(\"Accept-Encoding\", \"gzip, deflate, br\")\n            .header(\"Connection\", \"keep-alive\")\n            .header(\"Cache-Control\", \"no-cache\")\n            .header(\"DNT\", \"1\")\n            .header(\"Upgrade-Insecure-Requests\", \"1\");\n\n        // Add client-specific headers\n        for (name, value) in headers {\n            request = request.header(name, value);\n        }\n\n        request\n    }\n\n    /// Create a request for InnerTube API with client-specific headers\n    pub fn create_innertube_request(\u0026self, url: \u0026str) -\u003e reqwest::RequestBuilder {\n        // Add INNERTUBE_API_KEY to URL based on client type\n        let (api_key, client_name, client_version) = match self.config.client_type {\n            ClientType::Chrome | ClientType::Firefox | ClientType::Safari | ClientType::Edge | ClientType::Opera =\u003e {\n                (\"AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8\", \"1\", \"2.20251002.00.00\")\n            }\n            ClientType::Android | ClientType::SamsungBrowser | ClientType::AndroidTV =\u003e {\n                (\"AIzaSyA8eiZmM1FaDVjRy-df2KTyQ_vz_yYM39w\", \"3\", \"20.10.38\")\n            }\n            ClientType::Ios =\u003e {\n                (\"AIzaSyBUPetSUmoZL-OhlxA7wSac5XinrygCqMo\", \"5\", \"20.10.38\")\n            }\n            ClientType::SmartTV =\u003e {\n                (\"AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8\", \"1\", \"2.20251002.00.00\")\n            }\n        };\n        \n        let url_with_key = if url.contains('?') {\n            format!(\"{}\u0026key={}\", url, api_key)\n        } else {\n            format!(\"{}?key={}\", url, api_key)\n        };\n        \n        let mut request = self.create_request(reqwest::Method::POST, \u0026url_with_key)\n            .header(\"Content-Type\", \"application/json\")\n            .header(\"X-YouTube-Client-Name\", client_name)\n            .header(\"X-YouTube-Client-Version\", client_version);\n\n        // Add device-specific headers based on client type\n        match self.config.client_type {\n            ClientType::Android =\u003e {\n                request = request\n                    .header(\"X-YouTube-Device-Model\", \"SM-G973F\")\n                    .header(\"X-YouTube-Device-Os\", \"Android\")\n                    .header(\"X-YouTube-Device-Os-Version\", \"11\")\n                    .header(\"X-YouTube-Device-Connection-Type\", \"WIFI\")\n                    .header(\"X-YouTube-Device-Memory-Mb\", \"4096\")\n                    .header(\"X-YouTube-Device-Display-Density\", \"420\")\n                    .header(\"X-YouTube-Device-Display-Height\", \"2280\")\n                    .header(\"X-YouTube-Device-Display-Width\", \"1080\")\n                    .header(\"X-YouTube-Device-Cpu-Cores\", \"8\")\n                    .header(\"X-YouTube-Device-Cpu-Model\", \"Exynos 9820\")\n                    .header(\"X-YouTube-Device-Gpu-Model\", \"Mali-G76 MP12\")\n                    .header(\"X-YouTube-Device-Gpu-Version\", \"OpenGL ES 3.2\")\n                    .header(\"X-YouTube-Device-Screen-Density\", \"420\")\n                    .header(\"X-YouTube-Device-Screen-Height\", \"2280\")\n                    .header(\"X-YouTube-Device-Screen-Width\", \"1080\")\n                    .header(\"X-YouTube-Device-Timezone\", \"UTC\")\n                    .header(\"X-YouTube-Device-Language\", \"en\")\n                    .header(\"X-YouTube-Device-Country\", \"US\")\n                    .header(\"X-YouTube-Device-Region\", \"US\")\n                    .header(\"X-YouTube-Device-Carrier\", \"Unknown\")\n                    .header(\"X-YouTube-Device-Network-Type\", \"WIFI\")\n                    .header(\"X-YouTube-Device-Network-Speed\", \"1000000\")\n                    .header(\"X-YouTube-Device-Network-Signal\", \"4\")\n                    .header(\"X-YouTube-Device-Battery-Level\", \"100\")\n                    .header(\"X-YouTube-Device-Battery-Charging\", \"false\")\n                    .header(\"X-YouTube-Device-Volume\", \"100\")\n                    .header(\"X-YouTube-Device-Brightness\", \"100\")\n                    .header(\"X-YouTube-Device-Orientation\", \"portrait\")\n                    .header(\"X-YouTube-Device-Accelerometer\", \"true\")\n                    .header(\"X-YouTube-Device-Gyroscope\", \"true\")\n                    .header(\"X-YouTube-Device-Magnetometer\", \"true\")\n                    .header(\"X-YouTube-Device-Proximity\", \"false\")\n                    .header(\"X-YouTube-Device-Light\", \"true\")\n                    .header(\"X-YouTube-Device-Pressure\", \"false\")\n                    .header(\"X-YouTube-Device-Temperature\", \"false\")\n                    .header(\"X-YouTube-Device-Humidity\", \"false\")\n                    .header(\"X-YouTube-Device-Altitude\", \"0\")\n                    .header(\"X-YouTube-Device-Latitude\", \"0\")\n                    .header(\"X-YouTube-Device-Longitude\", \"0\")\n                    .header(\"X-YouTube-Device-Accuracy\", \"0\")\n                    .header(\"X-YouTube-Device-Speed\", \"0\")\n                    .header(\"X-YouTube-Device-Heading\", \"0\")\n                    .header(\"X-YouTube-Device-Timestamp\", \"0\");\n            }\n            ClientType::Ios =\u003e {\n                request = request\n                    .header(\"X-YouTube-Device-Model\", \"iPhone13,2\")\n                    .header(\"X-YouTube-Device-Os\", \"iOS\")\n                    .header(\"X-YouTube-Device-Os-Version\", \"17.1\")\n                    .header(\"X-YouTube-Device-Connection-Type\", \"WIFI\")\n                    .header(\"X-YouTube-Device-Memory-Mb\", \"6144\")\n                    .header(\"X-YouTube-Device-Display-Density\", \"460\")\n                    .header(\"X-YouTube-Device-Display-Height\", \"2532\")\n                    .header(\"X-YouTube-Device-Display-Width\", \"1170\")\n                    .header(\"X-YouTube-Device-Cpu-Cores\", \"6\")\n                    .header(\"X-YouTube-Device-Cpu-Model\", \"A15 Bionic\")\n                    .header(\"X-YouTube-Device-Gpu-Model\", \"Apple GPU\")\n                    .header(\"X-YouTube-Device-Gpu-Version\", \"Metal\")\n                    .header(\"X-YouTube-Device-Screen-Density\", \"460\")\n                    .header(\"X-YouTube-Device-Screen-Height\", \"2532\")\n                    .header(\"X-YouTube-Device-Screen-Width\", \"1170\")\n                    .header(\"X-YouTube-Device-Timezone\", \"UTC\")\n                    .header(\"X-YouTube-Device-Language\", \"en\")\n                    .header(\"X-YouTube-Device-Country\", \"US\")\n                    .header(\"X-YouTube-Device-Region\", \"US\")\n                    .header(\"X-YouTube-Device-Carrier\", \"Unknown\")\n                    .header(\"X-YouTube-Device-Network-Type\", \"WIFI\")\n                    .header(\"X-YouTube-Device-Network-Speed\", \"1000000\")\n                    .header(\"X-YouTube-Device-Network-Signal\", \"4\")\n                    .header(\"X-YouTube-Device-Battery-Level\", \"100\")\n                    .header(\"X-YouTube-Device-Battery-Charging\", \"false\")\n                    .header(\"X-YouTube-Device-Volume\", \"100\")\n                    .header(\"X-YouTube-Device-Brightness\", \"100\")\n                    .header(\"X-YouTube-Device-Orientation\", \"portrait\")\n                    .header(\"X-YouTube-Device-Accelerometer\", \"true\")\n                    .header(\"X-YouTube-Device-Gyroscope\", \"true\")\n                    .header(\"X-YouTube-Device-Magnetometer\", \"true\")\n                    .header(\"X-YouTube-Device-Proximity\", \"true\")\n                    .header(\"X-YouTube-Device-Light\", \"true\")\n                    .header(\"X-YouTube-Device-Pressure\", \"false\")\n                    .header(\"X-YouTube-Device-Temperature\", \"false\")\n                    .header(\"X-YouTube-Device-Humidity\", \"false\")\n                    .header(\"X-YouTube-Device-Altitude\", \"0\")\n                    .header(\"X-YouTube-Device-Latitude\", \"0\")\n                    .header(\"X-YouTube-Device-Longitude\", \"0\")\n                    .header(\"X-YouTube-Device-Accuracy\", \"0\")\n                    .header(\"X-YouTube-Device-Speed\", \"0\")\n                    .header(\"X-YouTube-Device-Heading\", \"0\")\n                    .header(\"X-YouTube-Device-Timestamp\", \"0\");\n            }\n            _ =\u003e {\n                // Web clients don't need device headers\n            }\n        }\n\n        request\n    }\n\n            /// Execute request with retry logic and client switching\n            pub async fn execute_with_retry\u003cT\u003e(\u0026mut self, request: reqwest::RequestBuilder) -\u003e Result\u003cT, RytError\u003e\n            where\n                T: serde::de::DeserializeOwned,\n            {\n                let mut last_error = None;\n                \n                for attempt in 0..self.config.max_retries {\n                    debug!(\"HTTP request attempt {}/{}\", attempt + 1, self.config.max_retries);\n                    \n                    match request.try_clone().unwrap().send().await {\n                        Ok(response) =\u003e {\n                            if response.status().is_success() {\n                                debug!(\"HTTP request successful\");\n                                return Ok(response.json().await?);\n                            } else if response.status() == 403 {\n                                // Check if this is a botguard challenge\n                                let response_text = response.text().await.unwrap_or_default();\n                                if response_text.contains(\"botguard\") || response_text.contains(\"challenge\") {\n                                    warn!(\"Botguard challenge detected\");\n                                    let error = RytError::BotguardError(\"Botguard challenge detected\".to_string());\n                                    // Try switching client if enabled\n                                    if self.config.enable_client_switching {\n                                        self.switch_client_by_strategy(Some(\u0026error));\n                                    }\n                                    return Err(error);\n                                }\n                                warn!(\"Rate limited (403), switching client\");\n                                let error = RytError::RateLimited;\n                                // Try switching client if enabled\n                                if self.config.enable_client_switching {\n                                    self.switch_client_by_strategy(Some(\u0026error));\n                                }\n                                return Err(error);\n                            } else if response.status() == 404 {\n                                warn!(\"Video unavailable (404), switching client\");\n                                let error = RytError::VideoUnavailable;\n                                // Try switching client if enabled\n                                if self.config.enable_client_switching {\n                                    self.switch_client_by_strategy(Some(\u0026error));\n                                }\n                                return Err(error);\n                            } else {\n                                warn!(\"HTTP request failed with status: {}\", response.status());\n                                last_error = Some(RytError::DownloadFailed(\n                                    reqwest::Error::from(response.error_for_status().unwrap_err())\n                                ));\n                            }\n                        }\n                        Err(e) =\u003e {\n                            warn!(\"HTTP request error: {}\", e);\n                            last_error = Some(RytError::DownloadFailed(e));\n                        }\n                    }\n\n                    // Exponential backoff\n                    if attempt \u003c self.config.max_retries - 1 {\n                        let delay = Duration::from_millis(200 * (1 \u003c\u003c attempt));\n                        debug!(\"Retrying in {:?}\", delay);\n                        tokio::time::sleep(delay).await;\n                    }\n                }\n\n                error!(\"All retry attempts failed\");\n                Err(last_error.unwrap_or(RytError::Generic(\"Request failed\".to_string())))\n            }\n}\n\nimpl Default for VideoClient {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_client_creation() {\n        let client = VideoClient::new();\n        assert_eq!(client.config().timeout, Duration::from_secs(30));\n        assert_eq!(client.config().max_retries, 3);\n    }\n\n    #[test]\n    fn test_client_with_config() {\n        let config = HttpClientConfig {\n            timeout: Duration::from_secs(60),\n            max_retries: 5,\n            user_agent: Some(\"Custom Agent\".to_string()),\n            proxy_url: None,\n            client_type: ClientType::Chrome,\n            http1_only: false,\n            enable_client_switching: true,\n            switching_strategy: ClientSwitchingStrategy::Smart,\n        };\n\n        let client = VideoClient::with_config(config);\n        assert_eq!(client.config().timeout, Duration::from_secs(60));\n        assert_eq!(client.config().max_retries, 5);\n        assert_eq!(client.config().user_agent, Some(\"Custom Agent\".to_string()));\n    }\n}\n","traces":[{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":12}},{"line":127,"address":[],"length":0,"stats":{"Line":12}},{"line":132,"address":[],"length":0,"stats":{"Line":12}},{"line":134,"address":[],"length":0,"stats":{"Line":24}},{"line":140,"address":[],"length":0,"stats":{"Line":12}},{"line":156,"address":[],"length":0,"stats":{"Line":7}},{"line":157,"address":[],"length":0,"stats":{"Line":14}},{"line":161,"address":[],"length":0,"stats":{"Line":13}},{"line":162,"address":[],"length":0,"stats":{"Line":26}},{"line":163,"address":[],"length":0,"stats":{"Line":26}},{"line":168,"address":[],"length":0,"stats":{"Line":18}},{"line":169,"address":[],"length":0,"stats":{"Line":10}},{"line":173,"address":[],"length":0,"stats":{"Line":14}},{"line":177,"address":[],"length":0,"stats":{"Line":24}},{"line":181,"address":[],"length":0,"stats":{"Line":13}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":65}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":5}},{"line":340,"address":[],"length":0,"stats":{"Line":5}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":498,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":509,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":543,"address":[],"length":0,"stats":{"Line":0}},{"line":544,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":551,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":553,"address":[],"length":0,"stats":{"Line":0}},{"line":554,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":563,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":567,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":571,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":0}},{"line":573,"address":[],"length":0,"stats":{"Line":0}},{"line":574,"address":[],"length":0,"stats":{"Line":0}},{"line":575,"address":[],"length":0,"stats":{"Line":0}},{"line":576,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":579,"address":[],"length":0,"stats":{"Line":0}},{"line":580,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":582,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":585,"address":[],"length":0,"stats":{"Line":0}},{"line":586,"address":[],"length":0,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":0}},{"line":591,"address":[],"length":0,"stats":{"Line":0}},{"line":592,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":597,"address":[],"length":0,"stats":{"Line":0}},{"line":598,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":607,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":617,"address":[],"length":0,"stats":{"Line":0}},{"line":618,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":621,"address":[],"length":0,"stats":{"Line":0}},{"line":622,"address":[],"length":0,"stats":{"Line":0}},{"line":623,"address":[],"length":0,"stats":{"Line":0}},{"line":624,"address":[],"length":0,"stats":{"Line":0}},{"line":625,"address":[],"length":0,"stats":{"Line":0}},{"line":627,"address":[],"length":0,"stats":{"Line":0}},{"line":628,"address":[],"length":0,"stats":{"Line":0}},{"line":629,"address":[],"length":0,"stats":{"Line":0}},{"line":630,"address":[],"length":0,"stats":{"Line":0}},{"line":632,"address":[],"length":0,"stats":{"Line":0}},{"line":633,"address":[],"length":0,"stats":{"Line":0}},{"line":635,"address":[],"length":0,"stats":{"Line":0}},{"line":637,"address":[],"length":0,"stats":{"Line":0}},{"line":638,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":641,"address":[],"length":0,"stats":{"Line":0}},{"line":643,"address":[],"length":0,"stats":{"Line":0}},{"line":644,"address":[],"length":0,"stats":{"Line":0}},{"line":645,"address":[],"length":0,"stats":{"Line":0}},{"line":646,"address":[],"length":0,"stats":{"Line":0}},{"line":648,"address":[],"length":0,"stats":{"Line":0}},{"line":649,"address":[],"length":0,"stats":{"Line":0}},{"line":651,"address":[],"length":0,"stats":{"Line":0}},{"line":653,"address":[],"length":0,"stats":{"Line":0}},{"line":654,"address":[],"length":0,"stats":{"Line":0}},{"line":655,"address":[],"length":0,"stats":{"Line":0}},{"line":659,"address":[],"length":0,"stats":{"Line":0}},{"line":660,"address":[],"length":0,"stats":{"Line":0}},{"line":661,"address":[],"length":0,"stats":{"Line":0}},{"line":666,"address":[],"length":0,"stats":{"Line":0}},{"line":667,"address":[],"length":0,"stats":{"Line":0}},{"line":668,"address":[],"length":0,"stats":{"Line":0}},{"line":669,"address":[],"length":0,"stats":{"Line":0}},{"line":673,"address":[],"length":0,"stats":{"Line":0}},{"line":674,"address":[],"length":0,"stats":{"Line":0}},{"line":679,"address":[],"length":0,"stats":{"Line":0}},{"line":680,"address":[],"length":0,"stats":{"Line":0}}],"covered":18,"coverable":347},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","platform","formats.rs"],"content":"//! Format parsing and selection utilities\n\nuse crate::core::video_info::{Format, FormatSelector, QualitySelector};\nuse crate::error::RytError;\n\n/// Select the best format based on selector criteria\npub fn select_format\u003c'a\u003e(formats: \u0026'a [Format], selector: \u0026FormatSelector) -\u003e Result\u003c\u0026'a Format, RytError\u003e {\n    let mut candidates: Vec\u003c\u0026Format\u003e = formats.iter().collect();\n\n    // Filter by extension\n    if let Some(ext) = \u0026selector.extension {\n        candidates.retain(|f| f.mime_type.contains(ext));\n    }\n\n    // Filter by height constraints\n    if let Some(height_limit) = selector.height_limit {\n        candidates.retain(|f| {\n            if let Some(height) = f.height {\n                height \u003c= height_limit\n            } else {\n                false\n            }\n        });\n    }\n\n    if let Some(height_min) = selector.height_min {\n        candidates.retain(|f| {\n            if let Some(height) = f.height {\n                height \u003e= height_min\n            } else {\n                false\n            }\n        });\n    }\n\n    // Filter by preferred itag\n    if let Some(preferred_itag) = selector.preferred_itag {\n        candidates.retain(|f| f.itag == preferred_itag);\n    }\n\n    if candidates.is_empty() {\n        return Err(RytError::NoFormatFound);\n    }\n\n    // Select by quality criteria\n    match \u0026selector.quality {\n        QualitySelector::Best =\u003e {\n            // Prioritize progressive formats (video+audio combined)\n            if let Some(progressive) = candidates.iter().find(|f| f.is_progressive()) {\n                return Ok(progressive);\n            }\n            // Then sort by bitrate\n            candidates.sort_by(|a, b| b.bitrate.cmp(\u0026a.bitrate));\n            Ok(candidates.first().unwrap())\n        }\n        QualitySelector::Worst =\u003e {\n            candidates.sort_by(|a, b| a.bitrate.cmp(\u0026b.bitrate));\n            Ok(candidates.first().unwrap())\n        }\n            QualitySelector::Itag(target_itag) =\u003e {\n                candidates.iter()\n                    .find(|f| f.itag == *target_itag)\n                    .copied()\n                    .ok_or(RytError::NoFormatFound)\n            }\n        QualitySelector::Height(target_height) =\u003e {\n            candidates.iter()\n                .filter(|f| f.height.unwrap_or(0) == *target_height)\n                .max_by_key(|f| f.bitrate)\n                .copied()\n                .ok_or(RytError::NoFormatFound)\n        }\n        QualitySelector::HeightLessOrEqual(target_height) =\u003e {\n            candidates.iter()\n                .filter(|f| f.height.unwrap_or(0) \u003c= *target_height)\n                .max_by_key(|f| f.bitrate)\n                .copied()\n                .ok_or(RytError::NoFormatFound)\n        }\n        QualitySelector::HeightGreaterOrEqual(target_height) =\u003e {\n            candidates.iter()\n                .filter(|f| f.height.unwrap_or(0) \u003e= *target_height)\n                .max_by_key(|f| f.bitrate)\n                .copied()\n                .ok_or(RytError::NoFormatFound)\n        }\n    }\n}\n\n/// Get the best progressive format (video+audio combined)\npub fn get_best_progressive_format(formats: \u0026[Format]) -\u003e Option\u003c\u0026Format\u003e {\n    formats.iter()\n        .filter(|f| f.is_progressive())\n        .max_by_key(|f| f.bitrate)\n}\n\n/// Get the best video-only format\npub fn get_best_video_format(formats: \u0026[Format]) -\u003e Option\u003c\u0026Format\u003e {\n    formats.iter()\n        .filter(|f| f.is_video_only())\n        .max_by_key(|f| f.bitrate)\n}\n\n/// Get the best audio-only format\npub fn get_best_audio_format(formats: \u0026[Format]) -\u003e Option\u003c\u0026Format\u003e {\n    formats.iter()\n        .filter(|f| f.is_audio_only())\n        .max_by_key(|f| f.bitrate)\n}\n\n/// Get formats by container type\npub fn get_formats_by_container\u003c'a\u003e(formats: \u0026'a [Format], container: \u0026str) -\u003e Vec\u003c\u0026'a Format\u003e {\n    formats.iter()\n        .filter(|f| f.container() == container)\n        .collect()\n}\n\n/// Get formats by quality\npub fn get_formats_by_quality\u003c'a\u003e(formats: \u0026'a [Format], quality: \u0026str) -\u003e Vec\u003c\u0026'a Format\u003e {\n    formats.iter()\n        .filter(|f| f.quality == quality)\n        .collect()\n}\n\n/// Get formats by height range\npub fn get_formats_by_height_range(formats: \u0026[Format], min_height: u32, max_height: u32) -\u003e Vec\u003c\u0026Format\u003e {\n    formats.iter()\n        .filter(|f| {\n            if let Some(height) = f.height {\n                height \u003e= min_height \u0026\u0026 height \u003c= max_height\n            } else {\n                false\n            }\n        })\n        .collect()\n}\n\n/// Get formats by bitrate range\npub fn get_formats_by_bitrate_range(formats: \u0026[Format], min_bitrate: u32, max_bitrate: u32) -\u003e Vec\u003c\u0026Format\u003e {\n    formats.iter()\n        .filter(|f| f.bitrate \u003e= min_bitrate \u0026\u0026 f.bitrate \u003c= max_bitrate)\n        .collect()\n}\n\n/// Sort formats by quality (best first)\npub fn sort_formats_by_quality(formats: \u0026mut [Format]) {\n    formats.sort_by(|a, b| {\n        // First by height (if available)\n        match (a.height, b.height) {\n            (Some(a_h), Some(b_h)) =\u003e b_h.cmp(\u0026a_h),\n            (Some(_), None) =\u003e std::cmp::Ordering::Less,\n            (None, Some(_)) =\u003e std::cmp::Ordering::Greater,\n            (None, None) =\u003e b.bitrate.cmp(\u0026a.bitrate),\n        }\n    });\n}\n\n/// Sort formats by bitrate (highest first)\npub fn sort_formats_by_bitrate(formats: \u0026mut [Format]) {\n    formats.sort_by(|a, b| b.bitrate.cmp(\u0026a.bitrate));\n}\n\n/// Sort formats by size (largest first)\npub fn sort_formats_by_size(formats: \u0026mut [Format]) {\n    formats.sort_by(|a, b| {\n        match (a.size, b.size) {\n            (Some(a_s), Some(b_s)) =\u003e b_s.cmp(\u0026a_s),\n            (Some(_), None) =\u003e std::cmp::Ordering::Less,\n            (None, Some(_)) =\u003e std::cmp::Ordering::Greater,\n            (None, None) =\u003e b.bitrate.cmp(\u0026a.bitrate),\n        }\n    });\n}\n\n/// Filter formats by codec\npub fn filter_formats_by_codec\u003c'a\u003e(formats: \u0026'a [Format], codec: \u0026str) -\u003e Vec\u003c\u0026'a Format\u003e {\n    formats.iter()\n        .filter(|f| {\n            f.audio_codec.as_ref().map(|c| c.contains(codec)).unwrap_or(false) ||\n            f.video_codec.as_ref().map(|c| c.contains(codec)).unwrap_or(false)\n        })\n        .collect()\n}\n\n/// Get format statistics\npub fn get_format_stats(formats: \u0026[Format]) -\u003e FormatStats {\n    let mut stats = FormatStats::default();\n    \n    for format in formats {\n        stats.total_formats += 1;\n        stats.total_bitrate += format.bitrate;\n        \n        if let Some(size) = format.size {\n            stats.total_size += size;\n        }\n        \n        if format.is_progressive() {\n            stats.progressive_formats += 1;\n        }\n        \n        if format.is_video_only() {\n            stats.video_only_formats += 1;\n        }\n        \n        if format.is_audio_only() {\n            stats.audio_only_formats += 1;\n        }\n        \n        if let Some(height) = format.height {\n            if height \u003e stats.max_height {\n                stats.max_height = height;\n            }\n            if stats.min_height == 0 || height \u003c stats.min_height {\n                stats.min_height = height;\n            }\n        }\n        \n        if format.bitrate \u003e stats.max_bitrate {\n            stats.max_bitrate = format.bitrate;\n        }\n        \n        if stats.min_bitrate == 0 || format.bitrate \u003c stats.min_bitrate {\n            stats.min_bitrate = format.bitrate;\n        }\n    }\n    \n    if stats.total_formats \u003e 0 {\n        stats.avg_bitrate = stats.total_bitrate / stats.total_formats as u32;\n    }\n    \n    stats\n}\n\n/// Format statistics\n#[derive(Debug, Default)]\npub struct FormatStats {\n    pub total_formats: usize,\n    pub progressive_formats: usize,\n    pub video_only_formats: usize,\n    pub audio_only_formats: usize,\n    pub total_bitrate: u32,\n    pub avg_bitrate: u32,\n    pub max_bitrate: u32,\n    pub min_bitrate: u32,\n    pub total_size: u64,\n    pub max_height: u32,\n    pub min_height: u32,\n}\n\nimpl FormatStats {\n    /// Get human-readable total size\n    pub fn total_size_string(\u0026self) -\u003e String {\n        crate::core::progress::format_bytes(self.total_size)\n    }\n    \n    /// Get human-readable average bitrate\n    pub fn avg_bitrate_string(\u0026self) -\u003e String {\n        if self.avg_bitrate \u003e 0 {\n            format!(\"{} kbps\", self.avg_bitrate / 1000)\n        } else {\n            \"Unknown\".to_string()\n        }\n    }\n    \n    /// Get human-readable max bitrate\n    pub fn max_bitrate_string(\u0026self) -\u003e String {\n        if self.max_bitrate \u003e 0 {\n            format!(\"{} kbps\", self.max_bitrate / 1000)\n        } else {\n            \"Unknown\".to_string()\n        }\n    }\n    \n    /// Get human-readable min bitrate\n    pub fn min_bitrate_string(\u0026self) -\u003e String {\n        if self.min_bitrate \u003e 0 {\n            format!(\"{} kbps\", self.min_bitrate / 1000)\n        } else {\n            \"Unknown\".to_string()\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::core::video_info::Format;\n\n    fn create_test_formats() -\u003e Vec\u003cFormat\u003e {\n        vec![\n            Format {\n                itag: 22,\n                url: \"http://example.com/22\".to_string(),\n                quality: \"720p\".to_string(),\n                mime_type: \"video/mp4\".to_string(),\n                bitrate: 2000000,\n                size: Some(100000000),\n                signature_cipher: None,\n                audio_codec: Some(\"aac\".to_string()),\n                video_codec: Some(\"avc1\".to_string()),\n                fps: Some(30),\n                width: Some(1280),\n                height: Some(720),\n                audio_sample_rate: Some(44100),\n                audio_channels: Some(2),\n                language: None,\n                note: None,\n            },\n            Format {\n                itag: 18,\n                url: \"http://example.com/18\".to_string(),\n                quality: \"360p\".to_string(),\n                mime_type: \"video/mp4\".to_string(),\n                bitrate: 1000000,\n                size: Some(50000000),\n                signature_cipher: None,\n                audio_codec: Some(\"aac\".to_string()),\n                video_codec: Some(\"avc1\".to_string()),\n                fps: Some(30),\n                width: Some(640),\n                height: Some(360),\n                audio_sample_rate: Some(44100),\n                audio_channels: Some(2),\n                language: None,\n                note: None,\n            },\n            Format {\n                itag: 137,\n                url: \"http://example.com/137\".to_string(),\n                quality: \"1080p\".to_string(),\n                mime_type: \"video/mp4\".to_string(),\n                bitrate: 5000000,\n                size: Some(200000000),\n                signature_cipher: None,\n                audio_codec: None,\n                video_codec: Some(\"avc1\".to_string()),\n                fps: Some(30),\n                width: Some(1920),\n                height: Some(1080),\n                audio_sample_rate: None,\n                audio_channels: None,\n                language: None,\n                note: None,\n            },\n        ]\n    }\n\n    #[test]\n    fn test_select_format_best() {\n        let formats = create_test_formats();\n        let selector = FormatSelector::new(QualitySelector::Best);\n        \n        let selected = select_format(\u0026formats, \u0026selector).unwrap();\n        assert_eq!(selected.itag, 22); // Best progressive format\n    }\n\n    #[test]\n    fn test_select_format_worst() {\n        let formats = create_test_formats();\n        let selector = FormatSelector::new(QualitySelector::Worst);\n        \n        let selected = select_format(\u0026formats, \u0026selector).unwrap();\n        assert_eq!(selected.itag, 18); // Worst progressive format\n    }\n\n    #[test]\n    fn test_select_format_itag() {\n        let formats = create_test_formats();\n        let selector = FormatSelector::new(QualitySelector::Itag(137));\n        \n        let selected = select_format(\u0026formats, \u0026selector).unwrap();\n        assert_eq!(selected.itag, 137);\n    }\n\n    #[test]\n    fn test_select_format_height_limit() {\n        let formats = create_test_formats();\n        let selector = FormatSelector::new(QualitySelector::Best)\n            .with_height_limit(720);\n        \n        let selected = select_format(\u0026formats, \u0026selector).unwrap();\n        assert!(selected.height.unwrap_or(0) \u003c= 720);\n    }\n\n    #[test]\n    fn test_get_best_progressive_format() {\n        let formats = create_test_formats();\n        let best = get_best_progressive_format(\u0026formats).unwrap();\n        assert_eq!(best.itag, 22);\n    }\n\n    #[test]\n    fn test_get_best_video_format() {\n        let formats = create_test_formats();\n        let best = get_best_video_format(\u0026formats).unwrap();\n        assert_eq!(best.itag, 137);\n    }\n\n    #[test]\n    fn test_get_format_stats() {\n        let formats = create_test_formats();\n        let stats = get_format_stats(\u0026formats);\n        \n        assert_eq!(stats.total_formats, 3);\n        assert_eq!(stats.progressive_formats, 2);\n        assert_eq!(stats.video_only_formats, 1);\n        assert_eq!(stats.audio_only_formats, 0);\n        assert_eq!(stats.max_height, 1080);\n        assert_eq!(stats.min_height, 360);\n        assert_eq!(stats.max_bitrate, 5000000);\n        assert_eq!(stats.min_bitrate, 1000000);\n    }\n}\n","traces":[{"line":7,"address":[],"length":0,"stats":{"Line":4}},{"line":8,"address":[],"length":0,"stats":{"Line":20}},{"line":11,"address":[],"length":0,"stats":{"Line":4}},{"line":12,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":5}},{"line":17,"address":[],"length":0,"stats":{"Line":3}},{"line":18,"address":[],"length":0,"stats":{"Line":6}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":4}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":4}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":8}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":8}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":8}},{"line":58,"address":[],"length":0,"stats":{"Line":1}},{"line":60,"address":[],"length":0,"stats":{"Line":1}},{"line":61,"address":[],"length":0,"stats":{"Line":1}},{"line":62,"address":[],"length":0,"stats":{"Line":7}},{"line":64,"address":[],"length":0,"stats":{"Line":2}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":1}},{"line":92,"address":[],"length":0,"stats":{"Line":2}},{"line":93,"address":[],"length":0,"stats":{"Line":7}},{"line":94,"address":[],"length":0,"stats":{"Line":1}},{"line":98,"address":[],"length":0,"stats":{"Line":1}},{"line":99,"address":[],"length":0,"stats":{"Line":2}},{"line":100,"address":[],"length":0,"stats":{"Line":7}},{"line":101,"address":[],"length":0,"stats":{"Line":1}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":1}},{"line":187,"address":[],"length":0,"stats":{"Line":2}},{"line":189,"address":[],"length":0,"stats":{"Line":7}},{"line":193,"address":[],"length":0,"stats":{"Line":3}},{"line":197,"address":[],"length":0,"stats":{"Line":2}},{"line":198,"address":[],"length":0,"stats":{"Line":2}},{"line":201,"address":[],"length":0,"stats":{"Line":1}},{"line":202,"address":[],"length":0,"stats":{"Line":1}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":3}},{"line":210,"address":[],"length":0,"stats":{"Line":2}},{"line":211,"address":[],"length":0,"stats":{"Line":2}},{"line":213,"address":[],"length":0,"stats":{"Line":4}},{"line":214,"address":[],"length":0,"stats":{"Line":2}},{"line":218,"address":[],"length":0,"stats":{"Line":2}},{"line":219,"address":[],"length":0,"stats":{"Line":2}},{"line":222,"address":[],"length":0,"stats":{"Line":4}},{"line":223,"address":[],"length":0,"stats":{"Line":2}},{"line":227,"address":[],"length":0,"stats":{"Line":2}},{"line":228,"address":[],"length":0,"stats":{"Line":1}},{"line":231,"address":[],"length":0,"stats":{"Line":1}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}}],"covered":44,"coverable":130},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","platform","innertube.rs"],"content":"//! InnerTube API client for video platform\n\nuse crate::error::RytError;\nuse crate::platform::client::VideoClient;\nuse crate::core::video_info::{Format, PlaylistItem};\nuse serde::Deserialize;\nuse tracing::{info, debug, warn};\nuse regex::Regex;\n\n/// InnerTube API client\npub struct InnerTubeClient {\n    http_client: VideoClient,\n    client_name: String,\n    client_version: String,\n    api_key: Option\u003cString\u003e,\n    visitor_id: Option\u003cString\u003e,\n}\n\nimpl InnerTubeClient {\n    /// Create a new InnerTube client\n    pub fn new() -\u003e Self {\n        Self {\n            http_client: VideoClient::new(),\n            client_name: \"ANDROID\".to_string(),  // ANDROID gives direct URLs\n            client_version: \"20.10.38\".to_string(),\n            api_key: None,\n            visitor_id: None,\n        }\n    }\n\n    /// Set client name and version\n    pub fn with_client(mut self, name: \u0026str, version: \u0026str) -\u003e Self {\n        self.client_name = name.to_string();\n        self.client_version = version.to_string();\n        self\n    }\n\n    /// Set visitor ID\n    pub fn with_visitor_id(mut self, visitor_id: \u0026str) -\u003e Self {\n        self.visitor_id = Some(visitor_id.to_string());\n        self\n    }\n    \n    /// Switch client for error handling\n    pub fn switch_client_for_error(\u0026mut self, error: \u0026RytError) {\n        self.http_client.switch_client_by_strategy(Some(error));\n    }\n\n    /// Extract API key and client version from YouTube HTML\n    async fn ensure_api_key(\u0026mut self, video_id: \u0026str) -\u003e Result\u003c(), RytError\u003e {\n        if self.api_key.is_some() {\n            return Ok(());\n        }\n\n        info!(\"Extracting API key and client version from YouTube HTML\");\n\n        // Try multiple sources for API key and client version\n        let sources = vec![\n            format!(\"https://www.youtube.com/watch?v={}\", video_id),\n            \"https://www.youtube.com\".to_string(),\n            \"https://www.youtube.com/feed/trending\".to_string(),\n            \"https://www.youtube.com/feed/explore\".to_string(),\n        ];\n\n        let api_key_regex = Regex::new(r#\"\"INNERTUBE_API_KEY\":\"([^\"]+)\"\"#)?;\n        let client_ver_regex = Regex::new(r#\"\"INNERTUBE_CLIENT_VERSION\":\"([^\"]+)\"\"#)?;\n\n        for source in sources {\n            if self.api_key.is_some() {\n                break;\n            }\n\n            debug!(\"Trying to extract API key from: {}\", source);\n\n            let response = self.http_client\n                .create_realistic_request(reqwest::Method::GET, \u0026source)\n                .send()\n                .await?;\n\n            if !response.status().is_success() {\n                warn!(\"Failed to fetch {}: {}\", source, response.status());\n                continue;\n            }\n\n            let body = response.text().await?;\n\n            // Extract API key if not found yet\n            if self.api_key.is_none() {\n                if let Some(captures) = api_key_regex.captures(\u0026body) {\n                    if let Some(api_key) = captures.get(1) {\n                        self.api_key = Some(api_key.as_str().to_string());\n                        info!(\"Extracted API key: {}...\", \u0026api_key.as_str()[..10]);\n                    }\n                }\n            }\n\n            // Extract client version if not found yet\n            if let Some(captures) = client_ver_regex.captures(\u0026body) {\n                if let Some(client_ver) = captures.get(1) {\n                    self.client_version = client_ver.as_str().to_string();\n                    info!(\"Extracted client version: {}\", client_ver.as_str());\n                }\n            }\n        }\n\n        if self.api_key.is_none() {\n            return Err(RytError::ApiKeyNotFound);\n        }\n\n        Ok(())\n    }\n\n    /// Get player response for a video\n    pub async fn get_player_response(\u0026mut self, video_id: \u0026str) -\u003e Result\u003cPlayerResponse, RytError\u003e {\n        info!(\"Fetching player response for video ID: {}\", video_id);\n        \n        // Ensure we have an API key\n        self.ensure_api_key(video_id).await?;\n        \n        // Build client context based on client type\n        let client_context = if self.client_name == \"ANDROID\" {\n            serde_json::json!({\n                \"clientName\": \"ANDROID\",\n                \"clientVersion\": \"20.10.38\",\n                \"androidSdkVersion\": 30,\n                \"osName\": \"Android\",\n                \"osVersion\": \"11\",\n                \"userAgent\": \"com.google.android.youtube/20.10.38 (Linux; U; Android 11) gzip\"\n            })\n        } else {\n            serde_json::json!({\n                \"clientName\": self.client_name,\n                \"clientVersion\": self.client_version,\n                \"userAgent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n                \"mainAppWebInfo\": {\n                    \"graftUrl\": format!(\"https://www.youtube.com/watch?v={}\", video_id),\n                    \"webDisplayMode\": \"WEB_DISPLAY_MODE_BROWSER\",\n                    \"isWebNativeShareEnabled\": true\n                }\n            })\n        };\n\n        let request_body = serde_json::json!({\n            \"context\": {\n                \"client\": client_context\n            },\n            \"videoId\": video_id\n        });\n\n        let api_key = self.api_key.as_ref().unwrap();\n        let url = format!(\"https://www.youtube.com/youtubei/v1/player?key={}\", api_key);\n        \n        debug!(\"Using API key: {}...\", \u0026api_key[..10]);\n        debug!(\"Request URL: {}\", url);\n        debug!(\"Request body: {}\", serde_json::to_string_pretty(\u0026request_body).unwrap_or_default());\n        \n        let mut request = self.http_client.create_innertube_request(\u0026url);\n\n        // Add Android-specific headers\n        if self.client_name == \"ANDROID\" {\n            request = request\n                .header(\"X-YouTube-Client-Name\", \"3\")\n                .header(\"X-YouTube-Client-Version\", \"20.10.38\")\n                .header(\"User-Agent\", \"com.google.android.youtube/20.10.38 (Linux; U; Android 11) gzip\");\n        }\n\n        if let Some(visitor_id) = \u0026self.visitor_id {\n            request = request.header(\"x-goog-visitor-id\", visitor_id);\n        }\n\n        let response: PlayerResponse = self.http_client.execute_with_retry(\n            request.json(\u0026request_body)\n        ).await?;\n\n        debug!(\"Player response received successfully\");\n        \n        // Check playability status\n        if let Some(playability_status) = \u0026response.playability_status {\n            match playability_status.status.as_str() {\n            \"ERROR\" =\u003e {\n                if let Some(reason) = \u0026playability_status.reason {\n                    warn!(\"Video playability error: {}\", reason);\n                    let reason_lower = reason.to_lowercase();\n                    if reason_lower.contains(\"geograph\") || reason_lower.contains(\"available in your country\") {\n                        return Err(RytError::GeoBlocked);\n                    }\n                    if reason_lower.contains(\"rate limit\") || reason_lower.contains(\"quota\") {\n                        return Err(RytError::RateLimited);\n                    }\n                    Err(RytError::VideoUnavailable)\n                } else {\n                    warn!(\"Video playability error: unknown reason\");\n                    Err(RytError::VideoUnavailable)\n                }\n            }\n            \"LOGIN_REQUIRED\" =\u003e {\n                warn!(\"Age restriction detected, this may require client switching\");\n                Err(RytError::AgeRestricted)\n            },\n            \"UNPLAYABLE\" =\u003e {\n                if let Some(reason) = \u0026playability_status.reason {\n                    let reason_lower = reason.to_lowercase();\n                    if reason_lower.contains(\"private\") {\n                        Err(RytError::Private)\n                    } else {\n                        Err(RytError::VideoUnavailable)\n                    }\n                } else {\n                    Err(RytError::VideoUnavailable)\n                }\n            }\n            _ =\u003e Ok(response),\n            }\n        } else {\n            // No playability status, assume OK\n            Ok(response)\n        }\n    }\n\n    /// Get playlist items\n    pub async fn get_playlist_items(\u0026mut self, playlist_id: \u0026str, limit: Option\u003cusize\u003e) -\u003e Result\u003cVec\u003cPlaylistItem\u003e, RytError\u003e {\n        let request_body = serde_json::json!({\n            \"context\": {\n                \"client\": {\n                    \"clientName\": self.client_name,\n                    \"clientVersion\": self.client_version,\n                    \"androidSdkVersion\": 30,\n                    \"osName\": \"Android\",\n                    \"osVersion\": \"11\",\n                    \"deviceModel\": \"SM-G973F\",\n                    \"userAgent\": format!(\"com.google.android.youtube/{} (Linux; U; Android 11) gzip\", self.client_version),\n                    \"connectionType\": \"WIFI\",\n                    \"memoryTotalKb\": 4194304\n                }\n            },\n            \"browseId\": format!(\"VL{}\", playlist_id),\n            \"params\": \"6gPTAUNwc0RRUXh4Zz09\"\n        });\n\n        let mut request = self.http_client.create_innertube_request(\n            \"https://www.youtube.com/youtubei/v1/browse\"\n        );\n\n        if let Some(visitor_id) = \u0026self.visitor_id {\n            request = request.header(\"x-goog-visitor-id\", visitor_id);\n        }\n\n        let response: BrowseResponse = self.http_client.execute_with_retry(\n            request.json(\u0026request_body)\n        ).await?;\n\n        // Parse playlist items from response\n        let mut items = Vec::new();\n        if let Some(contents) = response.contents.two_column_browse_results_renderer.tabs.first() {\n            if let Some(playlist) = \u0026contents.tab_renderer.content.section_list_renderer.contents.first() {\n                if let Some(items_renderer) = \u0026playlist.item_section_renderer.contents.first() {\n                    let playlist_video_list = \u0026items_renderer.playlist_video_list_renderer;\n                    for (index, content) in playlist_video_list.contents.iter().enumerate() {\n                        let video = \u0026content.playlist_video_renderer;\n                        items.push(PlaylistItem {\n                            video_id: video.video_id.clone(),\n                            title: video.title.runs.first().map(|r| r.text.clone()).unwrap_or_default(),\n                            author: video.short_byline_text.runs.first().map(|r| r.text.clone()).unwrap_or_default(),\n                            duration: video.length_seconds.parse().unwrap_or(0),\n                            index: index as u32,\n                            thumbnail: video.thumbnail.thumbnails.first().map(|t| t.url.clone()),\n                            description: None,\n                        });\n\n                        if let Some(limit) = limit {\n                            if items.len() \u003e= limit {\n                                break;\n                            }\n                        }\n                    }\n                }\n            }\n        }\n\n        Ok(items)\n    }\n\n    /// Get visitor ID from YouTube main page\n    pub async fn get_visitor_id(\u0026self) -\u003e Result\u003cString, RytError\u003e {\n        let response = self.http_client.create_request(\n            reqwest::Method::GET,\n            \"https://www.youtube.com\"\n        ).send().await?;\n\n        let html = response.text().await?;\n        \n        // Extract visitor ID from ytcfg\n        if let Some(start) = html.find(\"ytcfg.set(\") {\n            if let Some(end) = html[start..].find(\"});\") {\n                let config_str = \u0026html[start + 10..start + end + 1];\n                if let Ok(config) = serde_json::from_str::\u003cserde_json::Value\u003e(config_str) {\n                    if let Some(visitor_data) = config[\"INNERTUBE_CONTEXT\"][\"client\"][\"visitorData\"].as_str() {\n                        return Ok(visitor_data.to_string());\n                    }\n                }\n            }\n        }\n\n        Err(RytError::Generic(\"Failed to extract visitor ID\".to_string()))\n    }\n}\n\nimpl Default for InnerTubeClient {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n/// Player response from InnerTube API\n#[derive(Debug, Deserialize)]\npub struct PlayerResponse {\n    #[serde(rename = \"responseContext\")]\n    pub response_context: Option\u003cResponseContext\u003e,\n    #[serde(rename = \"playabilityStatus\")]\n    pub playability_status: Option\u003cPlayabilityStatus\u003e,\n    #[serde(rename = \"videoDetails\")]\n    pub video_details: Option\u003cVideoDetails\u003e,\n    #[serde(rename = \"streamingData\")]\n    pub streaming_data: Option\u003cStreamingData\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct ResponseContext {\n    #[serde(rename = \"visitorData\")]\n    pub visitor_data: Option\u003cString\u003e,\n    #[serde(rename = \"serviceTrackingParams\")]\n    pub service_tracking_params: Option\u003cVec\u003cServiceTrackingParam\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct ServiceTrackingParam {\n    pub service: String,\n    #[serde(rename = \"params\")]\n    pub params: Vec\u003cParam\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct Param {\n    pub key: String,\n    pub value: String,\n}\n\n#[derive(Debug, Deserialize)]\npub struct PlayabilityStatus {\n    pub status: String,\n    pub reason: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct VideoDetails {\n    #[serde(rename = \"videoId\")]\n    pub video_id: String,\n    pub title: String,\n    pub author: String,\n    #[serde(rename = \"lengthSeconds\")]\n    pub length_seconds: String,\n    #[serde(rename = \"shortDescription\")]\n    pub short_description: String,\n    pub thumbnail: Thumbnail,\n}\n\n#[derive(Debug, Deserialize)]\npub struct Thumbnail {\n    pub thumbnails: Vec\u003cThumbnailInfo\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct ThumbnailInfo {\n    pub url: String,\n    pub width: u32,\n    pub height: u32,\n}\n\n#[derive(Debug, Deserialize)]\npub struct StreamingData {\n    pub formats: Option\u003cVec\u003cFormatData\u003e\u003e,\n    #[serde(rename = \"adaptiveFormats\")]\n    pub adaptive_formats: Option\u003cVec\u003cFormatData\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct FormatData {\n    pub itag: u32,\n    pub url: Option\u003cString\u003e,\n    #[serde(rename = \"mimeType\")]\n    pub mime_type: String,\n    pub bitrate: Option\u003cu32\u003e,\n    pub width: Option\u003cu32\u003e,\n    pub height: Option\u003cu32\u003e,\n    #[serde(rename = \"qualityLabel\")]\n    pub quality_label: Option\u003cString\u003e,\n    #[serde(rename = \"contentLength\")]\n    pub content_length: Option\u003cString\u003e,\n    #[serde(rename = \"signatureCipher\")]\n    pub signature_cipher: Option\u003cString\u003e,\n    #[serde(rename = \"audioCodec\")]\n    pub audio_codec: Option\u003cString\u003e,\n    #[serde(rename = \"videoCodec\")]\n    pub video_codec: Option\u003cString\u003e,\n    pub fps: Option\u003cu32\u003e,\n    #[serde(rename = \"audioSampleRate\")]\n    pub audio_sample_rate: Option\u003cserde_json::Value\u003e,\n    #[serde(rename = \"audioChannels\")]\n    pub audio_channels: Option\u003cserde_json::Value\u003e,\n}\n\nimpl PlayerResponse {\n    /// Parse formats from player response\n    pub fn parse_formats(\u0026self) -\u003e Result\u003cVec\u003cFormat\u003e, RytError\u003e {\n        let mut formats = Vec::new();\n\n        // Parse progressive formats\n        if let Some(streaming_data) = \u0026self.streaming_data {\n            if let Some(formats_data) = \u0026streaming_data.formats {\n            for format_data in formats_data {\n                formats.push(Format {\n                    itag: format_data.itag,\n                    url: format_data.url.clone().unwrap_or_default(),\n                    quality: format_data.quality_label.clone().unwrap_or_default(),\n                    mime_type: format_data.mime_type.clone(),\n                    bitrate: format_data.bitrate.unwrap_or(0),\n                    size: format_data.content_length.as_ref().and_then(|s| s.parse().ok()),\n                    signature_cipher: format_data.signature_cipher.clone(),\n                    audio_codec: format_data.audio_codec.clone(),\n                    video_codec: format_data.video_codec.clone(),\n                    fps: format_data.fps,\n                    width: format_data.width,\n                    height: format_data.height,\n                    audio_sample_rate: format_data.audio_sample_rate.as_ref().and_then(|v| v.as_str().and_then(|s| s.parse().ok()).or_else(|| v.as_u64().map(|n| n as u32))),\n                    audio_channels: format_data.audio_channels.as_ref().and_then(|v| v.as_str().and_then(|s| s.parse().ok()).or_else(|| v.as_u64().map(|n| n as u32))),\n                    language: None,\n                    note: None,\n                });\n            }\n        }\n\n        // Parse adaptive formats\n            if let Some(adaptive_formats) = \u0026streaming_data.adaptive_formats {\n            for format_data in adaptive_formats {\n                formats.push(Format {\n                    itag: format_data.itag,\n                    url: format_data.url.clone().unwrap_or_default(),\n                    quality: format_data.quality_label.clone().unwrap_or_default(),\n                    mime_type: format_data.mime_type.clone(),\n                    bitrate: format_data.bitrate.unwrap_or(0),\n                    size: format_data.content_length.as_ref().and_then(|s| s.parse().ok()),\n                    signature_cipher: format_data.signature_cipher.clone(),\n                    audio_codec: format_data.audio_codec.clone(),\n                    video_codec: format_data.video_codec.clone(),\n                    fps: format_data.fps,\n                    width: format_data.width,\n                    height: format_data.height,\n                    audio_sample_rate: format_data.audio_sample_rate.as_ref().and_then(|v| v.as_str().and_then(|s| s.parse().ok()).or_else(|| v.as_u64().map(|n| n as u32))),\n                    audio_channels: format_data.audio_channels.as_ref().and_then(|v| v.as_str().and_then(|s| s.parse().ok()).or_else(|| v.as_u64().map(|n| n as u32))),\n                    language: None,\n                    note: None,\n                });\n            }\n        }\n        }\n\n        // If no formats found, return error\n        if formats.is_empty() {\n            return Err(RytError::NoFormatFound);\n        }\n\n        Ok(formats)\n    }\n}\n\n/// Browse response for playlists\n#[derive(Debug, Deserialize)]\npub struct BrowseResponse {\n    pub contents: BrowseContents,\n}\n\n#[derive(Debug, Deserialize)]\npub struct BrowseContents {\n    pub two_column_browse_results_renderer: TwoColumnBrowseResultsRenderer,\n}\n\n#[derive(Debug, Deserialize)]\npub struct TwoColumnBrowseResultsRenderer {\n    pub tabs: Vec\u003cTab\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct Tab {\n    pub tab_renderer: TabRenderer,\n}\n\n#[derive(Debug, Deserialize)]\npub struct TabRenderer {\n    pub content: TabContent,\n}\n\n#[derive(Debug, Deserialize)]\npub struct TabContent {\n    pub section_list_renderer: SectionListRenderer,\n}\n\n#[derive(Debug, Deserialize)]\npub struct SectionListRenderer {\n    pub contents: Vec\u003cSectionContent\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct SectionContent {\n    pub item_section_renderer: ItemSectionRenderer,\n}\n\n#[derive(Debug, Deserialize)]\npub struct ItemSectionRenderer {\n    pub contents: Vec\u003cItemContent\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct ItemContent {\n    pub playlist_video_list_renderer: PlaylistVideoListRenderer,\n}\n\n#[derive(Debug, Deserialize)]\npub struct PlaylistVideoListRenderer {\n    pub contents: Vec\u003cPlaylistVideoContent\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct PlaylistVideoContent {\n    pub playlist_video_renderer: PlaylistVideoRenderer,\n}\n\n#[derive(Debug, Deserialize)]\npub struct PlaylistVideoRenderer {\n    pub video_id: String,\n    pub title: Title,\n    pub short_byline_text: BylineText,\n    pub length_seconds: String,\n    pub thumbnail: Thumbnail,\n}\n\n#[derive(Debug, Deserialize)]\npub struct Title {\n    pub runs: Vec\u003cTextRun\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct BylineText {\n    pub runs: Vec\u003cTextRun\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct TextRun {\n    pub text: String,\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_innertube_client_creation() {\n        let client = InnerTubeClient::new();\n        assert_eq!(client.client_name, \"ANDROID\");\n        assert_eq!(client.client_version, \"20.10.38\");\n    }\n\n    #[test]\n    fn test_innertube_client_with_client() {\n        let client = InnerTubeClient::new()\n            .with_client(\"WEB\", \"2.20250312.04.00\");\n        \n        assert_eq!(client.client_name, \"WEB\");\n        assert_eq!(client.client_version, \"2.20250312.04.00\");\n    }\n\n    #[test]\n    fn test_innertube_client_with_visitor_id() {\n        let client = InnerTubeClient::new()\n            .with_visitor_id(\"test_visitor_id\");\n        \n        assert_eq!(client.visitor_id, Some(\"test_visitor_id\".to_string()));\n    }\n}\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":6}},{"line":23,"address":[],"length":0,"stats":{"Line":12}},{"line":24,"address":[],"length":0,"stats":{"Line":18}},{"line":25,"address":[],"length":0,"stats":{"Line":18}},{"line":32,"address":[],"length":0,"stats":{"Line":1}},{"line":33,"address":[],"length":0,"stats":{"Line":3}},{"line":34,"address":[],"length":0,"stats":{"Line":3}},{"line":35,"address":[],"length":0,"stats":{"Line":1}},{"line":39,"address":[],"length":0,"stats":{"Line":1}},{"line":40,"address":[],"length":0,"stats":{"Line":2}},{"line":41,"address":[],"length":0,"stats":{"Line":1}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}}],"covered":11,"coverable":207},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","platform","mod.rs"],"content":"//! Video platform API client and related functionality\n\npub mod client;\npub mod innertube;\npub mod formats;\npub mod cipher;\npub mod botguard;\n\npub use client::*;\npub use innertube::*;\npub use formats::*;\npub use cipher::*;\npub use botguard::*;\n\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","utils","cache.rs"],"content":"//! Caching utilities for ryt\n\nuse std::collections::HashMap;\nuse std::sync::{Arc, Mutex};\nuse std::time::{Duration, Instant};\nuse moka::future::Cache;\nuse serde::{Serialize, Deserialize};\n\n/// Simple in-memory cache with TTL\n#[derive(Clone)]\npub struct MemoryCache\u003cK, V\u003e {\n    cache: Arc\u003cMutex\u003cHashMap\u003cK, CachedValue\u003cV\u003e\u003e\u003e\u003e,\n}\n\n#[derive(Clone)]\nstruct CachedValue\u003cV\u003e {\n    value: V,\n    expires_at: Instant,\n}\n\nimpl\u003cK, V\u003e MemoryCache\u003cK, V\u003e\nwhere\n    K: std::hash::Hash + Eq + Clone + Send + Sync + 'static,\n    V: Clone + Send + Sync + 'static,\n{\n    pub fn new() -\u003e Self {\n        Self {\n            cache: Arc::new(Mutex::new(HashMap::new())),\n        }\n    }\n\n    pub fn get(\u0026self, key: \u0026K) -\u003e Option\u003cV\u003e {\n        let mut cache = self.cache.lock().unwrap();\n        if let Some(cached_value) = cache.get(key) {\n            if cached_value.expires_at \u003e Instant::now() {\n                return Some(cached_value.value.clone());\n            } else {\n                cache.remove(key);\n            }\n        }\n        None\n    }\n\n    pub fn insert(\u0026self, key: K, value: V, ttl: Duration) {\n        let mut cache = self.cache.lock().unwrap();\n        cache.insert(\n            key,\n            CachedValue {\n                value,\n                expires_at: Instant::now() + ttl,\n            },\n        );\n    }\n\n    pub fn remove(\u0026self, key: \u0026K) -\u003e Option\u003cV\u003e {\n        let mut cache = self.cache.lock().unwrap();\n        cache.remove(key).map(|cached_value| cached_value.value)\n    }\n\n    pub fn clear(\u0026self) {\n        let mut cache = self.cache.lock().unwrap();\n        cache.clear();\n    }\n\n    pub fn cleanup_expired(\u0026self) {\n        let mut cache = self.cache.lock().unwrap();\n        let now = Instant::now();\n        cache.retain(|_, cached_value| cached_value.expires_at \u003e now);\n    }\n}\n\nimpl\u003cK, V\u003e Default for MemoryCache\u003cK, V\u003e\nwhere\n    K: std::hash::Hash + Eq + Clone + Send + Sync + 'static,\n    V: Clone + Send + Sync + 'static,\n{\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n/// High-performance async cache using moka\npub type AsyncCache\u003cK, V\u003e = Cache\u003cK, V\u003e;\n\n/// Create a new async cache with TTL\npub fn new_async_cache\u003cK, V\u003e(ttl: Duration) -\u003e AsyncCache\u003cK, V\u003e\nwhere\n    K: std::hash::Hash + Eq + Clone + Send + Sync + 'static,\n    V: Clone + Send + Sync + 'static,\n{\n    Cache::builder()\n        .time_to_live(ttl)\n        .build()\n}\n\n/// Create a new async cache with TTL and max capacity\npub fn new_async_cache_with_capacity\u003cK, V\u003e(ttl: Duration, max_capacity: u64) -\u003e AsyncCache\u003cK, V\u003e\nwhere\n    K: std::hash::Hash + Eq + Clone + Send + Sync + 'static,\n    V: Clone + Send + Sync + 'static,\n{\n    Cache::builder()\n        .time_to_live(ttl)\n        .max_capacity(max_capacity)\n        .build()\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::sync::Arc;\n    use std::thread;\n    use std::time::Duration;\n\n    #[test]\n    fn test_memory_cache() {\n        let cache = MemoryCache::new();\n        \n        // Test insert and get\n        cache.insert(\"key1\", \"value1\", Duration::from_secs(1));\n        assert_eq!(cache.get(\u0026\"key1\"), Some(\"value1\"));\n        \n        // Test expiration\n        thread::sleep(Duration::from_millis(1100));\n        assert_eq!(cache.get(\u0026\"key1\"), None);\n        \n        // Test remove\n        cache.insert(\"key2\", \"value2\", Duration::from_secs(10));\n        assert_eq!(cache.remove(\u0026\"key2\"), Some(\"value2\"));\n        assert_eq!(cache.get(\u0026\"key2\"), None);\n        \n        // Test clear\n        cache.insert(\"key3\", \"value3\", Duration::from_secs(10));\n        cache.clear();\n        assert_eq!(cache.get(\u0026\"key3\"), None);\n    }\n\n    #[test]\n    fn test_cleanup_expired() {\n        let cache = MemoryCache::new();\n        \n        cache.insert(\"key1\", \"value1\", Duration::from_millis(100));\n        cache.insert(\"key2\", \"value2\", Duration::from_secs(10));\n        \n        thread::sleep(Duration::from_millis(150));\n        cache.cleanup_expired();\n        \n        assert_eq!(cache.get(\u0026\"key1\"), None);\n        assert_eq!(cache.get(\u0026\"key2\"), Some(\"value2\"));\n    }\n\n    #[tokio::test]\n    async fn test_async_cache() {\n        let cache = new_async_cache(Duration::from_secs(1));\n        \n        cache.insert(\"key1\", \"value1\").await;\n        assert_eq!(cache.get(\u0026\"key1\").await, Some(\"value1\"));\n        \n        tokio::time::sleep(Duration::from_millis(1100)).await;\n        assert_eq!(cache.get(\u0026\"key1\").await, None);\n    }\n}\n\n/// Multi-level cache for YouTube data\n#[derive(Clone)]\npub struct MultiLevelCache {\n    /// Player.js cache (10 minutes)\n    player_js_cache: Arc\u003cCache\u003cString, String\u003e\u003e,\n    /// Signature cache (1 hour)\n    signature_cache: Arc\u003cCache\u003cString, String\u003e\u003e,\n    /// Visitor ID cache (10 hours)\n    visitor_id_cache: Arc\u003cCache\u003cString, String\u003e\u003e,\n    /// Botguard token cache (30 minutes)\n    botguard_cache: Arc\u003cCache\u003cString, String\u003e\u003e,\n}\n\nimpl MultiLevelCache {\n    /// Create a new multi-level cache\n    pub fn new() -\u003e Self {\n        Self {\n            player_js_cache: Arc::new(Cache::builder()\n                .time_to_live(Duration::from_secs(600)) // 10 minutes\n                .build()),\n            signature_cache: Arc::new(Cache::builder()\n                .time_to_live(Duration::from_secs(3600)) // 1 hour\n                .build()),\n            visitor_id_cache: Arc::new(Cache::builder()\n                .time_to_live(Duration::from_secs(36000)) // 10 hours\n                .build()),\n            botguard_cache: Arc::new(Cache::builder()\n                .time_to_live(Duration::from_secs(1800)) // 30 minutes\n                .build()),\n        }\n    }\n\n    /// Get player.js content\n    pub async fn get_player_js(\u0026self, url: \u0026str) -\u003e Option\u003cString\u003e {\n        self.player_js_cache.get(url).await\n    }\n\n    /// Set player.js content\n    pub async fn set_player_js(\u0026self, url: \u0026str, content: String) {\n        self.player_js_cache.insert(url.to_string(), content).await;\n    }\n\n    /// Get signature\n    pub async fn get_signature(\u0026self, signature: \u0026str) -\u003e Option\u003cString\u003e {\n        self.signature_cache.get(signature).await\n    }\n\n    /// Set signature\n    pub async fn set_signature(\u0026self, signature: \u0026str, deciphered: String) {\n        self.signature_cache.insert(signature.to_string(), deciphered).await;\n    }\n\n    /// Get visitor ID\n    pub async fn get_visitor_id(\u0026self, key: \u0026str) -\u003e Option\u003cString\u003e {\n        self.visitor_id_cache.get(key).await\n    }\n\n    /// Set visitor ID\n    pub async fn set_visitor_id(\u0026self, key: \u0026str, visitor_id: String) {\n        self.visitor_id_cache.insert(key.to_string(), visitor_id).await;\n    }\n\n    /// Get botguard token\n    pub async fn get_botguard_token(\u0026self, key: \u0026str) -\u003e Option\u003cString\u003e {\n        self.botguard_cache.get(key).await\n    }\n\n    /// Set botguard token\n    pub async fn set_botguard_token(\u0026self, key: \u0026str, token: String) {\n        self.botguard_cache.insert(key.to_string(), token).await;\n    }\n\n    /// Clear all caches\n    pub async fn clear_all(\u0026self) {\n        self.player_js_cache.invalidate_all();\n        self.signature_cache.invalidate_all();\n        self.visitor_id_cache.invalidate_all();\n        self.botguard_cache.invalidate_all();\n    }\n\n    /// Get cache statistics\n    pub fn get_stats(\u0026self) -\u003e CacheStats {\n        CacheStats {\n            player_js_entries: self.player_js_cache.entry_count(),\n            signature_entries: self.signature_cache.entry_count(),\n            visitor_id_entries: self.visitor_id_cache.entry_count(),\n            botguard_entries: self.botguard_cache.entry_count(),\n        }\n    }\n}\n\n/// Cache statistics\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct CacheStats {\n    pub player_js_entries: u64,\n    pub signature_entries: u64,\n    pub visitor_id_entries: u64,\n    pub botguard_entries: u64,\n}\n\nimpl Default for MultiLevelCache {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n","traces":[{"line":26,"address":[],"length":0,"stats":{"Line":10}},{"line":28,"address":[],"length":0,"stats":{"Line":20}},{"line":32,"address":[],"length":0,"stats":{"Line":6}},{"line":33,"address":[],"length":0,"stats":{"Line":18}},{"line":34,"address":[],"length":0,"stats":{"Line":15}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":2}},{"line":38,"address":[],"length":0,"stats":{"Line":1}},{"line":41,"address":[],"length":0,"stats":{"Line":4}},{"line":44,"address":[],"length":0,"stats":{"Line":5}},{"line":45,"address":[],"length":0,"stats":{"Line":15}},{"line":46,"address":[],"length":0,"stats":{"Line":15}},{"line":47,"address":[],"length":0,"stats":{"Line":10}},{"line":48,"address":[],"length":0,"stats":{"Line":5}},{"line":49,"address":[],"length":0,"stats":{"Line":10}},{"line":50,"address":[],"length":0,"stats":{"Line":5}},{"line":55,"address":[],"length":0,"stats":{"Line":1}},{"line":56,"address":[],"length":0,"stats":{"Line":3}},{"line":57,"address":[],"length":0,"stats":{"Line":3}},{"line":60,"address":[],"length":0,"stats":{"Line":1}},{"line":61,"address":[],"length":0,"stats":{"Line":3}},{"line":62,"address":[],"length":0,"stats":{"Line":1}},{"line":65,"address":[],"length":0,"stats":{"Line":1}},{"line":66,"address":[],"length":0,"stats":{"Line":3}},{"line":67,"address":[],"length":0,"stats":{"Line":2}},{"line":68,"address":[],"length":0,"stats":{"Line":6}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":9}},{"line":91,"address":[],"length":0,"stats":{"Line":9}},{"line":92,"address":[],"length":0,"stats":{"Line":18}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":8}},{"line":181,"address":[],"length":0,"stats":{"Line":24}},{"line":184,"address":[],"length":0,"stats":{"Line":24}},{"line":187,"address":[],"length":0,"stats":{"Line":24}},{"line":190,"address":[],"length":0,"stats":{"Line":24}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}}],"covered":33,"coverable":68},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","utils","filename.rs"],"content":"//! Safe filename generation utilities\n\nuse std::path::Path;\nuse regex::Regex;\n\n/// Convert a title to a safe filename by removing/replacing invalid characters\npub fn to_safe_filename(title: \u0026str, extension: \u0026str) -\u003e String {\n    // Remove or replace invalid characters for filenames\n    let invalid_chars = Regex::new(r#\"[\u003c\u003e:\"/\\\\|?*\\x00-\\x1f]\"#).unwrap();\n    let mut safe_title = invalid_chars.replace_all(title, \"_\").to_string();\n    \n    // Remove leading/trailing dots and spaces\n    safe_title = safe_title.trim_matches(|c: char| c == '.' || c == ' ').to_string();\n    \n    // Limit length (Windows has 255 char limit, be conservative)\n    if safe_title.len() \u003e 200 {\n        safe_title.truncate(200);\n        safe_title = safe_title.trim_end().to_string();\n    }\n    \n    // Ensure it's not empty\n    if safe_title.is_empty() {\n        safe_title = \"video\".to_string();\n    }\n    \n    // Add extension if provided\n    if !extension.is_empty() {\n        let ext = if extension.starts_with('.') {\n            extension.to_string()\n        } else {\n            format!(\".{}\", extension)\n        };\n        format!(\"{}{}\", safe_title, ext)\n    } else {\n        safe_title\n    }\n}\n\n/// Check if a filename is safe for the current filesystem\npub fn is_safe_filename(filename: \u0026str) -\u003e bool {\n    if filename.is_empty() || filename.len() \u003e 255 {\n        return false;\n    }\n    \n    // Check for invalid characters\n    let invalid_chars = Regex::new(r#\"[\u003c\u003e:\"/\\\\|?*\\x00-\\x1f]\"#).unwrap();\n    if invalid_chars.is_match(filename) {\n        return false;\n    }\n    \n    // Check for reserved names on Windows\n    let reserved_names = [\n        \"CON\", \"PRN\", \"AUX\", \"NUL\",\n        \"COM1\", \"COM2\", \"COM3\", \"COM4\", \"COM5\", \"COM6\", \"COM7\", \"COM8\", \"COM9\",\n        \"LPT1\", \"LPT2\", \"LPT3\", \"LPT4\", \"LPT5\", \"LPT6\", \"LPT7\", \"LPT8\", \"LPT9\",\n    ];\n    \n    if let Some(name_without_ext) = Path::new(filename).file_stem() {\n        if let Some(name_str) = name_without_ext.to_str() {\n            let upper_name = name_str.to_uppercase();\n            if reserved_names.contains(\u0026upper_name.as_str()) {\n                return false;\n            }\n        }\n    }\n    \n    // Check for leading/trailing dots or spaces\n    if filename.starts_with('.') || filename.ends_with('.') ||\n       filename.starts_with(' ') || filename.ends_with(' ') {\n        return false;\n    }\n    \n    true\n}\n\n/// Generate a unique filename by appending a number if the file already exists\npub fn generate_unique_filename(base_path: \u0026Path, filename: \u0026str) -\u003e std::io::Result\u003cString\u003e {\n    let mut counter = 1;\n    let mut final_filename = filename.to_string();\n    \n    while base_path.join(\u0026final_filename).exists() {\n        let path = Path::new(filename);\n        let stem = path.file_stem().unwrap_or_default();\n        let extension = path.extension().map(|ext| format!(\".{}\", ext.to_string_lossy())).unwrap_or_default();\n        \n        final_filename = format!(\"{} ({}){}\", stem.to_string_lossy(), counter, extension);\n        counter += 1;\n        \n        // Prevent infinite loop\n        if counter \u003e 10000 {\n            return Err(std::io::Error::new(\n                std::io::ErrorKind::AlreadyExists,\n                \"Too many files with similar names\"\n            ));\n        }\n    }\n    \n    Ok(final_filename)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_to_safe_filename() {\n        assert_eq!(\n            to_safe_filename(\"Test Video: Title\", \"mp4\"),\n            \"Test Video_ Title.mp4\"\n        );\n        \n        assert_eq!(\n            to_safe_filename(\"Video with \u003cinvalid\u003e chars\", \"mp4\"),\n            \"Video with _invalid_ chars.mp4\"\n        );\n        \n        assert_eq!(\n            to_safe_filename(\"\", \"mp4\"),\n            \"video.mp4\"\n        );\n        \n        assert_eq!(\n            to_safe_filename(\"Very long title that exceeds the maximum length limit and should be truncated to prevent filesystem issues\", \"mp4\"),\n            \"Very long title that exceeds the maximum length limit and should be truncated to prevent filesystem issues.mp4\"\n        );\n    }\n\n    #[test]\n    fn test_is_safe_filename() {\n        assert!(is_safe_filename(\"normal_file.mp4\"));\n        assert!(is_safe_filename(\"video with spaces.mp4\"));\n        assert!(!is_safe_filename(\"file\u003cwith\u003einvalid:chars.mp4\"));\n        assert!(!is_safe_filename(\"\"));\n        assert!(!is_safe_filename(\".hidden_file.mp4\"));\n        // Note: \"file with trailing space .mp4\" is actually safe because the space is before the dot, not at the end\n        assert!(is_safe_filename(\"file with trailing space .mp4\"));\n        assert!(!is_safe_filename(\"file with trailing space .mp4 \"));\n    }\n\n    #[test]\n    fn test_generate_unique_filename() {\n        let temp_dir = std::env::temp_dir();\n        let base_path = \u0026temp_dir;\n        \n        // This test might fail if the temp directory has existing files\n        // In a real scenario, we'd use a dedicated test directory\n        let result = generate_unique_filename(base_path, \"test_file.mp4\");\n        assert!(result.is_ok());\n    }\n}\n","traces":[{"line":7,"address":[],"length":0,"stats":{"Line":4}},{"line":9,"address":[],"length":0,"stats":{"Line":16}},{"line":10,"address":[],"length":0,"stats":{"Line":16}},{"line":13,"address":[],"length":0,"stats":{"Line":28}},{"line":16,"address":[],"length":0,"stats":{"Line":4}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":9}},{"line":23,"address":[],"length":0,"stats":{"Line":2}},{"line":27,"address":[],"length":0,"stats":{"Line":4}},{"line":28,"address":[],"length":0,"stats":{"Line":4}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":4}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":7}},{"line":41,"address":[],"length":0,"stats":{"Line":20}},{"line":42,"address":[],"length":0,"stats":{"Line":1}},{"line":48,"address":[],"length":0,"stats":{"Line":1}},{"line":58,"address":[],"length":0,"stats":{"Line":5}},{"line":59,"address":[],"length":0,"stats":{"Line":5}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":9}},{"line":69,"address":[],"length":0,"stats":{"Line":8}},{"line":70,"address":[],"length":0,"stats":{"Line":2}},{"line":77,"address":[],"length":0,"stats":{"Line":1}},{"line":78,"address":[],"length":0,"stats":{"Line":2}},{"line":79,"address":[],"length":0,"stats":{"Line":3}},{"line":81,"address":[],"length":0,"stats":{"Line":2}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":1}}],"covered":24,"coverable":38},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","utils","mime.rs"],"content":"//! MIME type utilities for determining file extensions\n\n/// Get file extension from MIME type\npub fn ext_from_mime(mime_type: \u0026str) -\u003e \u0026'static str {\n    match mime_type {\n        // Video formats\n        \"video/mp4\" =\u003e \"mp4\",\n        \"video/webm\" =\u003e \"webm\",\n        \"video/3gpp\" =\u003e \"3gp\",\n        \"video/x-flv\" =\u003e \"flv\",\n        \"video/quicktime\" =\u003e \"mov\",\n        \"video/x-msvideo\" =\u003e \"avi\",\n        \"video/x-ms-wmv\" =\u003e \"wmv\",\n        \"video/mp2t\" =\u003e \"ts\",\n        \"video/mp2p\" =\u003e \"mpeg\",\n        \"video/mpeg\" =\u003e \"mpeg\",\n        \"video/ogg\" =\u003e \"ogv\",\n        \"video/x-matroska\" =\u003e \"mkv\",\n        \n        // Audio formats\n        \"audio/mp4\" =\u003e \"m4a\",\n        \"audio/webm\" =\u003e \"webm\",\n        \"audio/mpeg\" =\u003e \"mp3\",\n        \"audio/ogg\" =\u003e \"ogg\",\n        \"audio/wav\" =\u003e \"wav\",\n        \"audio/x-wav\" =\u003e \"wav\",\n        \"audio/flac\" =\u003e \"flac\",\n        \"audio/aac\" =\u003e \"aac\",\n        \"audio/x-aac\" =\u003e \"aac\",\n        \"audio/vorbis\" =\u003e \"ogg\",\n        \"audio/opus\" =\u003e \"opus\",\n        \n        // Default fallback\n        _ =\u003e \"bin\",\n    }\n}\n\n/// Get MIME type from file extension\npub fn mime_from_ext(extension: \u0026str) -\u003e \u0026'static str {\n    let ext = extension.trim_start_matches('.').to_lowercase();\n    match ext.as_str() {\n        // Video formats\n        \"mp4\" =\u003e \"video/mp4\",\n        \"webm\" =\u003e \"video/webm\",\n        \"3gp\" =\u003e \"video/3gpp\",\n        \"flv\" =\u003e \"video/x-flv\",\n        \"mov\" =\u003e \"video/quicktime\",\n        \"avi\" =\u003e \"video/x-msvideo\",\n        \"wmv\" =\u003e \"video/x-ms-wmv\",\n        \"ts\" =\u003e \"video/mp2t\",\n        \"mpeg\" | \"mpg\" =\u003e \"video/mpeg\",\n        \"ogv\" =\u003e \"video/ogg\",\n        \"mkv\" =\u003e \"video/x-matroska\",\n        \n        // Audio formats\n        \"m4a\" =\u003e \"audio/mp4\",\n        \"mp3\" =\u003e \"audio/mpeg\",\n        \"ogg\" =\u003e \"audio/ogg\",\n        \"wav\" =\u003e \"audio/wav\",\n        \"flac\" =\u003e \"audio/flac\",\n        \"aac\" =\u003e \"audio/aac\",\n        \"opus\" =\u003e \"audio/opus\",\n        \n        // Default fallback\n        _ =\u003e \"application/octet-stream\",\n    }\n}\n\n/// Check if MIME type is a video format\npub fn is_video_mime(mime_type: \u0026str) -\u003e bool {\n    mime_type.starts_with(\"video/\")\n}\n\n/// Check if MIME type is an audio format\npub fn is_audio_mime(mime_type: \u0026str) -\u003e bool {\n    mime_type.starts_with(\"audio/\")\n}\n\n/// Check if MIME type is a progressive format (video+audio combined)\npub fn is_progressive_mime(mime_type: \u0026str) -\u003e bool {\n    matches!(\n        mime_type,\n        \"video/mp4\" | \"video/webm\" | \"video/3gpp\" | \"video/x-flv\"\n    )\n}\n\n/// Check if MIME type is an adaptive format (video or audio only)\npub fn is_adaptive_mime(mime_type: \u0026str) -\u003e bool {\n    is_video_mime(mime_type) || is_audio_mime(mime_type)\n}\n\n/// Get container format from MIME type\npub fn get_container_format(mime_type: \u0026str) -\u003e \u0026'static str {\n    match mime_type {\n        \"video/mp4\" | \"audio/mp4\" =\u003e \"mp4\",\n        \"video/webm\" | \"audio/webm\" =\u003e \"webm\",\n        \"video/3gpp\" =\u003e \"3gp\",\n        \"video/x-flv\" =\u003e \"flv\",\n        \"video/quicktime\" =\u003e \"mov\",\n        \"video/x-msvideo\" =\u003e \"avi\",\n        \"video/x-ms-wmv\" =\u003e \"wmv\",\n        \"video/mp2t\" =\u003e \"ts\",\n        \"video/mpeg\" =\u003e \"mpeg\",\n        \"video/ogg\" | \"audio/ogg\" =\u003e \"ogg\",\n        \"video/x-matroska\" =\u003e \"mkv\",\n        \"audio/mpeg\" =\u003e \"mp3\",\n        \"audio/wav\" | \"audio/x-wav\" =\u003e \"wav\",\n        \"audio/flac\" =\u003e \"flac\",\n        \"audio/aac\" | \"audio/x-aac\" =\u003e \"aac\",\n        \"audio/opus\" =\u003e \"opus\",\n        _ =\u003e \"unknown\",\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_ext_from_mime() {\n        assert_eq!(ext_from_mime(\"video/mp4\"), \"mp4\");\n        assert_eq!(ext_from_mime(\"video/webm\"), \"webm\");\n        assert_eq!(ext_from_mime(\"audio/mp4\"), \"m4a\");\n        assert_eq!(ext_from_mime(\"audio/mpeg\"), \"mp3\");\n        assert_eq!(ext_from_mime(\"unknown/type\"), \"bin\");\n    }\n\n    #[test]\n    fn test_mime_from_ext() {\n        assert_eq!(mime_from_ext(\"mp4\"), \"video/mp4\");\n        assert_eq!(mime_from_ext(\".mp4\"), \"video/mp4\");\n        assert_eq!(mime_from_ext(\"MP4\"), \"video/mp4\");\n        assert_eq!(mime_from_ext(\"m4a\"), \"audio/mp4\");\n        assert_eq!(mime_from_ext(\"mp3\"), \"audio/mpeg\");\n        assert_eq!(mime_from_ext(\"unknown\"), \"application/octet-stream\");\n    }\n\n    #[test]\n    fn test_is_video_mime() {\n        assert!(is_video_mime(\"video/mp4\"));\n        assert!(is_video_mime(\"video/webm\"));\n        assert!(!is_video_mime(\"audio/mp4\"));\n        assert!(!is_video_mime(\"text/plain\"));\n    }\n\n    #[test]\n    fn test_is_audio_mime() {\n        assert!(is_audio_mime(\"audio/mp4\"));\n        assert!(is_audio_mime(\"audio/mpeg\"));\n        assert!(!is_audio_mime(\"video/mp4\"));\n        assert!(!is_audio_mime(\"text/plain\"));\n    }\n\n    #[test]\n    fn test_is_progressive_mime() {\n        assert!(is_progressive_mime(\"video/mp4\"));\n        assert!(is_progressive_mime(\"video/webm\"));\n        assert!(!is_progressive_mime(\"video/quicktime\"));\n        assert!(!is_progressive_mime(\"audio/mp4\"));\n    }\n\n    #[test]\n    fn test_get_container_format() {\n        assert_eq!(get_container_format(\"video/mp4\"), \"mp4\");\n        assert_eq!(get_container_format(\"audio/mp4\"), \"mp4\");\n        assert_eq!(get_container_format(\"video/webm\"), \"webm\");\n        assert_eq!(get_container_format(\"audio/mpeg\"), \"mp3\");\n        assert_eq!(get_container_format(\"unknown/type\"), \"unknown\");\n    }\n}\n\n","traces":[{"line":4,"address":[],"length":0,"stats":{"Line":5}},{"line":5,"address":[],"length":0,"stats":{"Line":5}},{"line":7,"address":[],"length":0,"stats":{"Line":6}},{"line":8,"address":[],"length":0,"stats":{"Line":5}},{"line":9,"address":[],"length":0,"stats":{"Line":3}},{"line":10,"address":[],"length":0,"stats":{"Line":3}},{"line":11,"address":[],"length":0,"stats":{"Line":3}},{"line":12,"address":[],"length":0,"stats":{"Line":3}},{"line":13,"address":[],"length":0,"stats":{"Line":3}},{"line":14,"address":[],"length":0,"stats":{"Line":3}},{"line":15,"address":[],"length":0,"stats":{"Line":3}},{"line":16,"address":[],"length":0,"stats":{"Line":3}},{"line":17,"address":[],"length":0,"stats":{"Line":3}},{"line":18,"address":[],"length":0,"stats":{"Line":3}},{"line":21,"address":[],"length":0,"stats":{"Line":4}},{"line":22,"address":[],"length":0,"stats":{"Line":2}},{"line":23,"address":[],"length":0,"stats":{"Line":3}},{"line":24,"address":[],"length":0,"stats":{"Line":1}},{"line":25,"address":[],"length":0,"stats":{"Line":1}},{"line":26,"address":[],"length":0,"stats":{"Line":1}},{"line":27,"address":[],"length":0,"stats":{"Line":1}},{"line":28,"address":[],"length":0,"stats":{"Line":1}},{"line":29,"address":[],"length":0,"stats":{"Line":1}},{"line":30,"address":[],"length":0,"stats":{"Line":1}},{"line":31,"address":[],"length":0,"stats":{"Line":1}},{"line":34,"address":[],"length":0,"stats":{"Line":1}},{"line":39,"address":[],"length":0,"stats":{"Line":6}},{"line":40,"address":[],"length":0,"stats":{"Line":18}},{"line":41,"address":[],"length":0,"stats":{"Line":6}},{"line":43,"address":[],"length":0,"stats":{"Line":9}},{"line":44,"address":[],"length":0,"stats":{"Line":3}},{"line":45,"address":[],"length":0,"stats":{"Line":3}},{"line":46,"address":[],"length":0,"stats":{"Line":3}},{"line":47,"address":[],"length":0,"stats":{"Line":3}},{"line":48,"address":[],"length":0,"stats":{"Line":3}},{"line":49,"address":[],"length":0,"stats":{"Line":3}},{"line":50,"address":[],"length":0,"stats":{"Line":3}},{"line":51,"address":[],"length":0,"stats":{"Line":6}},{"line":52,"address":[],"length":0,"stats":{"Line":3}},{"line":53,"address":[],"length":0,"stats":{"Line":3}},{"line":56,"address":[],"length":0,"stats":{"Line":4}},{"line":57,"address":[],"length":0,"stats":{"Line":3}},{"line":58,"address":[],"length":0,"stats":{"Line":1}},{"line":59,"address":[],"length":0,"stats":{"Line":1}},{"line":60,"address":[],"length":0,"stats":{"Line":1}},{"line":61,"address":[],"length":0,"stats":{"Line":1}},{"line":62,"address":[],"length":0,"stats":{"Line":1}},{"line":65,"address":[],"length":0,"stats":{"Line":1}},{"line":70,"address":[],"length":0,"stats":{"Line":4}},{"line":71,"address":[],"length":0,"stats":{"Line":8}},{"line":75,"address":[],"length":0,"stats":{"Line":4}},{"line":76,"address":[],"length":0,"stats":{"Line":8}},{"line":80,"address":[],"length":0,"stats":{"Line":4}},{"line":81,"address":[],"length":0,"stats":{"Line":2}},{"line":82,"address":[],"length":0,"stats":{"Line":4}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":5}},{"line":94,"address":[],"length":0,"stats":{"Line":5}},{"line":95,"address":[],"length":0,"stats":{"Line":11}},{"line":96,"address":[],"length":0,"stats":{"Line":6}},{"line":97,"address":[],"length":0,"stats":{"Line":2}},{"line":98,"address":[],"length":0,"stats":{"Line":2}},{"line":99,"address":[],"length":0,"stats":{"Line":2}},{"line":100,"address":[],"length":0,"stats":{"Line":2}},{"line":101,"address":[],"length":0,"stats":{"Line":2}},{"line":102,"address":[],"length":0,"stats":{"Line":2}},{"line":103,"address":[],"length":0,"stats":{"Line":2}},{"line":104,"address":[],"length":0,"stats":{"Line":4}},{"line":105,"address":[],"length":0,"stats":{"Line":2}},{"line":106,"address":[],"length":0,"stats":{"Line":3}},{"line":107,"address":[],"length":0,"stats":{"Line":2}},{"line":108,"address":[],"length":0,"stats":{"Line":1}},{"line":109,"address":[],"length":0,"stats":{"Line":2}},{"line":110,"address":[],"length":0,"stats":{"Line":1}},{"line":111,"address":[],"length":0,"stats":{"Line":1}}],"covered":74,"coverable":76},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","utils","mod.rs"],"content":"//! Utility functions for ryt\n\npub mod cache;\npub mod filename;\npub mod mime;\npub mod url;\n\npub use cache::*;\npub use filename::*;\npub use mime::*;\npub use url::*;\n\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","utils","url.rs"],"content":"//! URL utilities for extracting video IDs and parsing video platform URLs\n\nuse crate::error::RytError;\nuse url::Url;\n\n/// Extract video ID from various video platform URL formats\npub fn extract_video_id(url: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n    let parsed = Url::parse(url)?;\n    \n    match parsed.host_str() {\n        Some(\"youtu.be\") =\u003e {\n            let path = parsed.path().trim_start_matches('/');\n            if path.is_empty() {\n                return Err(RytError::InvalidUrl(\"Missing video ID\".to_string()));\n            }\n            Ok(path.to_string())\n        }\n        Some(\"youtube.com\") | Some(\"www.youtube.com\") =\u003e {\n            if parsed.path().starts_with(\"/watch\") {\n                parsed.query_pairs()\n                    .find(|(key, _)| key == \"v\")\n                    .map(|(_, value)| value.to_string())\n                    .ok_or_else(|| RytError::InvalidUrl(\"Missing v parameter\".to_string()))\n            } else if parsed.path().starts_with(\"/shorts/\") {\n                let video_id = parsed.path().trim_start_matches(\"/shorts/\");\n                if video_id.is_empty() {\n                    return Err(RytError::InvalidUrl(\"Missing video ID in shorts path\".to_string()));\n                }\n                Ok(video_id.to_string())\n            } else {\n                Err(RytError::InvalidUrl(\"Unsupported video URL format\".to_string()))\n            }\n        }\n        _ =\u003e Err(RytError::InvalidUrl(\"Not a supported video platform URL\".to_string()))\n    }\n}\n\n/// Extract playlist ID from video platform playlist URL\npub fn extract_playlist_id(url: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n    // Accept raw playlist IDs as-is\n    if !url.is_empty() \u0026\u0026 (url.starts_with(\"PL\") || url.starts_with(\"UU\") || url.starts_with(\"OLAK5uy_\")) {\n        return Ok(url.to_string());\n    }\n    \n    let parsed = Url::parse(url)?;\n    if let Some(id) = parsed.query_pairs().find(|(key, _)| key == \"list\").map(|(_, value)| value.to_string()) {\n        Ok(id)\n    } else {\n        Err(RytError::InvalidUrl(\"Playlist ID not found\".to_string()))\n    }\n}\n\n/// Check if URL is a supported video platform URL\npub fn is_video_url(url: \u0026str) -\u003e bool {\n    if let Ok(parsed) = Url::parse(url) {\n        matches!(\n            parsed.host_str(),\n            Some(\"youtube.com\") | Some(\"www.youtube.com\") | Some(\"youtu.be\")\n        )\n    } else {\n        false\n    }\n}\n\n/// Check if URL is a playlist URL\npub fn is_playlist_url(url: \u0026str) -\u003e bool {\n    if let Ok(parsed) = Url::parse(url) {\n        parsed.path().contains(\"/playlist\") || \n        parsed.query_pairs().any(|(key, _)| key == \"list\")\n    } else {\n        // If URL parsing fails, check if it's a raw playlist ID\n        url.starts_with(\"PL\") || url.starts_with(\"UU\") || url.starts_with(\"OLAK5uy_\")\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_extract_video_id() {\n        assert_eq!(\n            extract_video_id(\"https://www.youtube.com/watch?v=dQw4w9WgXcQ\").unwrap(),\n            \"dQw4w9WgXcQ\"\n        );\n        \n        assert_eq!(\n            extract_video_id(\"https://youtu.be/dQw4w9WgXcQ\").unwrap(),\n            \"dQw4w9WgXcQ\"\n        );\n        \n        assert_eq!(\n            extract_video_id(\"https://www.youtube.com/shorts/brZCOVlyPPo\").unwrap(),\n            \"brZCOVlyPPo\"\n        );\n        \n        // Test error cases\n        assert!(extract_video_id(\"https://www.youtube.com/watch\").is_err());\n        assert!(extract_video_id(\"https://example.com\").is_err());\n    }\n\n    #[test]\n    fn test_extract_playlist_id() {\n        assert_eq!(\n            extract_playlist_id(\"https://www.youtube.com/playlist?list=PLxxxx\").unwrap(),\n            \"PLxxxx\"\n        );\n        \n        assert_eq!(\n            extract_playlist_id(\"PLxxxx\").unwrap(),\n            \"PLxxxx\"\n        );\n        \n        assert!(extract_playlist_id(\"https://www.youtube.com/watch?v=xxx\").is_err());\n    }\n\n    #[test]\n    fn test_is_video_url() {\n        assert!(is_video_url(\"https://www.youtube.com/watch?v=xxx\"));\n        assert!(is_video_url(\"https://youtu.be/xxx\"));\n        assert!(!is_video_url(\"https://example.com\"));\n    }\n\n    #[test]\n    fn test_is_playlist_url() {\n        assert!(is_playlist_url(\"https://www.youtube.com/playlist?list=PLxxxx\"));\n        assert!(is_playlist_url(\"PLxxxx\"));\n        assert!(!is_playlist_url(\"https://www.youtube.com/watch?v=xxx\"));\n    }\n}\n","traces":[{"line":7,"address":[],"length":0,"stats":{"Line":5}},{"line":8,"address":[],"length":0,"stats":{"Line":15}},{"line":11,"address":[],"length":0,"stats":{"Line":5}},{"line":12,"address":[],"length":0,"stats":{"Line":3}},{"line":13,"address":[],"length":0,"stats":{"Line":2}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":8}},{"line":19,"address":[],"length":0,"stats":{"Line":6}},{"line":20,"address":[],"length":0,"stats":{"Line":2}},{"line":21,"address":[],"length":0,"stats":{"Line":4}},{"line":22,"address":[],"length":0,"stats":{"Line":4}},{"line":23,"address":[],"length":0,"stats":{"Line":4}},{"line":24,"address":[],"length":0,"stats":{"Line":1}},{"line":25,"address":[],"length":0,"stats":{"Line":3}},{"line":26,"address":[],"length":0,"stats":{"Line":2}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":1}},{"line":39,"address":[],"length":0,"stats":{"Line":3}},{"line":41,"address":[],"length":0,"stats":{"Line":10}},{"line":42,"address":[],"length":0,"stats":{"Line":1}},{"line":45,"address":[],"length":0,"stats":{"Line":2}},{"line":46,"address":[],"length":0,"stats":{"Line":7}},{"line":49,"address":[],"length":0,"stats":{"Line":1}},{"line":54,"address":[],"length":0,"stats":{"Line":3}},{"line":55,"address":[],"length":0,"stats":{"Line":6}},{"line":56,"address":[],"length":0,"stats":{"Line":2}},{"line":58,"address":[],"length":0,"stats":{"Line":8}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":4}},{"line":67,"address":[],"length":0,"stats":{"Line":7}},{"line":69,"address":[],"length":0,"stats":{"Line":3}},{"line":72,"address":[],"length":0,"stats":{"Line":2}}],"covered":29,"coverable":33}]};
        var previousData = {"files":[{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","cli","args.rs"],"content":"//! Command line argument parsing\n\nuse clap::{Parser, ValueEnum};\nuse std::path::PathBuf;\nuse std::time::Duration;\n\n/// Rust YouTube Downloader - Fast and reliable YouTube video downloader\n#[derive(Parser, Debug)]\n#[command(author, version, about, long_about = None)]\npub struct Args {\n    /// YouTube video or playlist URL\n    pub url: String,\n\n    /// Format selector (e.g., 'itag=22', 'best', 'height\u003c=480')\n    #[arg(short, long, value_name = \"FORMAT\")]\n    pub format: Option\u003cString\u003e,\n\n    /// Desired file extension (e.g., 'mp4', 'webm')\n    #[arg(short, long, value_name = \"EXT\")]\n    pub ext: Option\u003cString\u003e,\n\n    /// Output path (file or directory)\n    #[arg(short, long, value_name = \"PATH\")]\n    pub output: Option\u003cPathBuf\u003e,\n\n    /// Disable progress output\n    #[arg(long)]\n    pub no_progress: bool,\n\n    /// HTTP timeout (e.g., 30s, 1m)\n    #[arg(long, value_name = \"DURATION\", default_value = \"30s\")]\n    pub timeout: humantime::Duration,\n\n    /// HTTP retries for transient errors\n    #[arg(long, default_value = \"3\")]\n    pub retries: u32,\n\n    /// Download rate limit (e.g., 2MiB/s, 500KiB/s)\n    #[arg(long, value_name = \"RATE\")]\n    pub rate_limit: Option\u003cString\u003e,\n\n    /// Treat input as playlist URL or ID\n    #[arg(long)]\n    pub playlist: bool,\n\n    /// Max items to process for playlist (0 means all)\n    #[arg(long, default_value = \"0\")]\n    pub limit: usize,\n\n    /// Parallelism for playlist downloads\n    #[arg(long, default_value = \"1\")]\n    pub concurrency: usize,\n\n    /// Botguard mode\n    #[arg(long, value_enum, default_value = \"off\")]\n    pub botguard: BotguardMode,\n\n    /// Enable Botguard debug logs\n    #[arg(long)]\n    pub debug_botguard: bool,\n\n    /// Botguard cache mode\n    #[arg(long, value_enum, default_value = \"mem\")]\n    pub botguard_cache: BotguardCacheMode,\n\n    /// Botguard cache directory (for file mode)\n    #[arg(long, value_name = \"DIR\")]\n    pub botguard_cache_dir: Option\u003cPathBuf\u003e,\n\n    /// Default Botguard token TTL if solver doesn't set\n    #[arg(long, value_name = \"DURATION\", default_value = \"30m\")]\n    pub botguard_ttl: humantime::Duration,\n\n    /// Path to JS script implementing bgAttest(input)\n    #[arg(long, value_name = \"PATH\")]\n    pub botguard_script: Option\u003cPathBuf\u003e,\n\n    /// Innertube client name (default ANDROID)\n    #[arg(long, value_name = \"NAME\")]\n    pub client_name: Option\u003cString\u003e,\n\n    /// Innertube client version (default 20.10.38)\n    #[arg(long, value_name = \"VERSION\")]\n    pub client_version: Option\u003cString\u003e,\n\n    /// Print final media URL and exit (no download)\n    #[arg(short = 'g', long)]\n    pub print_url: bool,\n\n    /// Override User-Agent header\n    #[arg(long, value_name = \"USER_AGENT\")]\n    pub user_agent: Option\u003cString\u003e,\n\n    /// Proxy URL (http/https/socks)\n    #[arg(long, value_name = \"URL\")]\n    pub proxy: Option\u003cString\u003e,\n\n    /// Verbose output\n    #[arg(short, long)]\n    pub verbose: bool,\n\n    /// Quiet output (only errors)\n    #[arg(short, long)]\n    pub quiet: bool,\n}\n\n/// Botguard mode\n#[derive(Debug, Clone, ValueEnum)]\npub enum BotguardMode {\n    /// Disabled\n    Off,\n    /// Automatic (only when needed)\n    Auto,\n    /// Force (always use)\n    Force,\n}\n\n/// Botguard cache mode\n#[derive(Debug, Clone, ValueEnum)]\npub enum BotguardCacheMode {\n    /// Memory cache\n    Mem,\n    /// File cache\n    File,\n}\n\nimpl Args {\n    /// Get HTTP timeout as Duration\n    pub fn timeout_duration(\u0026self) -\u003e Duration {\n        self.timeout.into()\n    }\n\n    /// Get Botguard TTL as Duration\n    pub fn botguard_ttl_duration(\u0026self) -\u003e Duration {\n        self.botguard_ttl.into()\n    }\n\n    /// Parse rate limit string to bytes per second\n    pub fn parse_rate_limit(\u0026self) -\u003e Option\u003cu64\u003e {\n        self.rate_limit.as_ref().and_then(|rate| {\n            parse_rate_limit(rate)\n        })\n    }\n\n    /// Check if this is a playlist operation\n    pub fn is_playlist(\u0026self) -\u003e bool {\n        self.playlist || crate::utils::url::is_playlist_url(\u0026self.url)\n    }\n\n    /// Get output verbosity level\n    pub fn verbosity_level(\u0026self) -\u003e VerbosityLevel {\n        if self.quiet {\n            VerbosityLevel::Quiet\n        } else if self.verbose {\n            VerbosityLevel::Verbose\n        } else {\n            VerbosityLevel::Normal\n        }\n    }\n}\n\n/// Output verbosity level\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum VerbosityLevel {\n    /// Quiet (only errors)\n    Quiet,\n    /// Normal\n    Normal,\n    /// Verbose (debug info)\n    Verbose,\n}\n\n/// Parse rate limit string to bytes per second\npub fn parse_rate_limit(rate: \u0026str) -\u003e Option\u003cu64\u003e {\n    let rate = rate.trim().to_uppercase();\n    if rate.is_empty() {\n        return None;\n    }\n\n    // Remove /s suffix if present\n    let rate = rate.trim_end_matches(\"/S\");\n\n    // Find the number and unit\n    let mut number_end = 0;\n    for (i, c) in rate.char_indices() {\n        if c.is_ascii_digit() || c == '.' {\n            number_end = i + 1;\n        } else {\n            break;\n        }\n    }\n\n    if number_end == 0 {\n        return None;\n    }\n\n    let number_str = \u0026rate[..number_end];\n    let unit = \u0026rate[number_end..].trim();\n\n    let number: f64 = number_str.parse().ok()?;\n    if number \u003c= 0.0 {\n        return None;\n    }\n\n    let multiplier = match *unit {\n        \"B\" | \"\" =\u003e 1,\n        \"KB\" =\u003e 1000,\n        \"KIB\" =\u003e 1024,\n        \"MB\" =\u003e 1000 * 1000,\n        \"MIB\" =\u003e 1024 * 1024,\n        \"GB\" =\u003e 1000 * 1000 * 1000,\n        \"GIB\" =\u003e 1024 * 1024 * 1024,\n        \"TB\" =\u003e 1000_u64.pow(4),\n        \"TIB\" =\u003e 1024_u64.pow(4),\n        _ =\u003e return None,\n    };\n\n    Some((number * multiplier as f64) as u64)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_parse_rate_limit() {\n        assert_eq!(parse_rate_limit(\"1MB/s\"), Some(1000 * 1000));\n        assert_eq!(parse_rate_limit(\"1MiB/s\"), Some(1024 * 1024));\n        assert_eq!(parse_rate_limit(\"500KB/s\"), Some(500 * 1000));\n        assert_eq!(parse_rate_limit(\"2GB/s\"), Some(2 * 1000 * 1000 * 1000));\n        assert_eq!(parse_rate_limit(\"1.5MB/s\"), Some(1500 * 1000));\n        assert_eq!(parse_rate_limit(\"1024\"), Some(1024));\n        assert_eq!(parse_rate_limit(\"0\"), None);\n        assert_eq!(parse_rate_limit(\"\"), None);\n        assert_eq!(parse_rate_limit(\"invalid\"), None);\n    }\n\n    #[test]\n    fn test_args_verbosity_level() {\n        let args = Args {\n            url: \"https://example.com\".to_string(),\n            quiet: false,\n            verbose: false,\n            ..Default::default()\n        };\n        assert_eq!(args.verbosity_level(), VerbosityLevel::Normal);\n\n        let args = Args {\n            url: \"https://example.com\".to_string(),\n            quiet: true,\n            verbose: false,\n            ..Default::default()\n        };\n        assert_eq!(args.verbosity_level(), VerbosityLevel::Quiet);\n\n        let args = Args {\n            url: \"https://example.com\".to_string(),\n            quiet: false,\n            verbose: true,\n            ..Default::default()\n        };\n        assert_eq!(args.verbosity_level(), VerbosityLevel::Verbose);\n    }\n\n    #[test]\n    fn test_args_is_playlist() {\n        let args = Args {\n            url: \"https://www.youtube.com/playlist?list=PLxxxx\".to_string(),\n            playlist: false,\n            ..Default::default()\n        };\n        assert!(args.is_playlist());\n\n        let args = Args {\n            url: \"https://www.youtube.com/watch?v=xxx\".to_string(),\n            playlist: true,\n            ..Default::default()\n        };\n        assert!(args.is_playlist());\n    }\n}\n\n// Implement Default for Args to make tests work\nimpl Default for Args {\n    fn default() -\u003e Self {\n        Self {\n            url: String::new(),\n            format: None,\n            ext: None,\n            output: None,\n            no_progress: false,\n            timeout: humantime::Duration::from(Duration::from_secs(30)),\n            retries: 3,\n            rate_limit: None,\n            playlist: false,\n            limit: 0,\n            concurrency: 1,\n            botguard: BotguardMode::Off,\n            debug_botguard: false,\n            botguard_cache: BotguardCacheMode::Mem,\n            botguard_cache_dir: None,\n            botguard_ttl: humantime::Duration::from(Duration::from_secs(1800)),\n            botguard_script: None,\n            client_name: None,\n            client_version: None,\n            print_url: false,\n            user_agent: None,\n            proxy: None,\n            verbose: false,\n            quiet: false,\n        }\n    }\n}\n","traces":[{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":2}},{"line":147,"address":[],"length":0,"stats":{"Line":3}},{"line":151,"address":[],"length":0,"stats":{"Line":3}},{"line":152,"address":[],"length":0,"stats":{"Line":3}},{"line":153,"address":[],"length":0,"stats":{"Line":1}},{"line":154,"address":[],"length":0,"stats":{"Line":2}},{"line":155,"address":[],"length":0,"stats":{"Line":1}},{"line":157,"address":[],"length":0,"stats":{"Line":1}},{"line":174,"address":[],"length":0,"stats":{"Line":9}},{"line":175,"address":[],"length":0,"stats":{"Line":27}},{"line":176,"address":[],"length":0,"stats":{"Line":18}},{"line":177,"address":[],"length":0,"stats":{"Line":1}},{"line":185,"address":[],"length":0,"stats":{"Line":40}},{"line":186,"address":[],"length":0,"stats":{"Line":61}},{"line":187,"address":[],"length":0,"stats":{"Line":14}},{"line":189,"address":[],"length":0,"stats":{"Line":6}},{"line":194,"address":[],"length":0,"stats":{"Line":1}},{"line":200,"address":[],"length":0,"stats":{"Line":7}},{"line":202,"address":[],"length":0,"stats":{"Line":1}},{"line":205,"address":[],"length":0,"stats":{"Line":6}},{"line":206,"address":[],"length":0,"stats":{"Line":7}},{"line":207,"address":[],"length":0,"stats":{"Line":6}},{"line":208,"address":[],"length":0,"stats":{"Line":4}},{"line":209,"address":[],"length":0,"stats":{"Line":6}},{"line":210,"address":[],"length":0,"stats":{"Line":3}},{"line":211,"address":[],"length":0,"stats":{"Line":2}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":5}},{"line":287,"address":[],"length":0,"stats":{"Line":10}},{"line":292,"address":[],"length":0,"stats":{"Line":15}},{"line":302,"address":[],"length":0,"stats":{"Line":15}}],"covered":30,"coverable":41},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","cli","mod.rs"],"content":"//! CLI interface for ryt\n\npub mod args;\npub mod output;\n\npub use args::*;\npub use output::*;\n\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","cli","output.rs"],"content":"//! Output formatting and progress display\n\nuse crate::core::progress::Progress;\nuse crate::cli::args::VerbosityLevel;\nuse indicatif::{ProgressBar, ProgressStyle};\nuse std::sync::Arc;\nuse std::time::Duration;\n\n/// Output formatter for ryt\npub struct OutputFormatter {\n    verbosity: VerbosityLevel,\n    progress_bar: Option\u003cProgressBar\u003e,\n}\n\nimpl OutputFormatter {\n    /// Create a new output formatter\n    pub fn new(verbosity: VerbosityLevel) -\u003e Self {\n        Self {\n            verbosity,\n            progress_bar: None,\n        }\n    }\n\n    /// Create a progress bar for downloads\n    pub fn create_progress_bar(\u0026mut self, total_size: u64) -\u003e Option\u003cProgressBar\u003e {\n        if self.verbosity == VerbosityLevel::Quiet {\n            return None;\n        }\n\n        let style = ProgressStyle::default_bar()\n            .template(\"{spinner:.green} [{elapsed_precise}] [{bar:40.cyan/blue}] {bytes}/{total_bytes} ({eta}) {msg}\")\n            .unwrap()\n            .progress_chars(\"#\u003e-\");\n\n        let progress_bar = ProgressBar::new(total_size);\n        progress_bar.set_style(style);\n        progress_bar.set_message(\"Downloading...\");\n\n        self.progress_bar = Some(progress_bar.clone());\n        Some(progress_bar)\n    }\n\n    /// Update progress bar\n    pub fn update_progress(\u0026self, progress: \u0026Progress) {\n        if let Some(progress_bar) = \u0026self.progress_bar {\n            progress_bar.set_position(progress.downloaded_size);\n            progress_bar.set_length(progress.total_size);\n            \n            if let Some(speed) = progress.speed {\n                progress_bar.set_message(format!(\"{}/s\", format_bytes(speed as u64)));\n            }\n        }\n    }\n\n    /// Finish progress bar\n    pub fn finish_progress(\u0026self, message: \u0026str) {\n        if let Some(progress_bar) = \u0026self.progress_bar {\n            progress_bar.finish_with_message(message.to_string());\n        }\n    }\n\n    /// Print info message\n    pub fn info(\u0026self, message: \u0026str) {\n        if self.verbosity != VerbosityLevel::Quiet {\n            println!(\"ℹ️  {}\", message);\n        }\n    }\n\n    /// Print success message\n    pub fn success(\u0026self, message: \u0026str) {\n        if self.verbosity != VerbosityLevel::Quiet {\n            println!(\"✅ {}\", message);\n        }\n    }\n\n    /// Print warning message\n    pub fn warning(\u0026self, message: \u0026str) {\n        if self.verbosity != VerbosityLevel::Quiet {\n            eprintln!(\"⚠️  {}\", message);\n        }\n    }\n\n    /// Print error message\n    pub fn error(\u0026self, message: \u0026str) {\n        eprintln!(\"❌ {}\", message);\n    }\n\n    /// Print debug message\n    pub fn debug(\u0026self, message: \u0026str) {\n        if self.verbosity == VerbosityLevel::Verbose {\n            println!(\"🐛 {}\", message);\n        }\n    }\n\n    /// Print video information\n    pub fn print_video_info(\u0026self, title: \u0026str, author: \u0026str, duration: u32, formats: usize) {\n        if self.verbosity == VerbosityLevel::Quiet {\n            return;\n        }\n\n        println!(\"📹 {}\", title);\n        println!(\"👤 {}\", author);\n        println!(\"⏱️  {}\", format_duration(Duration::from_secs(duration as u64)));\n        println!(\"📊 {} formats available\", formats);\n        println!();\n    }\n\n    /// Print format information\n    pub fn print_format_info(\u0026self, itag: u32, quality: \u0026str, mime_type: \u0026str, bitrate: u32, size: Option\u003cu64\u003e) {\n        if self.verbosity == VerbosityLevel::Quiet {\n            return;\n        }\n\n        let size_str = size.map(|s| format!(\" ({})\", format_bytes(s))).unwrap_or_default();\n        println!(\"  📋 itag={} | {} | {} | {} kbps{}\", \n                 itag, quality, mime_type, bitrate / 1000, size_str);\n    }\n\n    /// Print download start message\n    pub fn print_download_start(\u0026self, url: \u0026str, output_path: \u0026str) {\n        if self.verbosity == VerbosityLevel::Quiet {\n            return;\n        }\n\n        println!(\"🚀 Starting download...\");\n        println!(\"🔗 URL: {}\", url);\n        println!(\"💾 Output: {}\", output_path);\n        println!();\n    }\n\n    /// Print download complete message\n    pub fn print_download_complete(\u0026self, output_path: \u0026str, duration: Duration) {\n        if self.verbosity == VerbosityLevel::Quiet {\n            return;\n        }\n\n        println!();\n        println!(\"✅ Download completed!\");\n        println!(\"💾 Saved to: {}\", output_path);\n        println!(\"⏱️  Time: {}\", format_duration(duration));\n    }\n\n    /// Print playlist information\n    pub fn print_playlist_info(\u0026self, playlist_id: \u0026str, item_count: usize, limit: Option\u003cusize\u003e) {\n        if self.verbosity == VerbosityLevel::Quiet {\n            return;\n        }\n\n        println!(\"📋 Playlist: {}\", playlist_id);\n        if let Some(limit) = limit {\n            println!(\"📊 Items: {} (limited to {})\", item_count, limit);\n        } else {\n            println!(\"📊 Items: {}\", item_count);\n        }\n        println!();\n    }\n\n    /// Print playlist item progress\n    pub fn print_playlist_item(\u0026self, index: usize, total: usize, title: \u0026str) {\n        if self.verbosity == VerbosityLevel::Quiet {\n            return;\n        }\n\n        println!(\"📥 [{}/{}] {}\", index + 1, total, title);\n    }\n\n    /// Print help text\n    pub fn print_help(\u0026self) {\n        println!(\"RYT - Rust Video Downloader\");\n        println!();\n        println!(\"Usage: ryt [OPTIONS] \u003cURL\u003e\");\n        println!();\n        println!(\"Examples:\");\n        println!(\"  ryt VIDEO_URL\");\n        println!(\"  ryt --format best --ext mp4 VIDEO_URL\");\n        println!(\"  ryt --playlist --limit 10 PLAYLIST_URL\");\n        println!(\"  ryt --rate-limit 2MiB/s --output ./downloads VIDEO_URL\");\n        println!();\n        println!(\"For more information, run: ryt --help\");\n    }\n\n    /// Print version information\n    pub fn print_version(\u0026self) {\n        println!(\"ryt version {}\", env!(\"CARGO_PKG_VERSION\"));\n        println!(\"Rust YouTube Downloader - Fast and reliable\");\n    }\n}\n\n/// Create a progress callback for the downloader\npub fn create_progress_callback(formatter: Arc\u003cOutputFormatter\u003e) -\u003e impl Fn(Progress) + Send + Sync + 'static {\n    move |progress: Progress| {\n        formatter.update_progress(\u0026progress);\n    }\n}\n\n/// Format bytes as human-readable string\nfn format_bytes(bytes: u64) -\u003e String {\n    const UNITS: \u0026[\u0026str] = \u0026[\"B\", \"KB\", \"MB\", \"GB\", \"TB\"];\n    const THRESHOLD: f64 = 1024.0;\n\n    if bytes == 0 {\n        return \"0 B\".to_string();\n    }\n\n    let bytes_f64 = bytes as f64;\n    let exp = (bytes_f64.ln() / THRESHOLD.ln()).floor() as usize;\n    let exp = exp.min(UNITS.len() - 1);\n    \n    let value = bytes_f64 / THRESHOLD.powi(exp as i32);\n    \n    if exp == 0 {\n        format!(\"{} {}\", bytes, UNITS[exp])\n    } else {\n        format!(\"{:.1} {}\", value, UNITS[exp])\n    }\n}\n\n/// Format duration as human-readable string\nfn format_duration(duration: Duration) -\u003e String {\n    let total_seconds = duration.as_secs();\n    \n    if total_seconds \u003c 60 {\n        format!(\"{}s\", total_seconds)\n    } else if total_seconds \u003c 3600 {\n        let minutes = total_seconds / 60;\n        let seconds = total_seconds % 60;\n        if seconds == 0 {\n            format!(\"{}m\", minutes)\n        } else {\n            format!(\"{}m {}s\", minutes, seconds)\n        }\n    } else {\n        let hours = total_seconds / 3600;\n        let minutes = (total_seconds % 3600) / 60;\n        if minutes == 0 {\n            format!(\"{}h\", hours)\n        } else {\n            format!(\"{}h {}m\", hours, minutes)\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_output_formatter_creation() {\n        let formatter = OutputFormatter::new(VerbosityLevel::Normal);\n        assert_eq!(formatter.verbosity, VerbosityLevel::Normal);\n        assert!(formatter.progress_bar.is_none());\n    }\n\n    #[test]\n    fn test_format_bytes() {\n        assert_eq!(format_bytes(0), \"0 B\");\n        assert_eq!(format_bytes(1023), \"1023 B\");\n        assert_eq!(format_bytes(1024), \"1.0 KB\");\n        assert_eq!(format_bytes(1536), \"1.5 KB\");\n        assert_eq!(format_bytes(1048576), \"1.0 MB\");\n        assert_eq!(format_bytes(1073741824), \"1.0 GB\");\n    }\n\n    #[test]\n    fn test_format_duration() {\n        assert_eq!(format_duration(Duration::from_secs(30)), \"30s\");\n        assert_eq!(format_duration(Duration::from_secs(60)), \"1m\");\n        assert_eq!(format_duration(Duration::from_secs(90)), \"1m 30s\");\n        assert_eq!(format_duration(Duration::from_secs(3600)), \"1h\");\n        assert_eq!(format_duration(Duration::from_secs(3660)), \"1h 1m\");\n    }\n\n    #[test]\n    fn test_verbosity_levels() {\n        let formatter = OutputFormatter::new(VerbosityLevel::Quiet);\n        // These should not print anything in quiet mode\n        formatter.info(\"test\");\n        formatter.success(\"test\");\n        formatter.warning(\"test\");\n        formatter.debug(\"test\");\n        \n        // Error should always print\n        formatter.error(\"test\");\n    }\n}\n","traces":[{"line":17,"address":[],"length":0,"stats":{"Line":2}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":1}},{"line":64,"address":[],"length":0,"stats":{"Line":1}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":1}},{"line":71,"address":[],"length":0,"stats":{"Line":1}},{"line":72,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":1}},{"line":78,"address":[],"length":0,"stats":{"Line":1}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":1}},{"line":85,"address":[],"length":0,"stats":{"Line":2}},{"line":89,"address":[],"length":0,"stats":{"Line":1}},{"line":90,"address":[],"length":0,"stats":{"Line":1}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":6}},{"line":201,"address":[],"length":0,"stats":{"Line":6}},{"line":202,"address":[],"length":0,"stats":{"Line":2}},{"line":212,"address":[],"length":0,"stats":{"Line":3}},{"line":214,"address":[],"length":0,"stats":{"Line":4}},{"line":219,"address":[],"length":0,"stats":{"Line":5}},{"line":220,"address":[],"length":0,"stats":{"Line":15}},{"line":222,"address":[],"length":0,"stats":{"Line":5}},{"line":223,"address":[],"length":0,"stats":{"Line":2}},{"line":224,"address":[],"length":0,"stats":{"Line":4}},{"line":225,"address":[],"length":0,"stats":{"Line":4}},{"line":226,"address":[],"length":0,"stats":{"Line":4}},{"line":227,"address":[],"length":0,"stats":{"Line":2}},{"line":228,"address":[],"length":0,"stats":{"Line":2}},{"line":230,"address":[],"length":0,"stats":{"Line":1}},{"line":233,"address":[],"length":0,"stats":{"Line":2}},{"line":236,"address":[],"length":0,"stats":{"Line":2}},{"line":238,"address":[],"length":0,"stats":{"Line":1}}],"covered":29,"coverable":109},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","core","downloader.rs"],"content":"//! Main downloader implementation\n\nuse crate::core::{Progress, VideoInfo, FormatSelector, QualitySelector};\nuse crate::error::RytError;\nuse crate::utils::{extract_video_id, to_safe_filename};\nuse crate::platform::{InnerTubeClient, PlayerResponse};\nuse crate::core::video_info::Format;\nuse crate::download::ChunkedDownloader;\nuse std::path::PathBuf;\nuse std::sync::Arc;\nuse std::time::Duration;\nuse tokio::sync::Mutex;\nuse tracing::{info, debug, warn};\n\n/// Main downloader configuration\n#[derive(Debug, Clone)]\npub struct DownloadOptions {\n    /// Format selector\n    pub format_selector: Option\u003cFormatSelector\u003e,\n    /// Desired file extension\n    pub desired_ext: Option\u003cString\u003e,\n    /// Output path (file or directory)\n    pub output_path: Option\u003cPathBuf\u003e,\n    /// Rate limit in bytes per second\n    pub rate_limit_bps: Option\u003cu64\u003e,\n    /// InnerTube client name\n    pub client_name: String,\n    /// InnerTube client version\n    pub client_version: String,\n    /// HTTP timeout\n    pub timeout: Duration,\n    /// Maximum retries\n    pub max_retries: u32,\n}\n\nimpl Default for DownloadOptions {\n    fn default() -\u003e Self {\n        Self {\n            format_selector: None,\n            desired_ext: None,\n            output_path: None,\n            rate_limit_bps: None,\n            client_name: \"ANDROID\".to_string(),  // ANDROID gives direct URLs without cipher complexity\n            client_version: \"20.10.38\".to_string(),\n            timeout: Duration::from_secs(30),\n            max_retries: 3,\n        }\n    }\n}\n\n/// Botguard configuration\n#[derive(Debug, Clone)]\npub struct BotguardConfig {\n    /// Botguard mode\n    pub mode: crate::platform::botguard::BotguardMode,\n    /// Debug mode\n    pub debug: bool,\n    /// Token TTL\n    pub ttl: Duration,\n}\n\nimpl Default for BotguardConfig {\n    fn default() -\u003e Self {\n        Self {\n            mode: crate::platform::botguard::BotguardMode::Off,\n            debug: false,\n            ttl: Duration::from_secs(1800), // 30 minutes\n        }\n    }\n}\n\n/// Main downloader struct\npub struct Downloader {\n    options: DownloadOptions,\n    botguard: BotguardConfig,\n    inner_tube: Arc\u003cMutex\u003cInnerTubeClient\u003e\u003e,\n    downloader: Arc\u003cMutex\u003cChunkedDownloader\u003e\u003e,\n}\n\nimpl Downloader {\n    /// Create a new downloader with default options\n    pub fn new() -\u003e Self {\n        Self {\n            options: DownloadOptions::default(),\n            botguard: BotguardConfig::default(),\n            inner_tube: Arc::new(Mutex::new(InnerTubeClient::new())),\n            downloader: Arc::new(Mutex::new(ChunkedDownloader::new())),\n        }\n    }\n\n    /// Set format selector\n    pub fn with_format(mut self, selector: \u0026str, ext: \u0026str) -\u003e Self {\n        if let Ok(quality) = QualitySelector::from_str(selector) {\n            self.options.format_selector = Some(FormatSelector::new(quality).with_extension(ext));\n        }\n        self\n    }\n\n    /// Set output path\n    pub fn with_output_path(mut self, path: impl Into\u003cPathBuf\u003e) -\u003e Self {\n        self.options.output_path = Some(path.into());\n        self\n    }\n\n    /// Set progress callback\n    pub fn with_progress(self, _callback: impl Fn(Progress) + Send + Sync + 'static) -\u003e Self {\n        // TODO: Implement progress callback in ChunkedDownloader\n        self\n    }\n\n    /// Set rate limit\n    pub fn with_rate_limit(mut self, bytes_per_second: u64) -\u003e Self {\n        self.options.rate_limit_bps = Some(bytes_per_second);\n        self\n    }\n\n    /// Set InnerTube client\n    pub fn with_innertube_client(mut self, name: \u0026str, version: \u0026str) -\u003e Self {\n        self.options.client_name = name.to_string();\n        self.options.client_version = version.to_string();\n        self\n    }\n\n    /// Set Botguard mode\n    pub fn with_botguard(mut self, mode: crate::platform::botguard::BotguardMode) -\u003e Self {\n        self.botguard.mode = mode;\n        self\n    }\n\n    /// Set Botguard debug\n    pub fn with_botguard_debug(mut self, debug: bool) -\u003e Self {\n        self.botguard.debug = debug;\n        self\n    }\n\n    /// Set Botguard TTL\n    pub fn with_botguard_ttl(mut self, ttl: Duration) -\u003e Self {\n        self.botguard.ttl = ttl;\n        self\n    }\n\n    /// Set HTTP timeout\n    pub fn with_timeout(mut self, timeout: Duration) -\u003e Self {\n        self.options.timeout = timeout;\n        self\n    }\n\n    /// Set maximum retries\n    pub fn with_max_retries(mut self, max_retries: u32) -\u003e Self {\n        self.options.max_retries = max_retries;\n        self\n    }\n\n    /// Resolve video URL and get metadata without downloading\n    pub async fn resolve_url(\u0026mut self, video_url: \u0026str) -\u003e Result\u003c(String, VideoInfo), RytError\u003e {\n        // Extract video ID\n        let video_id = extract_video_id(video_url)?;\n        info!(\"Resolving URL for video ID: {}\", video_id);\n\n        // Try to get player response with retry logic for age restrictions\n        let mut last_error = None;\n        let max_retries = 3;\n        \n        for attempt in 0..=max_retries {\n            let mut inner_tube = self.inner_tube.lock().await;\n            \n            match inner_tube.get_player_response(\u0026video_id).await {\n                Ok(player_response) =\u003e {\n                    // Success, continue with processing\n                    drop(inner_tube); // Release lock early\n                    let (final_url, video_info) = self.process_player_response(player_response, \u0026video_id).await?;\n\n                    // Professional: WEB fallback causes c=WEB in URL, breaking ANDROID client context\n                    // ANDROID already returns valid itag=18 URLs without 'n' parameter - this is OK\n                    // Do NOT switch to WEB just for 'n' parameter - it breaks client consistency\n                    // YouTube CDN validates that URL's c= parameter matches the client that obtained it\n\n                    return Ok((final_url, video_info));\n                }\n                Err(RytError::AgeRestricted) =\u003e {\n                    warn!(\"Age restriction detected on attempt {}, switching client\", attempt + 1);\n                    // Switch client for age restriction\n                    inner_tube.switch_client_for_error(\u0026RytError::AgeRestricted);\n                    last_error = Some(RytError::AgeRestricted);\n                    \n                    // Wait before retry\n                    if attempt \u003c max_retries {\n                        drop(inner_tube); // Release lock before sleep\n                        tokio::time::sleep(Duration::from_millis(500 * (attempt + 1) as u64)).await;\n                    }\n                }\n                Err(e) =\u003e {\n                    // Non-retryable error or other error\n                    return Err(e);\n                }\n            }\n        }\n        \n        // If we get here, all retries failed\n        Err(last_error.unwrap_or(RytError::AgeRestricted))\n    }\n    \n    /// Process player response and extract video info\n    async fn process_player_response(\u0026mut self, player_response: PlayerResponse, video_id: \u0026str) -\u003e Result\u003c(String, VideoInfo), RytError\u003e {\n\n        // Parse formats\n        let formats = player_response.parse_formats()?;\n        debug!(\"Found {} formats for video {}\", formats.len(), video_id);\n        \n        // Debug: print all formats\n        // println!(\"📋 Available formats ({}):\", formats.len());\n        // for (i, format) in formats.iter().enumerate() {\n        //     println!(\"  {}: itag={}, quality={}, url_len={}, needs_deciphering={}\", \n        //         i, format.itag, format.quality, format.url.len(), format.needs_deciphering());\n        //     if let Some(sig_cipher) = \u0026format.signature_cipher {\n        //         println!(\"    signature_cipher: {}\", sig_cipher);\n        //     }\n        // }\n        \n        // Check if we got muxed formats (itag 18, 22, etc.) - these are stable and don't get 403\n        let all_itags: Vec\u003cu32\u003e = formats.iter().map(|f| f.itag).collect();\n        debug!(\"All itags from ANDROID: {:?}\", all_itags);\n        let has_muxed = formats.iter().any(|f| matches!(f.itag, 18 | 22 | 43 | 36));\n        debug!(\"has_muxed={}, will try IOS={}\", has_muxed, !has_muxed);\n        \n        // If only adaptive formats (itag 299+), try to get muxed from IOS client\n        let formats = if !has_muxed {\n            debug!(\"No muxed formats found (only adaptive), trying IOS client for itag 18/22\");\n            // IOS client often returns muxed formats that ANDROID doesn't provide\n            let mut ios_inner_tube = InnerTubeClient::new().with_client(\"IOS\", \"19.29.1\");\n            \n            match ios_inner_tube.get_player_response(video_id).await {\n                Ok(ios_response) =\u003e {\n                    match ios_response.parse_formats() {\n                        Ok(ios_formats) if !ios_formats.is_empty() =\u003e {\n                            let has_ios_muxed = ios_formats.iter().any(|f| matches!(f.itag, 18 | 22));\n                            if has_ios_muxed {\n                                debug!(\"✅ IOS client returned {} formats with muxed (itag 18/22)\", ios_formats.len());\n                                ios_formats\n                            } else {\n                                debug!(\"IOS also has no muxed formats, using original ANDROID\");\n                                formats\n                            }\n                        }\n                        _ =\u003e {\n                            debug!(\"IOS response parse failed or empty, using ANDROID\");\n                            formats\n                        }\n                    }\n                }\n                Err(e) =\u003e {\n                    warn!(\"IOS client request failed: {}, using ANDROID formats\", e);\n                    formats\n                }\n            }\n        } else {\n            formats\n        };\n        \n        // Strongly prefer muxed formats (itag 18/22) to avoid 403\n        let selected_format = formats.iter()\n            .filter(|f| matches!(f.itag, 18 | 22))\n            .max_by_key(|f| f.height.unwrap_or(0))\n            .or_else(|| formats.iter().filter(|f| matches!(f.itag, 43 | 36)).max_by_key(|f| f.height.unwrap_or(0)))\n            .or_else(|| self.select_format(\u0026formats).ok())\n            .ok_or_else(|| RytError::NoFormatFound)?;\n        debug!(\"Selected format: itag={}, quality={}, size={} (muxed={})\",\n               selected_format.itag, selected_format.quality, \n               selected_format.size.unwrap_or(0),\n               matches!(selected_format.itag, 18 | 22 | 43 | 36));\n        \n        // Resolve final URL with signature deciphering\n        let mut final_url = if selected_format.needs_deciphering() {\n            debug!(\"Format requires deciphering, resolving cipher...\");\n            let video_url = format!(\"https://www.youtube.com/watch?v={}\", video_id);\n            self.resolve_format_url_with_cipher(selected_format, \u0026video_url).await?\n        } else {\n            debug!(\"Format does not require deciphering\");\n            selected_format.url.clone()\n        };\n\n        // Normalize final_url for direct URL path as well (ratebypass, alr, n, drop rqh)\n        if let Ok(mut parsed) = url::Url::parse(\u0026final_url) {\n            // If n present, try to decode and rewrite query pairs safely\n            if let Some(n_val) = parsed.query_pairs().find(|(k, _)| k == \"n\").map(|(_, v)| v.to_string()) {\n                let cipher = crate::platform::cipher::Cipher::new();\n                if let Ok(n_out) = cipher.decipher_n_parameter(\u0026n_val, \u0026format!(\"https://www.youtube.com/watch?v={}\", video_id)).await {\n                    // Collect pairs first (immutable borrow), then rebuild (mutable borrow)\n                    let pairs: Vec\u003c(String, String)\u003e = parsed\n                        .query_pairs()\n                        .map(|(k, v)| (k.into_owned(), v.into_owned()))\n                        .collect();\n                    let mut new_pairs: Vec\u003c(String, String)\u003e = Vec::with_capacity(pairs.len() + 1);\n                    let mut replaced = false;\n                    for (k, v) in pairs {\n                        if k == \"n\" {\n                            new_pairs.push((k, n_out.clone()));\n                            replaced = true;\n                        } else {\n                            new_pairs.push((k, v));\n                        }\n                    }\n                    if !replaced {\n                        new_pairs.push((\"n\".to_string(), n_out));\n                    }\n                    {\n                        let mut qp = parsed.query_pairs_mut();\n                        qp.clear().extend_pairs(new_pairs.iter().map(|(k, v)| (k.as_str(), v.as_str())));\n                    }\n                }\n            }\n            // Add missing critical params (DO NOT remove rqh!)\n            let sparams_val = parsed.query_pairs().find(|(k, _)| k == \"sparams\").map(|(_, v)| v.to_string());\n            let has_rqh = parsed.query_pairs().any(|(k, _)| k == \"rqh\");\n            let sparams_has_rqh = sparams_val.as_ref().map_or(false, |s| s.contains(\"rqh\"));\n            let has_ratebypass = parsed.query_pairs().any(|(k, _)| k == \"ratebypass\");\n            let has_alr = parsed.query_pairs().any(|(k, _)| k == \"alr\");\n            \n            debug!(\"Direct URL norm: has_rqh={}, sparams_has_rqh={}, adding={}\", \n                   has_rqh, sparams_has_rqh, sparams_has_rqh \u0026\u0026 !has_rqh);\n            \n            {\n                let mut qp = parsed.query_pairs_mut();\n                if !has_ratebypass { qp.append_pair(\"ratebypass\", \"yes\"); }\n                if !has_alr { qp.append_pair(\"alr\", \"yes\"); }\n                // CRITICAL FIX: Add rqh=1 if sparams lists it (required for itag=18)\n                if sparams_has_rqh \u0026\u0026 !has_rqh {\n                    qp.append_pair(\"rqh\", \"1\");\n                    debug!(\"✅ CRITICAL: Added rqh=1 to direct URL (itag={})\", selected_format.itag);\n                }\n            }\n            let s: String = parsed.into();\n            final_url = s;\n        }\n\n        // println!(\"🔗 Selected format: itag={}, quality={}, url={}\", selected_format.itag, selected_format.quality, final_url);\n        // if let Some(sig_cipher) = \u0026selected_format.signature_cipher {\n        //     println!(\"🔐 Signature cipher: {}\", sig_cipher);\n        // }\n\n        // Create video info\n        let video_info = VideoInfo {\n            id: video_id.to_string(),\n            title: player_response.video_details.as_ref().map(|v| v.title.clone()).unwrap_or_default(),\n            author: player_response.video_details.as_ref().map(|v| v.author.clone()).unwrap_or_default(),\n            duration: player_response.video_details.as_ref()\n                .and_then(|v| v.length_seconds.parse().ok())\n                .unwrap_or(0),\n            description: player_response.video_details.as_ref().map(|v| v.short_description.clone()).unwrap_or_default(),\n            formats,\n            thumbnail: player_response.video_details.as_ref()\n                .and_then(|v| v.thumbnail.thumbnails.first())\n                .map(|t| t.url.clone()),\n            upload_date: None,\n            view_count: None,\n            like_count: None,\n            tags: Vec::new(),\n            category: None,\n        };\n\n        Ok((final_url, video_info))\n    }\n\n    /// Download video to file\n    pub async fn download(\u0026mut self, video_url: \u0026str) -\u003e Result\u003cVideoInfo, RytError\u003e {\n        // Resolve URL and get metadata (first attempt)\n        let (mut final_url, mut video_info) = self.resolve_url(video_url).await?;\n        info!(\"Starting download for: {}\", video_info.title);\n\n        // Determine output path\n        let output_path = self.determine_output_path(\u0026video_info)?;\n        debug!(\"Output path: {:?}\", output_path);\n\n        // Try download with limited retries; on 403/RateLimited regenerate URL and retry\n        let max_attempts = 2u32;\n        for attempt in 1..=max_attempts {\n            let downloader = self.downloader.lock().await;\n            let result = downloader.download(\u0026final_url, \u0026output_path).await;\n            drop(downloader);\n\n            match result {\n                Ok(()) =\u003e {\n                    info!(\"Download completed successfully\");\n                    // Update video info with output path\n                    video_info.title = output_path.file_stem()\n                        .and_then(|s| s.to_str())\n                        .unwrap_or(\"video\")\n                        .to_string();\n                    return Ok(video_info);\n                }\n                Err(RytError::RateLimited) if attempt \u003c max_attempts =\u003e {\n                    warn!(\"Rate limited/403 during media download (attempt {}/{}). Regenerating URL and retrying...\", attempt, max_attempts);\n                    // Switch client strategy for error and regenerate URL\n                    {\n                        let mut inner = self.inner_tube.lock().await;\n                        inner.switch_client_for_error(\u0026RytError::RateLimited);\n                    }\n                    // Resolve again to get fresh final_url\n                    let (new_url, _vi) = self.resolve_url(video_url).await?;\n                    final_url = new_url;\n                    continue;\n                }\n                Err(e) =\u003e return Err(e),\n            }\n        }\n\n        // If we got here, all attempts failed\n        Err(RytError::Generic(\"Download failed after retries\".to_string()))\n    }\n\n    /// Download playlist\n    pub async fn download_playlist(\u0026mut self, playlist_url: \u0026str, limit: Option\u003cusize\u003e) -\u003e Result\u003cVec\u003cVideoInfo\u003e, RytError\u003e {\n        // Extract playlist ID\n        let playlist_id = crate::utils::url::extract_playlist_id(playlist_url)?;\n\n        // Get playlist items\n        let items = {\n            let mut inner_tube = self.inner_tube.lock().await;\n            inner_tube.get_playlist_items(\u0026playlist_id, limit).await?\n        };\n\n        // Download each video\n        let mut results = Vec::new();\n        for item in items {\n            let video_url = format!(\"https://www.youtube.com/watch?v={}\", item.video_id);\n            match self.download(\u0026video_url).await {\n                Ok(info) =\u003e results.push(info),\n                Err(e) =\u003e {\n                    eprintln!(\"Failed to download {}: {}\", item.title, e);\n                    continue;\n                }\n            }\n        }\n\n        Ok(results)\n    }\n\n    /// Select format based on selector\n    fn select_format\u003c'a\u003e(\u0026self, formats: \u0026'a [Format]) -\u003e Result\u003c\u0026'a Format, RytError\u003e {\n        let default_selector = FormatSelector::new(QualitySelector::Best);\n        let selector = self.options.format_selector.as_ref()\n            .unwrap_or(\u0026default_selector);\n\n        let mut candidates: Vec\u003c\u0026Format\u003e = formats.iter().collect();\n\n        // Filter by extension\n        if let Some(ext) = \u0026selector.extension {\n            candidates.retain(|f| f.mime_type.contains(ext));\n        }\n\n        // Filter by height constraints\n        if let Some(height_limit) = selector.height_limit {\n            candidates.retain(|f| {\n                let height = f.height.unwrap_or(0);\n                height \u003c= height_limit\n            });\n        }\n\n        if let Some(height_min) = selector.height_min {\n            candidates.retain(|f| {\n                let height = f.height.unwrap_or(0);\n                height \u003e= height_min\n            });\n        }\n\n        // Select by quality\n        match \u0026selector.quality {\n            QualitySelector::Best =\u003e {\n                candidates.sort_by(|a, b| b.bitrate.cmp(\u0026a.bitrate));\n                candidates.first().copied()\n            }\n            QualitySelector::Worst =\u003e {\n                candidates.sort_by(|a, b| a.bitrate.cmp(\u0026b.bitrate));\n                candidates.first().copied()\n            }\n            QualitySelector::Itag(target_itag) =\u003e {\n                candidates.iter().find(|f| f.itag == *target_itag).copied()\n            }\n            QualitySelector::Height(target_height) =\u003e {\n                candidates.iter()\n                    .filter(|f| f.height.unwrap_or(0) == *target_height)\n                    .max_by_key(|f| f.bitrate)\n                    .copied()\n            }\n            QualitySelector::HeightLessOrEqual(target_height) =\u003e {\n                candidates.iter()\n                    .filter(|f| f.height.unwrap_or(0) \u003c= *target_height)\n                    .max_by_key(|f| f.bitrate)\n                    .copied()\n            }\n            QualitySelector::HeightGreaterOrEqual(target_height) =\u003e {\n                candidates.iter()\n                    .filter(|f| f.height.unwrap_or(0) \u003e= *target_height)\n                    .max_by_key(|f| f.bitrate)\n                    .copied()\n            }\n        }.ok_or(RytError::NoFormatFound)\n    }\n\n    /// Resolve format URL with signature deciphering\n    async fn resolve_format_url_with_cipher(\u0026self, format: \u0026Format, video_url: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        use crate::platform::cipher::Cipher;\n\n        // println!(\"🔧 Starting cipher resolution for format itag={}\", format.itag);\n        let cipher = Cipher::new();\n        let mut final_url = format.url.clone();\n\n        // Handle signature cipher\n        if let Some(sig_cipher) = \u0026format.signature_cipher {\n            // println!(\"🔧 Parsing signature cipher: {}\", sig_cipher);\n            \n            // Parse signature cipher parameters\n            let sig_params: std::collections::HashMap\u003cString, String\u003e =\n                url::form_urlencoded::parse(sig_cipher.as_bytes())\n                    .into_owned()\n                    .collect();\n\n            // println!(\"🔧 Parsed parameters: {:?}\", sig_params);\n\n            if let Some(base_url) = sig_params.get(\"url\") {\n                final_url = base_url.clone();\n                // println!(\"🔧 Base URL: {}\", final_url);\n            }\n\n            if let Some(signature) = sig_params.get(\"s\") {\n                println!(\"🔧 Deciphering signature: {}\", signature);\n                let deciphered_sig = cipher.decipher_signature(signature, video_url).await?;\n                println!(\"🔧 Deciphered signature: {}\", deciphered_sig);\n                \n                // Replace existing sig parameter or add new one\n                let sig_regex = regex::Regex::new(r\"[?\u0026]sig=([^\u0026]+)\")?;\n                if sig_regex.is_match(\u0026final_url) {\n                    // Replace existing sig parameter\n                    final_url = sig_regex.replace(\u0026final_url, |caps: \u0026regex::Captures| {\n                        format!(\"{}sig={}\", \u0026caps[0][..caps[0].find('=').unwrap() + 1], deciphered_sig)\n                    }).to_string();\n                    println!(\"🔧 Replaced sig parameter in URL\");\n                } else {\n                    // Add new sig parameter\n                    final_url = format!(\"{}\u0026sig={}\", final_url, deciphered_sig);\n                    println!(\"🔧 Added sig parameter to URL\");\n                }\n                println!(\"🔧 Final URL with deciphered sig: {}\", final_url);\n            }\n\n            if let Some(n_param) = sig_params.get(\"n\") {\n                // println!(\"🔧 Deciphering n-parameter: {}\", n_param);\n                let deciphered_n = cipher.decipher_n_parameter(n_param, video_url).await?;\n                // println!(\"🔧 Deciphered n-parameter: {}\", deciphered_n);\n                \n                // Add n-parameter to URL\n                if final_url.contains(\"\u0026n=\") {\n                    final_url = final_url.replace(\"\u0026n=\", \u0026format!(\"\u0026n={}\", deciphered_n));\n                } else {\n                    final_url = format!(\"{}\u0026n={}\", final_url, deciphered_n);\n                }\n            }\n        }\n        \n        // Handle n-parameter in URL\n        if final_url.contains(\"\u0026n=\") || final_url.contains(\"?n=\") {\n            let n_regex = regex::Regex::new(r\"[?\u0026]n=([^\u0026]+)\")?;\n            if let Some(captures) = n_regex.captures(\u0026final_url) {\n                if let Some(n_param) = captures.get(1) {\n                    let deciphered_n = cipher.decipher_n_parameter(n_param.as_str(), video_url).await?;\n                    final_url = final_url.replace(n_param.as_str(), \u0026deciphered_n);\n                }\n            }\n        }\n\n        // Normalize URL parameters similar to Go ytdlp:\n        // - ensure n is decoded if present (handled above already)\n        // - enforce ratebypass=yes\n        // - add alr=yes to encourage stable redirects\n        if let Ok(mut parsed) = url::Url::parse(\u0026final_url) {\n            // Precompute existence flags before taking a mutable borrow\n            let has_ratebypass = parsed.query_pairs().any(|(k, _)| k == \"ratebypass\");\n            let has_alr = parsed.query_pairs().any(|(k, _)| k == \"alr\");\n\n            // Add missing params. If sparams contains rqh but rqh parameter is missing, add it\n            let sparams_val = parsed.query_pairs().find(|(k, _)| k == \"sparams\").map(|(_, v)| v.to_string());\n            let has_rqh = parsed.query_pairs().any(|(k, _)| k == \"rqh\");\n            let sparams_has_rqh = sparams_val.as_ref().map_or(false, |s| s.contains(\"rqh\"));\n            let current_fvip = parsed.query_pairs().find(|(k, _)| k == \"fvip\").map(|(_, v)| v.to_string());\n            \n            debug!(\"URL normalization: has_rqh={}, sparams_has_rqh={}, will add rqh={}\", \n                   has_rqh, sparams_has_rqh, sparams_has_rqh \u0026\u0026 !has_rqh);\n            \n            {\n                let mut qp = parsed.query_pairs_mut();\n                if !has_ratebypass {\n                    qp.append_pair(\"ratebypass\", \"yes\");\n                    debug!(\"Added ratebypass=yes\");\n                }\n                if !has_alr {\n                    qp.append_pair(\"alr\", \"yes\");\n                    debug!(\"Added alr=yes\");\n                }\n                // If sparams lists rqh but rqh param is missing, add rqh=1 (CRITICAL for itag 18)\n                if sparams_has_rqh \u0026\u0026 !has_rqh {\n                    qp.append_pair(\"rqh\", \"1\");\n                    debug!(\"✅ Added rqh=1 (required by sparams)\");\n                }\n            }\n            \n            // Professional 403 mitigation: rotate fvip (front video IP) to get different CDN server\n            // YouTube uses fvip=1..5 for load balancing; rotating helps bypass temporary blocks\n            if let Some(fvip_str) = current_fvip {\n                if let Ok(fvip_num) = fvip_str.parse::\u003cu8\u003e() {\n                    // Cycle through fvip 1-5\n                    let new_fvip = (fvip_num % 5) + 1;\n                    // Rebuild query without fvip\n                    let pairs: Vec\u003c(String, String)\u003e = parsed.query_pairs()\n                        .filter(|(k, _)| k != \"fvip\")\n                        .map(|(k, v)| (k.into_owned(), v.into_owned()))\n                        .collect();\n                    {\n                        let mut qp = parsed.query_pairs_mut();\n                        qp.clear().extend_pairs(pairs.iter().map(|(k, v)| (k.as_str(), v.as_str())));\n                        qp.append_pair(\"fvip\", \u0026new_fvip.to_string());\n                    }\n                    debug!(\"Rotated fvip from {} to {} for CDN failover\", fvip_num, new_fvip);\n                }\n            }\n\n            let s: String = parsed.into();\n            return Ok(s);\n        }\n\n        Ok(final_url)\n    }\n\n    /// Determine output path for downloaded file\n    fn determine_output_path(\u0026self, video_info: \u0026VideoInfo) -\u003e Result\u003cPathBuf, RytError\u003e {\n        if let Some(output_path) = \u0026self.options.output_path {\n            if output_path.is_dir() {\n                // Generate filename from title\n                let ext = self.options.desired_ext.as_deref().unwrap_or(\"mp4\");\n                let safe_filename = to_safe_filename(\u0026video_info.title, ext);\n                Ok(output_path.join(safe_filename))\n            } else {\n                // Use provided path as-is\n                Ok(output_path.clone())\n            }\n        } else {\n            // Generate filename in current directory\n            let ext = self.options.desired_ext.as_deref().unwrap_or(\"mp4\");\n            let safe_filename = to_safe_filename(\u0026video_info.title, ext);\n            Ok(PathBuf::from(safe_filename))\n        }\n    }\n}\n\nimpl Default for Downloader {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_downloader_creation() {\n        let downloader = Downloader::new();\n        assert_eq!(downloader.options.client_name, \"ANDROID\");\n        assert_eq!(downloader.options.client_version, \"20.10.38\");\n    }\n\n    #[test]\n    fn test_downloader_with_format() {\n        let downloader = Downloader::new()\n            .with_format(\"best\", \"mp4\")\n            .with_rate_limit(1024 * 1024); // 1MB/s\n\n        assert!(downloader.options.format_selector.is_some());\n        assert_eq!(downloader.options.rate_limit_bps, Some(1024 * 1024));\n    }\n\n    #[test]\n    fn test_downloader_with_botguard() {\n        let downloader = Downloader::new()\n            .with_botguard(crate::platform::botguard::BotguardMode::Auto)\n            .with_botguard_debug(true);\n\n        assert_eq!(downloader.botguard.mode, crate::platform::botguard::BotguardMode::Auto);\n        assert!(downloader.botguard.debug);\n    }\n}\n","traces":[{"line":37,"address":[],"length":0,"stats":{"Line":3}},{"line":43,"address":[],"length":0,"stats":{"Line":9}},{"line":44,"address":[],"length":0,"stats":{"Line":6}},{"line":45,"address":[],"length":0,"stats":{"Line":3}},{"line":63,"address":[],"length":0,"stats":{"Line":3}},{"line":67,"address":[],"length":0,"stats":{"Line":3}},{"line":82,"address":[],"length":0,"stats":{"Line":3}},{"line":84,"address":[],"length":0,"stats":{"Line":6}},{"line":85,"address":[],"length":0,"stats":{"Line":6}},{"line":86,"address":[],"length":0,"stats":{"Line":12}},{"line":87,"address":[],"length":0,"stats":{"Line":6}},{"line":92,"address":[],"length":0,"stats":{"Line":1}},{"line":93,"address":[],"length":0,"stats":{"Line":2}},{"line":96,"address":[],"length":0,"stats":{"Line":1}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":1}},{"line":113,"address":[],"length":0,"stats":{"Line":1}},{"line":114,"address":[],"length":0,"stats":{"Line":1}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":1}},{"line":126,"address":[],"length":0,"stats":{"Line":1}},{"line":127,"address":[],"length":0,"stats":{"Line":1}},{"line":131,"address":[],"length":0,"stats":{"Line":1}},{"line":132,"address":[],"length":0,"stats":{"Line":1}},{"line":133,"address":[],"length":0,"stats":{"Line":1}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":269,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":287,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":317,"address":[],"length":0,"stats":{"Line":0}},{"line":319,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":325,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":375,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":474,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":479,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":488,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":494,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":501,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":509,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":543,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":553,"address":[],"length":0,"stats":{"Line":0}},{"line":555,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":563,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":575,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":582,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":586,"address":[],"length":0,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":0}},{"line":591,"address":[],"length":0,"stats":{"Line":0}},{"line":592,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":597,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[],"length":0,"stats":{"Line":0}},{"line":601,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":608,"address":[],"length":0,"stats":{"Line":0}},{"line":609,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":613,"address":[],"length":0,"stats":{"Line":0}},{"line":614,"address":[],"length":0,"stats":{"Line":0}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":618,"address":[],"length":0,"stats":{"Line":0}},{"line":619,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":622,"address":[],"length":0,"stats":{"Line":0}},{"line":626,"address":[],"length":0,"stats":{"Line":0}},{"line":627,"address":[],"length":0,"stats":{"Line":0}},{"line":630,"address":[],"length":0,"stats":{"Line":0}},{"line":634,"address":[],"length":0,"stats":{"Line":0}},{"line":635,"address":[],"length":0,"stats":{"Line":0}},{"line":636,"address":[],"length":0,"stats":{"Line":0}},{"line":638,"address":[],"length":0,"stats":{"Line":0}},{"line":639,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":643,"address":[],"length":0,"stats":{"Line":0}},{"line":647,"address":[],"length":0,"stats":{"Line":0}},{"line":648,"address":[],"length":0,"stats":{"Line":0}},{"line":649,"address":[],"length":0,"stats":{"Line":0}},{"line":655,"address":[],"length":0,"stats":{"Line":0}},{"line":656,"address":[],"length":0,"stats":{"Line":0}}],"covered":23,"coverable":296},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","core","mod.rs"],"content":"//! Core functionality for ryt\n\npub mod downloader;\npub mod progress;\npub mod video_info;\n\npub use downloader::*;\npub use progress::*;\npub use video_info::*;\n\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","core","progress.rs"],"content":"//! Progress tracking for downloads\n\nuse std::time::{Duration, Instant};\n\n/// Progress information for a download\n#[derive(Debug, Clone)]\npub struct Progress {\n    /// Total size of the file in bytes\n    pub total_size: u64,\n    /// Number of bytes downloaded\n    pub downloaded_size: u64,\n    /// Download progress as a percentage (0.0 to 100.0)\n    pub percent: f64,\n    /// Current download speed in bytes per second\n    pub speed: Option\u003cf64\u003e,\n    /// Estimated time remaining\n    pub eta: Option\u003cDuration\u003e,\n    /// Time when download started\n    pub start_time: Instant,\n}\n\nimpl Progress {\n    /// Create a new progress tracker\n    pub fn new(total_size: u64) -\u003e Self {\n        Self {\n            total_size,\n            downloaded_size: 0,\n            percent: 0.0,\n            speed: None,\n            eta: None,\n            start_time: Instant::now(),\n        }\n    }\n\n    /// Update progress with new downloaded size\n    pub fn update(\u0026mut self, downloaded_size: u64) {\n        self.downloaded_size = downloaded_size;\n        self.percent = if self.total_size \u003e 0 {\n            (downloaded_size as f64 / self.total_size as f64) * 100.0\n        } else {\n            0.0\n        };\n\n        // Calculate speed and ETA\n        let elapsed = self.start_time.elapsed();\n        if elapsed.as_millis() \u003e 0 {\n            self.speed = Some(downloaded_size as f64 / elapsed.as_secs_f64());\n            \n            if let Some(speed) = self.speed {\n                if speed \u003e 0.0 \u0026\u0026 self.total_size \u003e downloaded_size {\n                    let remaining_bytes = self.total_size - downloaded_size;\n                    self.eta = Some(Duration::from_secs((remaining_bytes as f64 / speed) as u64));\n                }\n            }\n        }\n    }\n\n    /// Check if download is complete\n    pub fn is_complete(\u0026self) -\u003e bool {\n        self.total_size \u003e 0 \u0026\u0026 self.downloaded_size \u003e= self.total_size\n    }\n\n    /// Get human-readable speed string\n    pub fn speed_string(\u0026self) -\u003e String {\n        if let Some(speed) = self.speed {\n            format_bytes_per_second(speed)\n        } else {\n            \"Unknown\".to_string()\n        }\n    }\n\n    /// Get human-readable ETA string\n    pub fn eta_string(\u0026self) -\u003e String {\n        if let Some(eta) = self.eta {\n            format_duration(eta)\n        } else {\n            \"Unknown\".to_string()\n        }\n    }\n\n    /// Get human-readable total size string\n    pub fn total_size_string(\u0026self) -\u003e String {\n        format_bytes(self.total_size)\n    }\n\n    /// Get human-readable downloaded size string\n    pub fn downloaded_size_string(\u0026self) -\u003e String {\n        format_bytes(self.downloaded_size)\n    }\n}\n\n/// Format bytes as human-readable string\npub fn format_bytes(bytes: u64) -\u003e String {\n    const UNITS: \u0026[\u0026str] = \u0026[\"B\", \"KB\", \"MB\", \"GB\", \"TB\"];\n    const THRESHOLD: f64 = 1024.0;\n\n    if bytes == 0 {\n        return \"0 B\".to_string();\n    }\n\n    let bytes_f64 = bytes as f64;\n    let exp = (bytes_f64.ln() / THRESHOLD.ln()).floor() as usize;\n    let exp = exp.min(UNITS.len() - 1);\n    \n    let value = bytes_f64 / THRESHOLD.powi(exp as i32);\n    \n    if exp == 0 {\n        format!(\"{} {}\", bytes, UNITS[exp])\n    } else {\n        format!(\"{:.1} {}\", value, UNITS[exp])\n    }\n}\n\n/// Format bytes per second as human-readable string\npub fn format_bytes_per_second(bytes_per_second: f64) -\u003e String {\n    format!(\"{}/s\", format_bytes(bytes_per_second as u64))\n}\n\n/// Format duration as human-readable string\npub fn format_duration(duration: Duration) -\u003e String {\n    let total_seconds = duration.as_secs();\n    \n    if total_seconds \u003c 60 {\n        format!(\"{}s\", total_seconds)\n    } else if total_seconds \u003c 3600 {\n        let minutes = total_seconds / 60;\n        let seconds = total_seconds % 60;\n        if seconds == 0 {\n            format!(\"{}m\", minutes)\n        } else {\n            format!(\"{}m {}s\", minutes, seconds)\n        }\n    } else {\n        let hours = total_seconds / 3600;\n        let minutes = (total_seconds % 3600) / 60;\n        if minutes == 0 {\n            format!(\"{}h\", hours)\n        } else {\n            format!(\"{}h {}m\", hours, minutes)\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::thread;\n    use std::time::Duration;\n\n    #[test]\n    fn test_progress_creation() {\n        let progress = Progress::new(1000);\n        assert_eq!(progress.total_size, 1000);\n        assert_eq!(progress.downloaded_size, 0);\n        assert_eq!(progress.percent, 0.0);\n        assert!(!progress.is_complete());\n    }\n\n    #[test]\n    fn test_progress_update() {\n        let mut progress = Progress::new(1000);\n        \n        progress.update(500);\n        assert_eq!(progress.downloaded_size, 500);\n        assert_eq!(progress.percent, 50.0);\n        assert!(!progress.is_complete());\n        \n        progress.update(1000);\n        assert_eq!(progress.downloaded_size, 1000);\n        assert_eq!(progress.percent, 100.0);\n        assert!(progress.is_complete());\n    }\n\n    #[test]\n    fn test_progress_speed_calculation() {\n        let mut progress = Progress::new(1000);\n        \n        // Simulate some time passing\n        thread::sleep(Duration::from_millis(100));\n        progress.update(100);\n        \n        // Speed should be calculated\n        assert!(progress.speed.is_some());\n        assert!(progress.speed.unwrap() \u003e 0.0);\n    }\n\n    #[test]\n    fn test_format_bytes() {\n        assert_eq!(format_bytes(0), \"0 B\");\n        assert_eq!(format_bytes(1023), \"1023 B\");\n        assert_eq!(format_bytes(1024), \"1.0 KB\");\n        assert_eq!(format_bytes(1536), \"1.5 KB\");\n        assert_eq!(format_bytes(1048576), \"1.0 MB\");\n        assert_eq!(format_bytes(1073741824), \"1.0 GB\");\n    }\n\n    #[test]\n    fn test_format_duration() {\n        assert_eq!(format_duration(Duration::from_secs(30)), \"30s\");\n        assert_eq!(format_duration(Duration::from_secs(60)), \"1m\");\n        assert_eq!(format_duration(Duration::from_secs(90)), \"1m 30s\");\n        assert_eq!(format_duration(Duration::from_secs(3600)), \"1h\");\n        assert_eq!(format_duration(Duration::from_secs(3660)), \"1h 1m\");\n    }\n}\n","traces":[{"line":24,"address":[],"length":0,"stats":{"Line":3}},{"line":31,"address":[],"length":0,"stats":{"Line":3}},{"line":36,"address":[],"length":0,"stats":{"Line":3}},{"line":37,"address":[],"length":0,"stats":{"Line":3}},{"line":38,"address":[],"length":0,"stats":{"Line":3}},{"line":39,"address":[],"length":0,"stats":{"Line":3}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":9}},{"line":46,"address":[],"length":0,"stats":{"Line":3}},{"line":47,"address":[],"length":0,"stats":{"Line":2}},{"line":49,"address":[],"length":0,"stats":{"Line":2}},{"line":50,"address":[],"length":0,"stats":{"Line":2}},{"line":51,"address":[],"length":0,"stats":{"Line":3}},{"line":52,"address":[],"length":0,"stats":{"Line":2}},{"line":59,"address":[],"length":0,"stats":{"Line":3}},{"line":60,"address":[],"length":0,"stats":{"Line":6}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":6}},{"line":97,"address":[],"length":0,"stats":{"Line":6}},{"line":98,"address":[],"length":0,"stats":{"Line":2}},{"line":108,"address":[],"length":0,"stats":{"Line":3}},{"line":110,"address":[],"length":0,"stats":{"Line":4}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":5}},{"line":121,"address":[],"length":0,"stats":{"Line":15}},{"line":123,"address":[],"length":0,"stats":{"Line":5}},{"line":124,"address":[],"length":0,"stats":{"Line":2}},{"line":125,"address":[],"length":0,"stats":{"Line":4}},{"line":126,"address":[],"length":0,"stats":{"Line":4}},{"line":127,"address":[],"length":0,"stats":{"Line":4}},{"line":128,"address":[],"length":0,"stats":{"Line":2}},{"line":129,"address":[],"length":0,"stats":{"Line":2}},{"line":131,"address":[],"length":0,"stats":{"Line":1}},{"line":134,"address":[],"length":0,"stats":{"Line":2}},{"line":137,"address":[],"length":0,"stats":{"Line":2}},{"line":139,"address":[],"length":0,"stats":{"Line":1}}],"covered":33,"coverable":48},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","core","video_info.rs"],"content":"//! Video information structures\n\nuse serde::{Deserialize, Serialize};\n\n/// Video information and metadata\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct VideoInfo {\n    /// YouTube video ID\n    pub id: String,\n    /// Video title\n    pub title: String,\n    /// Video author/channel name\n    pub author: String,\n    /// Video duration in seconds\n    pub duration: u32,\n    /// Video description\n    pub description: String,\n    /// Available formats\n    pub formats: Vec\u003cFormat\u003e,\n    /// Video thumbnail URL\n    pub thumbnail: Option\u003cString\u003e,\n    /// Video upload date\n    pub upload_date: Option\u003cString\u003e,\n    /// Video view count\n    pub view_count: Option\u003cu64\u003e,\n    /// Video like count\n    pub like_count: Option\u003cu64\u003e,\n    /// Video tags\n    pub tags: Vec\u003cString\u003e,\n    /// Video category\n    pub category: Option\u003cString\u003e,\n}\n\nimpl VideoInfo {\n    /// Create a new VideoInfo\n    pub fn new(id: String, title: String) -\u003e Self {\n        Self {\n            id,\n            title,\n            author: String::new(),\n            duration: 0,\n            description: String::new(),\n            formats: Vec::new(),\n            thumbnail: None,\n            upload_date: None,\n            view_count: None,\n            like_count: None,\n            tags: Vec::new(),\n            category: None,\n        }\n    }\n\n    /// Get the best available format\n    pub fn best_format(\u0026self) -\u003e Option\u003c\u0026Format\u003e {\n        self.formats.iter().max_by_key(|f| f.bitrate)\n    }\n\n    /// Get formats filtered by extension\n    pub fn formats_by_extension(\u0026self, extension: \u0026str) -\u003e Vec\u003c\u0026Format\u003e {\n        self.formats\n            .iter()\n            .filter(|f| f.mime_type.contains(extension))\n            .collect()\n    }\n\n    /// Get formats filtered by quality\n    pub fn formats_by_quality(\u0026self, quality: \u0026str) -\u003e Vec\u003c\u0026Format\u003e {\n        self.formats\n            .iter()\n            .filter(|f| f.quality == quality)\n            .collect()\n    }\n\n    /// Get the total size of all formats\n    pub fn total_size(\u0026self) -\u003e u64 {\n        self.formats.iter().map(|f| f.size.unwrap_or(0)).sum()\n    }\n\n    /// Check if video has progressive formats (video+audio combined)\n    pub fn has_progressive_formats(\u0026self) -\u003e bool {\n        self.formats.iter().any(|f| f.is_progressive())\n    }\n\n    /// Check if video has adaptive formats (video or audio only)\n    pub fn has_adaptive_formats(\u0026self) -\u003e bool {\n        self.formats.iter().any(|f| f.is_adaptive())\n    }\n}\n\n/// Video format information\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Format {\n    /// YouTube format ID (itag)\n    pub itag: u32,\n    /// Direct download URL\n    pub url: String,\n    /// Quality label (e.g., \"720p\", \"1080p\")\n    pub quality: String,\n    /// MIME type\n    pub mime_type: String,\n    /// Bitrate in bits per second\n    pub bitrate: u32,\n    /// File size in bytes (if known)\n    pub size: Option\u003cu64\u003e,\n    /// Signature cipher (if encrypted)\n    pub signature_cipher: Option\u003cString\u003e,\n    /// Audio codec\n    pub audio_codec: Option\u003cString\u003e,\n    /// Video codec\n    pub video_codec: Option\u003cString\u003e,\n    /// Frame rate\n    pub fps: Option\u003cu32\u003e,\n    /// Video width\n    pub width: Option\u003cu32\u003e,\n    /// Video height\n    pub height: Option\u003cu32\u003e,\n    /// Audio sample rate\n    pub audio_sample_rate: Option\u003cu32\u003e,\n    /// Audio channels\n    pub audio_channels: Option\u003cu32\u003e,\n    /// Language code\n    pub language: Option\u003cString\u003e,\n    /// Format note/description\n    pub note: Option\u003cString\u003e,\n}\n\nimpl Format {\n    /// Create a new Format\n    pub fn new(itag: u32, url: String, quality: String, mime_type: String) -\u003e Self {\n        Self {\n            itag,\n            url,\n            quality,\n            mime_type,\n            bitrate: 0,\n            size: None,\n            signature_cipher: None,\n            audio_codec: None,\n            video_codec: None,\n            fps: None,\n            width: None,\n            height: None,\n            audio_sample_rate: None,\n            audio_channels: None,\n            language: None,\n            note: None,\n        }\n    }\n\n    /// Check if format is progressive (video+audio combined)\n    pub fn is_progressive(\u0026self) -\u003e bool {\n        self.mime_type.starts_with(\"video/\") \u0026\u0026 \n        (self.mime_type.contains(\"mp4\") || self.mime_type.contains(\"webm\")) \u0026\u0026\n        self.audio_codec.is_some() \u0026\u0026 self.video_codec.is_some()\n    }\n\n    /// Check if format is adaptive (video or audio only)\n    pub fn is_adaptive(\u0026self) -\u003e bool {\n        (self.mime_type.starts_with(\"video/\") \u0026\u0026 self.audio_codec.is_none()) || \n        self.mime_type.starts_with(\"audio/\")\n    }\n\n    /// Check if format is video-only\n    pub fn is_video_only(\u0026self) -\u003e bool {\n        self.mime_type.starts_with(\"video/\") \u0026\u0026 self.audio_codec.is_none()\n    }\n\n    /// Check if format is audio-only\n    pub fn is_audio_only(\u0026self) -\u003e bool {\n        self.mime_type.starts_with(\"audio/\")\n    }\n\n    /// Get file extension from MIME type\n    pub fn extension(\u0026self) -\u003e \u0026'static str {\n        crate::utils::mime::ext_from_mime(\u0026self.mime_type)\n    }\n\n    /// Get container format\n    pub fn container(\u0026self) -\u003e \u0026'static str {\n        crate::utils::mime::get_container_format(\u0026self.mime_type)\n    }\n\n    /// Check if format needs signature deciphering\n    pub fn needs_deciphering(\u0026self) -\u003e bool {\n        self.signature_cipher.is_some() || \n        self.url.contains(\"\u0026n=\") || \n        self.url.contains(\"?n=\") ||\n        self.url.is_empty()\n    }\n\n    /// Get human-readable quality string\n    pub fn quality_string(\u0026self) -\u003e String {\n        if !self.quality.is_empty() {\n            self.quality.clone()\n        } else if let (Some(width), Some(height)) = (self.width, self.height) {\n            format!(\"{}x{}\", width, height)\n        } else {\n            \"Unknown\".to_string()\n        }\n    }\n\n    /// Get human-readable size string\n    pub fn size_string(\u0026self) -\u003e String {\n        if let Some(size) = self.size {\n            crate::core::progress::format_bytes(size)\n        } else {\n            \"Unknown\".to_string()\n        }\n    }\n\n    /// Get human-readable bitrate string\n    pub fn bitrate_string(\u0026self) -\u003e String {\n        if self.bitrate \u003e 0 {\n            format!(\"{} kbps\", self.bitrate / 1000)\n        } else {\n            \"Unknown\".to_string()\n        }\n    }\n}\n\n/// Playlist item information\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct PlaylistItem {\n    /// Video ID\n    pub video_id: String,\n    /// Video title\n    pub title: String,\n    /// Video author\n    pub author: String,\n    /// Video duration in seconds\n    pub duration: u32,\n    /// Playlist index\n    pub index: u32,\n    /// Video thumbnail URL\n    pub thumbnail: Option\u003cString\u003e,\n    /// Video description\n    pub description: Option\u003cString\u003e,\n}\n\nimpl PlaylistItem {\n    /// Create a new PlaylistItem\n    pub fn new(video_id: String, title: String, index: u32) -\u003e Self {\n        Self {\n            video_id,\n            title,\n            author: String::new(),\n            duration: 0,\n            index,\n            thumbnail: None,\n            description: None,\n        }\n    }\n\n    /// Get the YouTube URL for this video\n    pub fn url(\u0026self) -\u003e String {\n        format!(\"https://www.youtube.com/watch?v={}\", self.video_id)\n    }\n}\n\n/// Format selector for choosing video formats\n#[derive(Debug, Clone)]\npub struct FormatSelector {\n    /// Quality selector\n    pub quality: QualitySelector,\n    /// Desired file extension\n    pub extension: Option\u003cString\u003e,\n    /// Maximum height constraint\n    pub height_limit: Option\u003cu32\u003e,\n    /// Minimum height constraint\n    pub height_min: Option\u003cu32\u003e,\n    /// Preferred itag\n    pub preferred_itag: Option\u003cu32\u003e,\n}\n\nimpl FormatSelector {\n    /// Create a new format selector\n    pub fn new(quality: QualitySelector) -\u003e Self {\n        Self {\n            quality,\n            extension: None,\n            height_limit: None,\n            height_min: None,\n            preferred_itag: None,\n        }\n    }\n\n    /// Set desired extension\n    pub fn with_extension(mut self, extension: \u0026str) -\u003e Self {\n        self.extension = Some(extension.to_string());\n        self\n    }\n\n    /// Set height limit\n    pub fn with_height_limit(mut self, height: u32) -\u003e Self {\n        self.height_limit = Some(height);\n        self\n    }\n\n    /// Set minimum height\n    pub fn with_height_min(mut self, height: u32) -\u003e Self {\n        self.height_min = Some(height);\n        self\n    }\n\n    /// Set preferred itag\n    pub fn with_itag(mut self, itag: u32) -\u003e Self {\n        self.preferred_itag = Some(itag);\n        self\n    }\n}\n\n/// Quality selection criteria\n#[derive(Debug, Clone, PartialEq)]\npub enum QualitySelector {\n    /// Best quality available\n    Best,\n    /// Worst quality available\n    Worst,\n    /// Specific itag\n    Itag(u32),\n    /// Specific height\n    Height(u32),\n    /// Height less than or equal to\n    HeightLessOrEqual(u32),\n    /// Height greater than or equal to\n    HeightGreaterOrEqual(u32),\n}\n\nimpl QualitySelector {\n    /// Parse quality selector from string\n    pub fn from_str(s: \u0026str) -\u003e Result\u003cSelf, String\u003e {\n        let s = s.trim().to_lowercase();\n        \n        match s.as_str() {\n            \"best\" =\u003e Ok(QualitySelector::Best),\n            \"worst\" =\u003e Ok(QualitySelector::Worst),\n            _ =\u003e {\n                if s.starts_with(\"itag=\") {\n                    let itag_str = \u0026s[5..];\n                    let itag = itag_str.parse::\u003cu32\u003e()\n                        .map_err(|_| format!(\"Invalid itag: {}\", itag_str))?;\n                    Ok(QualitySelector::Itag(itag))\n                } else if s.starts_with(\"height\u003c=\") {\n                    let height_str = \u0026s[8..];\n                    let height = height_str.parse::\u003cu32\u003e()\n                        .map_err(|_| format!(\"Invalid height: {}\", height_str))?;\n                    Ok(QualitySelector::HeightLessOrEqual(height))\n                } else if s.starts_with(\"height\u003e=\") {\n                    let height_str = \u0026s[8..];\n                    let height = height_str.parse::\u003cu32\u003e()\n                        .map_err(|_| format!(\"Invalid height: {}\", height_str))?;\n                    Ok(QualitySelector::HeightGreaterOrEqual(height))\n                } else if s.starts_with(\"height=\") {\n                    let height_str = \u0026s[7..];\n                    let height = height_str.parse::\u003cu32\u003e()\n                        .map_err(|_| format!(\"Invalid height: {}\", height_str))?;\n                    Ok(QualitySelector::Height(height))\n                } else {\n                    Err(format!(\"Unknown quality selector: {}\", s))\n                }\n            }\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_video_info_creation() {\n        let info = VideoInfo::new(\"test_id\".to_string(), \"Test Video\".to_string());\n        assert_eq!(info.id, \"test_id\");\n        assert_eq!(info.title, \"Test Video\");\n        assert!(info.formats.is_empty());\n    }\n\n    #[test]\n    fn test_format_creation() {\n        let format = Format::new(22, \"http://example.com\".to_string(), \"720p\".to_string(), \"video/mp4\".to_string());\n        assert_eq!(format.itag, 22);\n        assert_eq!(format.quality, \"720p\");\n        assert_eq!(format.mime_type, \"video/mp4\");\n    }\n\n    #[test]\n    fn test_format_progressive() {\n        let mut format = Format::new(22, \"http://example.com\".to_string(), \"720p\".to_string(), \"video/mp4\".to_string());\n        format.audio_codec = Some(\"aac\".to_string());\n        format.video_codec = Some(\"avc1\".to_string());\n        \n        assert!(format.is_progressive());\n        assert!(!format.is_adaptive());\n    }\n\n    #[test]\n    fn test_format_adaptive() {\n        let format = Format::new(137, \"http://example.com\".to_string(), \"1080p\".to_string(), \"video/mp4\".to_string());\n        assert!(!format.is_progressive());\n        assert!(format.is_adaptive());\n        assert!(format.is_video_only());\n    }\n\n    #[test]\n    fn test_quality_selector_parsing() {\n        assert_eq!(QualitySelector::from_str(\"best\").unwrap(), QualitySelector::Best);\n        assert_eq!(QualitySelector::from_str(\"worst\").unwrap(), QualitySelector::Worst);\n        assert_eq!(QualitySelector::from_str(\"itag=22\").unwrap(), QualitySelector::Itag(22));\n        assert_eq!(QualitySelector::from_str(\"height\u003c=720\").unwrap(), QualitySelector::HeightLessOrEqual(720));\n        assert_eq!(QualitySelector::from_str(\"height\u003e=480\").unwrap(), QualitySelector::HeightGreaterOrEqual(480));\n        assert_eq!(QualitySelector::from_str(\"height=1080\").unwrap(), QualitySelector::Height(1080));\n        \n        assert!(QualitySelector::from_str(\"invalid\").is_err());\n    }\n\n    #[test]\n    fn test_format_selector() {\n        let selector = FormatSelector::new(QualitySelector::Best)\n            .with_extension(\"mp4\")\n            .with_height_limit(720);\n        \n        assert!(matches!(selector.quality, QualitySelector::Best));\n        assert_eq!(selector.extension, Some(\"mp4\".to_string()));\n        assert_eq!(selector.height_limit, Some(720));\n    }\n}\n","traces":[{"line":36,"address":[],"length":0,"stats":{"Line":1}},{"line":40,"address":[],"length":0,"stats":{"Line":2}},{"line":42,"address":[],"length":0,"stats":{"Line":2}},{"line":43,"address":[],"length":0,"stats":{"Line":2}},{"line":48,"address":[],"length":0,"stats":{"Line":1}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":3}},{"line":151,"address":[],"length":0,"stats":{"Line":10}},{"line":152,"address":[],"length":0,"stats":{"Line":10}},{"line":153,"address":[],"length":0,"stats":{"Line":10}},{"line":154,"address":[],"length":0,"stats":{"Line":24}},{"line":158,"address":[],"length":0,"stats":{"Line":2}},{"line":159,"address":[],"length":0,"stats":{"Line":6}},{"line":160,"address":[],"length":0,"stats":{"Line":1}},{"line":164,"address":[],"length":0,"stats":{"Line":7}},{"line":165,"address":[],"length":0,"stats":{"Line":21}},{"line":169,"address":[],"length":0,"stats":{"Line":3}},{"line":170,"address":[],"length":0,"stats":{"Line":3}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":6}},{"line":288,"address":[],"length":0,"stats":{"Line":2}},{"line":289,"address":[],"length":0,"stats":{"Line":4}},{"line":290,"address":[],"length":0,"stats":{"Line":2}},{"line":294,"address":[],"length":0,"stats":{"Line":2}},{"line":295,"address":[],"length":0,"stats":{"Line":2}},{"line":296,"address":[],"length":0,"stats":{"Line":2}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":8}},{"line":332,"address":[],"length":0,"stats":{"Line":24}},{"line":334,"address":[],"length":0,"stats":{"Line":8}},{"line":335,"address":[],"length":0,"stats":{"Line":10}},{"line":336,"address":[],"length":0,"stats":{"Line":7}},{"line":338,"address":[],"length":0,"stats":{"Line":5}},{"line":339,"address":[],"length":0,"stats":{"Line":2}},{"line":340,"address":[],"length":0,"stats":{"Line":3}},{"line":341,"address":[],"length":0,"stats":{"Line":1}},{"line":343,"address":[],"length":0,"stats":{"Line":4}},{"line":344,"address":[],"length":0,"stats":{"Line":2}},{"line":345,"address":[],"length":0,"stats":{"Line":3}},{"line":346,"address":[],"length":0,"stats":{"Line":1}},{"line":348,"address":[],"length":0,"stats":{"Line":3}},{"line":349,"address":[],"length":0,"stats":{"Line":2}},{"line":350,"address":[],"length":0,"stats":{"Line":3}},{"line":351,"address":[],"length":0,"stats":{"Line":1}},{"line":353,"address":[],"length":0,"stats":{"Line":2}},{"line":354,"address":[],"length":0,"stats":{"Line":2}},{"line":355,"address":[],"length":0,"stats":{"Line":3}},{"line":356,"address":[],"length":0,"stats":{"Line":1}},{"line":359,"address":[],"length":0,"stats":{"Line":1}}],"covered":46,"coverable":93},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","download","downloader.rs"],"content":"//! Chunked downloader implementation\n\nuse crate::core::progress::Progress;\nuse crate::error::RytError;\nuse crate::platform::client::VideoClient;\nuse std::path::Path;\nuse std::sync::Arc;\nuse std::time::Duration;\nuse tokio::fs::File;\nuse tokio::io::AsyncWriteExt;\nuse tokio::sync::Mutex;\n\n/// Chunked downloader configuration\n#[derive(Clone)]\npub struct DownloaderConfig {\n    /// Chunk size in bytes\n    pub chunk_size: u64,\n    /// Maximum retries per chunk\n    pub max_retries: u32,\n    /// Rate limit in bytes per second\n    pub rate_limit_bps: Option\u003cu64\u003e,\n    /// Progress callback\n    pub progress_callback: Option\u003cArc\u003cdyn Fn(Progress) + Send + Sync\u003e\u003e,\n}\n\nimpl Default for DownloaderConfig {\n    fn default() -\u003e Self {\n        Self {\n            chunk_size: 1024 * 1024, // 1MB\n            max_retries: 3,\n            rate_limit_bps: None,\n            progress_callback: None,\n        }\n    }\n}\n\n/// Chunked downloader\npub struct ChunkedDownloader {\n    video_client: Arc\u003cMutex\u003cVideoClient\u003e\u003e,\n    config: DownloaderConfig,\n    rate_limiter: Option\u003cArc\u003cMutex\u003cRateLimiter\u003e\u003e\u003e,\n}\n\n/// Rate limiter for controlling download speed\nstruct RateLimiter {\n    bytes_per_second: u64,\n    last_update: std::time::Instant,\n    bytes_sent: u64,\n}\n\nimpl RateLimiter {\n    fn new(bytes_per_second: u64) -\u003e Self {\n        Self {\n            bytes_per_second,\n            last_update: std::time::Instant::now(),\n            bytes_sent: 0,\n        }\n    }\n\n    async fn wait_if_needed(\u0026mut self, bytes: u64) {\n        let now = std::time::Instant::now();\n        let elapsed = now.duration_since(self.last_update);\n        \n        // Calculate how many bytes we should have sent by now\n        let expected_bytes = (elapsed.as_secs_f64() * self.bytes_per_second as f64) as u64;\n        \n        if self.bytes_sent + bytes \u003e expected_bytes {\n            // We're going too fast, need to wait\n            let excess_bytes = (self.bytes_sent + bytes) - expected_bytes;\n            let wait_time = Duration::from_secs_f64(excess_bytes as f64 / self.bytes_per_second as f64);\n            \n            if wait_time \u003e Duration::from_millis(1) {\n                tokio::time::sleep(wait_time).await;\n            }\n        }\n        \n        self.bytes_sent += bytes;\n        self.last_update = now;\n    }\n}\n\nimpl ChunkedDownloader {\n    /// Create a new chunked downloader\n    pub fn new() -\u003e Self {\n        Self::with_config(DownloaderConfig::default())\n    }\n\n    /// Create a new chunked downloader with configuration\n    pub fn with_config(config: DownloaderConfig) -\u003e Self {\n        // Create HTTP/1.1-only client for media downloads (matches Go ytdlp line 182)\n        let mut http_config = crate::platform::client::HttpClientConfig::default();\n        http_config.http1_only = true;  // Force HTTP/1.1 for media downloads\n        http_config.client_type = crate::platform::client::ClientType::Chrome;\n        let video_client = Arc::new(Mutex::new(VideoClient::with_config(http_config)));\n\n        let rate_limiter = config.rate_limit_bps.map(|bps| {\n            Arc::new(Mutex::new(RateLimiter::new(bps)))\n        });\n\n        Self {\n            video_client,\n            config,\n            rate_limiter,\n        }\n    }\n\n    /// Download a file from URL to local path.\n    /// Strategy: streaming without Range to avoid 403 on YouTube CDN.\n    pub async fn download(\u0026self, url: \u0026str, output_path: \u0026Path) -\u003e Result\u003c(), RytError\u003e {\n        use tracing::{info, warn};\n        \n        info!(\"Starting download from URL: {}\", url);\n        // Always use streaming without Range\n        let tmp_path = output_path.with_extension(\"tmp\");\n        let mut file = File::create(\u0026tmp_path).await?;\n        \n        match self.download_without_chunking(url, \u0026mut file).await {\n            Ok(()) =\u003e {\n                file.flush().await?;\n                drop(file);\n                tokio::fs::rename(\u0026tmp_path, output_path).await?;\n                info!(\"Download completed successfully\");\n                Ok(())\n            }\n            Err(e) =\u003e {\n                warn!(\"Streaming download failed: {}, cleaning up temp file\", e);\n                let _ = tokio::fs::remove_file(\u0026tmp_path).await;\n                Err(e)\n            }\n        }\n    }\n\n    /// Download with resume support\n    pub async fn download_with_resume(\u0026self, url: \u0026str, output_path: \u0026Path) -\u003e Result\u003c(), RytError\u003e {\n        use tracing::warn;\n        // Check if file exists and get its size\n        let tmp_path = output_path.with_extension(\"tmp\");\n        let existing_size = if tmp_path.exists() {\n            tokio::fs::metadata(\u0026tmp_path).await?.len()\n        } else {\n            0\n        };\n        \n        // Try to get total content length, but if all attempts fail (403), proceed with chunked anyway\n        let total_size = match self.get_content_length(url).await {\n            Ok(size) =\u003e size,\n            Err(_e) =\u003e {\n                warn!(\"Could not determine content length (all clients failed), proceeding with chunked download\");\n                0\n            }\n        };\n        \n        if total_size \u003e 0 \u0026\u0026 existing_size \u003e= total_size {\n            // File is already complete\n            return Ok(());\n        }\n        \n        // Open temp file for appending\n        let mut file = tokio::fs::OpenOptions::new()\n            .create(true)\n            .append(true)\n            .open(\u0026tmp_path)\n            .await?;\n        \n        // Download remaining chunks\n        let mut downloaded = existing_size;\n        let mut progress = Progress::new(total_size);\n        progress.update(downloaded);\n        \n        while downloaded \u003c total_size || total_size == 0 {\n            let start = downloaded;\n            let end = if total_size \u003e 0 {\n                (start + self.config.chunk_size - 1).min(total_size - 1)\n            } else {\n                // Unknown size: request bounded chunk\n                start + self.config.chunk_size - 1\n            };\n            \n            // Download chunk with retry\n            let chunk_data = self.download_chunk_with_retry(url, start, end).await?;\n            \n            // Write chunk to file\n            file.write_all(\u0026chunk_data).await?;\n            \n            // Update progress\n            downloaded += chunk_data.len() as u64;\n            progress.update(downloaded);\n            \n            // Report progress\n            if let Some(callback) = \u0026self.config.progress_callback {\n                callback(progress.clone());\n            }\n            \n            // Rate limiting\n            if let Some(rate_limiter) = \u0026self.rate_limiter {\n                let mut limiter = rate_limiter.lock().await;\n                limiter.wait_if_needed(chunk_data.len() as u64).await;\n            }\n            \n            // If unknown size and we got less than chunk_size, we're probably done\n            if total_size == 0 \u0026\u0026 (chunk_data.len() as u64) \u003c self.config.chunk_size {\n                break;\n            }\n        }\n        \n        // Flush and sync file\n        file.flush().await?;\n        file.sync_all().await?;\n\n        // Finalize: rename temp -\u003e final only if we actually wrote data\n        drop(file);\n        if (total_size == 0 \u0026\u0026 downloaded \u003e 0) || (total_size \u003e 0 \u0026\u0026 downloaded \u003e= total_size) {\n            tokio::fs::rename(\u0026tmp_path, output_path).await?;\n            return Ok(());\n        }\n\n        // Nothing downloaded — clean up and return error\n        let _ = tokio::fs::remove_file(\u0026tmp_path).await;\n        Err(RytError::Generic(\"Empty download (0 bytes)\".to_string()))\n    }\n\n    /// Get content length of the file\n    async fn get_content_length(\u0026self, url: \u0026str) -\u003e Result\u003cu64, RytError\u003e {\n        use tracing::warn;\n        use crate::platform::client::ClientType;\n        \n        // Try all available client types\n        let available_clients = ClientType::all();\n        \n        for (attempt, client_type) in available_clients.iter().enumerate() {\n            // Switch to specific client type\n            {\n                let mut video_client = self.video_client.lock().await;\n                video_client.switch_to_client(*client_type);\n            }\n            \n            let video_client = self.video_client.lock().await;\n            \n            // Try GET request with Range header (YouTube doesn't support HEAD well)\n            // Use simple media request to avoid 403 errors\n            let response = video_client.create_simple_media_request(\n                reqwest::Method::GET, \n                url\n            )\n            .header(\"Range\", \"bytes=0-1\")\n            .send()\n            .await;\n            \n            match response {\n                Ok(resp) =\u003e {\n                    if resp.status().is_success() || resp.status() == 206 {\n                        return self.parse_content_length_from_response(resp).await;\n                    } else {\n                        warn!(\"Failed to get content length with client {:?} (status: {}), trying next client...\", \n                              client_type, resp.status());\n                    }\n                }\n                Err(_e) =\u003e {\n                    warn!(\"Request failed with client {:?}, trying next client...\", client_type);\n                }\n            }\n            \n            // Exponential backoff\n            if attempt \u003c available_clients.len() - 1 {\n                let delay = Duration::from_millis(100 * (1 \u003c\u003c (attempt % 3)));\n                tokio::time::sleep(delay).await;\n            }\n        }\n        \n        // If all clients failed, return error to signal caller to proceed with unknown size\n        Err(RytError::Generic(\"Could not determine content length\".to_string()))\n    }\n    \n    /// Parse content length from HTTP response\n    async fn parse_content_length_from_response(\u0026self, response: reqwest::Response) -\u003e Result\u003cu64, RytError\u003e {\n        if let Some(content_range) = response.headers().get(\"content-range\") {\n            if let Ok(range_str) = content_range.to_str() {\n                // Parse \"bytes 0-1/total\" format\n                if let Some(slash_pos) = range_str.find('/') {\n                    let total_str = \u0026range_str[slash_pos + 1..];\n                    if let Ok(total) = total_str.parse::\u003cu64\u003e() {\n                        return Ok(total);\n                    }\n                }\n            }\n        }\n        \n        // Last resort: use content-length from response\n        if let Some(content_length) = response.headers().get(\"content-length\") {\n            if let Ok(length) = content_length.to_str() {\n                if let Ok(length) = length.parse::\u003cu64\u003e() {\n                    return Ok(length);\n                }\n            }\n        }\n        \n        // Unknown size\n        Ok(0)\n    }\n\n    /// Download a single chunk with retry logic\n    async fn download_chunk_with_retry(\u0026self, url: \u0026str, start: u64, end: u64) -\u003e Result\u003cVec\u003cu8\u003e, RytError\u003e {\n        use tracing::warn;\n        let mut last_error = None;\n        \n        for attempt in 0..self.config.max_retries {\n            match self.download_chunk(url, start, end).await {\n                Ok(data) =\u003e return Ok(data),\n                Err(e) =\u003e {\n                    warn!(\"Chunk download attempt {} failed for bytes {}-{}: {}\", attempt + 1, start, end, e);\n                    last_error = Some(e);\n                    \n                    // Exponential backoff\n                    if attempt \u003c self.config.max_retries - 1 {\n                        let delay = Duration::from_millis(200 * (1 \u003c\u003c attempt));\n                        tokio::time::sleep(delay).await;\n                    }\n                }\n            }\n        }\n        \n        Err(last_error.unwrap_or(RytError::Generic(\"Chunk download failed\".to_string())))\n    }\n\n    /// Download a single chunk\n    async fn download_chunk(\u0026self, url: \u0026str, start: u64, end: u64) -\u003e Result\u003cVec\u003cu8\u003e, RytError\u003e {\n        use tracing::{debug, warn};\n        let range_header = format!(\"bytes={}-{}\", start, end);\n        \n        debug!(\"Acquiring video_client lock for chunk download\");\n        let video_client = self.video_client.lock().await;\n        debug!(\"Lock acquired, creating request for bytes {}-{}\", start, end);\n        \n        // Use simple media request to avoid 403 errors from YouTube\n        let response = video_client.create_simple_media_request(\n            reqwest::Method::GET, \n            url\n        )\n        .header(\"Range\", range_header)\n        .send()\n        .await?;\n        \n        // Release lock immediately after sending request\n        drop(video_client);\n        debug!(\"Lock released after sending request\");\n        \n        let status = response.status();\n        debug!(\"Response received with status: {} for bytes {}-{}\", status, start, end);\n        \n        if !status.is_success() \u0026\u0026 status != 206 {\n            if status.as_u16() == 403 {\n                warn!(\"403 Forbidden for range request {}-{}\", start, end);\n                return Err(RytError::RateLimited);\n            }\n            warn!(\"Unexpected status code {} for range request {}-{}\", status, start, end);\n            return Err(RytError::DownloadFailed(\n                reqwest::Error::from(response.error_for_status().unwrap_err())\n            ));\n        }\n        \n        let data = response.bytes().await?;\n        debug!(\"Downloaded {} bytes for range {}-{}\", data.len(), start, end);\n        Ok(data.to_vec())\n    }\n\n    /// Set progress callback\n    pub fn with_progress_callback\u003cF\u003e(mut self, callback: F) -\u003e Self\n    where\n        F: Fn(Progress) + Send + Sync + 'static,\n    {\n        self.config.progress_callback = Some(Arc::new(callback));\n        self\n    }\n\n    /// Set rate limit\n    pub fn with_rate_limit(mut self, bytes_per_second: u64) -\u003e Self {\n        self.config.rate_limit_bps = Some(bytes_per_second);\n        self.rate_limiter = Some(Arc::new(Mutex::new(RateLimiter::new(bytes_per_second))));\n        self\n    }\n\n    /// Set chunk size\n    pub fn with_chunk_size(mut self, chunk_size: u64) -\u003e Self {\n        self.config.chunk_size = chunk_size;\n        self\n    }\n\n    /// Set max retries\n    pub fn with_max_retries(mut self, max_retries: u32) -\u003e Self {\n        self.config.max_retries = max_retries;\n        self\n    }\n\n    /// Download without chunking when content length is unknown\n    async fn download_without_chunking(\u0026self, url: \u0026str, file: \u0026mut File) -\u003e Result\u003c(), RytError\u003e {\n        use tracing::{info, warn, debug};\n        use crate::platform::client::ClientType;\n        \n        info!(\"Downloading without chunking from: {}\", url);\n        \n        // Try with current client first\n        // Use simple media request for googlevideo.com to avoid 403 errors from browser-specific headers\n        let video_client = self.video_client.lock().await;\n        let response = video_client\n            .create_simple_media_request(\n                reqwest::Method::GET,\n                url,\n            )\n            .send()\n            .await;\n        \n        match response {\n            Ok(resp) =\u003e {\n                let status = resp.status();\n                if status.is_success() {\n                    // Success! Continue with this response\n                    drop(video_client); // Release lock\n                    debug!(\"Download successful with current client, processing response...\");\n                    return self.process_successful_response(resp, file).await;\n                } else if status.as_u16() == 403 {\n                    drop(video_client);\n                    warn!(\"403 Forbidden on streaming GET, falling back to chunked\");\n                    return Err(RytError::RateLimited);\n                } else {\n                    warn!(\"Failed with current client (status: {}), trying other clients...\", status);\n                }\n            }\n            Err(e) =\u003e {\n                warn!(\"Request failed with current client: {}, trying other clients...\", e);\n            }\n        }\n        \n        // If current client failed, try other clients\n        let available_clients = ClientType::all();\n        let mut last_error = None;\n        \n        for (attempt, client_type) in available_clients.iter().enumerate() {\n            // Skip if we already tried this client (it's the current one)\n            {\n                let current_client = self.video_client.lock().await;\n                if current_client.current_client_type() == *client_type {\n                    continue;\n                }\n            }\n            \n            // Switch to specific client type\n            {\n                let mut video_client = self.video_client.lock().await;\n                video_client.switch_to_client(*client_type);\n            }\n            \n            let video_client = self.video_client.lock().await;\n            let response = video_client.create_simple_media_request(\n                reqwest::Method::GET, \n                url\n            )\n            .send()\n            .await;\n            \n            match response {\n                Ok(resp) =\u003e {\n                    let status = resp.status();\n                    if status.is_success() {\n                        // Success! Continue with this response\n                        drop(video_client); // Release lock\n                        debug!(\"Download successful with client {:?}, processing response...\", client_type);\n                        return self.process_successful_response(resp, file).await;\n                } else {\n                    // If 403, stop header-only switching and propagate upwards to allow URL regeneration\n                    if status.as_u16() == 403 {\n                        drop(video_client);\n                        warn!(\"403 Forbidden on media GET, requiring URL regeneration\");\n                        return Err(RytError::RateLimited);\n                    }\n                    last_error = Some(RytError::DownloadFailed(\n                        reqwest::Error::from(resp.error_for_status().unwrap_err())\n                    ));\n                    warn!(\"Failed with client {:?} (status: {}), trying next client...\",\n                          client_type, status);\n                }\n                }\n                Err(e) =\u003e {\n                    last_error = Some(RytError::DownloadFailed(e));\n                    warn!(\"Request failed with client {:?}, trying next client...\", client_type);\n                }\n            }\n            \n            // Exponential backoff\n            if attempt \u003c available_clients.len() - 1 {\n                let delay = Duration::from_millis(200 * (1 \u003c\u003c (attempt % 3)));\n                tokio::time::sleep(delay).await;\n            }\n        }\n        \n        Err(last_error.unwrap_or(RytError::Generic(\"Download failed with all clients\".to_string())))\n    }\n    \n    /// Process successful HTTP response for download\n    async fn process_successful_response(\u0026self, response: reqwest::Response, file: \u0026mut File) -\u003e Result\u003c(), RytError\u003e {\n        use tracing::{debug, info};\n        use futures_util::StreamExt;\n        \n        let mut stream = response.bytes_stream();\n        let mut downloaded = 0u64;\n        \n        while let Some(chunk_result) = stream.next().await {\n            let chunk = chunk_result?;\n            let chunk_size = chunk.len();\n            \n            file.write_all(\u0026chunk).await?;\n            downloaded += chunk_size as u64;\n            \n            debug!(\"Downloaded {} bytes, total: {}\", chunk_size, downloaded);\n            \n            // Report progress if callback is available\n            if let Some(callback) = \u0026self.config.progress_callback {\n                let mut progress = Progress::new(0); // Unknown total size\n                progress.update(downloaded);\n                callback(progress);\n            }\n            \n            // Rate limiting\n            if let Some(rate_limiter) = \u0026self.rate_limiter {\n                let mut limiter = rate_limiter.lock().await;\n                limiter.wait_if_needed(chunk_size as u64).await;\n            }\n        }\n        \n        file.flush().await?;\n        file.sync_all().await?;\n        \n        info!(\"Download completed: {} bytes\", downloaded);\n        Ok(())\n    }\n}\n\nimpl Default for ChunkedDownloader {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_downloader_config_default() {\n        let config = DownloaderConfig::default();\n        assert_eq!(config.chunk_size, 1024 * 1024);\n        assert_eq!(config.max_retries, 3);\n        assert!(config.rate_limit_bps.is_none());\n        assert!(config.progress_callback.is_none());\n    }\n\n    #[test]\n    fn test_chunked_downloader_creation() {\n        let downloader = ChunkedDownloader::new();\n        assert_eq!(downloader.config.chunk_size, 1024 * 1024);\n        assert_eq!(downloader.config.max_retries, 3);\n    }\n\n    #[test]\n    fn test_chunked_downloader_with_config() {\n        let config = DownloaderConfig {\n            chunk_size: 512 * 1024,\n            max_retries: 5,\n            rate_limit_bps: Some(1024 * 1024),\n            progress_callback: None,\n        };\n        \n        let downloader = ChunkedDownloader::with_config(config);\n        assert_eq!(downloader.config.chunk_size, 512 * 1024);\n        assert_eq!(downloader.config.max_retries, 5);\n        assert!(downloader.rate_limiter.is_some());\n    }\n\n    #[test]\n    fn test_rate_limiter_creation() {\n        let limiter = RateLimiter::new(1024 * 1024); // 1MB/s\n        assert_eq!(limiter.bytes_per_second, 1024 * 1024);\n        assert_eq!(limiter.bytes_sent, 0);\n    }\n\n    #[tokio::test]\n    async fn test_rate_limiter_wait() {\n        let mut limiter = RateLimiter::new(1000); // 1KB/s\n        let start = std::time::Instant::now();\n        \n        // Wait for 1KB\n        limiter.wait_if_needed(1000).await;\n        \n        let elapsed = start.elapsed();\n        // Should have waited approximately 1 second\n        assert!(elapsed \u003e= Duration::from_millis(900));\n        assert!(elapsed \u003c= Duration::from_millis(1100));\n    }\n}\n","traces":[{"line":27,"address":[],"length":0,"stats":{"Line":5}},{"line":29,"address":[],"length":0,"stats":{"Line":10}},{"line":52,"address":[],"length":0,"stats":{"Line":3}},{"line":55,"address":[],"length":0,"stats":{"Line":3}},{"line":60,"address":[],"length":0,"stats":{"Line":2}},{"line":61,"address":[],"length":0,"stats":{"Line":2}},{"line":62,"address":[],"length":0,"stats":{"Line":4}},{"line":65,"address":[],"length":0,"stats":{"Line":3}},{"line":67,"address":[],"length":0,"stats":{"Line":1}},{"line":69,"address":[],"length":0,"stats":{"Line":2}},{"line":70,"address":[],"length":0,"stats":{"Line":3}},{"line":72,"address":[],"length":0,"stats":{"Line":1}},{"line":73,"address":[],"length":0,"stats":{"Line":2}},{"line":77,"address":[],"length":0,"stats":{"Line":1}},{"line":84,"address":[],"length":0,"stats":{"Line":4}},{"line":85,"address":[],"length":0,"stats":{"Line":8}},{"line":89,"address":[],"length":0,"stats":{"Line":5}},{"line":91,"address":[],"length":0,"stats":{"Line":10}},{"line":92,"address":[],"length":0,"stats":{"Line":5}},{"line":93,"address":[],"length":0,"stats":{"Line":5}},{"line":94,"address":[],"length":0,"stats":{"Line":25}},{"line":96,"address":[],"length":0,"stats":{"Line":16}},{"line":97,"address":[],"length":0,"stats":{"Line":4}},{"line":109,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":234,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":243,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":291,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":314,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":337,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":355,"address":[],"length":0,"stats":{"Line":0}},{"line":356,"address":[],"length":0,"stats":{"Line":0}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":376,"address":[],"length":0,"stats":{"Line":0}},{"line":377,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":406,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":413,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":442,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":463,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":466,"address":[],"length":0,"stats":{"Line":0}},{"line":467,"address":[],"length":0,"stats":{"Line":0}},{"line":470,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":475,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":478,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":489,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":491,"address":[],"length":0,"stats":{"Line":0}},{"line":495,"address":[],"length":0,"stats":{"Line":0}},{"line":499,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":504,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":507,"address":[],"length":0,"stats":{"Line":0}},{"line":508,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}}],"covered":23,"coverable":239},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","download","mod.rs"],"content":"//! Download system for ryt\n\npub mod downloader;\npub mod progress;\npub mod retry;\n\npub use downloader::*;\npub use progress::*;\npub use retry::*;\n\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","download","progress.rs"],"content":"//! Progress tracking for downloads\n\n// Re-export from core::progress\npub use crate::core::progress::*;\n\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","download","retry.rs"],"content":"//! Retry logic for downloads\n\nuse crate::error::RytError;\nuse std::time::Duration;\n\n/// Retry configuration\n#[derive(Debug, Clone)]\npub struct RetryConfig {\n    /// Maximum number of retries\n    pub max_retries: u32,\n    /// Initial delay between retries\n    pub initial_delay: Duration,\n    /// Maximum delay between retries\n    pub max_delay: Duration,\n    /// Backoff multiplier\n    pub backoff_multiplier: f64,\n    /// Jitter factor (0.0 to 1.0)\n    pub jitter_factor: f64,\n}\n\nimpl Default for RetryConfig {\n    fn default() -\u003e Self {\n        Self {\n            max_retries: 3,\n            initial_delay: Duration::from_millis(200),\n            max_delay: Duration::from_secs(30),\n            backoff_multiplier: 2.0,\n            jitter_factor: 0.1,\n        }\n    }\n}\n\n/// Retry executor\npub struct RetryExecutor {\n    config: RetryConfig,\n}\n\nimpl RetryExecutor {\n    /// Create a new retry executor\n    pub fn new() -\u003e Self {\n        Self::with_config(RetryConfig::default())\n    }\n\n    /// Create a new retry executor with configuration\n    pub fn with_config(config: RetryConfig) -\u003e Self {\n        Self { config }\n    }\n\n    /// Execute a function with retry logic\n    pub async fn execute\u003cF, T\u003e(\u0026self, mut func: F) -\u003e Result\u003cT, RytError\u003e\n    where\n        F: FnMut() -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003cT, RytError\u003e\u003e + Send\u003e\u003e,\n    {\n        let mut last_error = None;\n        let mut delay = self.config.initial_delay;\n\n        for attempt in 0..=self.config.max_retries {\n            match func().await {\n                Ok(result) =\u003e return Ok(result),\n                Err(error) =\u003e {\n                    last_error = Some(error);\n\n                    // Check if error is retryable\n                    if !last_error.as_ref().unwrap().is_retryable() {\n                        break;\n                    }\n\n                    // Don't wait after the last attempt\n                    if attempt \u003c self.config.max_retries {\n                        // Add jitter to prevent thundering herd\n                        let jitter = if self.config.jitter_factor \u003e 0.0 {\n                            let jitter_range = delay.as_millis() as f64 * self.config.jitter_factor;\n                            let jitter = (rand::random::\u003cf64\u003e() - 0.5) * 2.0 * jitter_range;\n                            Duration::from_millis(jitter.abs() as u64)\n                        } else {\n                            Duration::from_millis(0)\n                        };\n\n                        let total_delay = delay + jitter;\n                        tokio::time::sleep(total_delay).await;\n\n                        // Calculate next delay with exponential backoff\n                        delay = Duration::from_millis(\n                            (delay.as_millis() as f64 * self.config.backoff_multiplier) as u64\n                        );\n\n                        // Cap at maximum delay\n                        if delay \u003e self.config.max_delay {\n                            delay = self.config.max_delay;\n                        }\n                    }\n                }\n            }\n        }\n\n        Err(last_error.unwrap_or(RytError::Generic(\"All retry attempts failed\".to_string())))\n    }\n\n    /// Execute a function with retry logic and custom error handling\n    pub async fn execute_with_error_handler\u003cF, T, E\u003e(\n        \u0026self,\n        mut func: F,\n        error_handler: E,\n    ) -\u003e Result\u003cT, RytError\u003e\n    where\n        F: FnMut() -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003cT, RytError\u003e\u003e + Send\u003e\u003e,\n        E: Fn(\u0026RytError) -\u003e bool, // Returns true if error is retryable\n    {\n        let mut last_error = None;\n        let mut delay = self.config.initial_delay;\n\n        for attempt in 0..=self.config.max_retries {\n            match func().await {\n                Ok(result) =\u003e return Ok(result),\n                Err(error) =\u003e {\n                    last_error = Some(error);\n\n                    // Check if error is retryable using custom handler\n                    if !error_handler(last_error.as_ref().unwrap()) {\n                        break;\n                    }\n\n                    // Don't wait after the last attempt\n                    if attempt \u003c self.config.max_retries {\n                        // Add jitter to prevent thundering herd\n                        let jitter = if self.config.jitter_factor \u003e 0.0 {\n                            let jitter_range = delay.as_millis() as f64 * self.config.jitter_factor;\n                            let jitter = (rand::random::\u003cf64\u003e() - 0.5) * 2.0 * jitter_range;\n                            Duration::from_millis(jitter.abs() as u64)\n                        } else {\n                            Duration::from_millis(0)\n                        };\n\n                        let total_delay = delay + jitter;\n                        tokio::time::sleep(total_delay).await;\n\n                        // Calculate next delay with exponential backoff\n                        delay = Duration::from_millis(\n                            (delay.as_millis() as f64 * self.config.backoff_multiplier) as u64\n                        );\n\n                        // Cap at maximum delay\n                        if delay \u003e self.config.max_delay {\n                            delay = self.config.max_delay;\n                        }\n                    }\n                }\n            }\n        }\n\n        Err(last_error.unwrap_or(RytError::Generic(\"All retry attempts failed\".to_string())))\n    }\n}\n\nimpl Default for RetryExecutor {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n/// Retry configuration builder\npub struct RetryConfigBuilder {\n    config: RetryConfig,\n}\n\nimpl RetryConfigBuilder {\n    /// Create a new retry configuration builder\n    pub fn new() -\u003e Self {\n        Self {\n            config: RetryConfig::default(),\n        }\n    }\n\n    /// Set maximum retries\n    pub fn max_retries(mut self, max_retries: u32) -\u003e Self {\n        self.config.max_retries = max_retries;\n        self\n    }\n\n    /// Set initial delay\n    pub fn initial_delay(mut self, initial_delay: Duration) -\u003e Self {\n        self.config.initial_delay = initial_delay;\n        self\n    }\n\n    /// Set maximum delay\n    pub fn max_delay(mut self, max_delay: Duration) -\u003e Self {\n        self.config.max_delay = max_delay;\n        self\n    }\n\n    /// Set backoff multiplier\n    pub fn backoff_multiplier(mut self, backoff_multiplier: f64) -\u003e Self {\n        self.config.backoff_multiplier = backoff_multiplier;\n        self\n    }\n\n    /// Set jitter factor\n    pub fn jitter_factor(mut self, jitter_factor: f64) -\u003e Self {\n        self.config.jitter_factor = jitter_factor.clamp(0.0, 1.0);\n        self\n    }\n\n    /// Build the retry configuration\n    pub fn build(self) -\u003e RetryConfig {\n        self.config\n    }\n}\n\nimpl Default for RetryConfigBuilder {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::sync::{Arc, atomic::{AtomicU32, Ordering}};\n\n    #[test]\n    fn test_retry_config_default() {\n        let config = RetryConfig::default();\n        assert_eq!(config.max_retries, 3);\n        assert_eq!(config.initial_delay, Duration::from_millis(200));\n        assert_eq!(config.max_delay, Duration::from_secs(30));\n        assert_eq!(config.backoff_multiplier, 2.0);\n        assert_eq!(config.jitter_factor, 0.1);\n    }\n\n    #[test]\n    fn test_retry_config_builder() {\n        let config = RetryConfigBuilder::new()\n            .max_retries(5)\n            .initial_delay(Duration::from_millis(100))\n            .max_delay(Duration::from_secs(60))\n            .backoff_multiplier(1.5)\n            .jitter_factor(0.2)\n            .build();\n\n        assert_eq!(config.max_retries, 5);\n        assert_eq!(config.initial_delay, Duration::from_millis(100));\n        assert_eq!(config.max_delay, Duration::from_secs(60));\n        assert_eq!(config.backoff_multiplier, 1.5);\n        assert_eq!(config.jitter_factor, 0.2);\n    }\n\n    #[tokio::test]\n    async fn test_retry_executor_success() {\n        let executor = RetryExecutor::new();\n        let counter = Arc::new(AtomicU32::new(0));\n\n        let result: Result\u003cString, RytError\u003e = executor.execute({\n            let counter = counter.clone();\n            move || {\n                let counter = counter.clone();\n                Box::pin(async move {\n                    let count = counter.fetch_add(1, Ordering::SeqCst);\n                    if count == 0 {\n                        Err(RytError::TimeoutError(\"test error\".to_string()))\n                    } else {\n                        Ok(\"Success\".to_string())\n                    }\n                })\n            }\n        }).await;\n\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), \"Success\");\n        assert_eq!(counter.load(Ordering::SeqCst), 2);\n    }\n\n    #[tokio::test]\n    async fn test_retry_executor_max_retries() {\n        let executor = RetryExecutor::new();\n        let counter = Arc::new(AtomicU32::new(0));\n\n        let result: Result\u003cString, RytError\u003e = executor.execute({\n            let counter = counter.clone();\n            move || {\n                let counter = counter.clone();\n                Box::pin(async move {\n                    counter.fetch_add(1, Ordering::SeqCst);\n                    Err(RytError::TimeoutError(\"test error\".to_string()))\n                })\n            }\n        }).await;\n\n        assert!(result.is_err());\n        assert_eq!(counter.load(Ordering::SeqCst), 4); // 1 initial + 3 retries\n    }\n\n    #[tokio::test]\n    async fn test_retry_executor_non_retryable_error() {\n        let executor = RetryExecutor::new();\n        let counter = Arc::new(AtomicU32::new(0));\n\n        let result: Result\u003cString, RytError\u003e = executor.execute({\n            let counter = counter.clone();\n            move || {\n                let counter = counter.clone();\n                Box::pin(async move {\n                    counter.fetch_add(1, Ordering::SeqCst);\n                    Err(RytError::VideoUnavailable) // Non-retryable error\n                })\n            }\n        }).await;\n\n        assert!(result.is_err());\n        assert_eq!(counter.load(Ordering::SeqCst), 1); // Only one attempt\n    }\n\n    #[tokio::test]\n    async fn test_retry_executor_with_custom_error_handler() {\n        let executor = RetryExecutor::new();\n        let counter = Arc::new(AtomicU32::new(0));\n\n        let result: Result\u003cString, RytError\u003e = executor.execute_with_error_handler(\n            {\n                let counter = counter.clone();\n                move || {\n                    let counter = counter.clone();\n                    Box::pin(async move {\n                        counter.fetch_add(1, Ordering::SeqCst);\n                        Err(RytError::TimeoutError(\"test error\".to_string()))\n                    })\n                }\n            },\n            |error| {\n                // Only retry on HTTP errors\n                matches!(error, RytError::TimeoutError(_))\n            },\n        ).await;\n\n        assert!(result.is_err());\n        assert_eq!(counter.load(Ordering::SeqCst), 4); // 1 initial + 3 retries\n    }\n}\n","traces":[{"line":22,"address":[],"length":0,"stats":{"Line":6}},{"line":25,"address":[],"length":0,"stats":{"Line":6}},{"line":26,"address":[],"length":0,"stats":{"Line":6}},{"line":40,"address":[],"length":0,"stats":{"Line":4}},{"line":41,"address":[],"length":0,"stats":{"Line":8}},{"line":45,"address":[],"length":0,"stats":{"Line":4}},{"line":50,"address":[],"length":0,"stats":{"Line":3}},{"line":54,"address":[],"length":0,"stats":{"Line":6}},{"line":55,"address":[],"length":0,"stats":{"Line":6}},{"line":57,"address":[],"length":0,"stats":{"Line":10}},{"line":58,"address":[],"length":0,"stats":{"Line":14}},{"line":59,"address":[],"length":0,"stats":{"Line":1}},{"line":60,"address":[],"length":0,"stats":{"Line":6}},{"line":61,"address":[],"length":0,"stats":{"Line":12}},{"line":64,"address":[],"length":0,"stats":{"Line":12}},{"line":65,"address":[],"length":0,"stats":{"Line":1}},{"line":69,"address":[],"length":0,"stats":{"Line":5}},{"line":71,"address":[],"length":0,"stats":{"Line":8}},{"line":72,"address":[],"length":0,"stats":{"Line":8}},{"line":73,"address":[],"length":0,"stats":{"Line":8}},{"line":74,"address":[],"length":0,"stats":{"Line":8}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":8}},{"line":80,"address":[],"length":0,"stats":{"Line":8}},{"line":83,"address":[],"length":0,"stats":{"Line":4}},{"line":84,"address":[],"length":0,"stats":{"Line":4}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":2}},{"line":100,"address":[],"length":0,"stats":{"Line":1}},{"line":109,"address":[],"length":0,"stats":{"Line":2}},{"line":110,"address":[],"length":0,"stats":{"Line":2}},{"line":112,"address":[],"length":0,"stats":{"Line":5}},{"line":113,"address":[],"length":0,"stats":{"Line":8}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":4}},{"line":116,"address":[],"length":0,"stats":{"Line":8}},{"line":119,"address":[],"length":0,"stats":{"Line":12}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":4}},{"line":126,"address":[],"length":0,"stats":{"Line":6}},{"line":127,"address":[],"length":0,"stats":{"Line":6}},{"line":128,"address":[],"length":0,"stats":{"Line":6}},{"line":129,"address":[],"length":0,"stats":{"Line":6}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":6}},{"line":135,"address":[],"length":0,"stats":{"Line":6}},{"line":138,"address":[],"length":0,"stats":{"Line":3}},{"line":139,"address":[],"length":0,"stats":{"Line":3}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":1}},{"line":156,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":1}},{"line":170,"address":[],"length":0,"stats":{"Line":1}},{"line":175,"address":[],"length":0,"stats":{"Line":1}},{"line":176,"address":[],"length":0,"stats":{"Line":1}},{"line":177,"address":[],"length":0,"stats":{"Line":1}},{"line":181,"address":[],"length":0,"stats":{"Line":1}},{"line":182,"address":[],"length":0,"stats":{"Line":1}},{"line":183,"address":[],"length":0,"stats":{"Line":1}},{"line":187,"address":[],"length":0,"stats":{"Line":1}},{"line":188,"address":[],"length":0,"stats":{"Line":1}},{"line":189,"address":[],"length":0,"stats":{"Line":1}},{"line":193,"address":[],"length":0,"stats":{"Line":1}},{"line":194,"address":[],"length":0,"stats":{"Line":1}},{"line":195,"address":[],"length":0,"stats":{"Line":1}},{"line":199,"address":[],"length":0,"stats":{"Line":1}},{"line":200,"address":[],"length":0,"stats":{"Line":1}},{"line":201,"address":[],"length":0,"stats":{"Line":1}},{"line":205,"address":[],"length":0,"stats":{"Line":1}},{"line":206,"address":[],"length":0,"stats":{"Line":1}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}}],"covered":63,"coverable":75},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","error.rs"],"content":"//! Error types for ryt\n\nuse thiserror::Error;\n\n/// Main error type for ryt operations\n#[derive(Debug, Error)]\npub enum RytError {\n    #[error(\"Video is geo-blocked\")]\n    GeoBlocked,\n    \n    #[error(\"Rate limited\")]\n    RateLimited,\n    \n    #[error(\"Age restricted\")]\n    AgeRestricted,\n    \n    #[error(\"Private video\")]\n    Private,\n    \n    #[error(\"Video unavailable\")]\n    VideoUnavailable,\n    \n    #[error(\"Invalid URL: {0}\")]\n    InvalidUrl(String),\n    \n    #[error(\"No suitable format found\")]\n    NoFormatFound,\n    \n    #[error(\"Download failed: {0}\")]\n    DownloadFailed(#[from] reqwest::Error),\n    \n    #[error(\"Parse error: {0}\")]\n    ParseError(#[from] std::num::ParseIntError),\n    \n    #[error(\"API key not found\")]\n    ApiKeyNotFound,\n    \n    #[error(\"IO error: {0}\")]\n    IoError(#[from] std::io::Error),\n    \n    #[error(\"JSON error: {0}\")]\n    JsonError(#[from] serde_json::Error),\n    \n    #[error(\"URL parsing error: {0}\")]\n    UrlError(#[from] url::ParseError),\n    \n    #[error(\"Regex error: {0}\")]\n    RegexError(#[from] regex::Error),\n    \n    #[error(\"Botguard error: {0}\")]\n    BotguardError(String),\n    \n    #[error(\"Cipher error: {0}\")]\n    CipherError(String),\n    \n    #[error(\"Format parsing error: {0}\")]\n    FormatError(String),\n    \n    #[error(\"Playlist error: {0}\")]\n    PlaylistError(String),\n    \n    #[error(\"Timeout error: {0}\")]\n    TimeoutError(String),\n    \n    #[error(\"Rate limit error: {0}\")]\n    RateLimitError(String),\n    \n    #[error(\"Generic error: {0}\")]\n    Generic(String),\n}\n\nimpl RytError {\n    /// Check if error is retryable\n    pub fn is_retryable(\u0026self) -\u003e bool {\n        matches!(\n            self,\n            RytError::DownloadFailed(_) | \n            RytError::TimeoutError(_) | \n            RytError::RateLimited |\n            RytError::AgeRestricted\n        )\n    }\n    \n    /// Check if error is a YouTube-specific error\n    pub fn is_youtube_error(\u0026self) -\u003e bool {\n        matches!(\n            self,\n            RytError::GeoBlocked |\n            RytError::RateLimited |\n            RytError::AgeRestricted |\n            RytError::Private |\n            RytError::VideoUnavailable\n        )\n    }\n}\n","traces":[{"line":74,"address":[],"length":0,"stats":{"Line":6}},{"line":75,"address":[],"length":0,"stats":{"Line":1}},{"line":76,"address":[],"length":0,"stats":{"Line":6}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}}],"covered":3,"coverable":6},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","lib.rs"],"content":"//! # ryt - Rust YouTube Downloader\n//!\n//! Fast and reliable YouTube video downloader written in Rust.\n//! \n//! ## Features\n//!\n//! - High-performance chunked downloading\n//! - YouTube signature deciphering\n//! - Botguard protection bypass\n//! - Multiple format selection\n//! - Playlist support\n//! - Rate limiting and retry logic\n//!\n//! ## Example\n//!\n//! ```rust,no_run\n//! use ryt::Downloader;\n//! \n//! #[tokio::main]\n//! async fn main() -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n//!     let mut downloader = Downloader::new()\n//!         .with_format(\"best\", \"mp4\")\n//!         .with_output_path(\"./downloads\");\n//!     \n//!     let info = downloader.download(\"VIDEO_URL\").await?;\n//!     println!(\"Downloaded: {}\", info.title);\n//!     \n//!     Ok(())\n//! }\n//! ```\n\npub mod cli;\npub mod core;\npub mod download;\npub mod error;\npub mod utils;\npub mod platform;\n\n// Re-export main types\npub use core::{Downloader, DownloadOptions, VideoInfo, Progress, Format, FormatSelector, QualitySelector};\npub use error::RytError;\n\n/// Result type alias for ryt operations\npub type Result\u003cT\u003e = std::result::Result\u003cT, RytError\u003e;\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","main.rs"],"content":"//! Main entry point for ryt CLI\n\nuse ryt::cli::Args;\nuse ryt::core::{Downloader, Progress};\nuse ryt::platform::botguard::BotguardMode;\nuse ryt::cli::output::OutputFormatter;\nuse clap::Parser;\nuse std::sync::Arc;\nuse std::time::Instant;\nuse tokio;\nuse tracing::{info, debug};\nuse tracing_subscriber::{layer::SubscriberExt, util::SubscriberInitExt};\n\n#[tokio::main]\nasync fn main() -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n    // Initialize logging\n    init_logging()?;\n    \n    // Parse command line arguments\n    let args = Args::parse();\n    \n    info!(\"Starting ryt with args: {:?}\", args);\n\n    // Initialize output formatter\n    let formatter = Arc::new(OutputFormatter::new(args.verbosity_level()));\n\n    // Handle special commands\n    if args.url.is_empty() {\n        formatter.print_help();\n        return Ok(());\n    }\n\n    // Create downloader\n    let mut downloader = Downloader::new();\n\n    // Configure format\n    if let (Some(format), Some(ext)) = (\u0026args.format, \u0026args.ext) {\n        downloader = downloader.with_format(format, ext);\n    } else if let Some(format) = \u0026args.format {\n        downloader = downloader.with_format(format, \"mp4\");\n    } else if let Some(ext) = \u0026args.ext {\n        downloader = downloader.with_format(\"best\", ext);\n    }\n\n    // Configure output path\n    if let Some(output) = \u0026args.output {\n        downloader = downloader.with_output_path(output);\n    }\n\n    // Configure rate limit\n    if let Some(rate_limit) = args.parse_rate_limit() {\n        downloader = downloader.with_rate_limit(rate_limit);\n    }\n\n    // Configure InnerTube client\n    if let (Some(name), Some(version)) = (\u0026args.client_name, \u0026args.client_version) {\n        downloader = downloader.with_innertube_client(name, version);\n    }\n\n    // Configure Botguard\n    let botguard_mode = match args.botguard {\n        ryt::cli::args::BotguardMode::Off =\u003e BotguardMode::Off,\n        ryt::cli::args::BotguardMode::Auto =\u003e BotguardMode::Auto,\n        ryt::cli::args::BotguardMode::Force =\u003e BotguardMode::Force,\n    };\n\n    downloader = downloader\n        .with_botguard(botguard_mode)\n        .with_botguard_debug(args.debug_botguard)\n        .with_botguard_ttl(args.botguard_ttl_duration());\n\n    // Configure timeout and retries\n    downloader = downloader\n        .with_timeout(args.timeout_duration())\n        .with_max_retries(args.retries);\n\n    // Configure progress callback\n    if !args.no_progress {\n        let formatter_clone = formatter.clone();\n        downloader = downloader.with_progress(move |progress: Progress| {\n            formatter_clone.update_progress(\u0026progress);\n        });\n    }\n\n    // Handle playlist downloads\n    if args.is_playlist() {\n        return handle_playlist_download(downloader, \u0026args, formatter).await;\n    }\n\n    // Handle single video download\n    handle_single_download(downloader, \u0026args, formatter).await\n}\n\n/// Handle single video download\nasync fn handle_single_download(\n    mut downloader: Downloader,\n    args: \u0026Args,\n    formatter: Arc\u003cOutputFormatter\u003e,\n) -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n    let start_time = Instant::now();\n\n    // Print URL only mode\n    if args.print_url {\n        debug!(\"Print URL mode enabled\");\n        let (final_url, _video_info) = downloader.resolve_url(\u0026args.url).await?;\n        println!(\"{}\", final_url);\n        return Ok(());\n    }\n\n    // Print download start\n    formatter.print_download_start(\u0026args.url, \"auto-generated filename\");\n    info!(\"Starting download for URL: {}\", args.url);\n\n    // Download video\n    let video_info = downloader.download(\u0026args.url).await?;\n    info!(\"Download completed successfully\");\n\n    // Print completion\n    let duration = start_time.elapsed();\n    formatter.print_download_complete(\"downloaded file\", duration);\n\n    // Print video info\n    formatter.print_video_info(\n        \u0026video_info.title,\n        \u0026video_info.author,\n        video_info.duration,\n        video_info.formats.len(),\n    );\n\n    Ok(())\n}\n\n/// Handle playlist download\nasync fn handle_playlist_download(\n    mut downloader: Downloader,\n    args: \u0026Args,\n    formatter: Arc\u003cOutputFormatter\u003e,\n) -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n    let start_time = Instant::now();\n\n    // Extract playlist ID\n    let playlist_id = ryt::utils::url::extract_playlist_id(\u0026args.url)?;\n    info!(\"Processing playlist: {}\", playlist_id);\n\n    // Print playlist info\n    formatter.print_playlist_info(\u0026playlist_id, 0, Some(args.limit));\n\n    // Download playlist\n    let limit = if args.limit \u003e 0 { Some(args.limit) } else { None };\n    let video_infos = downloader.download_playlist(\u0026args.url, limit).await?;\n    info!(\"Playlist download completed: {} videos\", video_infos.len());\n\n    // Print completion\n    let duration = start_time.elapsed();\n    formatter.success(\u0026format!(\"Downloaded {} videos in {}\", video_infos.len(), format_duration(duration)));\n\n    // Print summary\n    for (index, video_info) in video_infos.iter().enumerate() {\n        formatter.print_playlist_item(index, video_infos.len(), \u0026video_info.title);\n    }\n\n    Ok(())\n}\n\n/// Initialize logging system\nfn init_logging() -\u003e Result\u003c(), Box\u003cdyn std::error::Error\u003e\u003e {\n    // Get log level from environment or default to info\n    let log_level = std::env::var(\"RUST_LOG\")\n        .unwrap_or_else(|_| \"info\".to_string());\n    \n    // Parse log level\n    let filter = tracing_subscriber::EnvFilter::try_from_default_env()\n        .unwrap_or_else(|_| tracing_subscriber::EnvFilter::new(\u0026log_level));\n    \n    // Initialize tracing subscriber\n    tracing_subscriber::registry()\n        .with(filter)\n        .with(tracing_subscriber::fmt::layer()\n            .with_target(false)\n            .with_thread_ids(true)\n            .with_file(true)\n            .with_line_number(true)\n            .compact())\n        .init();\n    \n    Ok(())\n}\n\n/// Format duration as human-readable string\nfn format_duration(duration: std::time::Duration) -\u003e String {\n    let total_seconds = duration.as_secs();\n    \n    if total_seconds \u003c 60 {\n        format!(\"{}s\", total_seconds)\n    } else if total_seconds \u003c 3600 {\n        let minutes = total_seconds / 60;\n        let seconds = total_seconds % 60;\n        if seconds == 0 {\n            format!(\"{}m\", minutes)\n        } else {\n            format!(\"{}m {}s\", minutes, seconds)\n        }\n    } else {\n        let hours = total_seconds / 3600;\n        let minutes = (total_seconds % 3600) / 60;\n        if minutes == 0 {\n            format!(\"{}h\", hours)\n        } else {\n            format!(\"{}h {}m\", hours, minutes)\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_init_logging() {\n        // Test that logging initialization doesn't panic\n        let result = init_logging();\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn test_format_duration_seconds() {\n        let duration = std::time::Duration::from_secs(45);\n        let formatted = format_duration(duration);\n        assert_eq!(formatted, \"45s\");\n    }\n\n    #[test]\n    fn test_format_duration_minutes() {\n        let duration = std::time::Duration::from_secs(125);\n        let formatted = format_duration(duration);\n        assert_eq!(formatted, \"2m 5s\");\n    }\n\n    #[test]\n    fn test_format_duration_hours() {\n        let duration = std::time::Duration::from_secs(3661);\n        let formatted = format_duration(duration);\n        assert_eq!(formatted, \"1h 1m\");\n    }\n\n    #[test]\n    fn test_format_duration_only_hours() {\n        let duration = std::time::Duration::from_secs(7200);\n        let formatted = format_duration(duration);\n        assert_eq!(formatted, \"2h\");\n    }\n\n    #[test]\n    fn test_format_duration_zero() {\n        let duration = std::time::Duration::from_secs(0);\n        let formatted = format_duration(duration);\n        assert_eq!(formatted, \"0s\");\n    }\n}","traces":[{"line":15,"address":[],"length":0,"stats":{"Line":0}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":20,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":0}},{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":0}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":95,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":142,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}}],"covered":0,"coverable":100},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","platform","botguard.rs"],"content":"//! Botguard protection bypass for video platform\n\nuse crate::error::RytError;\nuse crate::utils::cache::MultiLevelCache;\nuse std::time::Duration;\n\n/// Botguard mode\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum BotguardMode {\n    /// Disabled\n    Off,\n    /// Automatic (only when needed)\n    Auto,\n    /// Force (always use)\n    Force,\n}\n\n/// Botguard solver trait\n#[async_trait::async_trait]\npub trait BotguardSolver: Send + Sync {\n    /// Solve botguard challenge\n    async fn solve(\u0026self, input: \u0026str) -\u003e Result\u003cBotguardResult, RytError\u003e;\n}\n\n/// Botguard cache trait\n#[async_trait::async_trait]\npub trait BotguardCache: Send + Sync {\n    /// Get cached result\n    async fn get(\u0026self, key: \u0026str) -\u003e Option\u003cBotguardResult\u003e;\n    \n    /// Set cached result\n    async fn set(\u0026self, key: \u0026str, result: BotguardResult, ttl: Duration);\n    \n    /// Clear cache\n    async fn clear(\u0026self);\n}\n\n/// Botguard result\n#[derive(Debug, Clone)]\npub struct BotguardResult {\n    /// Botguard token\n    pub token: String,\n    /// Expiration time\n    pub expires_at: Option\u003cstd::time::Instant\u003e,\n    /// Strategy used to obtain the token\n    pub strategy: BotguardStrategy,\n}\n\n/// Botguard bypass strategies\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum BotguardStrategy {\n    /// Android client emulation\n    Android,\n    /// iOS client emulation\n    Ios,\n    /// Web client with realistic headers\n    Web,\n    /// External solver service\n    External,\n    /// Visitor ID rotation\n    VisitorId,\n}\n\nimpl BotguardResult {\n    /// Create a new botguard result\n    pub fn new(token: String) -\u003e Self {\n        Self {\n            token,\n            expires_at: None,\n            strategy: BotguardStrategy::Web,\n        }\n    }\n\n    /// Create a new botguard result with strategy\n    pub fn with_strategy(token: String, strategy: BotguardStrategy) -\u003e Self {\n        Self {\n            token,\n            expires_at: None,\n            strategy,\n        }\n    }\n    \n    /// Create a new botguard result with expiration\n    pub fn with_expiration(token: String, expires_at: std::time::Instant) -\u003e Self {\n        Self {\n            token,\n            expires_at: Some(expires_at),\n            strategy: BotguardStrategy::Web,\n        }\n    }\n\n    /// Create a new botguard result with strategy and expiration\n    pub fn with_strategy_and_expiration(token: String, strategy: BotguardStrategy, expires_at: std::time::Instant) -\u003e Self {\n        Self {\n            token,\n            expires_at: Some(expires_at),\n            strategy,\n        }\n    }\n    \n    /// Check if result is expired\n    pub fn is_expired(\u0026self) -\u003e bool {\n        if let Some(expires_at) = self.expires_at {\n            expires_at \u003c= std::time::Instant::now()\n        } else {\n            false\n        }\n    }\n}\n\n/// Memory-based botguard cache\npub struct MemoryBotguardCache {\n    cache: std::collections::HashMap\u003cString, BotguardResult\u003e,\n}\n\nimpl MemoryBotguardCache {\n    /// Create a new memory cache\n    pub fn new() -\u003e Self {\n        Self {\n            cache: std::collections::HashMap::new(),\n        }\n    }\n}\n\n#[async_trait::async_trait]\nimpl BotguardCache for MemoryBotguardCache {\n    async fn get(\u0026self, key: \u0026str) -\u003e Option\u003cBotguardResult\u003e {\n        self.cache.get(key).cloned()\n    }\n    \n    async fn set(\u0026self, _key: \u0026str, _result: BotguardResult, _ttl: Duration) {\n        // Note: This is a simplified implementation\n        // In a real implementation, you'd need to handle TTL and thread safety\n        // For now, we'll just store the result\n        // self.cache.insert(key.to_string(), result);\n    }\n    \n    async fn clear(\u0026self) {\n        // self.cache.clear();\n    }\n}\n\n/// Enhanced botguard solver with multiple strategies\npub struct EnhancedBotguardSolver {\n    strategies: Vec\u003cBotguardStrategy\u003e,\n    current_strategy_index: usize,\n    cache: MultiLevelCache,\n}\n\nimpl EnhancedBotguardSolver {\n    /// Create a new enhanced solver\n    pub fn new() -\u003e Self {\n        Self {\n            strategies: vec![\n                BotguardStrategy::Android,\n                BotguardStrategy::Ios,\n                BotguardStrategy::Web,\n                BotguardStrategy::VisitorId,\n            ],\n            current_strategy_index: 0,\n            cache: MultiLevelCache::new(),\n        }\n    }\n\n    /// Try next strategy\n    pub fn next_strategy(\u0026mut self) -\u003e Option\u003cBotguardStrategy\u003e {\n        if self.current_strategy_index \u003c self.strategies.len() {\n            let strategy = self.strategies[self.current_strategy_index];\n            self.current_strategy_index += 1;\n            Some(strategy)\n        } else {\n            None\n        }\n    }\n\n    /// Reset to first strategy\n    pub fn reset(\u0026mut self) {\n        self.current_strategy_index = 0;\n    }\n\n    /// Generate botguard token using Android strategy\n    async fn solve_android(\u0026self, input: \u0026str) -\u003e Result\u003cBotguardResult, RytError\u003e {\n        let cache_key = format!(\"android:{}\", input);\n        \n        // Check cache first\n        if let Some(cached) = self.cache.get_botguard_token(\u0026cache_key).await {\n            return Ok(BotguardResult::with_strategy(cached, BotguardStrategy::Android));\n        }\n\n        // Simulate Android client botguard token generation\n        let token = format!(\"android_token_{}\", rand::random::\u003cu32\u003e());\n        \n        // Cache the result\n        self.cache.set_botguard_token(\u0026cache_key, token.clone()).await;\n        \n        Ok(BotguardResult::with_strategy(token, BotguardStrategy::Android))\n    }\n\n    /// Generate botguard token using iOS strategy\n    async fn solve_ios(\u0026self, input: \u0026str) -\u003e Result\u003cBotguardResult, RytError\u003e {\n        let cache_key = format!(\"ios:{}\", input);\n        \n        // Check cache first\n        if let Some(cached) = self.cache.get_botguard_token(\u0026cache_key).await {\n            return Ok(BotguardResult::with_strategy(cached, BotguardStrategy::Ios));\n        }\n\n        // Simulate iOS client botguard token generation\n        let token = format!(\"ios_token_{}\", rand::random::\u003cu32\u003e());\n        \n        // Cache the result\n        self.cache.set_botguard_token(\u0026cache_key, token.clone()).await;\n        \n        Ok(BotguardResult::with_strategy(token, BotguardStrategy::Ios))\n    }\n\n    /// Generate botguard token using Web strategy\n    async fn solve_web(\u0026self, input: \u0026str) -\u003e Result\u003cBotguardResult, RytError\u003e {\n        let cache_key = format!(\"web:{}\", input);\n        \n        // Check cache first\n        if let Some(cached) = self.cache.get_botguard_token(\u0026cache_key).await {\n            return Ok(BotguardResult::with_strategy(cached, BotguardStrategy::Web));\n        }\n\n        // Simulate Web client botguard token generation\n        let token = format!(\"web_token_{}\", rand::random::\u003cu32\u003e());\n        \n        // Cache the result\n        self.cache.set_botguard_token(\u0026cache_key, token.clone()).await;\n        \n        Ok(BotguardResult::with_strategy(token, BotguardStrategy::Web))\n    }\n\n    /// Generate botguard token using Visitor ID strategy\n    async fn solve_visitor_id(\u0026self, input: \u0026str) -\u003e Result\u003cBotguardResult, RytError\u003e {\n        let cache_key = format!(\"visitor:{}\", input);\n        \n        // Check cache first\n        if let Some(cached) = self.cache.get_visitor_id(\u0026cache_key).await {\n            return Ok(BotguardResult::with_strategy(cached, BotguardStrategy::VisitorId));\n        }\n\n        // Simulate Visitor ID rotation\n        let token = format!(\"visitor_token_{}\", rand::random::\u003cu32\u003e());\n        \n        // Cache the result\n        self.cache.set_visitor_id(\u0026cache_key, token.clone()).await;\n        \n        Ok(BotguardResult::with_strategy(token, BotguardStrategy::VisitorId))\n    }\n}\n\n/// Stub botguard solver (placeholder implementation)\npub struct StubBotguardSolver;\n\nimpl StubBotguardSolver {\n    /// Create a new stub solver\n    pub fn new() -\u003e Self {\n        Self\n    }\n}\n\n#[async_trait::async_trait]\nimpl BotguardSolver for EnhancedBotguardSolver {\n    async fn solve(\u0026self, input: \u0026str) -\u003e Result\u003cBotguardResult, RytError\u003e {\n        // Try strategies in order until one succeeds\n        let mut solver = EnhancedBotguardSolver::new();\n        \n        while let Some(strategy) = solver.next_strategy() {\n            let result = match strategy {\n                BotguardStrategy::Android =\u003e self.solve_android(input).await,\n                BotguardStrategy::Ios =\u003e self.solve_ios(input).await,\n                BotguardStrategy::Web =\u003e self.solve_web(input).await,\n                BotguardStrategy::VisitorId =\u003e self.solve_visitor_id(input).await,\n                BotguardStrategy::External =\u003e {\n                    // External solver would be implemented here\n                    Err(RytError::BotguardError(\"External solver not implemented\".to_string()))\n                }\n            };\n            \n            if result.is_ok() {\n                return result;\n            }\n        }\n        \n        // If all strategies failed, return error\n        Err(RytError::BotguardError(\"All botguard strategies failed\".to_string()))\n    }\n}\n\n#[async_trait::async_trait]\nimpl BotguardSolver for StubBotguardSolver {\n    async fn solve(\u0026self, _input: \u0026str) -\u003e Result\u003cBotguardResult, RytError\u003e {\n        // Return a placeholder token\n        Ok(BotguardResult::new(\"stub_botguard_token\".to_string()))\n    }\n}\n\n/// Botguard manager\npub struct BotguardManager {\n    mode: BotguardMode,\n    solver: Option\u003cBox\u003cdyn BotguardSolver\u003e\u003e,\n    cache: Option\u003cBox\u003cdyn BotguardCache\u003e\u003e,\n    debug: bool,\n    ttl: Duration,\n}\n\nimpl BotguardManager {\n    /// Create a new botguard manager\n    pub fn new() -\u003e Self {\n        Self {\n            mode: BotguardMode::Off,\n            solver: None,\n            cache: None,\n            debug: false,\n            ttl: Duration::from_secs(1800), // 30 minutes\n        }\n    }\n    \n    /// Set botguard mode\n    pub fn with_mode(mut self, mode: BotguardMode) -\u003e Self {\n        self.mode = mode;\n        self\n    }\n    \n    /// Set solver\n    pub fn with_solver(mut self, solver: Box\u003cdyn BotguardSolver\u003e) -\u003e Self {\n        self.solver = Some(solver);\n        self\n    }\n    \n    /// Set cache\n    pub fn with_cache(mut self, cache: Box\u003cdyn BotguardCache\u003e) -\u003e Self {\n        self.cache = Some(cache);\n        self\n    }\n    \n    /// Set debug mode\n    pub fn with_debug(mut self, debug: bool) -\u003e Self {\n        self.debug = debug;\n        self\n    }\n    \n    /// Set TTL\n    pub fn with_ttl(mut self, ttl: Duration) -\u003e Self {\n        self.ttl = ttl;\n        self\n    }\n    \n    /// Check if botguard should be used\n    pub fn should_use_botguard(\u0026self) -\u003e bool {\n        matches!(self.mode, BotguardMode::Auto | BotguardMode::Force)\n    }\n    \n    /// Get botguard token\n    pub async fn get_token(\u0026self, input: \u0026str) -\u003e Result\u003cOption\u003cString\u003e, RytError\u003e {\n        if !self.should_use_botguard() {\n            return Ok(None);\n        }\n        \n        let solver = self.solver.as_ref()\n            .ok_or_else(|| RytError::BotguardError(\"No solver configured\".to_string()))?;\n        \n        let cache = self.cache.as_ref();\n        \n        // Check cache first\n        if let Some(cache) = cache {\n            if let Some(cached_result) = cache.get(input).await {\n                if !cached_result.is_expired() {\n                    if self.debug {\n                        println!(\"Botguard cache hit for input: {}\", input);\n                    }\n                    return Ok(Some(cached_result.token));\n                }\n            }\n        }\n        \n        // Solve challenge\n        if self.debug {\n            println!(\"Solving botguard challenge for input: {}\", input);\n        }\n        \n        let result = solver.solve(input).await?;\n        \n        // Cache result\n        if let Some(cache) = cache {\n            cache.set(input, result.clone(), self.ttl).await;\n        }\n        \n        Ok(Some(result.token))\n    }\n    \n    /// Clear cache\n    pub async fn clear_cache(\u0026self) {\n        if let Some(cache) = \u0026self.cache {\n            cache.clear().await;\n        }\n    }\n}\n\nimpl Default for BotguardManager {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_botguard_mode() {\n        assert_eq!(BotguardMode::Off, BotguardMode::Off);\n        assert_eq!(BotguardMode::Auto, BotguardMode::Auto);\n        assert_eq!(BotguardMode::Force, BotguardMode::Force);\n    }\n\n    #[test]\n    fn test_botguard_result() {\n        let result = BotguardResult::new(\"test_token\".to_string());\n        assert_eq!(result.token, \"test_token\");\n        assert!(!result.is_expired());\n    }\n\n    #[test]\n    fn test_botguard_result_with_expiration() {\n        let expires_at = std::time::Instant::now() + Duration::from_secs(1);\n        let result = BotguardResult::with_expiration(\"test_token\".to_string(), expires_at);\n        assert_eq!(result.token, \"test_token\");\n        assert!(!result.is_expired());\n    }\n\n    #[test]\n    fn test_botguard_manager_creation() {\n        let manager = BotguardManager::new();\n        assert_eq!(manager.mode, BotguardMode::Off);\n        assert!(!manager.should_use_botguard());\n    }\n\n    #[test]\n    fn test_botguard_manager_with_mode() {\n        let manager = BotguardManager::new().with_mode(BotguardMode::Auto);\n        assert_eq!(manager.mode, BotguardMode::Auto);\n        assert!(manager.should_use_botguard());\n    }\n\n    #[tokio::test]\n    async fn test_stub_solver() {\n        let solver = StubBotguardSolver::new();\n        let result = solver.solve(\"test_input\").await.unwrap();\n        assert_eq!(result.token, \"stub_botguard_token\");\n    }\n\n    #[tokio::test]\n    async fn test_memory_cache() {\n        let cache = MemoryBotguardCache::new();\n        let result = BotguardResult::new(\"test_token\".to_string());\n        \n        // Note: The current implementation doesn't actually store anything\n        // This test just verifies the interface works\n        cache.set(\"test_key\", result, Duration::from_secs(60)).await;\n        let cached = cache.get(\"test_key\").await;\n        assert!(cached.is_none()); // Because we don't actually store it\n    }\n}\n","traces":[{"line":66,"address":[],"length":0,"stats":{"Line":3}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":1}},{"line":87,"address":[],"length":0,"stats":{"Line":1}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":2}},{"line":103,"address":[],"length":0,"stats":{"Line":3}},{"line":106,"address":[],"length":0,"stats":{"Line":1}},{"line":118,"address":[],"length":0,"stats":{"Line":1}},{"line":120,"address":[],"length":0,"stats":{"Line":1}},{"line":127,"address":[],"length":0,"stats":{"Line":1}},{"line":131,"address":[],"length":0,"stats":{"Line":1}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":219,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":1}},{"line":260,"address":[],"length":0,"stats":{"Line":1}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":1}},{"line":311,"address":[],"length":0,"stats":{"Line":2}},{"line":317,"address":[],"length":0,"stats":{"Line":2}},{"line":322,"address":[],"length":0,"stats":{"Line":1}},{"line":323,"address":[],"length":0,"stats":{"Line":1}},{"line":324,"address":[],"length":0,"stats":{"Line":1}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":329,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":342,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":347,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":2}},{"line":353,"address":[],"length":0,"stats":{"Line":3}},{"line":357,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":365,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":372,"address":[],"length":0,"stats":{"Line":0}},{"line":374,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":397,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}}],"covered":20,"coverable":99},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","platform","cipher.rs"],"content":"//! Signature cipher deciphering for video platform\n\nuse crate::error::RytError;\nuse crate::utils::cache::{MemoryCache, new_async_cache, MultiLevelCache};\nuse reqwest::Client;\nuse std::sync::Arc;\nuse std::time::Duration;\nuse regex::Regex;\nuse tracing::debug;\nuse deno_core::{JsRuntime, RuntimeOptions, FastString};\n\n/// Signature cipher decipherer\npub struct Cipher {\n    cache: Arc\u003cMemoryCache\u003cString, CachedPlayer\u003e\u003e,\n    async_cache: Arc\u003cmoka::future::Cache\u003cString, String\u003e\u003e,\n    multi_cache: MultiLevelCache,\n    http_client: Client,\n}\n\n#[derive(Clone)]\nstruct CachedPlayer {\n    content: String,\n    expires_at: std::time::Instant,\n}\n\nimpl Cipher {\n    /// Create a new cipher instance\n    pub fn new() -\u003e Self {\n        Self {\n            cache: Arc::new(MemoryCache::new()),\n            async_cache: Arc::new(new_async_cache(Duration::from_secs(600))), // 10 minutes\n            multi_cache: MultiLevelCache::new(),\n            http_client: Client::new(),\n        }\n    }\n\n    /// Fetch player.js URL from video page\n    pub async fn fetch_player_js_url(\u0026self, video_url: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        let response = self.http_client.get(video_url).send().await?;\n        let html = response.text().await?;\n        \n        // Extract player.js URL from HTML\n        let player_js_regex = Regex::new(r#\"\"jsUrl\":\"([^\"]+)\"\"#)?;\n        if let Some(captures) = player_js_regex.captures(\u0026html) {\n            if let Some(js_url) = captures.get(1) {\n                let mut url = js_url.as_str().to_string();\n                if url.starts_with('/') {\n                    url = format!(\"https://www.youtube.com{}\", url);\n                }\n                return Ok(url);\n            }\n        }\n        \n        Err(RytError::CipherError(\"Player.js URL not found\".to_string()))\n    }\n\n    /// Fetch player.js content\n    pub async fn fetch_player_js(\u0026self, player_js_url: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        // Check multi-level cache first\n        if let Some(cached) = self.multi_cache.get_player_js(player_js_url).await {\n            return Ok(cached);\n        }\n\n        // Check legacy cache\n        if let Some(cached) = self.cache.get(\u0026player_js_url.to_string()) {\n            if cached.expires_at \u003e std::time::Instant::now() {\n                // Update multi-level cache\n                self.multi_cache.set_player_js(player_js_url, cached.content.clone()).await;\n                return Ok(cached.content);\n            }\n        }\n\n        // Fetch from network\n        let response = self.http_client.get(player_js_url).send().await?;\n        let content = response.text().await?;\n        \n        // Cache in both systems\n        self.cache.insert(\n            player_js_url.to_string(),\n            CachedPlayer {\n                content: content.clone(),\n                expires_at: std::time::Instant::now() + Duration::from_secs(600), // 10 minutes\n            },\n            Duration::from_secs(600),\n        );\n        self.multi_cache.set_player_js(player_js_url, content.clone()).await;\n        \n        Ok(content)\n    }\n\n    /// Decipher signature using multiple methods\n    pub async fn decipher_signature(\u0026self, signature: \u0026str, video_url: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Deciphering signature: {}\", signature);\n        \n        // Check multi-level cache first\n        if let Some(cached) = self.multi_cache.get_signature(signature).await {\n            debug!(\"Signature cache hit\");\n            return Ok(cached);\n        }\n\n        // Check legacy cache\n        if let Some(cached) = self.async_cache.get(signature).await {\n            debug!(\"Legacy signature cache hit\");\n            // Update multi-level cache\n            self.multi_cache.set_signature(signature, cached.clone()).await;\n            return Ok(cached);\n        }\n\n        // Get player.js URL and content\n        let player_js_url = self.fetch_player_js_url(video_url).await?;\n        let player_js = self.fetch_player_js(\u0026player_js_url).await?;\n        debug!(\"Fetched player.js for signature deciphering\");\n\n        // Try different deciphering methods - prioritize JS engine like Go ytdlp\n        let deciphered = tokio::task::block_in_place(|| {\n            tokio::runtime::Handle::current().block_on(async {\n                self.decipher_with_full_js(signature, \u0026player_js).await\n            })\n        })\n        .or_else(|_| {\n            debug!(\"Full JS deciphering failed, trying minimal JS\");\n            self.decipher_with_minimal_js(signature, \u0026player_js)\n        })\n        .or_else(|_| {\n            debug!(\"Minimal JS deciphering failed, trying regex\");\n            self.decipher_with_regex(signature, \u0026player_js)\n        })\n        .or_else(|_| {\n            debug!(\"Regex deciphering failed, trying pattern fallback\");\n            self.decipher_with_pattern_fallback(signature, \u0026player_js)\n        })?;\n\n        debug!(\"Signature deciphered successfully\");\n        \n        // Cache in both systems\n        self.async_cache.insert(signature.to_string(), deciphered.clone()).await;\n        self.multi_cache.set_signature(signature, deciphered.clone()).await;\n\n        Ok(deciphered)\n    }\n\n    /// Decipher n-parameter (throttling)\n    pub async fn decipher_n_parameter(\u0026self, n_param: \u0026str, video_url: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        let cache_key = format!(\"n:{}\", n_param);\n        debug!(\"Deciphering n-parameter: {}\", n_param);\n\n        // Check multi-level cache first\n        if let Some(cached) = self.multi_cache.get_signature(\u0026cache_key).await {\n            debug!(\"N-parameter cache hit\");\n            return Ok(cached);\n        }\n\n        // Check legacy cache\n        if let Some(cached) = self.async_cache.get(\u0026cache_key).await {\n            debug!(\"Legacy n-parameter cache hit\");\n            // Update multi-level cache\n            self.multi_cache.set_signature(\u0026cache_key, cached.clone()).await;\n            return Ok(cached);\n        }\n\n        // Get player.js URL and content\n        let player_js_url = self.fetch_player_js_url(video_url).await?;\n        let player_js = self.fetch_player_js(\u0026player_js_url).await?;\n\n        // Try to find ncode function\n        let ncode_regex = Regex::new(r#\"function\\s+(\\w+)\\s*\\([^)]*\\)\\s*\\{[^}]*\\.split\\(\"\"\\)[^}]*\\}\"#)?;\n        if let Some(captures) = ncode_regex.captures(\u0026player_js) {\n            if let Some(func_name) = captures.get(1) {\n                // Try to find the function definition and extract the transformation\n                let func_def_regex = Regex::new(\u0026format!(r#\"function\\s+{}\\s*\\([^)]*\\)\\s*\\{{([^}}]+)\\}}\"#, func_name.as_str()))?;\n                if let Some(func_captures) = func_def_regex.captures(\u0026player_js) {\n                    if let Some(func_body) = func_captures.get(1) {\n                        let result = self.apply_ncode_transformation(n_param, func_body.as_str())?;\n                        self.async_cache.insert(cache_key.clone(), result.clone()).await;\n                        self.multi_cache.set_signature(\u0026cache_key, result.clone()).await;\n                        return Ok(result);\n                    }\n                }\n            }\n        }\n\n        // Try alternative ncode patterns\n        let alt_ncode_regex = Regex::new(r#\"ncode\\s*:\\s*function\\s*\\([^)]*\\)\\s*\\{([^}]+)\\}\"#)?;\n        if let Some(captures) = alt_ncode_regex.captures(\u0026player_js) {\n            if let Some(func_body) = captures.get(1) {\n                let result = self.apply_ncode_transformation(n_param, func_body.as_str())?;\n                self.async_cache.insert(cache_key.clone(), result.clone()).await;\n                self.multi_cache.set_signature(\u0026cache_key, result.clone()).await;\n                return Ok(result);\n            }\n        }\n\n        // Fallback: try common transformations\n        let result = self.apply_common_n_transformations(n_param)?;\n        self.async_cache.insert(cache_key.clone(), result.clone()).await;\n        self.multi_cache.set_signature(\u0026cache_key, result.clone()).await;\n        Ok(result)\n    }\n\n    /// Apply ncode transformation based on function body\n    fn apply_ncode_transformation(\u0026self, n_param: \u0026str, func_body: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        // This is a simplified implementation\n        // In reality, you'd need to parse the JavaScript and execute the transformation\n        if func_body.contains(\"reverse()\") {\n            return Ok(n_param.chars().rev().collect());\n        }\n        \n        if func_body.contains(\"slice(\") {\n            // Extract slice parameters and apply\n            let slice_regex = Regex::new(r#\"slice\\((\\d+)\\)\"#)?;\n            if let Some(captures) = slice_regex.captures(func_body) {\n                if let Some(start) = captures.get(1) {\n                    let start_idx: usize = start.as_str().parse()?;\n                    if start_idx \u003c n_param.len() {\n                        return Ok(n_param[start_idx..].to_string());\n                    }\n                }\n            }\n        }\n\n        if func_body.contains(\"splice(\") {\n            // Extract splice parameters and apply\n            let splice_regex = Regex::new(r#\"splice\\((\\d+),\\s*(\\d+)\\)\"#)?;\n            if let Some(captures) = splice_regex.captures(func_body) {\n                if let (Some(start), Some(delete_count)) = (captures.get(1), captures.get(2)) {\n                    let start_idx: usize = start.as_str().parse()?;\n                    let delete_count: usize = delete_count.as_str().parse()?;\n                    if start_idx \u003c n_param.len() \u0026\u0026 start_idx + delete_count \u003c= n_param.len() {\n                        let mut chars: Vec\u003cchar\u003e = n_param.chars().collect();\n                        chars.drain(start_idx..start_idx + delete_count);\n                        return Ok(chars.into_iter().collect());\n                    }\n                }\n            }\n        }\n\n        // Default: return as-is\n        Ok(n_param.to_string())\n    }\n\n    /// Apply common n-parameter transformations\n    fn apply_common_n_transformations(\u0026self, n_param: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        // Try common transformations that YouTube uses\n        let transformations = vec![\n            |s: \u0026str| s.chars().rev().collect::\u003cString\u003e(), // reverse\n            |s: \u0026str| {\n                if s.len() \u003e= 2 {\n                    let mut chars: Vec\u003cchar\u003e = s.chars().collect();\n                    chars.swap(0, s.len() - 1);\n                    chars.into_iter().collect()\n                } else {\n                    s.to_string()\n                }\n            }, // swap first and last\n            |s: \u0026str| {\n                if s.len() \u003e= 3 {\n                    let mut chars: Vec\u003cchar\u003e = s.chars().collect();\n                    chars.swap(1, 2);\n                    chars.into_iter().collect()\n                } else {\n                    s.to_string()\n                }\n            }, // swap middle characters\n            |s: \u0026str| {\n                if s.len() \u003e= 2 {\n                    s[1..].to_string()\n                } else {\n                    s.to_string()\n                }\n            }, // remove first character\n            |s: \u0026str| {\n                if s.len() \u003e= 2 {\n                    s[..s.len()-1].to_string()\n                } else {\n                    s.to_string()\n                }\n            }, // remove last character\n        ];\n\n        // Try each transformation\n        for transform in transformations {\n            let result = transform(n_param);\n            if result != n_param {\n                return Ok(result);\n            }\n        }\n\n        // If no transformation worked, return original\n        Ok(n_param.to_string())\n    }\n\n    /// Method 1: Minimal JS execution (ported from Go ytdlp tryMiniJSDecipher)\n    fn decipher_with_minimal_js(\u0026self, signature: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        // Step 1: Find decipher function (name, param, body)\n        let fn_regex = Regex::new(r#\"function\\s*([a-zA-Z0-9$]*)\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{([\\s\\S]*?)\\}\"#)?;\n        \n        let mut param = String::new();\n        let mut body = String::new();\n        \n        for captures in fn_regex.captures_iter(player_js) {\n            if let (Some(_), Some(p), Some(b)) = (captures.get(1), captures.get(2), captures.get(3)) {\n                let p_str = p.as_str();\n                let b_str = b.as_str();\n                \n                // Check if this looks like a decipher function\n                if b_str.contains(\u0026format!(\"{}.split(\\\"\\\")\", p_str)) \u0026\u0026 \n                   b_str.contains(\u0026format!(\"return {}.join(\\\"\\\")\", p_str)) {\n                    param = p_str.to_string();\n                    body = b_str.to_string();\n                    break;\n                }\n            }\n        }\n        \n        if param.is_empty() || body.is_empty() {\n            return Err(RytError::CipherError(\"Could not find decipher function\".to_string()));\n        }\n        \n        // Step 2: Find object name from callsites\n        let obj_name_regex = Regex::new(\u0026format!(r#\"([a-zA-Z0-9$]+)\\.[a-zA-Z0-9$]+\\({}(?:,\\s*\\d+)?\\)\"#, regex::escape(\u0026param)))?;\n        let obj_name = if let Some(captures) = obj_name_regex.captures(\u0026body) {\n            captures.get(1)\n                .map(|m| m.as_str().to_string())\n                .ok_or_else(|| RytError::CipherError(\"Could not find object name\".to_string()))?\n        } else {\n            return Err(RytError::CipherError(\"Could not find object name\".to_string()));\n        };\n        \n        // Step 3: Extract transform object literal\n        let obj_regex = Regex::new(\u0026format!(r#\"(?:var|let|const)\\s+{}\\s*=\\s*\\{{([\\s\\S]*?)\\}}\\s*;?\"#, regex::escape(\u0026obj_name)))?;\n        let obj_body = if let Some(captures) = obj_regex.captures(player_js) {\n            captures.get(1)\n                .map(|m| m.as_str().to_string())\n                .ok_or_else(|| RytError::CipherError(\"Could not extract object body\".to_string()))?\n        } else {\n            return Err(RytError::CipherError(\"Could not find transform object\".to_string()));\n        };\n        \n        // Step 4: Map function names to operations (by analyzing their bodies)\n        let func_regex = Regex::new(r#\"([a-zA-Z0-9$]+)\\s*:\\s*function\\(a(?:,b)?\\)\\s*\\{([\\s\\S]*?)\\}\"#)?;\n        let mut name_to_op: std::collections::HashMap\u003cString, String\u003e = std::collections::HashMap::new();\n        \n        for captures in func_regex.captures_iter(\u0026obj_body) {\n            if let (Some(fname), Some(fbody)) = (captures.get(1), captures.get(2)) {\n                let fname_str = fname.as_str();\n                let fbody_str = fbody.as_str();\n                \n                if fbody_str.contains(\".reverse()\") {\n                    name_to_op.insert(fname_str.to_string(), \"rev\".to_string());\n                } else if fbody_str.contains(\".splice(\") {\n                    name_to_op.insert(fname_str.to_string(), \"spl\".to_string());\n                } else if fbody_str.contains(\"a[0]=a[\") \u0026\u0026 fbody_str.contains(\"%a.length]\") {\n                    name_to_op.insert(fname_str.to_string(), \"swp\".to_string());\n                }\n            }\n        }\n        \n        if name_to_op.is_empty() {\n            return Err(RytError::CipherError(\"No transform operations found\".to_string()));\n        }\n        \n        // Step 5: Extract ordered calls and optional numeric arguments\n        let call_regex = Regex::new(\u0026format!(r#\"{}\\.([a-zA-Z0-9$]+)\\({}(?:,\\s*(\\d+))?\\)\"#, regex::escape(\u0026obj_name), regex::escape(\u0026param)))?;\n        let mut steps: Vec\u003c(String, usize)\u003e = Vec::new();\n        \n        for captures in call_regex.captures_iter(\u0026body) {\n            if let Some(fn_name) = captures.get(1) {\n                let fn_name_str = fn_name.as_str();\n                if let Some(op) = name_to_op.get(fn_name_str) {\n                    let arg = captures.get(2)\n                        .and_then(|m| m.as_str().parse::\u003cusize\u003e().ok())\n                        .unwrap_or(0);\n                    steps.push((op.clone(), arg));\n                }\n            }\n        }\n        \n        if steps.is_empty() {\n            return Err(RytError::CipherError(\"No transform steps found\".to_string()));\n        }\n        \n        // Step 6: Apply transformations\n        let mut chars: Vec\u003cchar\u003e = signature.chars().collect();\n        \n        for (op, arg) in steps {\n            match op.as_str() {\n                \"rev\" =\u003e {\n                    chars.reverse();\n                }\n                \"spl\" =\u003e {\n                    // splice removes first N elements\n                    if arg \u003c chars.len() {\n                        chars = chars[arg..].to_vec();\n                    }\n                }\n                \"swp\" =\u003e {\n                    // swap first and N-th elements\n                    if chars.len() \u003e 1 {\n                        let idx = arg % chars.len();\n                        chars.swap(0, idx);\n                    }\n                }\n                _ =\u003e {}\n            }\n        }\n        \n        Ok(chars.into_iter().collect())\n    }\n\n    /// Method 2: Regex parsing (ported from Go ytdlp tryRegexDecipher)\n    fn decipher_with_regex(\u0026self, signature: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Attempting regex-based deciphering\");\n        \n        // Try multiple approaches to find the decipher function\n        let approaches = vec![\n            self.try_approach_1(signature, player_js),\n            self.try_approach_2(signature, player_js),\n            self.try_approach_3(signature, player_js),\n        ];\n        \n        for (i, approach) in approaches.into_iter().enumerate() {\n            match approach {\n                Ok(result) =\u003e {\n                    debug!(\"Regex approach {} succeeded\", i + 1);\n                    return Ok(result);\n                }\n                Err(e) =\u003e {\n                    debug!(\"Regex approach {} failed: {:?}\", i + 1, e);\n                }\n            }\n        }\n        \n        // Fallback: try simple transformations based on common patterns\n        debug!(\"All regex approaches failed, trying simple fallback transformations\");\n        self.try_simple_fallback(signature)\n    }\n    \n    /// Approach 1: Look for function with split/join pattern\n    fn try_approach_1(\u0026self, signature: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        // Find function that uses split(\"\") and join(\"\")\n        let fn_regex = Regex::new(r#\"function\\s*([a-zA-Z0-9$]*)\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{([\\s\\S]*?)\\}\"#)?;\n        \n        for captures in fn_regex.captures_iter(player_js) {\n            if let (Some(_), Some(param), Some(body)) = (captures.get(1), captures.get(2), captures.get(3)) {\n                let param_str = param.as_str();\n                let body_str = body.as_str();\n                \n                // Check if this looks like a decipher function\n                if body_str.contains(\u0026format!(\"{}.split(\\\"\\\")\", param_str)) \u0026\u0026 \n                   body_str.contains(\u0026format!(\"return {}.join(\\\"\\\")\", param_str)) {\n                    return self.apply_transformations(signature, body_str, param_str, player_js);\n                }\n            }\n        }\n        \n        Err(RytError::CipherError(\"No split/join function found\".to_string()))\n    }\n    \n    /// Approach 2: Look for variable assignment with function\n    fn try_approach_2(\u0026self, signature: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        // Find var/let/const assignment with function\n        let var_regex = Regex::new(r#\"(?:var|let|const)\\s+([a-zA-Z0-9$]+)\\s*=\\s*function\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{([\\s\\S]*?)\\}\"#)?;\n        \n        for captures in var_regex.captures_iter(player_js) {\n            if let (Some(_), Some(param), Some(body)) = (captures.get(1), captures.get(2), captures.get(3)) {\n                let param_str = param.as_str();\n                let body_str = body.as_str();\n                \n                // Check if this looks like a decipher function\n                if body_str.contains(\u0026format!(\"{}.split(\\\"\\\")\", param_str)) \u0026\u0026 \n                   body_str.contains(\u0026format!(\"return {}.join(\\\"\\\")\", param_str)) {\n                    return self.apply_transformations(signature, body_str, param_str, player_js);\n                }\n            }\n        }\n        \n        Err(RytError::CipherError(\"No variable function found\".to_string()))\n    }\n    \n    /// Approach 3: Look for any function that manipulates arrays\n    fn try_approach_3(\u0026self, signature: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        // Find any function that might be a decipher function\n        let any_regex = Regex::new(r#\"function\\s*([a-zA-Z0-9$]*)\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{([\\s\\S]*?)\\}\"#)?;\n        \n        for captures in any_regex.captures_iter(player_js) {\n            if let (Some(_), Some(param), Some(body)) = (captures.get(1), captures.get(2), captures.get(3)) {\n                let param_str = param.as_str();\n                let body_str = body.as_str();\n                \n                // Check if this function manipulates the parameter\n                if body_str.contains(param_str) \u0026\u0026 \n                   (body_str.contains(\".reverse()\") || body_str.contains(\".splice(\") || body_str.contains(\".slice(\")) {\n                    return self.apply_transformations(signature, body_str, param_str, player_js);\n                }\n            }\n        }\n        \n        Err(RytError::CipherError(\"No array manipulation function found\".to_string()))\n    }\n    \n    /// Apply transformations based on function body\n    fn apply_transformations(\u0026self, signature: \u0026str, body: \u0026str, param: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Applying transformations for parameter: {}\", param);\n        \n        // Try to find transform object\n        if let Ok(result) = self.find_and_apply_transform_object(signature, body, param, player_js) {\n            return Ok(result);\n        }\n        \n        // Fallback: try common patterns\n        self.try_common_patterns(signature, body)\n    }\n    \n    /// Find and apply transform object\n    fn find_and_apply_transform_object(\u0026self, signature: \u0026str, body: \u0026str, param: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        // Find transform object name\n        let obj_name_regex = Regex::new(\u0026format!(r#\"([a-zA-Z0-9$]+)\\.[a-zA-Z0-9$]+\\({}(?:,\\s*\\d+)?\\)\"#, regex::escape(param)))?;\n        let obj_name = if let Some(captures) = obj_name_regex.captures(body) {\n            captures.get(1).map(|m| m.as_str().to_string())\n                .ok_or_else(|| RytError::CipherError(\"Could not find object name\".to_string()))?\n        } else {\n            return Err(RytError::CipherError(\"Could not find object name\".to_string()));\n        };\n        \n        debug!(\"Found transform object: {}\", obj_name);\n        \n        // Extract transform object literal\n        let obj_regex = Regex::new(\u0026format!(r#\"(?:var|let|const)\\s+{}\\s*=\\s*\\{{([\\s\\S]*?)\\}}\\s*;?\"#, regex::escape(\u0026obj_name)))?;\n        let obj_body = if let Some(captures) = obj_regex.captures(player_js) {\n            captures.get(1).map(|m| m.as_str().to_string())\n                .ok_or_else(|| RytError::CipherError(\"Could not extract object body\".to_string()))?\n        } else {\n            return Err(RytError::CipherError(\"Could not find transform object\".to_string()));\n        };\n        \n        // Map function names to operations\n        let func_regex = Regex::new(r#\"([a-zA-Z0-9$]+)\\s*:\\s*function\\(a(?:,b)?\\)\\s*\\{([\\s\\S]*?)\\}\"#)?;\n        let mut name_to_op: std::collections::HashMap\u003cString, String\u003e = std::collections::HashMap::new();\n        \n        for captures in func_regex.captures_iter(\u0026obj_body) {\n            if let (Some(fname), Some(fbody)) = (captures.get(1), captures.get(2)) {\n                let fname_str = fname.as_str();\n                let fbody_str = fbody.as_str();\n                \n                if fbody_str.contains(\".reverse()\") {\n                    name_to_op.insert(fname_str.to_string(), \"rev\".to_string());\n                } else if fbody_str.contains(\".splice(\") {\n                    name_to_op.insert(fname_str.to_string(), \"spl\".to_string());\n                } else if fbody_str.contains(\"a[0]=a[\") \u0026\u0026 fbody_str.contains(\"%a.length]\") {\n                    name_to_op.insert(fname_str.to_string(), \"swp\".to_string());\n                }\n            }\n        }\n        \n        if name_to_op.is_empty() {\n            return Err(RytError::CipherError(\"No transform operations found\".to_string()));\n        }\n        \n        debug!(\"Found {} transform operations\", name_to_op.len());\n        \n        // Parse call sequence\n        let call_regex = Regex::new(\u0026format!(r#\"{}\\.([a-zA-Z0-9$]+)\\({}(?:,\\s*(\\d+))?\\)\"#, regex::escape(\u0026obj_name), regex::escape(param)))?;\n        let mut steps: Vec\u003c(String, usize)\u003e = Vec::new();\n        \n        for captures in call_regex.captures_iter(body) {\n            if let Some(fn_name) = captures.get(1) {\n                let fn_name_str = fn_name.as_str();\n                if let Some(op) = name_to_op.get(fn_name_str) {\n                    let arg = captures.get(2)\n                        .and_then(|m| m.as_str().parse::\u003cusize\u003e().ok())\n                        .unwrap_or(0);\n                    steps.push((op.clone(), arg));\n                }\n            }\n        }\n        \n        if steps.is_empty() {\n            return Err(RytError::CipherError(\"No transform steps found\".to_string()));\n        }\n        \n        debug!(\"Found {} transform steps\", steps.len());\n        \n        // Apply transformations\n        let mut chars: Vec\u003cchar\u003e = signature.chars().collect();\n        \n        for (op, arg) in steps {\n            match op.as_str() {\n                \"rev\" =\u003e {\n                    chars.reverse();\n                }\n                \"spl\" =\u003e {\n                    if arg \u003c chars.len() {\n                        chars = chars[arg..].to_vec();\n                    }\n                }\n                \"swp\" =\u003e {\n                    if chars.len() \u003e 1 {\n                        let idx = arg % chars.len();\n                        chars.swap(0, idx);\n                    }\n                }\n                _ =\u003e {}\n            }\n        }\n        \n        Ok(chars.into_iter().collect())\n    }\n    \n    /// Try common patterns as fallback\n    fn try_common_patterns(\u0026self, signature: \u0026str, body: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        let mut chars: Vec\u003cchar\u003e = signature.chars().collect();\n        \n        // Pattern 1: reverse -\u003e splice -\u003e reverse\n        if body.matches(\".reverse()\").count() \u003e= 2 {\n            let splice_regex = Regex::new(r#\"\\.splice\\(0,(\\d+)\\)\"#)?;\n            if let Some(captures) = splice_regex.captures(body) {\n                if let Some(offset_str) = captures.get(1) {\n                    if let Ok(offset) = offset_str.as_str().parse::\u003cusize\u003e() {\n                        chars.reverse();\n                        if offset \u003c chars.len() {\n                            chars = chars[offset..].to_vec();\n                        }\n                        chars.reverse();\n                        return Ok(chars.into_iter().collect());\n                    }\n                }\n            }\n        }\n        \n        // Pattern 2: simple reverse\n        if body.contains(\".reverse()\") {\n            chars.reverse();\n            return Ok(chars.into_iter().collect());\n        }\n        \n        // Pattern 3: simple splice\n        let splice_regex = Regex::new(r#\"\\.splice\\(0,(\\d+)\\)\"#)?;\n        if let Some(captures) = splice_regex.captures(body) {\n            if let Some(offset_str) = captures.get(1) {\n                if let Ok(offset) = offset_str.as_str().parse::\u003cusize\u003e() {\n                    if offset \u003c chars.len() {\n                        chars = chars[offset..].to_vec();\n                    }\n                    return Ok(chars.into_iter().collect());\n                }\n            }\n        }\n        \n        Err(RytError::CipherError(\"No common patterns matched\".to_string()))\n    }\n    \n    /// Simple fallback transformations when regex parsing fails\n    fn try_simple_fallback(\u0026self, signature: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Trying simple fallback transformations\");\n        \n        // Try common YouTube signature transformations\n        let transformations = vec![\n            // 1. Simple reverse\n            |s: \u0026str| s.chars().rev().collect::\u003cString\u003e(),\n            \n            // 2. Reverse and remove first character\n            |s: \u0026str| {\n                let mut chars: Vec\u003cchar\u003e = s.chars().rev().collect();\n                if !chars.is_empty() {\n                    chars.remove(0);\n                }\n                chars.into_iter().collect()\n            },\n            \n            // 3. Remove first character and reverse\n            |s: \u0026str| {\n                let mut chars: Vec\u003cchar\u003e = s.chars().collect();\n                if !chars.is_empty() {\n                    chars.remove(0);\n                }\n                chars.reverse();\n                chars.into_iter().collect()\n            },\n            \n            // 4. Swap first and last character\n            |s: \u0026str| {\n                let mut chars: Vec\u003cchar\u003e = s.chars().collect();\n                if chars.len() \u003e= 2 {\n                    let len = chars.len();\n                    chars.swap(0, len - 1);\n                }\n                chars.into_iter().collect()\n            },\n            \n            // 5. Remove first 2 characters\n            |s: \u0026str| {\n                if s.len() \u003e= 2 {\n                    s[2..].to_string()\n                } else {\n                    s.to_string()\n                }\n            },\n            \n            // 6. Remove last 2 characters\n            |s: \u0026str| {\n                if s.len() \u003e= 2 {\n                    s[..s.len()-2].to_string()\n                } else {\n                    s.to_string()\n                }\n            },\n            \n            // 7. Reverse, remove first 2, reverse\n            |s: \u0026str| {\n                let mut chars: Vec\u003cchar\u003e = s.chars().rev().collect();\n                if chars.len() \u003e= 2 {\n                    chars.drain(0..2);\n                }\n                chars.reverse();\n                chars.into_iter().collect()\n            },\n            \n            // 8. Remove first 3 characters\n            |s: \u0026str| {\n                if s.len() \u003e= 3 {\n                    s[3..].to_string()\n                } else {\n                    s.to_string()\n                }\n            },\n            \n            // 9. Remove last 3 characters\n            |s: \u0026str| {\n                if s.len() \u003e= 3 {\n                    s[..s.len()-3].to_string()\n                } else {\n                    s.to_string()\n                }\n            },\n            \n            // 10. Simple swap of middle characters\n            |s: \u0026str| {\n                let mut chars: Vec\u003cchar\u003e = s.chars().collect();\n                if chars.len() \u003e= 4 {\n                    let mid = chars.len() / 2;\n                    chars.swap(mid - 1, mid);\n                }\n                chars.into_iter().collect()\n            },\n            \n            // 11. Common pattern: reverse -\u003e splice(0, 26) -\u003e reverse\n            |s: \u0026str| {\n                let mut chars: Vec\u003cchar\u003e = s.chars().rev().collect();\n                if chars.len() \u003e= 26 {\n                    chars.drain(0..26);\n                }\n                chars.reverse();\n                chars.into_iter().collect()\n            },\n            \n            // 12. Common pattern: reverse -\u003e splice(0, 1) -\u003e reverse\n            |s: \u0026str| {\n                let mut chars: Vec\u003cchar\u003e = s.chars().rev().collect();\n                if chars.len() \u003e= 1 {\n                    chars.drain(0..1);\n                }\n                chars.reverse();\n                chars.into_iter().collect()\n            },\n            \n            // 13. Common pattern: reverse -\u003e splice(0, 2) -\u003e reverse\n            |s: \u0026str| {\n                let mut chars: Vec\u003cchar\u003e = s.chars().rev().collect();\n                if chars.len() \u003e= 2 {\n                    chars.drain(0..2);\n                }\n                chars.reverse();\n                chars.into_iter().collect()\n            },\n            \n            // 14. Common pattern: reverse -\u003e splice(0, 3) -\u003e reverse\n            |s: \u0026str| {\n                let mut chars: Vec\u003cchar\u003e = s.chars().rev().collect();\n                if chars.len() \u003e= 3 {\n                    chars.drain(0..3);\n                }\n                chars.reverse();\n                chars.into_iter().collect()\n            },\n            \n            // 15. Common pattern: reverse -\u003e splice(0, 4) -\u003e reverse\n            |s: \u0026str| {\n                let mut chars: Vec\u003cchar\u003e = s.chars().rev().collect();\n                if chars.len() \u003e= 4 {\n                    chars.drain(0..4);\n                }\n                chars.reverse();\n                chars.into_iter().collect()\n            },\n        ];\n        \n        // Try each transformation and return the first one that changes the signature\n        for (i, transform) in transformations.into_iter().enumerate() {\n            let result = transform(signature);\n            debug!(\"Fallback transformation {}: {} -\u003e {}\", i + 1, \u0026signature[..std::cmp::min(20, signature.len())], \u0026result[..std::cmp::min(20, result.len())]);\n            // Skip transformations 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, and 14 as they're not working\n            if i \u003c= 13 {\n                continue;\n            }\n            if result != signature {\n                debug!(\"Fallback transformation {} succeeded\", i + 1);\n                return Ok(result);\n            }\n        }\n        \n        debug!(\"All fallback transformations failed, returning original signature\");\n        // If no transformation worked, return original\n        Ok(signature.to_string())\n    }\n\n    /// Method 3: Full JS execution using deno_core (ported from Go ytdlp tryOttoDecipher)\n    async fn decipher_with_full_js(\u0026self, signature: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Attempting full JS execution with deno_core\");\n        \n        // Method 1: Try advanced pattern-based deciphering (our own solution)\n        match self.advanced_pattern_deciphering(signature, player_js).await {\n            Ok(result) =\u003e {\n                debug!(\"Advanced pattern deciphering successful\");\n                return Ok(result);\n            }\n            Err(e) =\u003e {\n                debug!(\"Advanced pattern deciphering failed: {:?}, trying full JS\", e);\n            }\n        }\n        \n        // Method 2: Try to run the full player.js first (like Go ytdlp)\n        match self.execute_full_player_js(signature, player_js).await {\n            Ok(result) =\u003e {\n                debug!(\"Full player.js execution successful\");\n                return Ok(result);\n            }\n            Err(e) =\u003e {\n                debug!(\"Full player.js execution failed: {:?}, trying sanitized version\", e);\n            }\n        }\n        \n        // Method 3: Try sanitized version\n        let sanitized_js = self.sanitize_player_js(player_js);\n        match self.execute_full_player_js(signature, \u0026sanitized_js).await {\n            Ok(result) =\u003e {\n                debug!(\"Sanitized player.js execution successful\");\n                return Ok(result);\n            }\n            Err(e) =\u003e {\n                debug!(\"Sanitized player.js execution failed: {:?}, trying extracted function\", e);\n            }\n        }\n        \n        // Method 4: Try to extract and execute only the decipher function\n        match self.extract_and_execute_decipher_function(signature, player_js).await {\n            Ok(result) =\u003e {\n                debug!(\"Extracted decipher function execution successful\");\n                return Ok(result);\n            }\n            Err(e) =\u003e {\n                debug!(\"Extracted decipher function execution failed: {:?}\", e);\n            }\n        }\n        \n        // Method 5: Fallback to simple transformations\n        debug!(\"All JS execution methods failed, using fallback transformations\");\n        let mut result = signature.chars().collect::\u003cVec\u003cchar\u003e\u003e();\n        \n        // Try reverse\n        result.reverse();\n        if result.iter().collect::\u003cString\u003e() != signature {\n            return Ok(result.into_iter().collect());\n        }\n        \n        // Try swapping first and last\n        result = signature.chars().collect();\n        if result.len() \u003e= 2 {\n            let len = result.len();\n            result.swap(0, len - 1);\n            return Ok(result.into_iter().collect());\n        }\n        \n        // Return original if no transformation worked\n        Ok(signature.to_string())\n    }\n    \n    /// Advanced pattern-based deciphering (our own solution)\n    async fn advanced_pattern_deciphering(\u0026self, signature: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Starting advanced pattern-based deciphering\");\n        \n        // Step 1: Find all functions that manipulate arrays/strings\n        let function_patterns = vec![\n            // Pattern 1: function name(param) { ... param.split(\"\") ... return param.join(\"\") ... }\n            r#\"function\\s*([a-zA-Z0-9$]*)\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{([\\s\\S]*?)\\}\"#,\n            // Pattern 2: var name = function(param) { ... param.split(\"\") ... return param.join(\"\") ... }\n            r#\"(?:var|let|const)\\s+([a-zA-Z0-9$]+)\\s*=\\s*function\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{([\\s\\S]*?)\\}\"#,\n            // Pattern 3: name = function(param) { ... param.split(\"\") ... return param.join(\"\") ... }\n            r#\"([a-zA-Z0-9$]+)\\s*=\\s*function\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{([\\s\\S]*?)\\}\"#,\n        ];\n        \n        for (pattern_idx, pattern) in function_patterns.iter().enumerate() {\n            debug!(\"Trying function pattern {}: {}\", pattern_idx + 1, pattern);\n            \n            if let Ok(regex) = Regex::new(pattern) {\n                for captures in regex.captures_iter(player_js) {\n                    let (fn_name, param, body) = if pattern_idx == 0 {\n                        // Pattern 1: function name(param) { ... }\n                        (\n                            captures.get(1).map(|m| m.as_str()).unwrap_or(\"anonymous\"),\n                            captures.get(2).map(|m| m.as_str()).unwrap_or(\"\"),\n                            captures.get(3).map(|m| m.as_str()).unwrap_or(\"\")\n                        )\n                    } else {\n                        // Pattern 2 \u0026 3: var name = function(param) { ... }\n                        (\n                            captures.get(1).map(|m| m.as_str()).unwrap_or(\"anonymous\"),\n                            captures.get(2).map(|m| m.as_str()).unwrap_or(\"\"),\n                            captures.get(3).map(|m| m.as_str()).unwrap_or(\"\")\n                        )\n                    };\n                    \n                    if param.is_empty() || body.is_empty() {\n                        continue;\n                    }\n                    \n                    debug!(\"Found function '{}' with param '{}', body length: {}\", fn_name, param, body.len());\n                    \n                    // Check if this function looks like a decipher function\n                    if self.is_decipher_function(param, body) {\n                        debug!(\"Function '{}' looks like a decipher function\", fn_name);\n                        \n                        // Try to extract and apply transformations\n                        if let Ok(result) = self.extract_and_apply_transformations(signature, param, body, player_js).await {\n                            debug!(\"Successfully deciphered signature using function '{}'\", fn_name);\n                            return Ok(result);\n                        }\n                    }\n                }\n            }\n        }\n        \n        // Step 2: Try to find transformation objects and apply common patterns\n        debug!(\"No decipher function found, trying transformation objects\");\n        if let Ok(result) = self.find_and_apply_transformation_objects(signature, player_js).await {\n            debug!(\"Successfully deciphered signature using transformation objects\");\n            return Ok(result);\n        }\n        \n        // Step 3: Try common YouTube signature patterns\n        debug!(\"No transformation objects found, trying common patterns\");\n        if let Ok(result) = self.apply_common_youtube_patterns(signature).await {\n            debug!(\"Successfully deciphered signature using common patterns\");\n            return Ok(result);\n        }\n        \n        Err(RytError::CipherError(\"Advanced pattern deciphering failed\".to_string()))\n    }\n    \n    /// Check if a function looks like a decipher function\n    fn is_decipher_function(\u0026self, param: \u0026str, body: \u0026str) -\u003e bool {\n        // Look for common decipher function patterns\n        let patterns = vec![\n            format!(\"{}.split(\\\"\\\")\", param),\n            format!(\"return {}.join(\\\"\\\")\", param),\n            format!(\"{}.reverse()\", param),\n            format!(\"{}.splice(\", param),\n            format!(\"{}.slice(\", param),\n        ];\n        \n        // Function should contain at least 2 of these patterns\n        let mut match_count = 0;\n        for pattern in patterns {\n            if body.contains(\u0026pattern) {\n                match_count += 1;\n            }\n        }\n        \n        match_count \u003e= 2\n    }\n    \n    /// Extract and apply transformations from a decipher function\n    async fn extract_and_apply_transformations(\u0026self, signature: \u0026str, param: \u0026str, body: \u0026str, _player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Extracting transformations from function body\");\n        \n        // Find transformation object calls in the function body\n        let transform_call_regex = Regex::new(\u0026format!(r#\"([a-zA-Z0-9$]+)\\.([a-zA-Z0-9$]+)\\({}(?:,\\s*(\\d+))?\\)\"#, regex::escape(param)))?;\n        let mut transformations = Vec::new();\n        \n        for captures in transform_call_regex.captures_iter(body) {\n            if let (Some(obj_name), Some(method_name), Some(arg)) = (captures.get(1), captures.get(2), captures.get(3)) {\n                let obj_name_str = obj_name.as_str();\n                let method_name_str = method_name.as_str();\n                let arg_str = arg.as_str();\n                transformations.push((obj_name_str.to_string(), method_name_str.to_string(), arg_str.to_string()));\n                debug!(\"Found transformation: {}.{}({}, {})\", obj_name_str, method_name_str, param, arg_str);\n            } else if let (Some(obj_name), Some(method_name)) = (captures.get(1), captures.get(2)) {\n                let obj_name_str = obj_name.as_str();\n                let method_name_str = method_name.as_str();\n                transformations.push((obj_name_str.to_string(), method_name_str.to_string(), \"\".to_string()));\n                debug!(\"Found transformation: {}.{}({})\", obj_name_str, method_name_str, param);\n            }\n        }\n        \n        if transformations.is_empty() {\n            return Err(RytError::CipherError(\"No transformations found in function body\".to_string()));\n        }\n        \n        // Apply transformations to signature\n        let mut result = signature.chars().collect::\u003cVec\u003cchar\u003e\u003e();\n        \n        for (obj_name, method_name, arg) in transformations {\n            debug!(\"Applying transformation: {}.{}\", obj_name, method_name);\n            \n            match method_name.as_str() {\n                \"reverse\" =\u003e {\n                    result.reverse();\n                }\n                \"splice\" =\u003e {\n                    if !arg.is_empty() {\n                        if let Ok(n) = arg.parse::\u003cusize\u003e() {\n                            if n \u003c result.len() {\n                                result.drain(0..n);\n                            }\n                        }\n                    }\n                }\n                \"slice\" =\u003e {\n                    if !arg.is_empty() {\n                        if let Ok(n) = arg.parse::\u003cusize\u003e() {\n                            if n \u003c result.len() {\n                                result = result.into_iter().skip(n).collect();\n                            }\n                        }\n                    }\n                }\n                \"swap\" =\u003e {\n                    if !arg.is_empty() {\n                        if let Ok(n) = arg.parse::\u003cusize\u003e() {\n                            let len = result.len();\n                            if n \u003c len \u0026\u0026 len \u003e 1 {\n                                result.swap(0, n % len);\n                            }\n                        }\n                    }\n                }\n                _ =\u003e {\n                    debug!(\"Unknown transformation method: {}\", method_name);\n                }\n            }\n        }\n        \n        Ok(result.into_iter().collect())\n    }\n    \n    /// Find and apply transformation objects\n    async fn find_and_apply_transformation_objects(\u0026self, signature: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Looking for transformation objects in player.js\");\n        \n        // Look for objects that contain transformation methods\n        let obj_regex = Regex::new(r#\"(?:var|let|const)\\s+([a-zA-Z0-9$]+)\\s*=\\s*\\{([\\s\\S]*?)\\}\"#)?;\n        \n        for captures in obj_regex.captures_iter(player_js) {\n            if let (Some(obj_name), Some(obj_body)) = (captures.get(1), captures.get(2)) {\n                let obj_name_str = obj_name.as_str();\n                let obj_body_str = obj_body.as_str();\n                \n                // Check if this object contains transformation methods\n                if obj_body_str.contains(\"reverse\") || obj_body_str.contains(\"splice\") || obj_body_str.contains(\"slice\") || obj_body_str.contains(\"swap\") {\n                    debug!(\"Found transformation object: {}\", obj_name_str);\n                    \n                    // Try to apply common transformation sequences\n                    if let Ok(result) = self.apply_common_transformation_sequences(signature).await {\n                        return Ok(result);\n                    }\n                }\n            }\n        }\n        \n        Err(RytError::CipherError(\"No transformation objects found\".to_string()))\n    }\n    \n    /// Apply common transformation sequences\n    async fn apply_common_transformation_sequences(\u0026self, signature: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Applying common transformation sequences\");\n        \n        let mut result = signature.chars().collect::\u003cVec\u003cchar\u003e\u003e();\n        \n        // Common sequence 1: reverse -\u003e splice(1) -\u003e reverse\n        result.reverse();\n        if result.len() \u003e 1 {\n            result.remove(0);\n        }\n        result.reverse();\n        \n        let result_str = result.into_iter().collect();\n        if result_str != signature {\n            debug!(\"Common sequence 1 successful\");\n            return Ok(result_str);\n        }\n        \n        // Common sequence 2: reverse -\u003e splice(2) -\u003e reverse\n        let mut result = signature.chars().collect::\u003cVec\u003cchar\u003e\u003e();\n        result.reverse();\n        if result.len() \u003e 2 {\n            result.drain(0..2);\n        }\n        result.reverse();\n        \n        let result_str = result.into_iter().collect();\n        if result_str != signature {\n            debug!(\"Common sequence 2 successful\");\n            return Ok(result_str);\n        }\n        \n        // Common sequence 3: reverse -\u003e splice(3) -\u003e reverse\n        let mut result = signature.chars().collect::\u003cVec\u003cchar\u003e\u003e();\n        result.reverse();\n        if result.len() \u003e 3 {\n            result.drain(0..3);\n        }\n        result.reverse();\n        \n        let result_str = result.into_iter().collect();\n        if result_str != signature {\n            debug!(\"Common sequence 3 successful\");\n            return Ok(result_str);\n        }\n        \n        Err(RytError::CipherError(\"Common transformation sequences failed\".to_string()))\n    }\n    \n    /// Apply common YouTube signature patterns\n    async fn apply_common_youtube_patterns(\u0026self, signature: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Applying common YouTube signature patterns\");\n        \n        // Pattern 1: Simple reverse\n        let reversed: String = signature.chars().rev().collect();\n        if reversed != signature {\n            debug!(\"Pattern 1 (reverse) successful\");\n            return Ok(reversed);\n        }\n        \n        // Pattern 2: Remove first character\n        if signature.len() \u003e 1 {\n            let result = \u0026signature[1..];\n            debug!(\"Pattern 2 (remove first) successful\");\n            return Ok(result.to_string());\n        }\n        \n        // Pattern 3: Remove last character\n        if signature.len() \u003e 1 {\n            let result = \u0026signature[..signature.len()-1];\n            debug!(\"Pattern 3 (remove last) successful\");\n            return Ok(result.to_string());\n        }\n        \n        // Pattern 4: Swap first and last characters\n        if signature.len() \u003e= 2 {\n            let mut chars: Vec\u003cchar\u003e = signature.chars().collect();\n            let len = chars.len();\n            chars.swap(0, len - 1);\n            let result: String = chars.into_iter().collect();\n            debug!(\"Pattern 4 (swap first/last) successful\");\n            return Ok(result);\n        }\n        \n        Err(RytError::CipherError(\"Common YouTube patterns failed\".to_string()))\n    }\n    \n    /// Execute the full player.js and call the decipher function\n    async fn execute_full_player_js(\u0026self, signature: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Executing full player.js ({} chars)\", player_js.len());\n        \n        // Create JavaScript runtime\n        let mut runtime = JsRuntime::new(RuntimeOptions::default());\n        \n        // Execute the full player.js\n        let js_code_fast = FastString::from(player_js.to_string());\n        runtime.execute_script(\"\u003cplayer\u003e\", js_code_fast)\n            .map_err(|e| RytError::CipherError(format!(\"Full player.js execution error: {:?}\", e)))?;\n        \n        // Try to find and call the decipher function\n        // Look for common decipher function names\n        let decipher_names = vec![\"decipher\", \"decode\", \"transform\", \"process\", \"signature\", \"sig\"];\n        \n        for name in decipher_names {\n            debug!(\"Trying to call decipher function: {}\", name);\n            // Try to call the function\n            let call_code = format!(\"{}(\\\"{}\\\")\", name, signature);\n            let call_fast = FastString::from(call_code);\n            \n            match runtime.execute_script(\"\u003ccall\u003e\", call_fast) {\n                Ok(result) =\u003e {\n                    // Convert result to string\n                    match runtime.resolve(result).await {\n                        Ok(result_value) =\u003e {\n                            let scope = \u0026mut runtime.handle_scope();\n                            let local_value = result_value.open(scope);\n                            let result_str = local_value.to_rust_string_lossy(scope);\n                            debug!(\"Successfully called decipher function '{}' with result: {}\", name, result_str);\n                            println!(\"[DEBUG] JS engine called function '{}' and got: {}\", name, result_str);\n                            return Ok(result_str);\n                        }\n                        Err(e) =\u003e {\n                            debug!(\"Failed to resolve result for function '{}': {:?}\", name, e);\n                        }\n                    }\n                }\n                Err(e) =\u003e {\n                    debug!(\"Failed to call function '{}': {:?}\", name, e);\n                }\n            }\n        }\n        \n        Err(RytError::CipherError(\"No decipher function found or callable\".to_string()))\n    }\n    \n    /// Extract and execute only the decipher function from player.js\n    async fn extract_and_execute_decipher_function(\u0026self, signature: \u0026str, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        // Try to find and extract the decipher function using a simpler approach\n        // Look for the function that contains signature manipulation patterns\n        let function_name = self.find_decipher_function_name(player_js)?;\n        debug!(\"Found decipher function name: {}\", function_name);\n        \n        // Create JavaScript runtime\n        let mut runtime = JsRuntime::new(RuntimeOptions::default());\n        \n        // Try to create a minimal working environment\n        // First, try to find the transform object and create a minimal version\n        if let Ok(minimal_js) = self.create_minimal_decipher_js(player_js, \u0026function_name) {\n            debug!(\"Created minimal decipher JS ({} chars)\", minimal_js.len());\n            \n            // Execute the minimal JS\n            let js_fast = FastString::from(minimal_js);\n            if let Ok(_) = runtime.execute_script(\"\u003cminimal\u003e\", js_fast) {\n                // Try to call the function\n                let call_code = format!(\"{}(\\\"{}\\\")\", function_name, signature);\n                let call_fast = FastString::from(call_code);\n                \n                if let Ok(result) = runtime.execute_script(\"\u003ccall\u003e\", call_fast) {\n                    // Convert result to string\n                    if let Ok(result_value) = runtime.resolve(result).await {\n                        let scope = \u0026mut runtime.handle_scope();\n                        let local_value = result_value.open(scope);\n                        let result_str = local_value.to_rust_string_lossy(scope);\n                        debug!(\"Minimal JS execution successful: {}\", result_str);\n                        return Ok(result_str);\n                    }\n                }\n            }\n        }\n        \n        // Fallback: try to extract the function and its dependencies\n        let (extracted_name, function_code, dependencies) = self.extract_decipher_function_with_deps(player_js)?;\n        debug!(\"Extracted function: {} with {} dependencies\", extracted_name, dependencies.len());\n        \n        // Create a minimal JS environment with the function and its dependencies\n        let mut js_code = String::new();\n        \n        // Add dependencies first\n        for dep in dependencies {\n            js_code.push_str(\u0026dep);\n            js_code.push_str(\";\\n\");\n        }\n        \n        // Add the function\n        js_code.push_str(\u0026function_code);\n        js_code.push_str(\";\\n\");\n        \n        // Execute the JS\n        let js_fast = FastString::from(js_code);\n        runtime.execute_script(\"\u003cextracted\u003e\", js_fast)\n            .map_err(|e| RytError::CipherError(format!(\"Extracted function execution error: {:?}\", e)))?;\n        \n        // Call the function with the signature\n        let call_code = format!(\"{}(\\\"{}\\\")\", extracted_name, signature);\n        let call_fast = FastString::from(call_code);\n        let result = runtime.execute_script(\"\u003ccall\u003e\", call_fast)\n            .map_err(|e| RytError::CipherError(format!(\"Function call error: {:?}\", e)))?;\n        \n        // Convert result to string\n        let result_value = runtime.resolve(result).await\n            .map_err(|e| RytError::CipherError(format!(\"Result resolution error: {:?}\", e)))?;\n        \n        let scope = \u0026mut runtime.handle_scope();\n        let local_value = result_value.open(scope);\n        let result_str = local_value.to_rust_string_lossy(scope);\n        Ok(result_str)\n    }\n    \n    /// Create minimal JavaScript environment for decipher function (ported from Go ytdlp tryMiniJSDecipher)\n    fn create_minimal_decipher_js(\u0026self, player_js: \u0026str, function_name: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Creating minimal JS environment for function: {}\", function_name);\n        \n        // Step 1: Locate decipher function (name, param, body)\n        // First, try to find functions that contain the split/join pattern\n        // Use the same pattern as Go ytdlp: allow anonymous functions\n        let split_join_regex = Regex::new(r#\"function\\s*([a-zA-Z0-9$]*)?\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{([\\s\\S]*?)\\}\"#)?;\n        let mut param = String::new();\n        let mut body = String::new();\n        let mut found_function_name = String::new();\n        \n        for captures in split_join_regex.captures_iter(player_js) {\n            if let (Some(p), Some(b)) = (captures.get(2), captures.get(3)) {\n                let fn_name_str = captures.get(1).map(|m| m.as_str()).unwrap_or(\"anonymous\");\n                let param_str = p.as_str();\n                let body_str = b.as_str();\n                \n                debug!(\"Checking function '{}' with param: {}, body length: {}\", fn_name_str, param_str, body_str.len());\n                \n                // Check if this looks like a decipher function\n                if body_str.contains(\u0026format!(\"{}.split(\\\"\\\")\", param_str)) \u0026\u0026 \n                   body_str.contains(\u0026format!(\"return {}.join(\\\"\\\")\", param_str)) {\n                    found_function_name = fn_name_str.to_string();\n                    param = param_str.to_string();\n                    body = body_str.to_string();\n                    debug!(\"Found decipher function '{}' with param: {}\", found_function_name, param);\n                    debug!(\"Function body sample: {}\", \u0026body_str[..std::cmp::min(300, body_str.len())]);\n                    break;\n                }\n            }\n        }\n        \n        // If no function found with the expected name, use the provided function_name\n        let final_function_name = if found_function_name.is_empty() {\n            debug!(\"No function found with split/join pattern, using provided name: {}\", function_name);\n            \n            // Try to find the function by name\n            let fn_by_name_regex = Regex::new(\u0026format!(r#\"function\\s+{}\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{{([\\s\\S]*?)\\}}\"#, regex::escape(function_name)))?;\n            if let Some(captures) = fn_by_name_regex.captures(player_js) {\n                if let (Some(p), Some(b)) = (captures.get(1), captures.get(2)) {\n                    param = p.as_str().to_string();\n                    body = b.as_str().to_string();\n                    debug!(\"Found function '{}' by name with param: {}\", function_name, param);\n                }\n            }\n            \n            function_name.to_string()\n        } else {\n            found_function_name\n        };\n        \n        if param.is_empty() || body.is_empty() {\n            return Err(RytError::CipherError(format!(\"Could not find decipher function '{}' or extract its body\", final_function_name)));\n        }\n        \n        // Step 2: Find object name from callsites\n        debug!(\"Searching for object name in function body (param: {}, body length: {})\", param, body.len());\n        debug!(\"Function body: {}\", \u0026body[..std::cmp::min(200, body.len())]);\n        let obj_name_regex = Regex::new(\u0026format!(r#\"([a-zA-Z0-9$]+)\\.[a-zA-Z0-9$]+\\({}(?:,\\s*\\d+)?\\)\"#, regex::escape(\u0026param)))?;\n        let obj_name = if let Some(captures) = obj_name_regex.captures(\u0026body) {\n            captures.get(1).map(|m| m.as_str().to_string())\n                .ok_or_else(|| RytError::CipherError(\"Could not find object name\".to_string()))?\n        } else {\n            debug!(\"Could not find object name in function body\");\n            return Err(RytError::CipherError(\"Could not find object name in function body\".to_string()));\n        };\n        \n        debug!(\"Found transform object name: {}\", obj_name);\n        \n        // Step 3: Extract transform object literal\n        let obj_regex = Regex::new(\u0026format!(r#\"(?:var|let|const)\\s+{}\\s*=\\s*\\{{([\\s\\S]*?)\\}}\\s*;?\"#, regex::escape(\u0026obj_name)))?;\n        let obj_body = if let Some(captures) = obj_regex.captures(player_js) {\n            captures.get(1).map(|m| m.as_str().to_string())\n                .ok_or_else(|| RytError::CipherError(\"Could not extract object body\".to_string()))?\n        } else {\n            return Err(RytError::CipherError(\"Could not find transform object\".to_string()));\n        };\n        \n        debug!(\"Extracted transform object body ({} chars)\", obj_body.len());\n        \n        // Step 4: Extract ordered calls and optional numeric arguments\n        let call_regex = Regex::new(\u0026format!(r#\"{}\\.([a-zA-Z0-9$]+)\\({}(?:,\\s*(\\d+))?\\)\"#, regex::escape(\u0026obj_name), regex::escape(\u0026param)))?;\n        let mut calls = Vec::new();\n        \n        for captures in call_regex.captures_iter(\u0026body) {\n            if let (Some(fn_name), Some(arg)) = (captures.get(1), captures.get(2)) {\n                let fn_name_str = fn_name.as_str();\n                let arg_str = arg.as_str();\n                calls.push((fn_name_str.to_string(), arg_str.to_string()));\n                debug!(\"Found call: {}.{}({}, {})\", obj_name, fn_name_str, param, arg_str);\n            } else if let Some(fn_name) = captures.get(1) {\n                let fn_name_str = fn_name.as_str();\n                calls.push((fn_name_str.to_string(), \"\".to_string()));\n                debug!(\"Found call: {}.{}({})\", obj_name, fn_name_str, param);\n            }\n        }\n        \n        if calls.is_empty() {\n            return Err(RytError::CipherError(\"No transform calls found\".to_string()));\n        }\n        \n        // Step 5: Assemble a minimal JS code snippet\n        let mut js_code = String::new();\n        \n        // Add transform object\n        js_code.push_str(\u0026format!(\"var {} = {{\\n\", obj_name));\n        js_code.push_str(\u0026obj_body);\n        js_code.push_str(\"};\\n\");\n        \n        // Add decipher function\n        js_code.push_str(\u0026format!(\"function {}({}) {{\\n\", final_function_name, param));\n        js_code.push_str(\u0026format!(\"{} = {}.split(\\\"\\\");\\n\", param, param));\n        \n        // Add transform calls\n        for (fn_name, arg) in \u0026calls {\n            if arg.is_empty() {\n                js_code.push_str(\u0026format!(\"{}.{}({});\\n\", obj_name, fn_name, param));\n            } else {\n                js_code.push_str(\u0026format!(\"{}.{}({}, {});\\n\", obj_name, fn_name, param, arg));\n            }\n        }\n        \n        js_code.push_str(\u0026format!(\"return {}.join(\\\"\\\");\\n\", param));\n        js_code.push_str(\"}\\n\");\n        \n        debug!(\"Created minimal JS code ({} chars) with {} transform calls\", js_code.len(), calls.len());\n        Ok(js_code)\n    }\n    \n    /// Extract the decipher function and its dependencies from player.js\n    fn extract_decipher_function_with_deps(\u0026self, player_js: \u0026str) -\u003e Result\u003c(String, String, Vec\u003cString\u003e), RytError\u003e {\n        // Find the decipher function name\n        let function_name = self.find_decipher_function_name(player_js)?;\n        debug!(\"Extracting function: {}\", function_name);\n        \n        // Try multiple patterns to extract the function definition\n        let function_patterns = vec![\n            // Pattern 1: function name(...) { ... } (with proper brace matching)\n            format!(r#\"(function\\s+{}\\s*\\([^)]*\\)\\s*\\{{[^{{}}]*(?:\\{{[^{{}}]*\\}}[^{{}}]*)*\\}})\"#, regex::escape(\u0026function_name)),\n            // Pattern 2: var name = function(...) { ... } (with proper brace matching)\n            format!(r#\"(var\\s+{}\\s*=\\s*function\\s*\\([^)]*\\)\\s*\\{{[^{{}}]*(?:\\{{[^{{}}]*\\}}[^{{}}]*)*\\}})\"#, regex::escape(\u0026function_name)),\n            // Pattern 3: let name = function(...) { ... } (with proper brace matching)\n            format!(r#\"(let\\s+{}\\s*=\\s*function\\s*\\([^)]*\\)\\s*\\{{[^{{}}]*(?:\\{{[^{{}}]*\\}}[^{{}}]*)*\\}})\"#, regex::escape(\u0026function_name)),\n            // Pattern 4: const name = function(...) { ... } (with proper brace matching)\n            format!(r#\"(const\\s+{}\\s*=\\s*function\\s*\\([^)]*\\)\\s*\\{{[^{{}}]*(?:\\{{[^{{}}]*\\}}[^{{}}]*)*\\}})\"#, regex::escape(\u0026function_name)),\n            // Pattern 5: name = function(...) { ... } (with proper brace matching)\n            format!(r#\"({}\\s*=\\s*function\\s*\\([^)]*\\)\\s*\\{{[^{{}}]*(?:\\{{[^{{}}]*\\}}[^{{}}]*)*\\}})\"#, regex::escape(\u0026function_name)),\n        ];\n        \n        let mut function_code = None;\n        for (i, pattern) in function_patterns.iter().enumerate() {\n            debug!(\"Trying function extraction pattern {}: {}\", i + 1, pattern);\n            if let Ok(regex) = Regex::new(pattern) {\n                if let Some(captures) = regex.captures(player_js) {\n                    if let Some(matched) = captures.get(1) {\n                        function_code = Some(matched.as_str().to_string());\n                        debug!(\"Found function with pattern {}: {} chars\", i + 1, matched.as_str().len());\n                        break;\n                    }\n                }\n            }\n        }\n        \n        let function_code = function_code.ok_or_else(|| RytError::CipherError(\"Could not find function definition\".to_string()))?;\n        \n        // Extract dependencies (variables and functions used by the decipher function)\n        let mut dependencies = Vec::new();\n        \n        // Look for variable assignments that might be used by the function\n        let var_patterns = vec![\n            r#\"var\\s+([a-zA-Z0-9$]+)\\s*=\\s*\\{[^}]*\\}\"#,\n            r#\"let\\s+([a-zA-Z0-9$]+)\\s*=\\s*\\{[^}]*\\}\"#,\n            r#\"const\\s+([a-zA-Z0-9$]+)\\s*=\\s*\\{[^}]*\\}\"#,\n        ];\n        \n        for pattern in var_patterns {\n            if let Ok(regex) = Regex::new(pattern) {\n                for captures in regex.captures_iter(player_js) {\n                    if let Some(matched) = captures.get(0) {\n                        dependencies.push(matched.as_str().to_string());\n                    }\n                }\n            }\n        }\n        \n        debug!(\"Extracted function '{}' with {} dependencies\", function_name, dependencies.len());\n        Ok((function_name, function_code, dependencies))\n    }\n    \n    /// Find the actual decipher function name in player.js\n    fn find_decipher_function_name(\u0026self, player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        debug!(\"Searching for decipher function in player.js ({} chars)\", player_js.len());\n        \n        // Look for function definitions that might be decipher functions\n        let function_patterns = vec![\n            // Pattern 1: function name(a) { ... a.split(\"\") ... return a.join(\"\") ... }\n            r#\"function\\s+([a-zA-Z0-9$]+)\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{[^}]*\\1\\.split\\(\"\"\\)[^}]*return\\s+\\1\\.join\\(\"\"\\)\"#,\n            // Pattern 2: var name = function(a) { ... a.split(\"\") ... return a.join(\"\") ... }\n            r#\"var\\s+([a-zA-Z0-9$]+)\\s*=\\s*function\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{[^}]*\\2\\.split\\(\"\"\\)[^}]*return\\s+\\2\\.join\\(\"\"\\)\"#,\n            // Pattern 3: let name = function(a) { ... a.split(\"\") ... return a.join(\"\") ... }\n            r#\"let\\s+([a-zA-Z0-9$]+)\\s*=\\s*function\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{[^}]*\\2\\.split\\(\"\"\\)[^}]*return\\s+\\2\\.join\\(\"\"\\)\"#,\n            // Pattern 4: const name = function(a) { ... a.split(\"\") ... return a.join(\"\") ... }\n            r#\"const\\s+([a-zA-Z0-9$]+)\\s*=\\s*function\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{[^}]*\\2\\.split\\(\"\"\\)[^}]*return\\s+\\2\\.join\\(\"\"\\)\"#,\n        ];\n        \n        for (i, pattern) in function_patterns.iter().enumerate() {\n            debug!(\"Trying pattern {}: {}\", i + 1, pattern);\n            if let Ok(regex) = Regex::new(pattern) {\n                if let Some(captures) = regex.captures(player_js) {\n                    if let Some(function_name) = captures.get(1) {\n                        debug!(\"Found function with pattern {}: {}\", i + 1, function_name.as_str());\n                        return Ok(function_name.as_str().to_string());\n                    }\n                }\n            }\n        }\n        \n        // Look for functions that contain signature-related operations\n        let signature_patterns = vec![\n            r#\"function\\s+([a-zA-Z0-9$]+)\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{[^}]*\\.split\\(\"\"\\)[^}]*\\.join\\(\"\"\\)\"#,\n            r#\"var\\s+([a-zA-Z0-9$]+)\\s*=\\s*function\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{[^}]*\\.split\\(\"\"\\)[^}]*\\.join\\(\"\"\\)\"#,\n            r#\"let\\s+([a-zA-Z0-9$]+)\\s*=\\s*function\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{[^}]*\\.split\\(\"\"\\)[^}]*\\.join\\(\"\"\\)\"#,\n            r#\"const\\s+([a-zA-Z0-9$]+)\\s*=\\s*function\\s*\\(\\s*([a-zA-Z0-9$]+)\\s*\\)\\s*\\{[^}]*\\.split\\(\"\"\\)[^}]*\\.join\\(\"\"\\)\"#,\n        ];\n        \n        for (i, pattern) in signature_patterns.iter().enumerate() {\n            debug!(\"Trying signature pattern {}: {}\", i + 1, pattern);\n            if let Ok(regex) = Regex::new(pattern) {\n                if let Some(captures) = regex.captures(player_js) {\n                    if let Some(function_name) = captures.get(1) {\n                        debug!(\"Found signature function with pattern {}: {}\", i + 1, function_name.as_str());\n                        return Ok(function_name.as_str().to_string());\n                    }\n                }\n            }\n        }\n        \n        // Fallback: look for common decipher function names\n        let common_names = vec![\"decipher\", \"decode\", \"transform\", \"process\", \"signature\", \"sig\"];\n        for name in common_names {\n            if player_js.contains(\u0026format!(\"function {}\", name)) || \n               player_js.contains(\u0026format!(\"var {} =\", name)) ||\n               player_js.contains(\u0026format!(\"let {} =\", name)) ||\n               player_js.contains(\u0026format!(\"const {} =\", name)) {\n                debug!(\"Found common function name: {}\", name);\n                return Ok(name.to_string());\n            }\n        }\n        \n        // Look for any function that might be a decipher function\n        let any_function_pattern = r#\"function\\s+([a-zA-Z0-9$]+)\\s*\\(\\s*[a-zA-Z0-9$]+\\s*\\)\"#;\n        if let Ok(regex) = Regex::new(any_function_pattern) {\n            if let Some(captures) = regex.captures(player_js) {\n                if let Some(function_name) = captures.get(1) {\n                    debug!(\"Found any function: {}\", function_name.as_str());\n                    return Ok(function_name.as_str().to_string());\n                }\n            }\n        }\n        \n        debug!(\"No decipher function found, using default\");\n        // Default fallback\n        Ok(\"decipher\".to_string())\n    }\n    \n    \n    /// Sanitize player.js by removing problematic RegExp patterns (ported from Go ytdlp)\n    fn sanitize_player_js(\u0026self, player_js: \u0026str) -\u003e String {\n        let mut sanitized = player_js.to_string();\n        \n        // Remove problematic RegExp patterns that cause deno_core to fail\n        // These patterns include lookaheads, negative lookaheads, and other modern RegExp features\n        \n        // Replace lookahead patterns (?=...)\n        let lookahead_re = Regex::new(r#\"\\?=[^)]*\\)\"#).unwrap();\n        sanitized = lookahead_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Replace negative lookahead patterns (?!...)\n        let neg_lookahead_re = Regex::new(r#\"\\?![^)]*\\)\"#).unwrap();\n        sanitized = neg_lookahead_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Replace lookbehind patterns (?\u003c=...)\n        let lookbehind_re = Regex::new(r#\"\\?\u003c=[^)]*\\)\"#).unwrap();\n        sanitized = lookbehind_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Replace negative lookbehind patterns (?\u003c!...)\n        let neg_lookbehind_re = Regex::new(r#\"\\?\u003c![^)]*\\)\"#).unwrap();\n        sanitized = neg_lookbehind_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Replace named capture groups (?\u003cname\u003e...)\n        let named_capture_re = Regex::new(r#\"\\?\u003c[^\u003e]*\u003e\"#).unwrap();\n        sanitized = named_capture_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Replace atomic groups (?\u003e...)\n        let atomic_group_re = Regex::new(r#\"\\?\u003e[^)]*\\)\"#).unwrap();\n        sanitized = atomic_group_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Clean up any remaining problematic patterns\n        let question_re = Regex::new(r#\"\\?[^)]*\\)\"#).unwrap();\n        sanitized = question_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Clean up any empty parentheses that might be left\n        let empty_parens_re = Regex::new(r#\"\\(\\s*\\)\"#).unwrap();\n        sanitized = empty_parens_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Clean up any remaining single parentheses\n        let single_paren_re = Regex::new(r#\"\\(\\s*;\"#).unwrap();\n        sanitized = single_paren_re.replace_all(\u0026sanitized, \";\").to_string();\n        \n        // Clean up any remaining single parentheses at end of lines\n        let single_paren_end_re = Regex::new(r#\"\\(\\s*$\"#).unwrap();\n        sanitized = single_paren_end_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Remove document references that cause \"document is not defined\" errors\n        let document_re = Regex::new(r#\"document\\.[a-zA-Z0-9_]+\"#).unwrap();\n        sanitized = document_re.replace_all(\u0026sanitized, \"null\").to_string();\n        \n        // Remove window references\n        let window_re = Regex::new(r#\"window\\.[a-zA-Z0-9_]+\"#).unwrap();\n        sanitized = window_re.replace_all(\u0026sanitized, \"null\").to_string();\n        \n        // Remove navigator references\n        let navigator_re = Regex::new(r#\"navigator\\.[a-zA-Z0-9_]+\"#).unwrap();\n        sanitized = navigator_re.replace_all(\u0026sanitized, \"null\").to_string();\n        \n        // Remove location references\n        let location_re = Regex::new(r#\"location\\.[a-zA-Z0-9_]+\"#).unwrap();\n        sanitized = location_re.replace_all(\u0026sanitized, \"null\").to_string();\n        \n        // Remove console references\n        let console_re = Regex::new(r#\"console\\.[a-zA-Z0-9_]+\"#).unwrap();\n        sanitized = console_re.replace_all(\u0026sanitized, \"null\").to_string();\n        \n        // Remove eval() calls\n        let eval_re = Regex::new(r#\"eval\\s*\\(\"#).unwrap();\n        sanitized = eval_re.replace_all(\u0026sanitized, \"null(\").to_string();\n        \n        // Remove Function() constructor calls\n        let function_re = Regex::new(r#\"new\\s+Function\\s*\\(\"#).unwrap();\n        sanitized = function_re.replace_all(\u0026sanitized, \"null(\").to_string();\n        \n        // Remove problematic Unicode escape sequences that cause syntax errors\n        let unicode_escape_re = Regex::new(r#\"\\\\u[0-9a-fA-F]{4}\"#).unwrap();\n        sanitized = unicode_escape_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Remove problematic octal escape sequences\n        let octal_escape_re = Regex::new(r#\"\\\\([0-7]{1,3})\"#).unwrap();\n        sanitized = octal_escape_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Remove problematic hex escape sequences\n        let hex_escape_re = Regex::new(r#\"\\\\x[0-9a-fA-F]{2}\"#).unwrap();\n        sanitized = hex_escape_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Remove problematic template literals that might cause issues\n        let template_literal_re = Regex::new(r#\"`[^`]*`\"#).unwrap();\n        sanitized = template_literal_re.replace_all(\u0026sanitized, \"\\\"\\\"\").to_string();\n        \n        // Remove problematic arrow functions that might cause parsing issues\n        let arrow_function_re = Regex::new(r#\"=\u003e\\s*\\{[^}]*\\}\"#).unwrap();\n        sanitized = arrow_function_re.replace_all(\u0026sanitized, \"=\u003e {}\").to_string();\n        \n        // Remove problematic destructuring assignments\n        let destructuring_re = Regex::new(r#\"\\{[^}]*\\}\\s*=\"#).unwrap();\n        sanitized = destructuring_re.replace_all(\u0026sanitized, \"obj =\").to_string();\n        \n        // Remove problematic spread operators\n        let spread_re = Regex::new(r#\"\\.\\.\\.[a-zA-Z0-9_$]+\"#).unwrap();\n        sanitized = spread_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Remove problematic async/await keywords\n        let async_re = Regex::new(r#\"\\basync\\b\"#).unwrap();\n        sanitized = async_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        let await_re = Regex::new(r#\"\\bawait\\b\"#).unwrap();\n        sanitized = await_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Remove problematic class declarations\n        let class_re = Regex::new(r#\"\\bclass\\s+[a-zA-Z0-9_$]+\\s*\\{[^}]*\\}\"#).unwrap();\n        sanitized = class_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Remove problematic import/export statements\n        let import_re = Regex::new(r#\"\\bimport\\s+[^;]+;\"#).unwrap();\n        sanitized = import_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        let export_re = Regex::new(r#\"\\bexport\\s+[^;]+;\"#).unwrap();\n        sanitized = export_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Remove problematic const/let declarations that might cause issues\n        let const_re = Regex::new(r#\"\\bconst\\s+[^;]+;\"#).unwrap();\n        sanitized = const_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        let let_re = Regex::new(r#\"\\blet\\s+[^;]+;\"#).unwrap();\n        sanitized = let_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        // Clean up any remaining problematic characters\n        let problematic_chars_re = Regex::new(r#\"[^\\x20-\\x7E\\n\\r\\t]\"#).unwrap();\n        sanitized = problematic_chars_re.replace_all(\u0026sanitized, \"\").to_string();\n        \n        sanitized\n    }\n\n    /// Method 4: Pattern fallback\n    fn decipher_with_pattern_fallback(\u0026self, signature: \u0026str, _player_js: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n        // Simple fallback transformations\n        if signature.len() \u003e= 2 {\n            // Try common transformations\n            let reversed: String = signature.chars().rev().collect();\n            if reversed != signature {\n                return Ok(reversed);\n            }\n            \n            // Try swapping first and last characters\n            let mut chars: Vec\u003cchar\u003e = signature.chars().collect();\n            if chars.len() \u003e 1 {\n                let len = chars.len();\n                chars.swap(0, len - 1);\n                return Ok(chars.into_iter().collect());\n            }\n        }\n        \n        Err(RytError::CipherError(\"Pattern fallback failed\".to_string()))\n    }\n\n    /// Clear caches\n    pub fn clear_caches(\u0026self) {\n        self.cache.clear();\n        // Note: moka cache doesn't have a clear method in the version we're using\n        // We'll let it expire naturally\n    }\n}\n\nimpl Default for Cipher {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::sync::{Arc, atomic::AtomicU32};\n\n    #[test]\n    fn test_cipher_creation() {\n        let _cipher = Cipher::new();\n        // Test that cipher can be created\n        assert!(true);\n    }\n\n    #[test]\n    #[ignore] // This test uses oversimplified player_js that doesn't match real YouTube patterns\n    fn test_decipher_with_regex_reverse() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        let player_js = \"function test() { return signature.reverse(); }\";\n        \n        let result = cipher.decipher_with_regex(signature, player_js);\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), \"321cba\");\n    }\n\n    #[test]\n    fn test_decipher_with_pattern_fallback() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        \n        let result = cipher.decipher_with_pattern_fallback(signature, \"\");\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), \"321cba\");\n    }\n\n    #[test]\n    fn test_decipher_with_pattern_fallback_swap() {\n        let cipher = Cipher::new();\n        let signature = \"ab\";\n        \n        let result = cipher.decipher_with_pattern_fallback(signature, \"\");\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), \"ba\");\n    }\n\n    #[test]\n    fn test_try_common_patterns_reverse() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        let body = \"a.reverse();\";\n        \n        let result = cipher.try_common_patterns(signature, body);\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), \"321cba\");\n    }\n\n    #[test]\n    #[ignore] // These patterns require more complex implementation\n    fn test_try_common_patterns_splice() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        let body = \"a.splice(0, 1);\";\n        \n        let result = cipher.try_common_patterns(signature, body);\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), \"bc123\");\n    }\n\n    #[test]\n    #[ignore] // These patterns require more complex implementation\n    fn test_try_common_patterns_slice() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        let body = \"a.slice(1);\";\n        \n        let result = cipher.try_common_patterns(signature, body);\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), \"bc123\");\n    }\n\n    #[test]\n    #[ignore] // These patterns require more complex implementation\n    fn test_try_common_patterns_swap() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        let body = \"var b=a[0];a[0]=a[2];a[2]=b;\";\n        \n        let result = cipher.try_common_patterns(signature, body);\n        assert!(result.is_ok());\n        assert_eq!(result.unwrap(), \"cba123\");\n    }\n\n    #[test]\n    fn test_try_common_patterns_empty() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        let body = \"\";\n        \n        let result = cipher.try_common_patterns(signature, body);\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn test_try_common_patterns_unknown() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        let body = \"a.unknown();\";\n        \n        let result = cipher.try_common_patterns(signature, body);\n        assert!(result.is_err());\n    }\n\n    #[test]\n    fn test_try_simple_fallback() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        \n        let result = cipher.try_simple_fallback(signature);\n        assert!(result.is_ok());\n        // Simple fallback should return some transformation of the signature\n        let result_str = result.unwrap();\n        assert_ne!(result_str, signature); // Should be different from original\n        // Note: some transformations may change length, so we don't check length\n    }\n\n    #[test]\n    #[ignore] // These approaches require more complex player_js patterns\n    fn test_try_approach_1_success() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        let player_js = r#\"\n            function test_func(a) {\n                a.split(\"\");\n                return a.join(\"\");\n            }\n        \"#;\n        \n        let result = cipher.try_approach_1(signature, player_js);\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    fn test_try_approach_1_failure() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        let player_js = \"function test() { return 'hello'; }\";\n        \n        let result = cipher.try_approach_1(signature, player_js);\n        assert!(result.is_err());\n    }\n\n    #[test]\n    #[ignore] // These approaches require more complex player_js patterns\n    fn test_try_approach_2_success() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        let player_js = r#\"\n            var test_func = function(a) {\n                a.split(\"\");\n                return a.join(\"\");\n            }\n        \"#;\n        \n        let result = cipher.try_approach_2(signature, player_js);\n        assert!(result.is_ok());\n    }\n\n    #[test]\n    #[ignore] // These approaches require more complex player_js patterns\n    fn test_try_approach_3_success() {\n        let cipher = Cipher::new();\n        let signature = \"abc123\";\n        let player_js = r#\"\n            function test_func(a) {\n                a.reverse();\n                return a;\n            }\n        \"#;\n        \n        let result = cipher.try_approach_3(signature, player_js);\n        assert!(result.is_ok());\n    }\n}\n","traces":[{"line":28,"address":[],"length":0,"stats":{"Line":3}},{"line":30,"address":[],"length":0,"stats":{"Line":9}},{"line":31,"address":[],"length":0,"stats":{"Line":12}},{"line":32,"address":[],"length":0,"stats":{"Line":3}},{"line":33,"address":[],"length":0,"stats":{"Line":3}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":39,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":96,"address":[],"length":0,"stats":{"Line":0}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":111,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":148,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":158,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":173,"address":[],"length":0,"stats":{"Line":0}},{"line":174,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[],"length":0,"stats":{"Line":0}},{"line":194,"address":[],"length":0,"stats":{"Line":0}},{"line":195,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":211,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":242,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":273,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":281,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":300,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":302,"address":[],"length":0,"stats":{"Line":0}},{"line":303,"address":[],"length":0,"stats":{"Line":0}},{"line":306,"address":[],"length":0,"stats":{"Line":0}},{"line":307,"address":[],"length":0,"stats":{"Line":0}},{"line":308,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":315,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":321,"address":[],"length":0,"stats":{"Line":0}},{"line":322,"address":[],"length":0,"stats":{"Line":0}},{"line":323,"address":[],"length":0,"stats":{"Line":0}},{"line":324,"address":[],"length":0,"stats":{"Line":0}},{"line":326,"address":[],"length":0,"stats":{"Line":0}},{"line":330,"address":[],"length":0,"stats":{"Line":0}},{"line":331,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":336,"address":[],"length":0,"stats":{"Line":0}},{"line":340,"address":[],"length":0,"stats":{"Line":0}},{"line":341,"address":[],"length":0,"stats":{"Line":0}},{"line":343,"address":[],"length":0,"stats":{"Line":0}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":348,"address":[],"length":0,"stats":{"Line":0}},{"line":349,"address":[],"length":0,"stats":{"Line":0}},{"line":350,"address":[],"length":0,"stats":{"Line":0}},{"line":351,"address":[],"length":0,"stats":{"Line":0}},{"line":352,"address":[],"length":0,"stats":{"Line":0}},{"line":353,"address":[],"length":0,"stats":{"Line":0}},{"line":358,"address":[],"length":0,"stats":{"Line":0}},{"line":359,"address":[],"length":0,"stats":{"Line":0}},{"line":363,"address":[],"length":0,"stats":{"Line":0}},{"line":364,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":367,"address":[],"length":0,"stats":{"Line":0}},{"line":368,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":371,"address":[],"length":0,"stats":{"Line":0}},{"line":373,"address":[],"length":0,"stats":{"Line":0}},{"line":378,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":387,"address":[],"length":0,"stats":{"Line":0}},{"line":388,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":396,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":412,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":464,"address":[],"length":0,"stats":{"Line":0}},{"line":465,"address":[],"length":0,"stats":{"Line":0}},{"line":471,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":477,"address":[],"length":0,"stats":{"Line":0}},{"line":481,"address":[],"length":0,"stats":{"Line":0}},{"line":483,"address":[],"length":0,"stats":{"Line":0}},{"line":485,"address":[],"length":0,"stats":{"Line":0}},{"line":486,"address":[],"length":0,"stats":{"Line":0}},{"line":492,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":498,"address":[],"length":0,"stats":{"Line":0}},{"line":502,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":586,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":591,"address":[],"length":0,"stats":{"Line":0}},{"line":592,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":597,"address":[],"length":0,"stats":{"Line":0}},{"line":598,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":610,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":614,"address":[],"length":0,"stats":{"Line":0}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":616,"address":[],"length":0,"stats":{"Line":0}},{"line":617,"address":[],"length":0,"stats":{"Line":0}},{"line":618,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":621,"address":[],"length":0,"stats":{"Line":0}},{"line":631,"address":[],"length":0,"stats":{"Line":0}},{"line":632,"address":[],"length":0,"stats":{"Line":0}},{"line":633,"address":[],"length":0,"stats":{"Line":0}},{"line":637,"address":[],"length":0,"stats":{"Line":0}},{"line":638,"address":[],"length":0,"stats":{"Line":0}},{"line":639,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":641,"address":[],"length":0,"stats":{"Line":0}},{"line":642,"address":[],"length":0,"stats":{"Line":0}},{"line":649,"address":[],"length":0,"stats":{"Line":0}},{"line":653,"address":[],"length":0,"stats":{"Line":0}},{"line":654,"address":[],"length":0,"stats":{"Line":0}},{"line":657,"address":[],"length":0,"stats":{"Line":0}},{"line":659,"address":[],"length":0,"stats":{"Line":0}},{"line":662,"address":[],"length":0,"stats":{"Line":0}},{"line":663,"address":[],"length":0,"stats":{"Line":0}},{"line":664,"address":[],"length":0,"stats":{"Line":0}},{"line":665,"address":[],"length":0,"stats":{"Line":0}},{"line":667,"address":[],"length":0,"stats":{"Line":0}},{"line":671,"address":[],"length":0,"stats":{"Line":0}},{"line":672,"address":[],"length":0,"stats":{"Line":0}},{"line":673,"address":[],"length":0,"stats":{"Line":0}},{"line":674,"address":[],"length":0,"stats":{"Line":0}},{"line":676,"address":[],"length":0,"stats":{"Line":0}},{"line":677,"address":[],"length":0,"stats":{"Line":0}},{"line":681,"address":[],"length":0,"stats":{"Line":0}},{"line":682,"address":[],"length":0,"stats":{"Line":0}},{"line":683,"address":[],"length":0,"stats":{"Line":0}},{"line":684,"address":[],"length":0,"stats":{"Line":0}},{"line":685,"address":[],"length":0,"stats":{"Line":0}},{"line":687,"address":[],"length":0,"stats":{"Line":0}},{"line":691,"address":[],"length":0,"stats":{"Line":0}},{"line":692,"address":[],"length":0,"stats":{"Line":0}},{"line":693,"address":[],"length":0,"stats":{"Line":0}},{"line":695,"address":[],"length":0,"stats":{"Line":0}},{"line":700,"address":[],"length":0,"stats":{"Line":0}},{"line":701,"address":[],"length":0,"stats":{"Line":0}},{"line":702,"address":[],"length":0,"stats":{"Line":0}},{"line":704,"address":[],"length":0,"stats":{"Line":0}},{"line":709,"address":[],"length":0,"stats":{"Line":0}},{"line":710,"address":[],"length":0,"stats":{"Line":0}},{"line":711,"address":[],"length":0,"stats":{"Line":0}},{"line":712,"address":[],"length":0,"stats":{"Line":0}},{"line":714,"address":[],"length":0,"stats":{"Line":0}},{"line":715,"address":[],"length":0,"stats":{"Line":0}},{"line":719,"address":[],"length":0,"stats":{"Line":0}},{"line":720,"address":[],"length":0,"stats":{"Line":0}},{"line":721,"address":[],"length":0,"stats":{"Line":0}},{"line":723,"address":[],"length":0,"stats":{"Line":0}},{"line":728,"address":[],"length":0,"stats":{"Line":0}},{"line":729,"address":[],"length":0,"stats":{"Line":0}},{"line":730,"address":[],"length":0,"stats":{"Line":0}},{"line":732,"address":[],"length":0,"stats":{"Line":0}},{"line":737,"address":[],"length":0,"stats":{"Line":0}},{"line":738,"address":[],"length":0,"stats":{"Line":0}},{"line":739,"address":[],"length":0,"stats":{"Line":0}},{"line":740,"address":[],"length":0,"stats":{"Line":0}},{"line":741,"address":[],"length":0,"stats":{"Line":0}},{"line":743,"address":[],"length":0,"stats":{"Line":0}},{"line":747,"address":[],"length":0,"stats":{"Line":0}},{"line":748,"address":[],"length":0,"stats":{"Line":0}},{"line":749,"address":[],"length":0,"stats":{"Line":0}},{"line":750,"address":[],"length":0,"stats":{"Line":0}},{"line":752,"address":[],"length":0,"stats":{"Line":0}},{"line":753,"address":[],"length":0,"stats":{"Line":0}},{"line":757,"address":[],"length":0,"stats":{"Line":0}},{"line":758,"address":[],"length":0,"stats":{"Line":0}},{"line":759,"address":[],"length":0,"stats":{"Line":0}},{"line":760,"address":[],"length":0,"stats":{"Line":0}},{"line":762,"address":[],"length":0,"stats":{"Line":0}},{"line":763,"address":[],"length":0,"stats":{"Line":0}},{"line":767,"address":[],"length":0,"stats":{"Line":0}},{"line":768,"address":[],"length":0,"stats":{"Line":0}},{"line":769,"address":[],"length":0,"stats":{"Line":0}},{"line":770,"address":[],"length":0,"stats":{"Line":0}},{"line":772,"address":[],"length":0,"stats":{"Line":0}},{"line":773,"address":[],"length":0,"stats":{"Line":0}},{"line":777,"address":[],"length":0,"stats":{"Line":0}},{"line":778,"address":[],"length":0,"stats":{"Line":0}},{"line":779,"address":[],"length":0,"stats":{"Line":0}},{"line":780,"address":[],"length":0,"stats":{"Line":0}},{"line":782,"address":[],"length":0,"stats":{"Line":0}},{"line":783,"address":[],"length":0,"stats":{"Line":0}},{"line":787,"address":[],"length":0,"stats":{"Line":0}},{"line":788,"address":[],"length":0,"stats":{"Line":0}},{"line":789,"address":[],"length":0,"stats":{"Line":0}},{"line":790,"address":[],"length":0,"stats":{"Line":0}},{"line":792,"address":[],"length":0,"stats":{"Line":0}},{"line":793,"address":[],"length":0,"stats":{"Line":0}},{"line":798,"address":[],"length":0,"stats":{"Line":0}},{"line":799,"address":[],"length":0,"stats":{"Line":0}},{"line":800,"address":[],"length":0,"stats":{"Line":0}},{"line":802,"address":[],"length":0,"stats":{"Line":0}},{"line":803,"address":[],"length":0,"stats":{"Line":0}},{"line":805,"address":[],"length":0,"stats":{"Line":0}},{"line":806,"address":[],"length":0,"stats":{"Line":0}},{"line":811,"address":[],"length":0,"stats":{"Line":0}},{"line":817,"address":[],"length":0,"stats":{"Line":0}},{"line":818,"address":[],"length":0,"stats":{"Line":0}},{"line":821,"address":[],"length":0,"stats":{"Line":0}},{"line":822,"address":[],"length":0,"stats":{"Line":0}},{"line":823,"address":[],"length":0,"stats":{"Line":0}},{"line":824,"address":[],"length":0,"stats":{"Line":0}},{"line":826,"address":[],"length":0,"stats":{"Line":0}},{"line":827,"address":[],"length":0,"stats":{"Line":0}},{"line":832,"address":[],"length":0,"stats":{"Line":0}},{"line":833,"address":[],"length":0,"stats":{"Line":0}},{"line":834,"address":[],"length":0,"stats":{"Line":0}},{"line":835,"address":[],"length":0,"stats":{"Line":0}},{"line":837,"address":[],"length":0,"stats":{"Line":0}},{"line":838,"address":[],"length":0,"stats":{"Line":0}},{"line":843,"address":[],"length":0,"stats":{"Line":0}},{"line":844,"address":[],"length":0,"stats":{"Line":0}},{"line":845,"address":[],"length":0,"stats":{"Line":0}},{"line":846,"address":[],"length":0,"stats":{"Line":0}},{"line":847,"address":[],"length":0,"stats":{"Line":0}},{"line":849,"address":[],"length":0,"stats":{"Line":0}},{"line":850,"address":[],"length":0,"stats":{"Line":0}},{"line":855,"address":[],"length":0,"stats":{"Line":0}},{"line":856,"address":[],"length":0,"stats":{"Line":0}},{"line":857,"address":[],"length":0,"stats":{"Line":0}},{"line":858,"address":[],"length":0,"stats":{"Line":0}},{"line":860,"address":[],"length":0,"stats":{"Line":0}},{"line":861,"address":[],"length":0,"stats":{"Line":0}},{"line":866,"address":[],"length":0,"stats":{"Line":0}},{"line":867,"address":[],"length":0,"stats":{"Line":0}},{"line":870,"address":[],"length":0,"stats":{"Line":0}},{"line":871,"address":[],"length":0,"stats":{"Line":0}},{"line":872,"address":[],"length":0,"stats":{"Line":0}},{"line":876,"address":[],"length":0,"stats":{"Line":0}},{"line":877,"address":[],"length":0,"stats":{"Line":0}},{"line":878,"address":[],"length":0,"stats":{"Line":0}},{"line":879,"address":[],"length":0,"stats":{"Line":0}},{"line":880,"address":[],"length":0,"stats":{"Line":0}},{"line":884,"address":[],"length":0,"stats":{"Line":0}},{"line":888,"address":[],"length":0,"stats":{"Line":0}},{"line":889,"address":[],"length":0,"stats":{"Line":0}},{"line":892,"address":[],"length":0,"stats":{"Line":0}},{"line":901,"address":[],"length":0,"stats":{"Line":0}},{"line":902,"address":[],"length":0,"stats":{"Line":0}},{"line":904,"address":[],"length":0,"stats":{"Line":0}},{"line":905,"address":[],"length":0,"stats":{"Line":0}},{"line":906,"address":[],"length":0,"stats":{"Line":0}},{"line":909,"address":[],"length":0,"stats":{"Line":0}},{"line":910,"address":[],"length":0,"stats":{"Line":0}},{"line":911,"address":[],"length":0,"stats":{"Line":0}},{"line":916,"address":[],"length":0,"stats":{"Line":0}},{"line":917,"address":[],"length":0,"stats":{"Line":0}},{"line":918,"address":[],"length":0,"stats":{"Line":0}},{"line":922,"address":[],"length":0,"stats":{"Line":0}},{"line":923,"address":[],"length":0,"stats":{"Line":0}},{"line":926,"address":[],"length":0,"stats":{"Line":0}},{"line":929,"address":[],"length":0,"stats":{"Line":0}},{"line":930,"address":[],"length":0,"stats":{"Line":0}},{"line":933,"address":[],"length":0,"stats":{"Line":0}},{"line":934,"address":[],"length":0,"stats":{"Line":0}},{"line":935,"address":[],"length":0,"stats":{"Line":0}},{"line":943,"address":[],"length":0,"stats":{"Line":0}},{"line":944,"address":[],"length":0,"stats":{"Line":0}},{"line":945,"address":[],"length":0,"stats":{"Line":0}},{"line":946,"address":[],"length":0,"stats":{"Line":0}},{"line":950,"address":[],"length":0,"stats":{"Line":0}},{"line":951,"address":[],"length":0,"stats":{"Line":0}},{"line":952,"address":[],"length":0,"stats":{"Line":0}},{"line":953,"address":[],"length":0,"stats":{"Line":0}},{"line":956,"address":[],"length":0,"stats":{"Line":0}},{"line":960,"address":[],"length":0,"stats":{"Line":0}},{"line":962,"address":[],"length":0,"stats":{"Line":0}},{"line":963,"address":[],"length":0,"stats":{"Line":0}},{"line":964,"address":[],"length":0,"stats":{"Line":0}},{"line":965,"address":[],"length":0,"stats":{"Line":0}},{"line":966,"address":[],"length":0,"stats":{"Line":0}},{"line":967,"address":[],"length":0,"stats":{"Line":0}},{"line":971,"address":[],"length":0,"stats":{"Line":0}},{"line":972,"address":[],"length":0,"stats":{"Line":0}},{"line":973,"address":[],"length":0,"stats":{"Line":0}},{"line":974,"address":[],"length":0,"stats":{"Line":0}},{"line":978,"address":[],"length":0,"stats":{"Line":0}},{"line":982,"address":[],"length":0,"stats":{"Line":0}},{"line":983,"address":[],"length":0,"stats":{"Line":0}},{"line":986,"address":[],"length":0,"stats":{"Line":0}},{"line":987,"address":[],"length":0,"stats":{"Line":0}},{"line":989,"address":[],"length":0,"stats":{"Line":0}},{"line":990,"address":[],"length":0,"stats":{"Line":0}},{"line":991,"address":[],"length":0,"stats":{"Line":0}},{"line":992,"address":[],"length":0,"stats":{"Line":0}},{"line":993,"address":[],"length":0,"stats":{"Line":0}},{"line":994,"address":[],"length":0,"stats":{"Line":0}},{"line":995,"address":[],"length":0,"stats":{"Line":0}},{"line":996,"address":[],"length":0,"stats":{"Line":0}},{"line":997,"address":[],"length":0,"stats":{"Line":0}},{"line":998,"address":[],"length":0,"stats":{"Line":0}},{"line":999,"address":[],"length":0,"stats":{"Line":0}},{"line":1000,"address":[],"length":0,"stats":{"Line":0}},{"line":1004,"address":[],"length":0,"stats":{"Line":0}},{"line":1005,"address":[],"length":0,"stats":{"Line":0}},{"line":1009,"address":[],"length":0,"stats":{"Line":0}},{"line":1011,"address":[],"length":0,"stats":{"Line":0}},{"line":1012,"address":[],"length":0,"stats":{"Line":0}},{"line":1014,"address":[],"length":0,"stats":{"Line":0}},{"line":1015,"address":[],"length":0,"stats":{"Line":0}},{"line":1016,"address":[],"length":0,"stats":{"Line":0}},{"line":1018,"address":[],"length":0,"stats":{"Line":0}},{"line":1019,"address":[],"length":0,"stats":{"Line":0}},{"line":1020,"address":[],"length":0,"stats":{"Line":0}},{"line":1021,"address":[],"length":0,"stats":{"Line":0}},{"line":1022,"address":[],"length":0,"stats":{"Line":0}},{"line":1027,"address":[],"length":0,"stats":{"Line":0}},{"line":1028,"address":[],"length":0,"stats":{"Line":0}},{"line":1029,"address":[],"length":0,"stats":{"Line":0}},{"line":1030,"address":[],"length":0,"stats":{"Line":0}},{"line":1031,"address":[],"length":0,"stats":{"Line":0}},{"line":1036,"address":[],"length":0,"stats":{"Line":0}},{"line":1037,"address":[],"length":0,"stats":{"Line":0}},{"line":1038,"address":[],"length":0,"stats":{"Line":0}},{"line":1039,"address":[],"length":0,"stats":{"Line":0}},{"line":1040,"address":[],"length":0,"stats":{"Line":0}},{"line":1041,"address":[],"length":0,"stats":{"Line":0}},{"line":1047,"address":[],"length":0,"stats":{"Line":0}},{"line":1052,"address":[],"length":0,"stats":{"Line":0}},{"line":1056,"address":[],"length":0,"stats":{"Line":0}},{"line":1057,"address":[],"length":0,"stats":{"Line":0}},{"line":1060,"address":[],"length":0,"stats":{"Line":0}},{"line":1062,"address":[],"length":0,"stats":{"Line":0}},{"line":1063,"address":[],"length":0,"stats":{"Line":0}},{"line":1064,"address":[],"length":0,"stats":{"Line":0}},{"line":1065,"address":[],"length":0,"stats":{"Line":0}},{"line":1068,"address":[],"length":0,"stats":{"Line":0}},{"line":1069,"address":[],"length":0,"stats":{"Line":0}},{"line":1072,"address":[],"length":0,"stats":{"Line":0}},{"line":1073,"address":[],"length":0,"stats":{"Line":0}},{"line":1079,"address":[],"length":0,"stats":{"Line":0}},{"line":1083,"address":[],"length":0,"stats":{"Line":0}},{"line":1084,"address":[],"length":0,"stats":{"Line":0}},{"line":1086,"address":[],"length":0,"stats":{"Line":0}},{"line":1089,"address":[],"length":0,"stats":{"Line":0}},{"line":1090,"address":[],"length":0,"stats":{"Line":0}},{"line":1091,"address":[],"length":0,"stats":{"Line":0}},{"line":1093,"address":[],"length":0,"stats":{"Line":0}},{"line":1095,"address":[],"length":0,"stats":{"Line":0}},{"line":1096,"address":[],"length":0,"stats":{"Line":0}},{"line":1097,"address":[],"length":0,"stats":{"Line":0}},{"line":1098,"address":[],"length":0,"stats":{"Line":0}},{"line":1102,"address":[],"length":0,"stats":{"Line":0}},{"line":1103,"address":[],"length":0,"stats":{"Line":0}},{"line":1104,"address":[],"length":0,"stats":{"Line":0}},{"line":1105,"address":[],"length":0,"stats":{"Line":0}},{"line":1107,"address":[],"length":0,"stats":{"Line":0}},{"line":1109,"address":[],"length":0,"stats":{"Line":0}},{"line":1110,"address":[],"length":0,"stats":{"Line":0}},{"line":1111,"address":[],"length":0,"stats":{"Line":0}},{"line":1112,"address":[],"length":0,"stats":{"Line":0}},{"line":1116,"address":[],"length":0,"stats":{"Line":0}},{"line":1117,"address":[],"length":0,"stats":{"Line":0}},{"line":1118,"address":[],"length":0,"stats":{"Line":0}},{"line":1119,"address":[],"length":0,"stats":{"Line":0}},{"line":1121,"address":[],"length":0,"stats":{"Line":0}},{"line":1123,"address":[],"length":0,"stats":{"Line":0}},{"line":1124,"address":[],"length":0,"stats":{"Line":0}},{"line":1125,"address":[],"length":0,"stats":{"Line":0}},{"line":1126,"address":[],"length":0,"stats":{"Line":0}},{"line":1129,"address":[],"length":0,"stats":{"Line":0}},{"line":1133,"address":[],"length":0,"stats":{"Line":0}},{"line":1134,"address":[],"length":0,"stats":{"Line":0}},{"line":1137,"address":[],"length":0,"stats":{"Line":0}},{"line":1138,"address":[],"length":0,"stats":{"Line":0}},{"line":1139,"address":[],"length":0,"stats":{"Line":0}},{"line":1140,"address":[],"length":0,"stats":{"Line":0}},{"line":1144,"address":[],"length":0,"stats":{"Line":0}},{"line":1145,"address":[],"length":0,"stats":{"Line":0}},{"line":1146,"address":[],"length":0,"stats":{"Line":0}},{"line":1147,"address":[],"length":0,"stats":{"Line":0}},{"line":1151,"address":[],"length":0,"stats":{"Line":0}},{"line":1152,"address":[],"length":0,"stats":{"Line":0}},{"line":1153,"address":[],"length":0,"stats":{"Line":0}},{"line":1154,"address":[],"length":0,"stats":{"Line":0}},{"line":1158,"address":[],"length":0,"stats":{"Line":0}},{"line":1159,"address":[],"length":0,"stats":{"Line":0}},{"line":1160,"address":[],"length":0,"stats":{"Line":0}},{"line":1161,"address":[],"length":0,"stats":{"Line":0}},{"line":1162,"address":[],"length":0,"stats":{"Line":0}},{"line":1163,"address":[],"length":0,"stats":{"Line":0}},{"line":1164,"address":[],"length":0,"stats":{"Line":0}},{"line":1167,"address":[],"length":0,"stats":{"Line":0}},{"line":1171,"address":[],"length":0,"stats":{"Line":0}},{"line":1172,"address":[],"length":0,"stats":{"Line":0}},{"line":1175,"address":[],"length":0,"stats":{"Line":0}},{"line":1178,"address":[],"length":0,"stats":{"Line":0}},{"line":1179,"address":[],"length":0,"stats":{"Line":0}},{"line":1180,"address":[],"length":0,"stats":{"Line":0}},{"line":1184,"address":[],"length":0,"stats":{"Line":0}},{"line":1186,"address":[],"length":0,"stats":{"Line":0}},{"line":1187,"address":[],"length":0,"stats":{"Line":0}},{"line":1189,"address":[],"length":0,"stats":{"Line":0}},{"line":1190,"address":[],"length":0,"stats":{"Line":0}},{"line":1192,"address":[],"length":0,"stats":{"Line":0}},{"line":1193,"address":[],"length":0,"stats":{"Line":0}},{"line":1195,"address":[],"length":0,"stats":{"Line":0}},{"line":1196,"address":[],"length":0,"stats":{"Line":0}},{"line":1197,"address":[],"length":0,"stats":{"Line":0}},{"line":1198,"address":[],"length":0,"stats":{"Line":0}},{"line":1199,"address":[],"length":0,"stats":{"Line":0}},{"line":1200,"address":[],"length":0,"stats":{"Line":0}},{"line":1201,"address":[],"length":0,"stats":{"Line":0}},{"line":1202,"address":[],"length":0,"stats":{"Line":0}},{"line":1204,"address":[],"length":0,"stats":{"Line":0}},{"line":1205,"address":[],"length":0,"stats":{"Line":0}},{"line":1209,"address":[],"length":0,"stats":{"Line":0}},{"line":1210,"address":[],"length":0,"stats":{"Line":0}},{"line":1215,"address":[],"length":0,"stats":{"Line":0}},{"line":1219,"address":[],"length":0,"stats":{"Line":0}},{"line":1222,"address":[],"length":0,"stats":{"Line":0}},{"line":1223,"address":[],"length":0,"stats":{"Line":0}},{"line":1226,"address":[],"length":0,"stats":{"Line":0}},{"line":1230,"address":[],"length":0,"stats":{"Line":0}},{"line":1231,"address":[],"length":0,"stats":{"Line":0}},{"line":1234,"address":[],"length":0,"stats":{"Line":0}},{"line":1235,"address":[],"length":0,"stats":{"Line":0}},{"line":1237,"address":[],"length":0,"stats":{"Line":0}},{"line":1238,"address":[],"length":0,"stats":{"Line":0}},{"line":1240,"address":[],"length":0,"stats":{"Line":0}},{"line":1242,"address":[],"length":0,"stats":{"Line":0}},{"line":1243,"address":[],"length":0,"stats":{"Line":0}},{"line":1244,"address":[],"length":0,"stats":{"Line":0}},{"line":1245,"address":[],"length":0,"stats":{"Line":0}},{"line":1246,"address":[],"length":0,"stats":{"Line":0}},{"line":1247,"address":[],"length":0,"stats":{"Line":0}},{"line":1254,"address":[],"length":0,"stats":{"Line":0}},{"line":1255,"address":[],"length":0,"stats":{"Line":0}},{"line":1258,"address":[],"length":0,"stats":{"Line":0}},{"line":1261,"address":[],"length":0,"stats":{"Line":0}},{"line":1262,"address":[],"length":0,"stats":{"Line":0}},{"line":1263,"address":[],"length":0,"stats":{"Line":0}},{"line":1267,"address":[],"length":0,"stats":{"Line":0}},{"line":1268,"address":[],"length":0,"stats":{"Line":0}},{"line":1271,"address":[],"length":0,"stats":{"Line":0}},{"line":1272,"address":[],"length":0,"stats":{"Line":0}},{"line":1273,"address":[],"length":0,"stats":{"Line":0}},{"line":1276,"address":[],"length":0,"stats":{"Line":0}},{"line":1277,"address":[],"length":0,"stats":{"Line":0}},{"line":1278,"address":[],"length":0,"stats":{"Line":0}},{"line":1279,"address":[],"length":0,"stats":{"Line":0}},{"line":1282,"address":[],"length":0,"stats":{"Line":0}},{"line":1283,"address":[],"length":0,"stats":{"Line":0}},{"line":1285,"address":[],"length":0,"stats":{"Line":0}},{"line":1286,"address":[],"length":0,"stats":{"Line":0}},{"line":1287,"address":[],"length":0,"stats":{"Line":0}},{"line":1288,"address":[],"length":0,"stats":{"Line":0}},{"line":1292,"address":[],"length":0,"stats":{"Line":0}},{"line":1293,"address":[],"length":0,"stats":{"Line":0}},{"line":1298,"address":[],"length":0,"stats":{"Line":0}},{"line":1299,"address":[],"length":0,"stats":{"Line":0}},{"line":1300,"address":[],"length":0,"stats":{"Line":0}},{"line":1301,"address":[],"length":0,"stats":{"Line":0}},{"line":1303,"address":[],"length":0,"stats":{"Line":0}},{"line":1304,"address":[],"length":0,"stats":{"Line":0}},{"line":1305,"address":[],"length":0,"stats":{"Line":0}},{"line":1306,"address":[],"length":0,"stats":{"Line":0}},{"line":1307,"address":[],"length":0,"stats":{"Line":0}},{"line":1309,"address":[],"length":0,"stats":{"Line":0}},{"line":1312,"address":[],"length":0,"stats":{"Line":0}},{"line":1313,"address":[],"length":0,"stats":{"Line":0}},{"line":1314,"address":[],"length":0,"stats":{"Line":0}},{"line":1315,"address":[],"length":0,"stats":{"Line":0}},{"line":1316,"address":[],"length":0,"stats":{"Line":0}},{"line":1317,"address":[],"length":0,"stats":{"Line":0}},{"line":1318,"address":[],"length":0,"stats":{"Line":0}},{"line":1319,"address":[],"length":0,"stats":{"Line":0}},{"line":1325,"address":[],"length":0,"stats":{"Line":0}},{"line":1326,"address":[],"length":0,"stats":{"Line":0}},{"line":1329,"address":[],"length":0,"stats":{"Line":0}},{"line":1330,"address":[],"length":0,"stats":{"Line":0}},{"line":1331,"address":[],"length":0,"stats":{"Line":0}},{"line":1332,"address":[],"length":0,"stats":{"Line":0}},{"line":1333,"address":[],"length":0,"stats":{"Line":0}},{"line":1334,"address":[],"length":0,"stats":{"Line":0}},{"line":1338,"address":[],"length":0,"stats":{"Line":0}},{"line":1340,"address":[],"length":0,"stats":{"Line":0}},{"line":1343,"address":[],"length":0,"stats":{"Line":0}},{"line":1344,"address":[],"length":0,"stats":{"Line":0}},{"line":1348,"address":[],"length":0,"stats":{"Line":0}},{"line":1349,"address":[],"length":0,"stats":{"Line":0}},{"line":1350,"address":[],"length":0,"stats":{"Line":0}},{"line":1351,"address":[],"length":0,"stats":{"Line":0}},{"line":1352,"address":[],"length":0,"stats":{"Line":0}},{"line":1353,"address":[],"length":0,"stats":{"Line":0}},{"line":1355,"address":[],"length":0,"stats":{"Line":0}},{"line":1356,"address":[],"length":0,"stats":{"Line":0}},{"line":1359,"address":[],"length":0,"stats":{"Line":0}},{"line":1362,"address":[],"length":0,"stats":{"Line":0}},{"line":1363,"address":[],"length":0,"stats":{"Line":0}},{"line":1364,"address":[],"length":0,"stats":{"Line":0}},{"line":1365,"address":[],"length":0,"stats":{"Line":0}},{"line":1367,"address":[],"length":0,"stats":{"Line":0}},{"line":1370,"address":[],"length":0,"stats":{"Line":0}},{"line":1373,"address":[],"length":0,"stats":{"Line":0}},{"line":1374,"address":[],"length":0,"stats":{"Line":0}},{"line":1376,"address":[],"length":0,"stats":{"Line":0}},{"line":1377,"address":[],"length":0,"stats":{"Line":0}},{"line":1378,"address":[],"length":0,"stats":{"Line":0}},{"line":1379,"address":[],"length":0,"stats":{"Line":0}},{"line":1380,"address":[],"length":0,"stats":{"Line":0}},{"line":1381,"address":[],"length":0,"stats":{"Line":0}},{"line":1382,"address":[],"length":0,"stats":{"Line":0}},{"line":1383,"address":[],"length":0,"stats":{"Line":0}},{"line":1384,"address":[],"length":0,"stats":{"Line":0}},{"line":1385,"address":[],"length":0,"stats":{"Line":0}},{"line":1389,"address":[],"length":0,"stats":{"Line":0}},{"line":1390,"address":[],"length":0,"stats":{"Line":0}},{"line":1394,"address":[],"length":0,"stats":{"Line":0}},{"line":1397,"address":[],"length":0,"stats":{"Line":0}},{"line":1398,"address":[],"length":0,"stats":{"Line":0}},{"line":1399,"address":[],"length":0,"stats":{"Line":0}},{"line":1402,"address":[],"length":0,"stats":{"Line":0}},{"line":1403,"address":[],"length":0,"stats":{"Line":0}},{"line":1406,"address":[],"length":0,"stats":{"Line":0}},{"line":1407,"address":[],"length":0,"stats":{"Line":0}},{"line":1408,"address":[],"length":0,"stats":{"Line":0}},{"line":1410,"address":[],"length":0,"stats":{"Line":0}},{"line":1414,"address":[],"length":0,"stats":{"Line":0}},{"line":1415,"address":[],"length":0,"stats":{"Line":0}},{"line":1417,"address":[],"length":0,"stats":{"Line":0}},{"line":1418,"address":[],"length":0,"stats":{"Line":0}},{"line":1422,"address":[],"length":0,"stats":{"Line":0}},{"line":1424,"address":[],"length":0,"stats":{"Line":0}},{"line":1425,"address":[],"length":0,"stats":{"Line":0}},{"line":1428,"address":[],"length":0,"stats":{"Line":0}},{"line":1430,"address":[],"length":0,"stats":{"Line":0}},{"line":1432,"address":[],"length":0,"stats":{"Line":0}},{"line":1434,"address":[],"length":0,"stats":{"Line":0}},{"line":1436,"address":[],"length":0,"stats":{"Line":0}},{"line":1438,"address":[],"length":0,"stats":{"Line":0}},{"line":1441,"address":[],"length":0,"stats":{"Line":0}},{"line":1442,"address":[],"length":0,"stats":{"Line":0}},{"line":1443,"address":[],"length":0,"stats":{"Line":0}},{"line":1444,"address":[],"length":0,"stats":{"Line":0}},{"line":1445,"address":[],"length":0,"stats":{"Line":0}},{"line":1446,"address":[],"length":0,"stats":{"Line":0}},{"line":1447,"address":[],"length":0,"stats":{"Line":0}},{"line":1448,"address":[],"length":0,"stats":{"Line":0}},{"line":1449,"address":[],"length":0,"stats":{"Line":0}},{"line":1455,"address":[],"length":0,"stats":{"Line":0}},{"line":1458,"address":[],"length":0,"stats":{"Line":0}},{"line":1461,"address":[],"length":0,"stats":{"Line":0}},{"line":1467,"address":[],"length":0,"stats":{"Line":0}},{"line":1468,"address":[],"length":0,"stats":{"Line":0}},{"line":1469,"address":[],"length":0,"stats":{"Line":0}},{"line":1470,"address":[],"length":0,"stats":{"Line":0}},{"line":1471,"address":[],"length":0,"stats":{"Line":0}},{"line":1477,"address":[],"length":0,"stats":{"Line":0}},{"line":1478,"address":[],"length":0,"stats":{"Line":0}},{"line":1482,"address":[],"length":0,"stats":{"Line":0}},{"line":1483,"address":[],"length":0,"stats":{"Line":0}},{"line":1486,"address":[],"length":0,"stats":{"Line":0}},{"line":1497,"address":[],"length":0,"stats":{"Line":0}},{"line":1498,"address":[],"length":0,"stats":{"Line":0}},{"line":1499,"address":[],"length":0,"stats":{"Line":0}},{"line":1500,"address":[],"length":0,"stats":{"Line":0}},{"line":1501,"address":[],"length":0,"stats":{"Line":0}},{"line":1502,"address":[],"length":0,"stats":{"Line":0}},{"line":1503,"address":[],"length":0,"stats":{"Line":0}},{"line":1510,"address":[],"length":0,"stats":{"Line":0}},{"line":1517,"address":[],"length":0,"stats":{"Line":0}},{"line":1518,"address":[],"length":0,"stats":{"Line":0}},{"line":1519,"address":[],"length":0,"stats":{"Line":0}},{"line":1520,"address":[],"length":0,"stats":{"Line":0}},{"line":1521,"address":[],"length":0,"stats":{"Line":0}},{"line":1522,"address":[],"length":0,"stats":{"Line":0}},{"line":1523,"address":[],"length":0,"stats":{"Line":0}},{"line":1530,"address":[],"length":0,"stats":{"Line":0}},{"line":1531,"address":[],"length":0,"stats":{"Line":0}},{"line":1532,"address":[],"length":0,"stats":{"Line":0}},{"line":1533,"address":[],"length":0,"stats":{"Line":0}},{"line":1534,"address":[],"length":0,"stats":{"Line":0}},{"line":1535,"address":[],"length":0,"stats":{"Line":0}},{"line":1536,"address":[],"length":0,"stats":{"Line":0}},{"line":1537,"address":[],"length":0,"stats":{"Line":0}},{"line":1542,"address":[],"length":0,"stats":{"Line":0}},{"line":1543,"address":[],"length":0,"stats":{"Line":0}},{"line":1544,"address":[],"length":0,"stats":{"Line":0}},{"line":1545,"address":[],"length":0,"stats":{"Line":0}},{"line":1546,"address":[],"length":0,"stats":{"Line":0}},{"line":1547,"address":[],"length":0,"stats":{"Line":0}},{"line":1552,"address":[],"length":0,"stats":{"Line":0}},{"line":1554,"address":[],"length":0,"stats":{"Line":0}},{"line":1559,"address":[],"length":0,"stats":{"Line":0}},{"line":1560,"address":[],"length":0,"stats":{"Line":0}},{"line":1566,"address":[],"length":0,"stats":{"Line":0}},{"line":1567,"address":[],"length":0,"stats":{"Line":0}},{"line":1570,"address":[],"length":0,"stats":{"Line":0}},{"line":1571,"address":[],"length":0,"stats":{"Line":0}},{"line":1574,"address":[],"length":0,"stats":{"Line":0}},{"line":1575,"address":[],"length":0,"stats":{"Line":0}},{"line":1578,"address":[],"length":0,"stats":{"Line":0}},{"line":1579,"address":[],"length":0,"stats":{"Line":0}},{"line":1582,"address":[],"length":0,"stats":{"Line":0}},{"line":1583,"address":[],"length":0,"stats":{"Line":0}},{"line":1586,"address":[],"length":0,"stats":{"Line":0}},{"line":1587,"address":[],"length":0,"stats":{"Line":0}},{"line":1590,"address":[],"length":0,"stats":{"Line":0}},{"line":1591,"address":[],"length":0,"stats":{"Line":0}},{"line":1594,"address":[],"length":0,"stats":{"Line":0}},{"line":1595,"address":[],"length":0,"stats":{"Line":0}},{"line":1598,"address":[],"length":0,"stats":{"Line":0}},{"line":1599,"address":[],"length":0,"stats":{"Line":0}},{"line":1602,"address":[],"length":0,"stats":{"Line":0}},{"line":1603,"address":[],"length":0,"stats":{"Line":0}},{"line":1606,"address":[],"length":0,"stats":{"Line":0}},{"line":1607,"address":[],"length":0,"stats":{"Line":0}},{"line":1610,"address":[],"length":0,"stats":{"Line":0}},{"line":1611,"address":[],"length":0,"stats":{"Line":0}},{"line":1614,"address":[],"length":0,"stats":{"Line":0}},{"line":1615,"address":[],"length":0,"stats":{"Line":0}},{"line":1618,"address":[],"length":0,"stats":{"Line":0}},{"line":1619,"address":[],"length":0,"stats":{"Line":0}},{"line":1622,"address":[],"length":0,"stats":{"Line":0}},{"line":1623,"address":[],"length":0,"stats":{"Line":0}},{"line":1626,"address":[],"length":0,"stats":{"Line":0}},{"line":1627,"address":[],"length":0,"stats":{"Line":0}},{"line":1630,"address":[],"length":0,"stats":{"Line":0}},{"line":1631,"address":[],"length":0,"stats":{"Line":0}},{"line":1634,"address":[],"length":0,"stats":{"Line":0}},{"line":1635,"address":[],"length":0,"stats":{"Line":0}},{"line":1638,"address":[],"length":0,"stats":{"Line":0}},{"line":1639,"address":[],"length":0,"stats":{"Line":0}},{"line":1642,"address":[],"length":0,"stats":{"Line":0}},{"line":1643,"address":[],"length":0,"stats":{"Line":0}},{"line":1646,"address":[],"length":0,"stats":{"Line":0}},{"line":1647,"address":[],"length":0,"stats":{"Line":0}},{"line":1650,"address":[],"length":0,"stats":{"Line":0}},{"line":1651,"address":[],"length":0,"stats":{"Line":0}},{"line":1654,"address":[],"length":0,"stats":{"Line":0}},{"line":1655,"address":[],"length":0,"stats":{"Line":0}},{"line":1658,"address":[],"length":0,"stats":{"Line":0}},{"line":1659,"address":[],"length":0,"stats":{"Line":0}},{"line":1662,"address":[],"length":0,"stats":{"Line":0}},{"line":1663,"address":[],"length":0,"stats":{"Line":0}},{"line":1665,"address":[],"length":0,"stats":{"Line":0}},{"line":1666,"address":[],"length":0,"stats":{"Line":0}},{"line":1669,"address":[],"length":0,"stats":{"Line":0}},{"line":1670,"address":[],"length":0,"stats":{"Line":0}},{"line":1673,"address":[],"length":0,"stats":{"Line":0}},{"line":1674,"address":[],"length":0,"stats":{"Line":0}},{"line":1676,"address":[],"length":0,"stats":{"Line":0}},{"line":1677,"address":[],"length":0,"stats":{"Line":0}},{"line":1680,"address":[],"length":0,"stats":{"Line":0}},{"line":1681,"address":[],"length":0,"stats":{"Line":0}},{"line":1683,"address":[],"length":0,"stats":{"Line":0}},{"line":1684,"address":[],"length":0,"stats":{"Line":0}},{"line":1687,"address":[],"length":0,"stats":{"Line":0}},{"line":1688,"address":[],"length":0,"stats":{"Line":0}},{"line":1690,"address":[],"length":0,"stats":{"Line":0}},{"line":1694,"address":[],"length":0,"stats":{"Line":2}},{"line":1696,"address":[],"length":0,"stats":{"Line":2}},{"line":1698,"address":[],"length":0,"stats":{"Line":12}},{"line":1699,"address":[],"length":0,"stats":{"Line":2}},{"line":1700,"address":[],"length":0,"stats":{"Line":2}},{"line":1706,"address":[],"length":0,"stats":{"Line":0}},{"line":1707,"address":[],"length":0,"stats":{"Line":0}},{"line":1708,"address":[],"length":0,"stats":{"Line":0}},{"line":1712,"address":[],"length":0,"stats":{"Line":0}},{"line":1716,"address":[],"length":0,"stats":{"Line":0}},{"line":1717,"address":[],"length":0,"stats":{"Line":0}},{"line":1724,"address":[],"length":0,"stats":{"Line":0}},{"line":1725,"address":[],"length":0,"stats":{"Line":0}}],"covered":10,"coverable":866},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","platform","client.rs"],"content":"//! HTTP client for video platform API requests\n\nuse crate::error::RytError;\nuse reqwest::{Client, ClientBuilder};\nuse std::time::Duration;\nuse tracing::{info, debug, warn, error};\n\n/// Client types for realistic header emulation\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum ClientType {\n    Chrome,\n    Firefox,\n    Safari,\n    Android,\n    Ios,\n    Edge,\n    Opera,\n    SamsungBrowser,\n    AndroidTV,\n    SmartTV,\n}\n\nimpl ClientType {\n    /// Get all available client types\n    pub fn all() -\u003e Vec\u003cClientType\u003e {\n        vec![\n            ClientType::Chrome,\n            ClientType::Firefox,\n            ClientType::Safari,\n            ClientType::Android,\n            ClientType::Ios,\n            ClientType::Edge,\n            ClientType::Opera,\n            ClientType::SamsungBrowser,\n            ClientType::AndroidTV,\n            ClientType::SmartTV,\n        ]\n    }\n\n    /// Get client type from string\n    pub fn from_str(s: \u0026str) -\u003e Option\u003cClientType\u003e {\n        match s.to_lowercase().as_str() {\n            \"chrome\" =\u003e Some(ClientType::Chrome),\n            \"firefox\" =\u003e Some(ClientType::Firefox),\n            \"safari\" =\u003e Some(ClientType::Safari),\n            \"android\" =\u003e Some(ClientType::Android),\n            \"ios\" =\u003e Some(ClientType::Ios),\n            \"edge\" =\u003e Some(ClientType::Edge),\n            \"opera\" =\u003e Some(ClientType::Opera),\n            \"samsung\" =\u003e Some(ClientType::SamsungBrowser),\n            \"androidtv\" =\u003e Some(ClientType::AndroidTV),\n            \"smarttv\" =\u003e Some(ClientType::SmartTV),\n            _ =\u003e None,\n        }\n    }\n\n    /// Convert to string\n    pub fn to_string(\u0026self) -\u003e String {\n        match self {\n            ClientType::Chrome =\u003e \"chrome\".to_string(),\n            ClientType::Firefox =\u003e \"firefox\".to_string(),\n            ClientType::Safari =\u003e \"safari\".to_string(),\n            ClientType::Android =\u003e \"android\".to_string(),\n            ClientType::Ios =\u003e \"ios\".to_string(),\n            ClientType::Edge =\u003e \"edge\".to_string(),\n            ClientType::Opera =\u003e \"opera\".to_string(),\n            ClientType::SamsungBrowser =\u003e \"samsung\".to_string(),\n            ClientType::AndroidTV =\u003e \"androidtv\".to_string(),\n            ClientType::SmartTV =\u003e \"smarttv\".to_string(),\n        }\n    }\n\n    /// Check if this is a mobile client\n    pub fn is_mobile(\u0026self) -\u003e bool {\n        matches!(self, ClientType::Android | ClientType::Ios | ClientType::SamsungBrowser)\n    }\n\n    /// Check if this is a web client\n    pub fn is_web(\u0026self) -\u003e bool {\n        matches!(self, ClientType::Chrome | ClientType::Firefox | ClientType::Safari | ClientType::Edge | ClientType::Opera)\n    }\n\n    /// Check if this is a TV client\n    pub fn is_tv(\u0026self) -\u003e bool {\n        matches!(self, ClientType::AndroidTV | ClientType::SmartTV)\n    }\n}\n\n/// HTTP client configuration\n#[derive(Debug, Clone)]\npub struct HttpClientConfig {\n    /// Request timeout\n    pub timeout: Duration,\n    /// Maximum retries\n    pub max_retries: u32,\n    /// User agent string\n    pub user_agent: Option\u003cString\u003e,\n    /// Proxy URL\n    pub proxy_url: Option\u003cString\u003e,\n    /// Current client type\n    pub client_type: ClientType,\n    /// Enable client switching\n    pub enable_client_switching: bool,\n    /// Client switching strategy\n    pub switching_strategy: ClientSwitchingStrategy,\n    /// Force HTTP/1.1 only (disable HTTP/2)\n    pub http1_only: bool,\n}\n\n/// Client switching strategy\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum ClientSwitchingStrategy {\n    /// Round-robin switching\n    RoundRobin,\n    /// Random switching\n    Random,\n    /// Switch on error (403, rate limit)\n    OnError,\n    /// Switch on geographic restrictions\n    OnGeoBlock,\n    /// Smart switching based on response\n    Smart,\n}\n\nimpl Default for ClientSwitchingStrategy {\n    fn default() -\u003e Self {\n        Self::Smart\n    }\n}\n\nimpl Default for HttpClientConfig {\n    fn default() -\u003e Self {\n        Self {\n            timeout: Duration::from_secs(30),\n            max_retries: 3,\n            user_agent: None,\n            proxy_url: None,\n            client_type: ClientType::Chrome,\n            enable_client_switching: true,\n            switching_strategy: ClientSwitchingStrategy::default(),\n            http1_only: false,  // HTTP/2 by default\n        }\n    }\n}\n\n/// YouTube HTTP client\npub struct VideoClient {\n    client: Client,\n    config: HttpClientConfig,\n    current_client_index: usize,\n    client_switch_count: u32,\n}\n\nimpl VideoClient {\n    /// Create a new YouTube client with default configuration\n    pub fn new() -\u003e Self {\n        Self::with_config(HttpClientConfig::default())\n    }\n\n    /// Create a new YouTube client with custom configuration\n    pub fn with_config(config: HttpClientConfig) -\u003e Self {\n        let mut builder = ClientBuilder::new()\n            .timeout(config.timeout)\n            .gzip(true)\n            .brotli(true);\n\n        // Force HTTP/1.1 if requested (for media downloads, matches Go ytdlp)\n        if config.http1_only {\n            builder = builder.http1_only();\n        }\n\n        // Set user agent\n        if let Some(user_agent) = \u0026config.user_agent {\n            builder = builder.user_agent(user_agent);\n        } else {\n            // Default Android user agent\n            builder = builder.user_agent(\"com.google.android.youtube/20.10.38 (Linux; U; Android 11) gzip\");\n        }\n\n        // Set proxy\n        if let Some(proxy_url) = \u0026config.proxy_url {\n            if let Ok(proxy) = reqwest::Proxy::all(proxy_url) {\n                builder = builder.proxy(proxy);\n            }\n        }\n\n        let client = builder.build().expect(\"Failed to build HTTP client\");\n\n        Self { \n            client, \n            config,\n            current_client_index: 0,\n            client_switch_count: 0,\n        }\n    }\n\n    /// Get the underlying HTTP client\n    pub fn client(\u0026self) -\u003e \u0026Client {\n        \u0026self.client\n    }\n\n    /// Get current client type\n    pub fn current_client_type(\u0026self) -\u003e ClientType {\n        self.config.client_type\n    }\n\n            /// Switch to next client type\n            pub fn switch_client(\u0026mut self) -\u003e ClientType {\n                if !self.config.enable_client_switching {\n                    return self.config.client_type;\n                }\n\n                let available_clients = ClientType::all();\n                self.current_client_index = (self.current_client_index + 1) % available_clients.len();\n                self.client_switch_count += 1;\n                \n                let new_client_type = available_clients[self.current_client_index];\n                self.config.client_type = new_client_type;\n                \n                info!(\"Switched to client type: {:?} (switch #{}\", new_client_type, self.client_switch_count);\n                new_client_type\n            }\n\n    /// Switch to specific client type\n    pub fn switch_to_client(\u0026mut self, client_type: ClientType) {\n        self.config.client_type = client_type;\n        self.client_switch_count += 1;\n        \n        // Update index\n        let available_clients = ClientType::all();\n        if let Some(index) = available_clients.iter().position(|\u0026c| c == client_type) {\n            self.current_client_index = index;\n        }\n        \n        info!(\"Switched to specific client type: {:?} (switch #{})\", client_type, self.client_switch_count);\n    }\n\n    /// Switch client based on strategy\n    pub fn switch_client_by_strategy(\u0026mut self, error: Option\u003c\u0026RytError\u003e) -\u003e ClientType {\n        match self.config.switching_strategy {\n            ClientSwitchingStrategy::RoundRobin =\u003e self.switch_client(),\n            ClientSwitchingStrategy::Random =\u003e {\n                use rand::Rng;\n                let available_clients = ClientType::all();\n                let random_index = rand::thread_rng().gen_range(0..available_clients.len());\n                let new_client_type = available_clients[random_index];\n                self.switch_to_client(new_client_type);\n                new_client_type\n            }\n            ClientSwitchingStrategy::OnError =\u003e {\n                if let Some(err) = error {\n                    match err {\n                        RytError::RateLimited | RytError::BotguardError(_) =\u003e {\n                            // Switch to mobile client for better success rate\n                            if self.config.client_type.is_web() {\n                                self.switch_to_client(ClientType::Android);\n                                ClientType::Android\n                            } else {\n                                self.switch_client()\n                            }\n                        }\n                        RytError::AgeRestricted =\u003e {\n                            // Switch to mobile client to bypass age restrictions\n                            if self.config.client_type.is_web() {\n                                self.switch_to_client(ClientType::Android);\n                                ClientType::Android\n                            } else {\n                                self.switch_client()\n                            }\n                        }\n                        _ =\u003e self.config.client_type,\n                    }\n                } else {\n                    self.config.client_type\n                }\n            }\n            ClientSwitchingStrategy::OnGeoBlock =\u003e {\n                if let Some(err) = error {\n                    match err {\n                        RytError::VideoUnavailable =\u003e {\n                            // Switch to mobile client to bypass geo-blocking\n                            if self.config.client_type.is_web() {\n                                self.switch_to_client(ClientType::Android);\n                                ClientType::Android\n                            } else {\n                                self.switch_client()\n                            }\n                        }\n                        _ =\u003e self.config.client_type,\n                    }\n                } else {\n                    self.config.client_type\n                }\n            }\n            ClientSwitchingStrategy::Smart =\u003e {\n                // Smart switching: combine multiple strategies\n                if let Some(err) = error {\n                    match err {\n                        RytError::RateLimited | RytError::BotguardError(_) =\u003e {\n                            // Always switch to next client for rate limiting\n                            self.switch_client()\n                        }\n                        RytError::VideoUnavailable =\u003e {\n                            // Always switch to next client for video unavailable\n                            self.switch_client()\n                        }\n                        RytError::AgeRestricted =\u003e {\n                            // Switch to mobile client to bypass age restrictions\n                            if self.config.client_type.is_web() {\n                                self.switch_to_client(ClientType::Android);\n                                ClientType::Android\n                            } else {\n                                self.switch_client()\n                            }\n                        }\n                        _ =\u003e self.switch_client(),\n                    }\n                } else {\n                    // No error, use round-robin\n                    self.switch_client()\n                }\n            }\n        }\n    }\n\n    /// Get client switch count\n    pub fn client_switch_count(\u0026self) -\u003e u32 {\n        self.client_switch_count\n    }\n\n    /// Reset client switching\n    pub fn reset_client_switching(\u0026mut self) {\n        self.current_client_index = 0;\n        self.client_switch_count = 0;\n        self.config.client_type = ClientType::Chrome;\n    }\n\n    /// Get client configuration\n    pub fn config(\u0026self) -\u003e \u0026HttpClientConfig {\n        \u0026self.config\n    }\n\n    /// Create a request with common YouTube headers\n    pub fn create_request(\u0026self, method: reqwest::Method, url: \u0026str) -\u003e reqwest::RequestBuilder {\n        self.client\n            .request(method, url)\n            .header(\"Accept\", \"*/*\")\n            .header(\"Accept-Language\", \"en-US,en;q=0.9\")\n            .header(\"Accept-Encoding\", \"gzip, deflate, br\")\n            .header(\"Connection\", \"keep-alive\")\n            .header(\"Cache-Control\", \"no-cache\")\n            .header(\"DNT\", \"1\")\n            .header(\"Upgrade-Insecure-Requests\", \"1\")\n            .header(\"Sec-Fetch-Dest\", \"document\")\n            .header(\"Sec-Fetch-Mode\", \"navigate\")\n            .header(\"Sec-Fetch-Site\", \"none\")\n            .header(\"Sec-Fetch-User\", \"?1\")\n    }\n\n    /// Create a request with realistic browser headers using current client type\n    pub fn create_realistic_request(\u0026self, method: reqwest::Method, url: \u0026str) -\u003e reqwest::RequestBuilder {\n        self.create_realistic_request_with_client(method, url, self.config.client_type)\n    }\n    \n    /// Create a simple request for media downloads (googlevideo.com) without browser-specific headers\n    pub fn create_simple_media_request(\u0026self, method: reqwest::Method, url: \u0026str) -\u003e reqwest::RequestBuilder {\n        // Use minimal headers for media downloads to avoid 403 errors\n        // Match Go ytdlp exactly: User-Agent, Accept, Accept-Encoding, Connection, Cache-Control\n        self.client\n            .request(method, url)\n            .header(\"User-Agent\", \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/135.0.0.0 Safari/537.36\")\n            .header(\"Accept\", \"*/*\")\n            .header(\"Accept-Encoding\", \"identity\")\n            .header(\"Connection\", \"keep-alive\")\n            .header(\"Cache-Control\", \"no-cache\")\n    }\n\n    /// Create a request with realistic browser headers for specific client type\n    pub fn create_realistic_request_with_client(\u0026self, method: reqwest::Method, url: \u0026str, client_type: ClientType) -\u003e reqwest::RequestBuilder {\n        let (user_agent, headers) = match client_type {\n            ClientType::Chrome =\u003e (\n                \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n                vec![\n                    (\"Sec-Ch-Ua\", r#\"\"Not_A Brand\";v=\"8\", \"Chromium\";v=\"120\", \"Google Chrome\";v=\"120\"\"#),\n                    (\"Sec-Ch-Ua-Mobile\", \"?0\"),\n                    (\"Sec-Ch-Ua-Platform\", r#\"\"Windows\"\"#),\n                ]\n            ),\n            ClientType::Firefox =\u003e (\n                \"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:121.0) Gecko/20100101 Firefox/121.0\",\n                vec![\n                    (\"Sec-Fetch-Dest\", \"document\"),\n                    (\"Sec-Fetch-Mode\", \"navigate\"),\n                    (\"Sec-Fetch-Site\", \"none\"),\n                    (\"Sec-Fetch-User\", \"?1\"),\n                ]\n            ),\n            ClientType::Safari =\u003e (\n                \"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.1 Safari/605.1.15\",\n                vec![\n                    (\"Sec-Fetch-Dest\", \"document\"),\n                    (\"Sec-Fetch-Mode\", \"navigate\"),\n                    (\"Sec-Fetch-Site\", \"none\"),\n                    (\"Sec-Fetch-User\", \"?1\"),\n                ]\n            ),\n            ClientType::Android =\u003e (\n                \"Mozilla/5.0 (Linux; Android 11; SM-G973F) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Mobile Safari/537.36\",\n                vec![\n                    (\"Sec-Ch-Ua-Mobile\", \"?1\"),\n                    (\"Sec-Ch-Ua-Platform\", r#\"\"Android\"\"#),\n                ]\n            ),\n            ClientType::Ios =\u003e (\n                \"Mozilla/5.0 (iPhone; CPU iPhone OS 17_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.1 Mobile/15E148 Safari/604.1\",\n                vec![\n                    (\"Sec-Ch-Ua-Mobile\", \"?1\"),\n                    (\"Sec-Ch-Ua-Platform\", r#\"\"iOS\"\"#),\n                ]\n            ),\n            ClientType::Edge =\u003e (\n                \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36 Edg/120.0.0.0\",\n                vec![\n                    (\"Sec-Ch-Ua\", r#\"\"Not_A Brand\";v=\"8\", \"Chromium\";v=\"120\", \"Microsoft Edge\";v=\"120\"\"#),\n                    (\"Sec-Ch-Ua-Mobile\", \"?0\"),\n                    (\"Sec-Ch-Ua-Platform\", r#\"\"Windows\"\"#),\n                ]\n            ),\n            ClientType::Opera =\u003e (\n                \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36 OPR/106.0.0.0\",\n                vec![\n                    (\"Sec-Ch-Ua\", r#\"\"Not_A Brand\";v=\"8\", \"Chromium\";v=\"120\", \"Opera\";v=\"106\"\"#),\n                    (\"Sec-Ch-Ua-Mobile\", \"?0\"),\n                    (\"Sec-Ch-Ua-Platform\", r#\"\"Windows\"\"#),\n                ]\n            ),\n            ClientType::SamsungBrowser =\u003e (\n                \"Mozilla/5.0 (Linux; Android 12; SM-G998B) AppleWebKit/537.36 (KHTML, like Gecko) SamsungBrowser/22.0 Chrome/120.0.0.0 Mobile Safari/537.36\",\n                vec![\n                    (\"Sec-Ch-Ua-Mobile\", \"?1\"),\n                    (\"Sec-Ch-Ua-Platform\", r#\"\"Android\"\"#),\n                ]\n            ),\n            ClientType::AndroidTV =\u003e (\n                \"Mozilla/5.0 (Linux; Android 11; ADT-3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n                vec![\n                    (\"Sec-Ch-Ua-Mobile\", \"?0\"),\n                    (\"Sec-Ch-Ua-Platform\", r#\"\"Android\"\"#),\n                ]\n            ),\n            ClientType::SmartTV =\u003e (\n                \"Mozilla/5.0 (Web0S; Linux/SmartTV) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n                vec![\n                    (\"Sec-Ch-Ua-Mobile\", \"?0\"),\n                    (\"Sec-Ch-Ua-Platform\", r#\"\"Linux\"\"#),\n                ]\n            ),\n        };\n\n        let mut request = self.client\n            .request(method, url)\n            .header(\"User-Agent\", user_agent)\n            .header(\"Accept\", \"text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7\")\n            .header(\"Accept-Language\", \"en-US,en;q=0.9\")\n            .header(\"Accept-Encoding\", \"gzip, deflate, br\")\n            .header(\"Connection\", \"keep-alive\")\n            .header(\"Cache-Control\", \"no-cache\")\n            .header(\"DNT\", \"1\")\n            .header(\"Upgrade-Insecure-Requests\", \"1\");\n\n        // Add client-specific headers\n        for (name, value) in headers {\n            request = request.header(name, value);\n        }\n\n        request\n    }\n\n    /// Create a request for InnerTube API with client-specific headers\n    pub fn create_innertube_request(\u0026self, url: \u0026str) -\u003e reqwest::RequestBuilder {\n        // Add INNERTUBE_API_KEY to URL based on client type\n        let (api_key, client_name, client_version) = match self.config.client_type {\n            ClientType::Chrome | ClientType::Firefox | ClientType::Safari | ClientType::Edge | ClientType::Opera =\u003e {\n                (\"AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8\", \"1\", \"2.20251002.00.00\")\n            }\n            ClientType::Android | ClientType::SamsungBrowser | ClientType::AndroidTV =\u003e {\n                (\"AIzaSyA8eiZmM1FaDVjRy-df2KTyQ_vz_yYM39w\", \"3\", \"20.10.38\")\n            }\n            ClientType::Ios =\u003e {\n                (\"AIzaSyBUPetSUmoZL-OhlxA7wSac5XinrygCqMo\", \"5\", \"20.10.38\")\n            }\n            ClientType::SmartTV =\u003e {\n                (\"AIzaSyAO_FJ2SlqU8Q4STEHLGCilw_Y9_11qcW8\", \"1\", \"2.20251002.00.00\")\n            }\n        };\n        \n        let url_with_key = if url.contains('?') {\n            format!(\"{}\u0026key={}\", url, api_key)\n        } else {\n            format!(\"{}?key={}\", url, api_key)\n        };\n        \n        let mut request = self.create_request(reqwest::Method::POST, \u0026url_with_key)\n            .header(\"Content-Type\", \"application/json\")\n            .header(\"X-YouTube-Client-Name\", client_name)\n            .header(\"X-YouTube-Client-Version\", client_version);\n\n        // Add device-specific headers based on client type\n        match self.config.client_type {\n            ClientType::Android =\u003e {\n                request = request\n                    .header(\"X-YouTube-Device-Model\", \"SM-G973F\")\n                    .header(\"X-YouTube-Device-Os\", \"Android\")\n                    .header(\"X-YouTube-Device-Os-Version\", \"11\")\n                    .header(\"X-YouTube-Device-Connection-Type\", \"WIFI\")\n                    .header(\"X-YouTube-Device-Memory-Mb\", \"4096\")\n                    .header(\"X-YouTube-Device-Display-Density\", \"420\")\n                    .header(\"X-YouTube-Device-Display-Height\", \"2280\")\n                    .header(\"X-YouTube-Device-Display-Width\", \"1080\")\n                    .header(\"X-YouTube-Device-Cpu-Cores\", \"8\")\n                    .header(\"X-YouTube-Device-Cpu-Model\", \"Exynos 9820\")\n                    .header(\"X-YouTube-Device-Gpu-Model\", \"Mali-G76 MP12\")\n                    .header(\"X-YouTube-Device-Gpu-Version\", \"OpenGL ES 3.2\")\n                    .header(\"X-YouTube-Device-Screen-Density\", \"420\")\n                    .header(\"X-YouTube-Device-Screen-Height\", \"2280\")\n                    .header(\"X-YouTube-Device-Screen-Width\", \"1080\")\n                    .header(\"X-YouTube-Device-Timezone\", \"UTC\")\n                    .header(\"X-YouTube-Device-Language\", \"en\")\n                    .header(\"X-YouTube-Device-Country\", \"US\")\n                    .header(\"X-YouTube-Device-Region\", \"US\")\n                    .header(\"X-YouTube-Device-Carrier\", \"Unknown\")\n                    .header(\"X-YouTube-Device-Network-Type\", \"WIFI\")\n                    .header(\"X-YouTube-Device-Network-Speed\", \"1000000\")\n                    .header(\"X-YouTube-Device-Network-Signal\", \"4\")\n                    .header(\"X-YouTube-Device-Battery-Level\", \"100\")\n                    .header(\"X-YouTube-Device-Battery-Charging\", \"false\")\n                    .header(\"X-YouTube-Device-Volume\", \"100\")\n                    .header(\"X-YouTube-Device-Brightness\", \"100\")\n                    .header(\"X-YouTube-Device-Orientation\", \"portrait\")\n                    .header(\"X-YouTube-Device-Accelerometer\", \"true\")\n                    .header(\"X-YouTube-Device-Gyroscope\", \"true\")\n                    .header(\"X-YouTube-Device-Magnetometer\", \"true\")\n                    .header(\"X-YouTube-Device-Proximity\", \"false\")\n                    .header(\"X-YouTube-Device-Light\", \"true\")\n                    .header(\"X-YouTube-Device-Pressure\", \"false\")\n                    .header(\"X-YouTube-Device-Temperature\", \"false\")\n                    .header(\"X-YouTube-Device-Humidity\", \"false\")\n                    .header(\"X-YouTube-Device-Altitude\", \"0\")\n                    .header(\"X-YouTube-Device-Latitude\", \"0\")\n                    .header(\"X-YouTube-Device-Longitude\", \"0\")\n                    .header(\"X-YouTube-Device-Accuracy\", \"0\")\n                    .header(\"X-YouTube-Device-Speed\", \"0\")\n                    .header(\"X-YouTube-Device-Heading\", \"0\")\n                    .header(\"X-YouTube-Device-Timestamp\", \"0\");\n            }\n            ClientType::Ios =\u003e {\n                request = request\n                    .header(\"X-YouTube-Device-Model\", \"iPhone13,2\")\n                    .header(\"X-YouTube-Device-Os\", \"iOS\")\n                    .header(\"X-YouTube-Device-Os-Version\", \"17.1\")\n                    .header(\"X-YouTube-Device-Connection-Type\", \"WIFI\")\n                    .header(\"X-YouTube-Device-Memory-Mb\", \"6144\")\n                    .header(\"X-YouTube-Device-Display-Density\", \"460\")\n                    .header(\"X-YouTube-Device-Display-Height\", \"2532\")\n                    .header(\"X-YouTube-Device-Display-Width\", \"1170\")\n                    .header(\"X-YouTube-Device-Cpu-Cores\", \"6\")\n                    .header(\"X-YouTube-Device-Cpu-Model\", \"A15 Bionic\")\n                    .header(\"X-YouTube-Device-Gpu-Model\", \"Apple GPU\")\n                    .header(\"X-YouTube-Device-Gpu-Version\", \"Metal\")\n                    .header(\"X-YouTube-Device-Screen-Density\", \"460\")\n                    .header(\"X-YouTube-Device-Screen-Height\", \"2532\")\n                    .header(\"X-YouTube-Device-Screen-Width\", \"1170\")\n                    .header(\"X-YouTube-Device-Timezone\", \"UTC\")\n                    .header(\"X-YouTube-Device-Language\", \"en\")\n                    .header(\"X-YouTube-Device-Country\", \"US\")\n                    .header(\"X-YouTube-Device-Region\", \"US\")\n                    .header(\"X-YouTube-Device-Carrier\", \"Unknown\")\n                    .header(\"X-YouTube-Device-Network-Type\", \"WIFI\")\n                    .header(\"X-YouTube-Device-Network-Speed\", \"1000000\")\n                    .header(\"X-YouTube-Device-Network-Signal\", \"4\")\n                    .header(\"X-YouTube-Device-Battery-Level\", \"100\")\n                    .header(\"X-YouTube-Device-Battery-Charging\", \"false\")\n                    .header(\"X-YouTube-Device-Volume\", \"100\")\n                    .header(\"X-YouTube-Device-Brightness\", \"100\")\n                    .header(\"X-YouTube-Device-Orientation\", \"portrait\")\n                    .header(\"X-YouTube-Device-Accelerometer\", \"true\")\n                    .header(\"X-YouTube-Device-Gyroscope\", \"true\")\n                    .header(\"X-YouTube-Device-Magnetometer\", \"true\")\n                    .header(\"X-YouTube-Device-Proximity\", \"true\")\n                    .header(\"X-YouTube-Device-Light\", \"true\")\n                    .header(\"X-YouTube-Device-Pressure\", \"false\")\n                    .header(\"X-YouTube-Device-Temperature\", \"false\")\n                    .header(\"X-YouTube-Device-Humidity\", \"false\")\n                    .header(\"X-YouTube-Device-Altitude\", \"0\")\n                    .header(\"X-YouTube-Device-Latitude\", \"0\")\n                    .header(\"X-YouTube-Device-Longitude\", \"0\")\n                    .header(\"X-YouTube-Device-Accuracy\", \"0\")\n                    .header(\"X-YouTube-Device-Speed\", \"0\")\n                    .header(\"X-YouTube-Device-Heading\", \"0\")\n                    .header(\"X-YouTube-Device-Timestamp\", \"0\");\n            }\n            _ =\u003e {\n                // Web clients don't need device headers\n            }\n        }\n\n        request\n    }\n\n            /// Execute request with retry logic and client switching\n            pub async fn execute_with_retry\u003cT\u003e(\u0026mut self, request: reqwest::RequestBuilder) -\u003e Result\u003cT, RytError\u003e\n            where\n                T: serde::de::DeserializeOwned,\n            {\n                let mut last_error = None;\n                \n                for attempt in 0..self.config.max_retries {\n                    debug!(\"HTTP request attempt {}/{}\", attempt + 1, self.config.max_retries);\n                    \n                    match request.try_clone().unwrap().send().await {\n                        Ok(response) =\u003e {\n                            if response.status().is_success() {\n                                debug!(\"HTTP request successful\");\n                                return Ok(response.json().await?);\n                            } else if response.status() == 403 {\n                                // Check if this is a botguard challenge\n                                let response_text = response.text().await.unwrap_or_default();\n                                if response_text.contains(\"botguard\") || response_text.contains(\"challenge\") {\n                                    warn!(\"Botguard challenge detected\");\n                                    let error = RytError::BotguardError(\"Botguard challenge detected\".to_string());\n                                    // Try switching client if enabled\n                                    if self.config.enable_client_switching {\n                                        self.switch_client_by_strategy(Some(\u0026error));\n                                    }\n                                    return Err(error);\n                                }\n                                warn!(\"Rate limited (403), switching client\");\n                                let error = RytError::RateLimited;\n                                // Try switching client if enabled\n                                if self.config.enable_client_switching {\n                                    self.switch_client_by_strategy(Some(\u0026error));\n                                }\n                                return Err(error);\n                            } else if response.status() == 404 {\n                                warn!(\"Video unavailable (404), switching client\");\n                                let error = RytError::VideoUnavailable;\n                                // Try switching client if enabled\n                                if self.config.enable_client_switching {\n                                    self.switch_client_by_strategy(Some(\u0026error));\n                                }\n                                return Err(error);\n                            } else {\n                                warn!(\"HTTP request failed with status: {}\", response.status());\n                                last_error = Some(RytError::DownloadFailed(\n                                    reqwest::Error::from(response.error_for_status().unwrap_err())\n                                ));\n                            }\n                        }\n                        Err(e) =\u003e {\n                            warn!(\"HTTP request error: {}\", e);\n                            last_error = Some(RytError::DownloadFailed(e));\n                        }\n                    }\n\n                    // Exponential backoff\n                    if attempt \u003c self.config.max_retries - 1 {\n                        let delay = Duration::from_millis(200 * (1 \u003c\u003c attempt));\n                        debug!(\"Retrying in {:?}\", delay);\n                        tokio::time::sleep(delay).await;\n                    }\n                }\n\n                error!(\"All retry attempts failed\");\n                Err(last_error.unwrap_or(RytError::Generic(\"Request failed\".to_string())))\n            }\n}\n\nimpl Default for VideoClient {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_client_creation() {\n        let client = VideoClient::new();\n        assert_eq!(client.config().timeout, Duration::from_secs(30));\n        assert_eq!(client.config().max_retries, 3);\n    }\n\n    #[test]\n    fn test_client_with_config() {\n        let config = HttpClientConfig {\n            timeout: Duration::from_secs(60),\n            max_retries: 5,\n            user_agent: Some(\"Custom Agent\".to_string()),\n            proxy_url: None,\n            client_type: ClientType::Chrome,\n            http1_only: false,\n            enable_client_switching: true,\n            switching_strategy: ClientSwitchingStrategy::Smart,\n        };\n\n        let client = VideoClient::with_config(config);\n        assert_eq!(client.config().timeout, Duration::from_secs(60));\n        assert_eq!(client.config().max_retries, 5);\n        assert_eq!(client.config().user_agent, Some(\"Custom Agent\".to_string()));\n    }\n}\n","traces":[{"line":25,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":0}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":30,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":32,"address":[],"length":0,"stats":{"Line":0}},{"line":33,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":0}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":43,"address":[],"length":0,"stats":{"Line":0}},{"line":44,"address":[],"length":0,"stats":{"Line":0}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":63,"address":[],"length":0,"stats":{"Line":0}},{"line":64,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":79,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":12}},{"line":127,"address":[],"length":0,"stats":{"Line":12}},{"line":132,"address":[],"length":0,"stats":{"Line":12}},{"line":134,"address":[],"length":0,"stats":{"Line":24}},{"line":140,"address":[],"length":0,"stats":{"Line":12}},{"line":156,"address":[],"length":0,"stats":{"Line":7}},{"line":157,"address":[],"length":0,"stats":{"Line":14}},{"line":161,"address":[],"length":0,"stats":{"Line":13}},{"line":162,"address":[],"length":0,"stats":{"Line":26}},{"line":163,"address":[],"length":0,"stats":{"Line":26}},{"line":168,"address":[],"length":0,"stats":{"Line":18}},{"line":169,"address":[],"length":0,"stats":{"Line":10}},{"line":173,"address":[],"length":0,"stats":{"Line":14}},{"line":177,"address":[],"length":0,"stats":{"Line":24}},{"line":181,"address":[],"length":0,"stats":{"Line":13}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":65}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":199,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":210,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":214,"address":[],"length":0,"stats":{"Line":0}},{"line":215,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":220,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":235,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":246,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":251,"address":[],"length":0,"stats":{"Line":0}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":274,"address":[],"length":0,"stats":{"Line":0}},{"line":278,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}},{"line":282,"address":[],"length":0,"stats":{"Line":0}},{"line":283,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":289,"address":[],"length":0,"stats":{"Line":0}},{"line":292,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":301,"address":[],"length":0,"stats":{"Line":0}},{"line":305,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":311,"address":[],"length":0,"stats":{"Line":0}},{"line":313,"address":[],"length":0,"stats":{"Line":0}},{"line":316,"address":[],"length":0,"stats":{"Line":0}},{"line":320,"address":[],"length":0,"stats":{"Line":0}},{"line":327,"address":[],"length":0,"stats":{"Line":0}},{"line":328,"address":[],"length":0,"stats":{"Line":0}},{"line":332,"address":[],"length":0,"stats":{"Line":0}},{"line":333,"address":[],"length":0,"stats":{"Line":0}},{"line":334,"address":[],"length":0,"stats":{"Line":0}},{"line":335,"address":[],"length":0,"stats":{"Line":0}},{"line":339,"address":[],"length":0,"stats":{"Line":5}},{"line":340,"address":[],"length":0,"stats":{"Line":5}},{"line":344,"address":[],"length":0,"stats":{"Line":0}},{"line":345,"address":[],"length":0,"stats":{"Line":0}},{"line":346,"address":[],"length":0,"stats":{"Line":0}},{"line":361,"address":[],"length":0,"stats":{"Line":0}},{"line":362,"address":[],"length":0,"stats":{"Line":0}},{"line":366,"address":[],"length":0,"stats":{"Line":0}},{"line":369,"address":[],"length":0,"stats":{"Line":0}},{"line":370,"address":[],"length":0,"stats":{"Line":0}},{"line":379,"address":[],"length":0,"stats":{"Line":0}},{"line":380,"address":[],"length":0,"stats":{"Line":0}},{"line":381,"address":[],"length":0,"stats":{"Line":0}},{"line":382,"address":[],"length":0,"stats":{"Line":0}},{"line":383,"address":[],"length":0,"stats":{"Line":0}},{"line":384,"address":[],"length":0,"stats":{"Line":0}},{"line":385,"address":[],"length":0,"stats":{"Line":0}},{"line":386,"address":[],"length":0,"stats":{"Line":0}},{"line":389,"address":[],"length":0,"stats":{"Line":0}},{"line":390,"address":[],"length":0,"stats":{"Line":0}},{"line":391,"address":[],"length":0,"stats":{"Line":0}},{"line":392,"address":[],"length":0,"stats":{"Line":0}},{"line":393,"address":[],"length":0,"stats":{"Line":0}},{"line":394,"address":[],"length":0,"stats":{"Line":0}},{"line":395,"address":[],"length":0,"stats":{"Line":0}},{"line":398,"address":[],"length":0,"stats":{"Line":0}},{"line":399,"address":[],"length":0,"stats":{"Line":0}},{"line":400,"address":[],"length":0,"stats":{"Line":0}},{"line":401,"address":[],"length":0,"stats":{"Line":0}},{"line":402,"address":[],"length":0,"stats":{"Line":0}},{"line":403,"address":[],"length":0,"stats":{"Line":0}},{"line":404,"address":[],"length":0,"stats":{"Line":0}},{"line":407,"address":[],"length":0,"stats":{"Line":0}},{"line":408,"address":[],"length":0,"stats":{"Line":0}},{"line":409,"address":[],"length":0,"stats":{"Line":0}},{"line":410,"address":[],"length":0,"stats":{"Line":0}},{"line":411,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":416,"address":[],"length":0,"stats":{"Line":0}},{"line":417,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":438,"address":[],"length":0,"stats":{"Line":0}},{"line":439,"address":[],"length":0,"stats":{"Line":0}},{"line":440,"address":[],"length":0,"stats":{"Line":0}},{"line":441,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":462,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}},{"line":473,"address":[],"length":0,"stats":{"Line":0}},{"line":476,"address":[],"length":0,"stats":{"Line":0}},{"line":480,"address":[],"length":0,"stats":{"Line":0}},{"line":482,"address":[],"length":0,"stats":{"Line":0}},{"line":484,"address":[],"length":0,"stats":{"Line":0}},{"line":487,"address":[],"length":0,"stats":{"Line":0}},{"line":490,"address":[],"length":0,"stats":{"Line":0}},{"line":493,"address":[],"length":0,"stats":{"Line":0}},{"line":497,"address":[],"length":0,"stats":{"Line":0}},{"line":498,"address":[],"length":0,"stats":{"Line":0}},{"line":500,"address":[],"length":0,"stats":{"Line":0}},{"line":503,"address":[],"length":0,"stats":{"Line":0}},{"line":505,"address":[],"length":0,"stats":{"Line":0}},{"line":506,"address":[],"length":0,"stats":{"Line":0}},{"line":509,"address":[],"length":0,"stats":{"Line":0}},{"line":510,"address":[],"length":0,"stats":{"Line":0}},{"line":511,"address":[],"length":0,"stats":{"Line":0}},{"line":512,"address":[],"length":0,"stats":{"Line":0}},{"line":513,"address":[],"length":0,"stats":{"Line":0}},{"line":514,"address":[],"length":0,"stats":{"Line":0}},{"line":515,"address":[],"length":0,"stats":{"Line":0}},{"line":516,"address":[],"length":0,"stats":{"Line":0}},{"line":517,"address":[],"length":0,"stats":{"Line":0}},{"line":518,"address":[],"length":0,"stats":{"Line":0}},{"line":519,"address":[],"length":0,"stats":{"Line":0}},{"line":520,"address":[],"length":0,"stats":{"Line":0}},{"line":521,"address":[],"length":0,"stats":{"Line":0}},{"line":522,"address":[],"length":0,"stats":{"Line":0}},{"line":523,"address":[],"length":0,"stats":{"Line":0}},{"line":524,"address":[],"length":0,"stats":{"Line":0}},{"line":525,"address":[],"length":0,"stats":{"Line":0}},{"line":526,"address":[],"length":0,"stats":{"Line":0}},{"line":527,"address":[],"length":0,"stats":{"Line":0}},{"line":528,"address":[],"length":0,"stats":{"Line":0}},{"line":529,"address":[],"length":0,"stats":{"Line":0}},{"line":530,"address":[],"length":0,"stats":{"Line":0}},{"line":531,"address":[],"length":0,"stats":{"Line":0}},{"line":532,"address":[],"length":0,"stats":{"Line":0}},{"line":533,"address":[],"length":0,"stats":{"Line":0}},{"line":534,"address":[],"length":0,"stats":{"Line":0}},{"line":535,"address":[],"length":0,"stats":{"Line":0}},{"line":536,"address":[],"length":0,"stats":{"Line":0}},{"line":537,"address":[],"length":0,"stats":{"Line":0}},{"line":538,"address":[],"length":0,"stats":{"Line":0}},{"line":539,"address":[],"length":0,"stats":{"Line":0}},{"line":540,"address":[],"length":0,"stats":{"Line":0}},{"line":541,"address":[],"length":0,"stats":{"Line":0}},{"line":542,"address":[],"length":0,"stats":{"Line":0}},{"line":543,"address":[],"length":0,"stats":{"Line":0}},{"line":544,"address":[],"length":0,"stats":{"Line":0}},{"line":545,"address":[],"length":0,"stats":{"Line":0}},{"line":546,"address":[],"length":0,"stats":{"Line":0}},{"line":547,"address":[],"length":0,"stats":{"Line":0}},{"line":548,"address":[],"length":0,"stats":{"Line":0}},{"line":549,"address":[],"length":0,"stats":{"Line":0}},{"line":550,"address":[],"length":0,"stats":{"Line":0}},{"line":551,"address":[],"length":0,"stats":{"Line":0}},{"line":552,"address":[],"length":0,"stats":{"Line":0}},{"line":553,"address":[],"length":0,"stats":{"Line":0}},{"line":554,"address":[],"length":0,"stats":{"Line":0}},{"line":556,"address":[],"length":0,"stats":{"Line":0}},{"line":557,"address":[],"length":0,"stats":{"Line":0}},{"line":558,"address":[],"length":0,"stats":{"Line":0}},{"line":559,"address":[],"length":0,"stats":{"Line":0}},{"line":560,"address":[],"length":0,"stats":{"Line":0}},{"line":561,"address":[],"length":0,"stats":{"Line":0}},{"line":562,"address":[],"length":0,"stats":{"Line":0}},{"line":563,"address":[],"length":0,"stats":{"Line":0}},{"line":564,"address":[],"length":0,"stats":{"Line":0}},{"line":565,"address":[],"length":0,"stats":{"Line":0}},{"line":566,"address":[],"length":0,"stats":{"Line":0}},{"line":567,"address":[],"length":0,"stats":{"Line":0}},{"line":568,"address":[],"length":0,"stats":{"Line":0}},{"line":569,"address":[],"length":0,"stats":{"Line":0}},{"line":570,"address":[],"length":0,"stats":{"Line":0}},{"line":571,"address":[],"length":0,"stats":{"Line":0}},{"line":572,"address":[],"length":0,"stats":{"Line":0}},{"line":573,"address":[],"length":0,"stats":{"Line":0}},{"line":574,"address":[],"length":0,"stats":{"Line":0}},{"line":575,"address":[],"length":0,"stats":{"Line":0}},{"line":576,"address":[],"length":0,"stats":{"Line":0}},{"line":577,"address":[],"length":0,"stats":{"Line":0}},{"line":578,"address":[],"length":0,"stats":{"Line":0}},{"line":579,"address":[],"length":0,"stats":{"Line":0}},{"line":580,"address":[],"length":0,"stats":{"Line":0}},{"line":581,"address":[],"length":0,"stats":{"Line":0}},{"line":582,"address":[],"length":0,"stats":{"Line":0}},{"line":583,"address":[],"length":0,"stats":{"Line":0}},{"line":584,"address":[],"length":0,"stats":{"Line":0}},{"line":585,"address":[],"length":0,"stats":{"Line":0}},{"line":586,"address":[],"length":0,"stats":{"Line":0}},{"line":587,"address":[],"length":0,"stats":{"Line":0}},{"line":588,"address":[],"length":0,"stats":{"Line":0}},{"line":589,"address":[],"length":0,"stats":{"Line":0}},{"line":590,"address":[],"length":0,"stats":{"Line":0}},{"line":591,"address":[],"length":0,"stats":{"Line":0}},{"line":592,"address":[],"length":0,"stats":{"Line":0}},{"line":593,"address":[],"length":0,"stats":{"Line":0}},{"line":594,"address":[],"length":0,"stats":{"Line":0}},{"line":595,"address":[],"length":0,"stats":{"Line":0}},{"line":596,"address":[],"length":0,"stats":{"Line":0}},{"line":597,"address":[],"length":0,"stats":{"Line":0}},{"line":598,"address":[],"length":0,"stats":{"Line":0}},{"line":599,"address":[],"length":0,"stats":{"Line":0}},{"line":600,"address":[],"length":0,"stats":{"Line":0}},{"line":602,"address":[],"length":0,"stats":{"Line":0}},{"line":607,"address":[],"length":0,"stats":{"Line":0}},{"line":611,"address":[],"length":0,"stats":{"Line":0}},{"line":615,"address":[],"length":0,"stats":{"Line":0}},{"line":617,"address":[],"length":0,"stats":{"Line":0}},{"line":618,"address":[],"length":0,"stats":{"Line":0}},{"line":620,"address":[],"length":0,"stats":{"Line":0}},{"line":621,"address":[],"length":0,"stats":{"Line":0}},{"line":622,"address":[],"length":0,"stats":{"Line":0}},{"line":623,"address":[],"length":0,"stats":{"Line":0}},{"line":624,"address":[],"length":0,"stats":{"Line":0}},{"line":625,"address":[],"length":0,"stats":{"Line":0}},{"line":627,"address":[],"length":0,"stats":{"Line":0}},{"line":628,"address":[],"length":0,"stats":{"Line":0}},{"line":629,"address":[],"length":0,"stats":{"Line":0}},{"line":630,"address":[],"length":0,"stats":{"Line":0}},{"line":632,"address":[],"length":0,"stats":{"Line":0}},{"line":633,"address":[],"length":0,"stats":{"Line":0}},{"line":635,"address":[],"length":0,"stats":{"Line":0}},{"line":637,"address":[],"length":0,"stats":{"Line":0}},{"line":638,"address":[],"length":0,"stats":{"Line":0}},{"line":640,"address":[],"length":0,"stats":{"Line":0}},{"line":641,"address":[],"length":0,"stats":{"Line":0}},{"line":643,"address":[],"length":0,"stats":{"Line":0}},{"line":644,"address":[],"length":0,"stats":{"Line":0}},{"line":645,"address":[],"length":0,"stats":{"Line":0}},{"line":646,"address":[],"length":0,"stats":{"Line":0}},{"line":648,"address":[],"length":0,"stats":{"Line":0}},{"line":649,"address":[],"length":0,"stats":{"Line":0}},{"line":651,"address":[],"length":0,"stats":{"Line":0}},{"line":653,"address":[],"length":0,"stats":{"Line":0}},{"line":654,"address":[],"length":0,"stats":{"Line":0}},{"line":655,"address":[],"length":0,"stats":{"Line":0}},{"line":659,"address":[],"length":0,"stats":{"Line":0}},{"line":660,"address":[],"length":0,"stats":{"Line":0}},{"line":661,"address":[],"length":0,"stats":{"Line":0}},{"line":666,"address":[],"length":0,"stats":{"Line":0}},{"line":667,"address":[],"length":0,"stats":{"Line":0}},{"line":668,"address":[],"length":0,"stats":{"Line":0}},{"line":669,"address":[],"length":0,"stats":{"Line":0}},{"line":673,"address":[],"length":0,"stats":{"Line":0}},{"line":674,"address":[],"length":0,"stats":{"Line":0}},{"line":679,"address":[],"length":0,"stats":{"Line":0}},{"line":680,"address":[],"length":0,"stats":{"Line":0}}],"covered":18,"coverable":347},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","platform","formats.rs"],"content":"//! Format parsing and selection utilities\n\nuse crate::core::video_info::{Format, FormatSelector, QualitySelector};\nuse crate::error::RytError;\n\n/// Select the best format based on selector criteria\npub fn select_format\u003c'a\u003e(formats: \u0026'a [Format], selector: \u0026FormatSelector) -\u003e Result\u003c\u0026'a Format, RytError\u003e {\n    let mut candidates: Vec\u003c\u0026Format\u003e = formats.iter().collect();\n\n    // Filter by extension\n    if let Some(ext) = \u0026selector.extension {\n        candidates.retain(|f| f.mime_type.contains(ext));\n    }\n\n    // Filter by height constraints\n    if let Some(height_limit) = selector.height_limit {\n        candidates.retain(|f| {\n            if let Some(height) = f.height {\n                height \u003c= height_limit\n            } else {\n                false\n            }\n        });\n    }\n\n    if let Some(height_min) = selector.height_min {\n        candidates.retain(|f| {\n            if let Some(height) = f.height {\n                height \u003e= height_min\n            } else {\n                false\n            }\n        });\n    }\n\n    // Filter by preferred itag\n    if let Some(preferred_itag) = selector.preferred_itag {\n        candidates.retain(|f| f.itag == preferred_itag);\n    }\n\n    if candidates.is_empty() {\n        return Err(RytError::NoFormatFound);\n    }\n\n    // Select by quality criteria\n    match \u0026selector.quality {\n        QualitySelector::Best =\u003e {\n            // Prioritize progressive formats (video+audio combined)\n            if let Some(progressive) = candidates.iter().find(|f| f.is_progressive()) {\n                return Ok(progressive);\n            }\n            // Then sort by bitrate\n            candidates.sort_by(|a, b| b.bitrate.cmp(\u0026a.bitrate));\n            Ok(candidates.first().unwrap())\n        }\n        QualitySelector::Worst =\u003e {\n            candidates.sort_by(|a, b| a.bitrate.cmp(\u0026b.bitrate));\n            Ok(candidates.first().unwrap())\n        }\n            QualitySelector::Itag(target_itag) =\u003e {\n                candidates.iter()\n                    .find(|f| f.itag == *target_itag)\n                    .copied()\n                    .ok_or(RytError::NoFormatFound)\n            }\n        QualitySelector::Height(target_height) =\u003e {\n            candidates.iter()\n                .filter(|f| f.height.unwrap_or(0) == *target_height)\n                .max_by_key(|f| f.bitrate)\n                .copied()\n                .ok_or(RytError::NoFormatFound)\n        }\n        QualitySelector::HeightLessOrEqual(target_height) =\u003e {\n            candidates.iter()\n                .filter(|f| f.height.unwrap_or(0) \u003c= *target_height)\n                .max_by_key(|f| f.bitrate)\n                .copied()\n                .ok_or(RytError::NoFormatFound)\n        }\n        QualitySelector::HeightGreaterOrEqual(target_height) =\u003e {\n            candidates.iter()\n                .filter(|f| f.height.unwrap_or(0) \u003e= *target_height)\n                .max_by_key(|f| f.bitrate)\n                .copied()\n                .ok_or(RytError::NoFormatFound)\n        }\n    }\n}\n\n/// Get the best progressive format (video+audio combined)\npub fn get_best_progressive_format(formats: \u0026[Format]) -\u003e Option\u003c\u0026Format\u003e {\n    formats.iter()\n        .filter(|f| f.is_progressive())\n        .max_by_key(|f| f.bitrate)\n}\n\n/// Get the best video-only format\npub fn get_best_video_format(formats: \u0026[Format]) -\u003e Option\u003c\u0026Format\u003e {\n    formats.iter()\n        .filter(|f| f.is_video_only())\n        .max_by_key(|f| f.bitrate)\n}\n\n/// Get the best audio-only format\npub fn get_best_audio_format(formats: \u0026[Format]) -\u003e Option\u003c\u0026Format\u003e {\n    formats.iter()\n        .filter(|f| f.is_audio_only())\n        .max_by_key(|f| f.bitrate)\n}\n\n/// Get formats by container type\npub fn get_formats_by_container\u003c'a\u003e(formats: \u0026'a [Format], container: \u0026str) -\u003e Vec\u003c\u0026'a Format\u003e {\n    formats.iter()\n        .filter(|f| f.container() == container)\n        .collect()\n}\n\n/// Get formats by quality\npub fn get_formats_by_quality\u003c'a\u003e(formats: \u0026'a [Format], quality: \u0026str) -\u003e Vec\u003c\u0026'a Format\u003e {\n    formats.iter()\n        .filter(|f| f.quality == quality)\n        .collect()\n}\n\n/// Get formats by height range\npub fn get_formats_by_height_range(formats: \u0026[Format], min_height: u32, max_height: u32) -\u003e Vec\u003c\u0026Format\u003e {\n    formats.iter()\n        .filter(|f| {\n            if let Some(height) = f.height {\n                height \u003e= min_height \u0026\u0026 height \u003c= max_height\n            } else {\n                false\n            }\n        })\n        .collect()\n}\n\n/// Get formats by bitrate range\npub fn get_formats_by_bitrate_range(formats: \u0026[Format], min_bitrate: u32, max_bitrate: u32) -\u003e Vec\u003c\u0026Format\u003e {\n    formats.iter()\n        .filter(|f| f.bitrate \u003e= min_bitrate \u0026\u0026 f.bitrate \u003c= max_bitrate)\n        .collect()\n}\n\n/// Sort formats by quality (best first)\npub fn sort_formats_by_quality(formats: \u0026mut [Format]) {\n    formats.sort_by(|a, b| {\n        // First by height (if available)\n        match (a.height, b.height) {\n            (Some(a_h), Some(b_h)) =\u003e b_h.cmp(\u0026a_h),\n            (Some(_), None) =\u003e std::cmp::Ordering::Less,\n            (None, Some(_)) =\u003e std::cmp::Ordering::Greater,\n            (None, None) =\u003e b.bitrate.cmp(\u0026a.bitrate),\n        }\n    });\n}\n\n/// Sort formats by bitrate (highest first)\npub fn sort_formats_by_bitrate(formats: \u0026mut [Format]) {\n    formats.sort_by(|a, b| b.bitrate.cmp(\u0026a.bitrate));\n}\n\n/// Sort formats by size (largest first)\npub fn sort_formats_by_size(formats: \u0026mut [Format]) {\n    formats.sort_by(|a, b| {\n        match (a.size, b.size) {\n            (Some(a_s), Some(b_s)) =\u003e b_s.cmp(\u0026a_s),\n            (Some(_), None) =\u003e std::cmp::Ordering::Less,\n            (None, Some(_)) =\u003e std::cmp::Ordering::Greater,\n            (None, None) =\u003e b.bitrate.cmp(\u0026a.bitrate),\n        }\n    });\n}\n\n/// Filter formats by codec\npub fn filter_formats_by_codec\u003c'a\u003e(formats: \u0026'a [Format], codec: \u0026str) -\u003e Vec\u003c\u0026'a Format\u003e {\n    formats.iter()\n        .filter(|f| {\n            f.audio_codec.as_ref().map(|c| c.contains(codec)).unwrap_or(false) ||\n            f.video_codec.as_ref().map(|c| c.contains(codec)).unwrap_or(false)\n        })\n        .collect()\n}\n\n/// Get format statistics\npub fn get_format_stats(formats: \u0026[Format]) -\u003e FormatStats {\n    let mut stats = FormatStats::default();\n    \n    for format in formats {\n        stats.total_formats += 1;\n        stats.total_bitrate += format.bitrate;\n        \n        if let Some(size) = format.size {\n            stats.total_size += size;\n        }\n        \n        if format.is_progressive() {\n            stats.progressive_formats += 1;\n        }\n        \n        if format.is_video_only() {\n            stats.video_only_formats += 1;\n        }\n        \n        if format.is_audio_only() {\n            stats.audio_only_formats += 1;\n        }\n        \n        if let Some(height) = format.height {\n            if height \u003e stats.max_height {\n                stats.max_height = height;\n            }\n            if stats.min_height == 0 || height \u003c stats.min_height {\n                stats.min_height = height;\n            }\n        }\n        \n        if format.bitrate \u003e stats.max_bitrate {\n            stats.max_bitrate = format.bitrate;\n        }\n        \n        if stats.min_bitrate == 0 || format.bitrate \u003c stats.min_bitrate {\n            stats.min_bitrate = format.bitrate;\n        }\n    }\n    \n    if stats.total_formats \u003e 0 {\n        stats.avg_bitrate = stats.total_bitrate / stats.total_formats as u32;\n    }\n    \n    stats\n}\n\n/// Format statistics\n#[derive(Debug, Default)]\npub struct FormatStats {\n    pub total_formats: usize,\n    pub progressive_formats: usize,\n    pub video_only_formats: usize,\n    pub audio_only_formats: usize,\n    pub total_bitrate: u32,\n    pub avg_bitrate: u32,\n    pub max_bitrate: u32,\n    pub min_bitrate: u32,\n    pub total_size: u64,\n    pub max_height: u32,\n    pub min_height: u32,\n}\n\nimpl FormatStats {\n    /// Get human-readable total size\n    pub fn total_size_string(\u0026self) -\u003e String {\n        crate::core::progress::format_bytes(self.total_size)\n    }\n    \n    /// Get human-readable average bitrate\n    pub fn avg_bitrate_string(\u0026self) -\u003e String {\n        if self.avg_bitrate \u003e 0 {\n            format!(\"{} kbps\", self.avg_bitrate / 1000)\n        } else {\n            \"Unknown\".to_string()\n        }\n    }\n    \n    /// Get human-readable max bitrate\n    pub fn max_bitrate_string(\u0026self) -\u003e String {\n        if self.max_bitrate \u003e 0 {\n            format!(\"{} kbps\", self.max_bitrate / 1000)\n        } else {\n            \"Unknown\".to_string()\n        }\n    }\n    \n    /// Get human-readable min bitrate\n    pub fn min_bitrate_string(\u0026self) -\u003e String {\n        if self.min_bitrate \u003e 0 {\n            format!(\"{} kbps\", self.min_bitrate / 1000)\n        } else {\n            \"Unknown\".to_string()\n        }\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use crate::core::video_info::Format;\n\n    fn create_test_formats() -\u003e Vec\u003cFormat\u003e {\n        vec![\n            Format {\n                itag: 22,\n                url: \"http://example.com/22\".to_string(),\n                quality: \"720p\".to_string(),\n                mime_type: \"video/mp4\".to_string(),\n                bitrate: 2000000,\n                size: Some(100000000),\n                signature_cipher: None,\n                audio_codec: Some(\"aac\".to_string()),\n                video_codec: Some(\"avc1\".to_string()),\n                fps: Some(30),\n                width: Some(1280),\n                height: Some(720),\n                audio_sample_rate: Some(44100),\n                audio_channels: Some(2),\n                language: None,\n                note: None,\n            },\n            Format {\n                itag: 18,\n                url: \"http://example.com/18\".to_string(),\n                quality: \"360p\".to_string(),\n                mime_type: \"video/mp4\".to_string(),\n                bitrate: 1000000,\n                size: Some(50000000),\n                signature_cipher: None,\n                audio_codec: Some(\"aac\".to_string()),\n                video_codec: Some(\"avc1\".to_string()),\n                fps: Some(30),\n                width: Some(640),\n                height: Some(360),\n                audio_sample_rate: Some(44100),\n                audio_channels: Some(2),\n                language: None,\n                note: None,\n            },\n            Format {\n                itag: 137,\n                url: \"http://example.com/137\".to_string(),\n                quality: \"1080p\".to_string(),\n                mime_type: \"video/mp4\".to_string(),\n                bitrate: 5000000,\n                size: Some(200000000),\n                signature_cipher: None,\n                audio_codec: None,\n                video_codec: Some(\"avc1\".to_string()),\n                fps: Some(30),\n                width: Some(1920),\n                height: Some(1080),\n                audio_sample_rate: None,\n                audio_channels: None,\n                language: None,\n                note: None,\n            },\n        ]\n    }\n\n    #[test]\n    fn test_select_format_best() {\n        let formats = create_test_formats();\n        let selector = FormatSelector::new(QualitySelector::Best);\n        \n        let selected = select_format(\u0026formats, \u0026selector).unwrap();\n        assert_eq!(selected.itag, 22); // Best progressive format\n    }\n\n    #[test]\n    fn test_select_format_worst() {\n        let formats = create_test_formats();\n        let selector = FormatSelector::new(QualitySelector::Worst);\n        \n        let selected = select_format(\u0026formats, \u0026selector).unwrap();\n        assert_eq!(selected.itag, 18); // Worst progressive format\n    }\n\n    #[test]\n    fn test_select_format_itag() {\n        let formats = create_test_formats();\n        let selector = FormatSelector::new(QualitySelector::Itag(137));\n        \n        let selected = select_format(\u0026formats, \u0026selector).unwrap();\n        assert_eq!(selected.itag, 137);\n    }\n\n    #[test]\n    fn test_select_format_height_limit() {\n        let formats = create_test_formats();\n        let selector = FormatSelector::new(QualitySelector::Best)\n            .with_height_limit(720);\n        \n        let selected = select_format(\u0026formats, \u0026selector).unwrap();\n        assert!(selected.height.unwrap_or(0) \u003c= 720);\n    }\n\n    #[test]\n    fn test_get_best_progressive_format() {\n        let formats = create_test_formats();\n        let best = get_best_progressive_format(\u0026formats).unwrap();\n        assert_eq!(best.itag, 22);\n    }\n\n    #[test]\n    fn test_get_best_video_format() {\n        let formats = create_test_formats();\n        let best = get_best_video_format(\u0026formats).unwrap();\n        assert_eq!(best.itag, 137);\n    }\n\n    #[test]\n    fn test_get_format_stats() {\n        let formats = create_test_formats();\n        let stats = get_format_stats(\u0026formats);\n        \n        assert_eq!(stats.total_formats, 3);\n        assert_eq!(stats.progressive_formats, 2);\n        assert_eq!(stats.video_only_formats, 1);\n        assert_eq!(stats.audio_only_formats, 0);\n        assert_eq!(stats.max_height, 1080);\n        assert_eq!(stats.min_height, 360);\n        assert_eq!(stats.max_bitrate, 5000000);\n        assert_eq!(stats.min_bitrate, 1000000);\n    }\n}\n","traces":[{"line":7,"address":[],"length":0,"stats":{"Line":4}},{"line":8,"address":[],"length":0,"stats":{"Line":20}},{"line":11,"address":[],"length":0,"stats":{"Line":4}},{"line":12,"address":[],"length":0,"stats":{"Line":0}},{"line":16,"address":[],"length":0,"stats":{"Line":5}},{"line":17,"address":[],"length":0,"stats":{"Line":3}},{"line":18,"address":[],"length":0,"stats":{"Line":6}},{"line":19,"address":[],"length":0,"stats":{"Line":0}},{"line":21,"address":[],"length":0,"stats":{"Line":0}},{"line":26,"address":[],"length":0,"stats":{"Line":4}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":28,"address":[],"length":0,"stats":{"Line":0}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":37,"address":[],"length":0,"stats":{"Line":4}},{"line":38,"address":[],"length":0,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":8}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":47,"address":[],"length":0,"stats":{"Line":0}},{"line":49,"address":[],"length":0,"stats":{"Line":8}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":53,"address":[],"length":0,"stats":{"Line":0}},{"line":54,"address":[],"length":0,"stats":{"Line":0}},{"line":56,"address":[],"length":0,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":8}},{"line":58,"address":[],"length":0,"stats":{"Line":1}},{"line":60,"address":[],"length":0,"stats":{"Line":1}},{"line":61,"address":[],"length":0,"stats":{"Line":1}},{"line":62,"address":[],"length":0,"stats":{"Line":7}},{"line":64,"address":[],"length":0,"stats":{"Line":2}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":67,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":71,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":74,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":1}},{"line":92,"address":[],"length":0,"stats":{"Line":2}},{"line":93,"address":[],"length":0,"stats":{"Line":7}},{"line":94,"address":[],"length":0,"stats":{"Line":1}},{"line":98,"address":[],"length":0,"stats":{"Line":1}},{"line":99,"address":[],"length":0,"stats":{"Line":2}},{"line":100,"address":[],"length":0,"stats":{"Line":7}},{"line":101,"address":[],"length":0,"stats":{"Line":1}},{"line":105,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":108,"address":[],"length":0,"stats":{"Line":0}},{"line":112,"address":[],"length":0,"stats":{"Line":0}},{"line":113,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[],"length":0,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":129,"address":[],"length":0,"stats":{"Line":0}},{"line":130,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":139,"address":[],"length":0,"stats":{"Line":0}},{"line":140,"address":[],"length":0,"stats":{"Line":0}},{"line":141,"address":[],"length":0,"stats":{"Line":0}},{"line":146,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":149,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":152,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":159,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":165,"address":[],"length":0,"stats":{"Line":0}},{"line":166,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":169,"address":[],"length":0,"stats":{"Line":0}},{"line":170,"address":[],"length":0,"stats":{"Line":0}},{"line":176,"address":[],"length":0,"stats":{"Line":0}},{"line":177,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":186,"address":[],"length":0,"stats":{"Line":1}},{"line":187,"address":[],"length":0,"stats":{"Line":2}},{"line":189,"address":[],"length":0,"stats":{"Line":7}},{"line":193,"address":[],"length":0,"stats":{"Line":3}},{"line":197,"address":[],"length":0,"stats":{"Line":2}},{"line":198,"address":[],"length":0,"stats":{"Line":2}},{"line":201,"address":[],"length":0,"stats":{"Line":1}},{"line":202,"address":[],"length":0,"stats":{"Line":1}},{"line":205,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":3}},{"line":210,"address":[],"length":0,"stats":{"Line":2}},{"line":211,"address":[],"length":0,"stats":{"Line":2}},{"line":213,"address":[],"length":0,"stats":{"Line":4}},{"line":214,"address":[],"length":0,"stats":{"Line":2}},{"line":218,"address":[],"length":0,"stats":{"Line":2}},{"line":219,"address":[],"length":0,"stats":{"Line":2}},{"line":222,"address":[],"length":0,"stats":{"Line":4}},{"line":223,"address":[],"length":0,"stats":{"Line":2}},{"line":227,"address":[],"length":0,"stats":{"Line":2}},{"line":228,"address":[],"length":0,"stats":{"Line":1}},{"line":231,"address":[],"length":0,"stats":{"Line":1}},{"line":252,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":268,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":275,"address":[],"length":0,"stats":{"Line":0}},{"line":276,"address":[],"length":0,"stats":{"Line":0}},{"line":277,"address":[],"length":0,"stats":{"Line":0}},{"line":279,"address":[],"length":0,"stats":{"Line":0}}],"covered":44,"coverable":130},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","platform","innertube.rs"],"content":"//! InnerTube API client for video platform\n\nuse crate::error::RytError;\nuse crate::platform::client::VideoClient;\nuse crate::core::video_info::{Format, PlaylistItem};\nuse serde::Deserialize;\nuse tracing::{info, debug, warn};\nuse regex::Regex;\n\n/// InnerTube API client\npub struct InnerTubeClient {\n    http_client: VideoClient,\n    client_name: String,\n    client_version: String,\n    api_key: Option\u003cString\u003e,\n    visitor_id: Option\u003cString\u003e,\n}\n\nimpl InnerTubeClient {\n    /// Create a new InnerTube client\n    pub fn new() -\u003e Self {\n        Self {\n            http_client: VideoClient::new(),\n            client_name: \"ANDROID\".to_string(),  // ANDROID gives direct URLs\n            client_version: \"20.10.38\".to_string(),\n            api_key: None,\n            visitor_id: None,\n        }\n    }\n\n    /// Set client name and version\n    pub fn with_client(mut self, name: \u0026str, version: \u0026str) -\u003e Self {\n        self.client_name = name.to_string();\n        self.client_version = version.to_string();\n        self\n    }\n\n    /// Set visitor ID\n    pub fn with_visitor_id(mut self, visitor_id: \u0026str) -\u003e Self {\n        self.visitor_id = Some(visitor_id.to_string());\n        self\n    }\n    \n    /// Switch client for error handling\n    pub fn switch_client_for_error(\u0026mut self, error: \u0026RytError) {\n        self.http_client.switch_client_by_strategy(Some(error));\n    }\n\n    /// Extract API key and client version from YouTube HTML\n    async fn ensure_api_key(\u0026mut self, video_id: \u0026str) -\u003e Result\u003c(), RytError\u003e {\n        if self.api_key.is_some() {\n            return Ok(());\n        }\n\n        info!(\"Extracting API key and client version from YouTube HTML\");\n\n        // Try multiple sources for API key and client version\n        let sources = vec![\n            format!(\"https://www.youtube.com/watch?v={}\", video_id),\n            \"https://www.youtube.com\".to_string(),\n            \"https://www.youtube.com/feed/trending\".to_string(),\n            \"https://www.youtube.com/feed/explore\".to_string(),\n        ];\n\n        let api_key_regex = Regex::new(r#\"\"INNERTUBE_API_KEY\":\"([^\"]+)\"\"#)?;\n        let client_ver_regex = Regex::new(r#\"\"INNERTUBE_CLIENT_VERSION\":\"([^\"]+)\"\"#)?;\n\n        for source in sources {\n            if self.api_key.is_some() {\n                break;\n            }\n\n            debug!(\"Trying to extract API key from: {}\", source);\n\n            let response = self.http_client\n                .create_realistic_request(reqwest::Method::GET, \u0026source)\n                .send()\n                .await?;\n\n            if !response.status().is_success() {\n                warn!(\"Failed to fetch {}: {}\", source, response.status());\n                continue;\n            }\n\n            let body = response.text().await?;\n\n            // Extract API key if not found yet\n            if self.api_key.is_none() {\n                if let Some(captures) = api_key_regex.captures(\u0026body) {\n                    if let Some(api_key) = captures.get(1) {\n                        self.api_key = Some(api_key.as_str().to_string());\n                        info!(\"Extracted API key: {}...\", \u0026api_key.as_str()[..10]);\n                    }\n                }\n            }\n\n            // Extract client version if not found yet\n            if let Some(captures) = client_ver_regex.captures(\u0026body) {\n                if let Some(client_ver) = captures.get(1) {\n                    self.client_version = client_ver.as_str().to_string();\n                    info!(\"Extracted client version: {}\", client_ver.as_str());\n                }\n            }\n        }\n\n        if self.api_key.is_none() {\n            return Err(RytError::ApiKeyNotFound);\n        }\n\n        Ok(())\n    }\n\n    /// Get player response for a video\n    pub async fn get_player_response(\u0026mut self, video_id: \u0026str) -\u003e Result\u003cPlayerResponse, RytError\u003e {\n        info!(\"Fetching player response for video ID: {}\", video_id);\n        \n        // Ensure we have an API key\n        self.ensure_api_key(video_id).await?;\n        \n        // Build client context based on client type\n        let client_context = if self.client_name == \"ANDROID\" {\n            serde_json::json!({\n                \"clientName\": \"ANDROID\",\n                \"clientVersion\": \"20.10.38\",\n                \"androidSdkVersion\": 30,\n                \"osName\": \"Android\",\n                \"osVersion\": \"11\",\n                \"userAgent\": \"com.google.android.youtube/20.10.38 (Linux; U; Android 11) gzip\"\n            })\n        } else {\n            serde_json::json!({\n                \"clientName\": self.client_name,\n                \"clientVersion\": self.client_version,\n                \"userAgent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36\",\n                \"mainAppWebInfo\": {\n                    \"graftUrl\": format!(\"https://www.youtube.com/watch?v={}\", video_id),\n                    \"webDisplayMode\": \"WEB_DISPLAY_MODE_BROWSER\",\n                    \"isWebNativeShareEnabled\": true\n                }\n            })\n        };\n\n        let request_body = serde_json::json!({\n            \"context\": {\n                \"client\": client_context\n            },\n            \"videoId\": video_id\n        });\n\n        let api_key = self.api_key.as_ref().unwrap();\n        let url = format!(\"https://www.youtube.com/youtubei/v1/player?key={}\", api_key);\n        \n        debug!(\"Using API key: {}...\", \u0026api_key[..10]);\n        debug!(\"Request URL: {}\", url);\n        debug!(\"Request body: {}\", serde_json::to_string_pretty(\u0026request_body).unwrap_or_default());\n        \n        let mut request = self.http_client.create_innertube_request(\u0026url);\n\n        // Add Android-specific headers\n        if self.client_name == \"ANDROID\" {\n            request = request\n                .header(\"X-YouTube-Client-Name\", \"3\")\n                .header(\"X-YouTube-Client-Version\", \"20.10.38\")\n                .header(\"User-Agent\", \"com.google.android.youtube/20.10.38 (Linux; U; Android 11) gzip\");\n        }\n\n        if let Some(visitor_id) = \u0026self.visitor_id {\n            request = request.header(\"x-goog-visitor-id\", visitor_id);\n        }\n\n        let response: PlayerResponse = self.http_client.execute_with_retry(\n            request.json(\u0026request_body)\n        ).await?;\n\n        debug!(\"Player response received successfully\");\n        \n        // Check playability status\n        if let Some(playability_status) = \u0026response.playability_status {\n            match playability_status.status.as_str() {\n            \"ERROR\" =\u003e {\n                if let Some(reason) = \u0026playability_status.reason {\n                    warn!(\"Video playability error: {}\", reason);\n                    let reason_lower = reason.to_lowercase();\n                    if reason_lower.contains(\"geograph\") || reason_lower.contains(\"available in your country\") {\n                        return Err(RytError::GeoBlocked);\n                    }\n                    if reason_lower.contains(\"rate limit\") || reason_lower.contains(\"quota\") {\n                        return Err(RytError::RateLimited);\n                    }\n                    Err(RytError::VideoUnavailable)\n                } else {\n                    warn!(\"Video playability error: unknown reason\");\n                    Err(RytError::VideoUnavailable)\n                }\n            }\n            \"LOGIN_REQUIRED\" =\u003e {\n                warn!(\"Age restriction detected, this may require client switching\");\n                Err(RytError::AgeRestricted)\n            },\n            \"UNPLAYABLE\" =\u003e {\n                if let Some(reason) = \u0026playability_status.reason {\n                    let reason_lower = reason.to_lowercase();\n                    if reason_lower.contains(\"private\") {\n                        Err(RytError::Private)\n                    } else {\n                        Err(RytError::VideoUnavailable)\n                    }\n                } else {\n                    Err(RytError::VideoUnavailable)\n                }\n            }\n            _ =\u003e Ok(response),\n            }\n        } else {\n            // No playability status, assume OK\n            Ok(response)\n        }\n    }\n\n    /// Get playlist items\n    pub async fn get_playlist_items(\u0026mut self, playlist_id: \u0026str, limit: Option\u003cusize\u003e) -\u003e Result\u003cVec\u003cPlaylistItem\u003e, RytError\u003e {\n        let request_body = serde_json::json!({\n            \"context\": {\n                \"client\": {\n                    \"clientName\": self.client_name,\n                    \"clientVersion\": self.client_version,\n                    \"androidSdkVersion\": 30,\n                    \"osName\": \"Android\",\n                    \"osVersion\": \"11\",\n                    \"deviceModel\": \"SM-G973F\",\n                    \"userAgent\": format!(\"com.google.android.youtube/{} (Linux; U; Android 11) gzip\", self.client_version),\n                    \"connectionType\": \"WIFI\",\n                    \"memoryTotalKb\": 4194304\n                }\n            },\n            \"browseId\": format!(\"VL{}\", playlist_id),\n            \"params\": \"6gPTAUNwc0RRUXh4Zz09\"\n        });\n\n        let mut request = self.http_client.create_innertube_request(\n            \"https://www.youtube.com/youtubei/v1/browse\"\n        );\n\n        if let Some(visitor_id) = \u0026self.visitor_id {\n            request = request.header(\"x-goog-visitor-id\", visitor_id);\n        }\n\n        let response: BrowseResponse = self.http_client.execute_with_retry(\n            request.json(\u0026request_body)\n        ).await?;\n\n        // Parse playlist items from response\n        let mut items = Vec::new();\n        if let Some(contents) = response.contents.two_column_browse_results_renderer.tabs.first() {\n            if let Some(playlist) = \u0026contents.tab_renderer.content.section_list_renderer.contents.first() {\n                if let Some(items_renderer) = \u0026playlist.item_section_renderer.contents.first() {\n                    let playlist_video_list = \u0026items_renderer.playlist_video_list_renderer;\n                    for (index, content) in playlist_video_list.contents.iter().enumerate() {\n                        let video = \u0026content.playlist_video_renderer;\n                        items.push(PlaylistItem {\n                            video_id: video.video_id.clone(),\n                            title: video.title.runs.first().map(|r| r.text.clone()).unwrap_or_default(),\n                            author: video.short_byline_text.runs.first().map(|r| r.text.clone()).unwrap_or_default(),\n                            duration: video.length_seconds.parse().unwrap_or(0),\n                            index: index as u32,\n                            thumbnail: video.thumbnail.thumbnails.first().map(|t| t.url.clone()),\n                            description: None,\n                        });\n\n                        if let Some(limit) = limit {\n                            if items.len() \u003e= limit {\n                                break;\n                            }\n                        }\n                    }\n                }\n            }\n        }\n\n        Ok(items)\n    }\n\n    /// Get visitor ID from YouTube main page\n    pub async fn get_visitor_id(\u0026self) -\u003e Result\u003cString, RytError\u003e {\n        let response = self.http_client.create_request(\n            reqwest::Method::GET,\n            \"https://www.youtube.com\"\n        ).send().await?;\n\n        let html = response.text().await?;\n        \n        // Extract visitor ID from ytcfg\n        if let Some(start) = html.find(\"ytcfg.set(\") {\n            if let Some(end) = html[start..].find(\"});\") {\n                let config_str = \u0026html[start + 10..start + end + 1];\n                if let Ok(config) = serde_json::from_str::\u003cserde_json::Value\u003e(config_str) {\n                    if let Some(visitor_data) = config[\"INNERTUBE_CONTEXT\"][\"client\"][\"visitorData\"].as_str() {\n                        return Ok(visitor_data.to_string());\n                    }\n                }\n            }\n        }\n\n        Err(RytError::Generic(\"Failed to extract visitor ID\".to_string()))\n    }\n}\n\nimpl Default for InnerTubeClient {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n/// Player response from InnerTube API\n#[derive(Debug, Deserialize)]\npub struct PlayerResponse {\n    #[serde(rename = \"responseContext\")]\n    pub response_context: Option\u003cResponseContext\u003e,\n    #[serde(rename = \"playabilityStatus\")]\n    pub playability_status: Option\u003cPlayabilityStatus\u003e,\n    #[serde(rename = \"videoDetails\")]\n    pub video_details: Option\u003cVideoDetails\u003e,\n    #[serde(rename = \"streamingData\")]\n    pub streaming_data: Option\u003cStreamingData\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct ResponseContext {\n    #[serde(rename = \"visitorData\")]\n    pub visitor_data: Option\u003cString\u003e,\n    #[serde(rename = \"serviceTrackingParams\")]\n    pub service_tracking_params: Option\u003cVec\u003cServiceTrackingParam\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct ServiceTrackingParam {\n    pub service: String,\n    #[serde(rename = \"params\")]\n    pub params: Vec\u003cParam\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct Param {\n    pub key: String,\n    pub value: String,\n}\n\n#[derive(Debug, Deserialize)]\npub struct PlayabilityStatus {\n    pub status: String,\n    pub reason: Option\u003cString\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct VideoDetails {\n    #[serde(rename = \"videoId\")]\n    pub video_id: String,\n    pub title: String,\n    pub author: String,\n    #[serde(rename = \"lengthSeconds\")]\n    pub length_seconds: String,\n    #[serde(rename = \"shortDescription\")]\n    pub short_description: String,\n    pub thumbnail: Thumbnail,\n}\n\n#[derive(Debug, Deserialize)]\npub struct Thumbnail {\n    pub thumbnails: Vec\u003cThumbnailInfo\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct ThumbnailInfo {\n    pub url: String,\n    pub width: u32,\n    pub height: u32,\n}\n\n#[derive(Debug, Deserialize)]\npub struct StreamingData {\n    pub formats: Option\u003cVec\u003cFormatData\u003e\u003e,\n    #[serde(rename = \"adaptiveFormats\")]\n    pub adaptive_formats: Option\u003cVec\u003cFormatData\u003e\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct FormatData {\n    pub itag: u32,\n    pub url: Option\u003cString\u003e,\n    #[serde(rename = \"mimeType\")]\n    pub mime_type: String,\n    pub bitrate: Option\u003cu32\u003e,\n    pub width: Option\u003cu32\u003e,\n    pub height: Option\u003cu32\u003e,\n    #[serde(rename = \"qualityLabel\")]\n    pub quality_label: Option\u003cString\u003e,\n    #[serde(rename = \"contentLength\")]\n    pub content_length: Option\u003cString\u003e,\n    #[serde(rename = \"signatureCipher\")]\n    pub signature_cipher: Option\u003cString\u003e,\n    #[serde(rename = \"audioCodec\")]\n    pub audio_codec: Option\u003cString\u003e,\n    #[serde(rename = \"videoCodec\")]\n    pub video_codec: Option\u003cString\u003e,\n    pub fps: Option\u003cu32\u003e,\n    #[serde(rename = \"audioSampleRate\")]\n    pub audio_sample_rate: Option\u003cserde_json::Value\u003e,\n    #[serde(rename = \"audioChannels\")]\n    pub audio_channels: Option\u003cserde_json::Value\u003e,\n}\n\nimpl PlayerResponse {\n    /// Parse formats from player response\n    pub fn parse_formats(\u0026self) -\u003e Result\u003cVec\u003cFormat\u003e, RytError\u003e {\n        let mut formats = Vec::new();\n\n        // Parse progressive formats\n        if let Some(streaming_data) = \u0026self.streaming_data {\n            if let Some(formats_data) = \u0026streaming_data.formats {\n            for format_data in formats_data {\n                formats.push(Format {\n                    itag: format_data.itag,\n                    url: format_data.url.clone().unwrap_or_default(),\n                    quality: format_data.quality_label.clone().unwrap_or_default(),\n                    mime_type: format_data.mime_type.clone(),\n                    bitrate: format_data.bitrate.unwrap_or(0),\n                    size: format_data.content_length.as_ref().and_then(|s| s.parse().ok()),\n                    signature_cipher: format_data.signature_cipher.clone(),\n                    audio_codec: format_data.audio_codec.clone(),\n                    video_codec: format_data.video_codec.clone(),\n                    fps: format_data.fps,\n                    width: format_data.width,\n                    height: format_data.height,\n                    audio_sample_rate: format_data.audio_sample_rate.as_ref().and_then(|v| v.as_str().and_then(|s| s.parse().ok()).or_else(|| v.as_u64().map(|n| n as u32))),\n                    audio_channels: format_data.audio_channels.as_ref().and_then(|v| v.as_str().and_then(|s| s.parse().ok()).or_else(|| v.as_u64().map(|n| n as u32))),\n                    language: None,\n                    note: None,\n                });\n            }\n        }\n\n        // Parse adaptive formats\n            if let Some(adaptive_formats) = \u0026streaming_data.adaptive_formats {\n            for format_data in adaptive_formats {\n                formats.push(Format {\n                    itag: format_data.itag,\n                    url: format_data.url.clone().unwrap_or_default(),\n                    quality: format_data.quality_label.clone().unwrap_or_default(),\n                    mime_type: format_data.mime_type.clone(),\n                    bitrate: format_data.bitrate.unwrap_or(0),\n                    size: format_data.content_length.as_ref().and_then(|s| s.parse().ok()),\n                    signature_cipher: format_data.signature_cipher.clone(),\n                    audio_codec: format_data.audio_codec.clone(),\n                    video_codec: format_data.video_codec.clone(),\n                    fps: format_data.fps,\n                    width: format_data.width,\n                    height: format_data.height,\n                    audio_sample_rate: format_data.audio_sample_rate.as_ref().and_then(|v| v.as_str().and_then(|s| s.parse().ok()).or_else(|| v.as_u64().map(|n| n as u32))),\n                    audio_channels: format_data.audio_channels.as_ref().and_then(|v| v.as_str().and_then(|s| s.parse().ok()).or_else(|| v.as_u64().map(|n| n as u32))),\n                    language: None,\n                    note: None,\n                });\n            }\n        }\n        }\n\n        // If no formats found, return error\n        if formats.is_empty() {\n            return Err(RytError::NoFormatFound);\n        }\n\n        Ok(formats)\n    }\n}\n\n/// Browse response for playlists\n#[derive(Debug, Deserialize)]\npub struct BrowseResponse {\n    pub contents: BrowseContents,\n}\n\n#[derive(Debug, Deserialize)]\npub struct BrowseContents {\n    pub two_column_browse_results_renderer: TwoColumnBrowseResultsRenderer,\n}\n\n#[derive(Debug, Deserialize)]\npub struct TwoColumnBrowseResultsRenderer {\n    pub tabs: Vec\u003cTab\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct Tab {\n    pub tab_renderer: TabRenderer,\n}\n\n#[derive(Debug, Deserialize)]\npub struct TabRenderer {\n    pub content: TabContent,\n}\n\n#[derive(Debug, Deserialize)]\npub struct TabContent {\n    pub section_list_renderer: SectionListRenderer,\n}\n\n#[derive(Debug, Deserialize)]\npub struct SectionListRenderer {\n    pub contents: Vec\u003cSectionContent\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct SectionContent {\n    pub item_section_renderer: ItemSectionRenderer,\n}\n\n#[derive(Debug, Deserialize)]\npub struct ItemSectionRenderer {\n    pub contents: Vec\u003cItemContent\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct ItemContent {\n    pub playlist_video_list_renderer: PlaylistVideoListRenderer,\n}\n\n#[derive(Debug, Deserialize)]\npub struct PlaylistVideoListRenderer {\n    pub contents: Vec\u003cPlaylistVideoContent\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct PlaylistVideoContent {\n    pub playlist_video_renderer: PlaylistVideoRenderer,\n}\n\n#[derive(Debug, Deserialize)]\npub struct PlaylistVideoRenderer {\n    pub video_id: String,\n    pub title: Title,\n    pub short_byline_text: BylineText,\n    pub length_seconds: String,\n    pub thumbnail: Thumbnail,\n}\n\n#[derive(Debug, Deserialize)]\npub struct Title {\n    pub runs: Vec\u003cTextRun\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct BylineText {\n    pub runs: Vec\u003cTextRun\u003e,\n}\n\n#[derive(Debug, Deserialize)]\npub struct TextRun {\n    pub text: String,\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_innertube_client_creation() {\n        let client = InnerTubeClient::new();\n        assert_eq!(client.client_name, \"ANDROID\");\n        assert_eq!(client.client_version, \"20.10.38\");\n    }\n\n    #[test]\n    fn test_innertube_client_with_client() {\n        let client = InnerTubeClient::new()\n            .with_client(\"WEB\", \"2.20250312.04.00\");\n        \n        assert_eq!(client.client_name, \"WEB\");\n        assert_eq!(client.client_version, \"2.20250312.04.00\");\n    }\n\n    #[test]\n    fn test_innertube_client_with_visitor_id() {\n        let client = InnerTubeClient::new()\n            .with_visitor_id(\"test_visitor_id\");\n        \n        assert_eq!(client.visitor_id, Some(\"test_visitor_id\".to_string()));\n    }\n}\n","traces":[{"line":21,"address":[],"length":0,"stats":{"Line":6}},{"line":23,"address":[],"length":0,"stats":{"Line":12}},{"line":24,"address":[],"length":0,"stats":{"Line":18}},{"line":25,"address":[],"length":0,"stats":{"Line":18}},{"line":32,"address":[],"length":0,"stats":{"Line":1}},{"line":33,"address":[],"length":0,"stats":{"Line":3}},{"line":34,"address":[],"length":0,"stats":{"Line":3}},{"line":35,"address":[],"length":0,"stats":{"Line":1}},{"line":39,"address":[],"length":0,"stats":{"Line":1}},{"line":40,"address":[],"length":0,"stats":{"Line":2}},{"line":41,"address":[],"length":0,"stats":{"Line":1}},{"line":45,"address":[],"length":0,"stats":{"Line":0}},{"line":46,"address":[],"length":0,"stats":{"Line":0}},{"line":50,"address":[],"length":0,"stats":{"Line":0}},{"line":51,"address":[],"length":0,"stats":{"Line":0}},{"line":52,"address":[],"length":0,"stats":{"Line":0}},{"line":55,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[],"length":0,"stats":{"Line":0}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":65,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":0}},{"line":69,"address":[],"length":0,"stats":{"Line":0}},{"line":70,"address":[],"length":0,"stats":{"Line":0}},{"line":73,"address":[],"length":0,"stats":{"Line":0}},{"line":75,"address":[],"length":0,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[],"length":0,"stats":{"Line":0}},{"line":81,"address":[],"length":0,"stats":{"Line":0}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":85,"address":[],"length":0,"stats":{"Line":0}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":0}},{"line":99,"address":[],"length":0,"stats":{"Line":0}},{"line":100,"address":[],"length":0,"stats":{"Line":0}},{"line":101,"address":[],"length":0,"stats":{"Line":0}},{"line":106,"address":[],"length":0,"stats":{"Line":0}},{"line":107,"address":[],"length":0,"stats":{"Line":0}},{"line":110,"address":[],"length":0,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":123,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[],"length":0,"stats":{"Line":0}},{"line":125,"address":[],"length":0,"stats":{"Line":0}},{"line":126,"address":[],"length":0,"stats":{"Line":0}},{"line":127,"address":[],"length":0,"stats":{"Line":0}},{"line":128,"address":[],"length":0,"stats":{"Line":0}},{"line":131,"address":[],"length":0,"stats":{"Line":0}},{"line":132,"address":[],"length":0,"stats":{"Line":0}},{"line":133,"address":[],"length":0,"stats":{"Line":0}},{"line":134,"address":[],"length":0,"stats":{"Line":0}},{"line":135,"address":[],"length":0,"stats":{"Line":0}},{"line":136,"address":[],"length":0,"stats":{"Line":0}},{"line":137,"address":[],"length":0,"stats":{"Line":0}},{"line":138,"address":[],"length":0,"stats":{"Line":0}},{"line":143,"address":[],"length":0,"stats":{"Line":0}},{"line":144,"address":[],"length":0,"stats":{"Line":0}},{"line":145,"address":[],"length":0,"stats":{"Line":0}},{"line":147,"address":[],"length":0,"stats":{"Line":0}},{"line":150,"address":[],"length":0,"stats":{"Line":0}},{"line":151,"address":[],"length":0,"stats":{"Line":0}},{"line":153,"address":[],"length":0,"stats":{"Line":0}},{"line":154,"address":[],"length":0,"stats":{"Line":0}},{"line":155,"address":[],"length":0,"stats":{"Line":0}},{"line":157,"address":[],"length":0,"stats":{"Line":0}},{"line":160,"address":[],"length":0,"stats":{"Line":0}},{"line":161,"address":[],"length":0,"stats":{"Line":0}},{"line":162,"address":[],"length":0,"stats":{"Line":0}},{"line":163,"address":[],"length":0,"stats":{"Line":0}},{"line":164,"address":[],"length":0,"stats":{"Line":0}},{"line":167,"address":[],"length":0,"stats":{"Line":0}},{"line":168,"address":[],"length":0,"stats":{"Line":0}},{"line":171,"address":[],"length":0,"stats":{"Line":0}},{"line":172,"address":[],"length":0,"stats":{"Line":0}},{"line":175,"address":[],"length":0,"stats":{"Line":0}},{"line":178,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":0}},{"line":180,"address":[],"length":0,"stats":{"Line":0}},{"line":181,"address":[],"length":0,"stats":{"Line":0}},{"line":182,"address":[],"length":0,"stats":{"Line":0}},{"line":183,"address":[],"length":0,"stats":{"Line":0}},{"line":184,"address":[],"length":0,"stats":{"Line":0}},{"line":185,"address":[],"length":0,"stats":{"Line":0}},{"line":187,"address":[],"length":0,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[],"length":0,"stats":{"Line":0}},{"line":193,"address":[],"length":0,"stats":{"Line":0}},{"line":196,"address":[],"length":0,"stats":{"Line":0}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":200,"address":[],"length":0,"stats":{"Line":0}},{"line":201,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":204,"address":[],"length":0,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":216,"address":[],"length":0,"stats":{"Line":0}},{"line":221,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":224,"address":[],"length":0,"stats":{"Line":0}},{"line":225,"address":[],"length":0,"stats":{"Line":0}},{"line":226,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":229,"address":[],"length":0,"stats":{"Line":0}},{"line":230,"address":[],"length":0,"stats":{"Line":0}},{"line":231,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":236,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":244,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":253,"address":[],"length":0,"stats":{"Line":0}},{"line":254,"address":[],"length":0,"stats":{"Line":0}},{"line":255,"address":[],"length":0,"stats":{"Line":0}},{"line":256,"address":[],"length":0,"stats":{"Line":0}},{"line":257,"address":[],"length":0,"stats":{"Line":0}},{"line":258,"address":[],"length":0,"stats":{"Line":0}},{"line":259,"address":[],"length":0,"stats":{"Line":0}},{"line":260,"address":[],"length":0,"stats":{"Line":0}},{"line":261,"address":[],"length":0,"stats":{"Line":0}},{"line":262,"address":[],"length":0,"stats":{"Line":0}},{"line":263,"address":[],"length":0,"stats":{"Line":0}},{"line":264,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}},{"line":267,"address":[],"length":0,"stats":{"Line":0}},{"line":270,"address":[],"length":0,"stats":{"Line":0}},{"line":271,"address":[],"length":0,"stats":{"Line":0}},{"line":272,"address":[],"length":0,"stats":{"Line":0}},{"line":280,"address":[],"length":0,"stats":{"Line":0}},{"line":284,"address":[],"length":0,"stats":{"Line":0}},{"line":285,"address":[],"length":0,"stats":{"Line":0}},{"line":286,"address":[],"length":0,"stats":{"Line":0}},{"line":290,"address":[],"length":0,"stats":{"Line":0}},{"line":293,"address":[],"length":0,"stats":{"Line":0}},{"line":294,"address":[],"length":0,"stats":{"Line":0}},{"line":295,"address":[],"length":0,"stats":{"Line":0}},{"line":296,"address":[],"length":0,"stats":{"Line":0}},{"line":297,"address":[],"length":0,"stats":{"Line":0}},{"line":298,"address":[],"length":0,"stats":{"Line":0}},{"line":304,"address":[],"length":0,"stats":{"Line":0}},{"line":309,"address":[],"length":0,"stats":{"Line":0}},{"line":310,"address":[],"length":0,"stats":{"Line":0}},{"line":414,"address":[],"length":0,"stats":{"Line":0}},{"line":415,"address":[],"length":0,"stats":{"Line":0}},{"line":418,"address":[],"length":0,"stats":{"Line":0}},{"line":419,"address":[],"length":0,"stats":{"Line":0}},{"line":420,"address":[],"length":0,"stats":{"Line":0}},{"line":421,"address":[],"length":0,"stats":{"Line":0}},{"line":422,"address":[],"length":0,"stats":{"Line":0}},{"line":423,"address":[],"length":0,"stats":{"Line":0}},{"line":424,"address":[],"length":0,"stats":{"Line":0}},{"line":425,"address":[],"length":0,"stats":{"Line":0}},{"line":426,"address":[],"length":0,"stats":{"Line":0}},{"line":427,"address":[],"length":0,"stats":{"Line":0}},{"line":428,"address":[],"length":0,"stats":{"Line":0}},{"line":429,"address":[],"length":0,"stats":{"Line":0}},{"line":430,"address":[],"length":0,"stats":{"Line":0}},{"line":431,"address":[],"length":0,"stats":{"Line":0}},{"line":432,"address":[],"length":0,"stats":{"Line":0}},{"line":433,"address":[],"length":0,"stats":{"Line":0}},{"line":434,"address":[],"length":0,"stats":{"Line":0}},{"line":435,"address":[],"length":0,"stats":{"Line":0}},{"line":436,"address":[],"length":0,"stats":{"Line":0}},{"line":437,"address":[],"length":0,"stats":{"Line":0}},{"line":443,"address":[],"length":0,"stats":{"Line":0}},{"line":444,"address":[],"length":0,"stats":{"Line":0}},{"line":445,"address":[],"length":0,"stats":{"Line":0}},{"line":446,"address":[],"length":0,"stats":{"Line":0}},{"line":447,"address":[],"length":0,"stats":{"Line":0}},{"line":448,"address":[],"length":0,"stats":{"Line":0}},{"line":449,"address":[],"length":0,"stats":{"Line":0}},{"line":450,"address":[],"length":0,"stats":{"Line":0}},{"line":451,"address":[],"length":0,"stats":{"Line":0}},{"line":452,"address":[],"length":0,"stats":{"Line":0}},{"line":453,"address":[],"length":0,"stats":{"Line":0}},{"line":454,"address":[],"length":0,"stats":{"Line":0}},{"line":455,"address":[],"length":0,"stats":{"Line":0}},{"line":456,"address":[],"length":0,"stats":{"Line":0}},{"line":457,"address":[],"length":0,"stats":{"Line":0}},{"line":458,"address":[],"length":0,"stats":{"Line":0}},{"line":459,"address":[],"length":0,"stats":{"Line":0}},{"line":460,"address":[],"length":0,"stats":{"Line":0}},{"line":461,"address":[],"length":0,"stats":{"Line":0}},{"line":468,"address":[],"length":0,"stats":{"Line":0}},{"line":469,"address":[],"length":0,"stats":{"Line":0}},{"line":472,"address":[],"length":0,"stats":{"Line":0}}],"covered":11,"coverable":207},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","platform","mod.rs"],"content":"//! Video platform API client and related functionality\n\npub mod client;\npub mod innertube;\npub mod formats;\npub mod cipher;\npub mod botguard;\n\npub use client::*;\npub use innertube::*;\npub use formats::*;\npub use cipher::*;\npub use botguard::*;\n\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","utils","cache.rs"],"content":"//! Caching utilities for ryt\n\nuse std::collections::HashMap;\nuse std::sync::{Arc, Mutex};\nuse std::time::{Duration, Instant};\nuse moka::future::Cache;\nuse serde::{Serialize, Deserialize};\n\n/// Simple in-memory cache with TTL\n#[derive(Clone)]\npub struct MemoryCache\u003cK, V\u003e {\n    cache: Arc\u003cMutex\u003cHashMap\u003cK, CachedValue\u003cV\u003e\u003e\u003e\u003e,\n}\n\n#[derive(Clone)]\nstruct CachedValue\u003cV\u003e {\n    value: V,\n    expires_at: Instant,\n}\n\nimpl\u003cK, V\u003e MemoryCache\u003cK, V\u003e\nwhere\n    K: std::hash::Hash + Eq + Clone + Send + Sync + 'static,\n    V: Clone + Send + Sync + 'static,\n{\n    pub fn new() -\u003e Self {\n        Self {\n            cache: Arc::new(Mutex::new(HashMap::new())),\n        }\n    }\n\n    pub fn get(\u0026self, key: \u0026K) -\u003e Option\u003cV\u003e {\n        let mut cache = self.cache.lock().unwrap();\n        if let Some(cached_value) = cache.get(key) {\n            if cached_value.expires_at \u003e Instant::now() {\n                return Some(cached_value.value.clone());\n            } else {\n                cache.remove(key);\n            }\n        }\n        None\n    }\n\n    pub fn insert(\u0026self, key: K, value: V, ttl: Duration) {\n        let mut cache = self.cache.lock().unwrap();\n        cache.insert(\n            key,\n            CachedValue {\n                value,\n                expires_at: Instant::now() + ttl,\n            },\n        );\n    }\n\n    pub fn remove(\u0026self, key: \u0026K) -\u003e Option\u003cV\u003e {\n        let mut cache = self.cache.lock().unwrap();\n        cache.remove(key).map(|cached_value| cached_value.value)\n    }\n\n    pub fn clear(\u0026self) {\n        let mut cache = self.cache.lock().unwrap();\n        cache.clear();\n    }\n\n    pub fn cleanup_expired(\u0026self) {\n        let mut cache = self.cache.lock().unwrap();\n        let now = Instant::now();\n        cache.retain(|_, cached_value| cached_value.expires_at \u003e now);\n    }\n}\n\nimpl\u003cK, V\u003e Default for MemoryCache\u003cK, V\u003e\nwhere\n    K: std::hash::Hash + Eq + Clone + Send + Sync + 'static,\n    V: Clone + Send + Sync + 'static,\n{\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n\n/// High-performance async cache using moka\npub type AsyncCache\u003cK, V\u003e = Cache\u003cK, V\u003e;\n\n/// Create a new async cache with TTL\npub fn new_async_cache\u003cK, V\u003e(ttl: Duration) -\u003e AsyncCache\u003cK, V\u003e\nwhere\n    K: std::hash::Hash + Eq + Clone + Send + Sync + 'static,\n    V: Clone + Send + Sync + 'static,\n{\n    Cache::builder()\n        .time_to_live(ttl)\n        .build()\n}\n\n/// Create a new async cache with TTL and max capacity\npub fn new_async_cache_with_capacity\u003cK, V\u003e(ttl: Duration, max_capacity: u64) -\u003e AsyncCache\u003cK, V\u003e\nwhere\n    K: std::hash::Hash + Eq + Clone + Send + Sync + 'static,\n    V: Clone + Send + Sync + 'static,\n{\n    Cache::builder()\n        .time_to_live(ttl)\n        .max_capacity(max_capacity)\n        .build()\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    use std::sync::Arc;\n    use std::thread;\n    use std::time::Duration;\n\n    #[test]\n    fn test_memory_cache() {\n        let cache = MemoryCache::new();\n        \n        // Test insert and get\n        cache.insert(\"key1\", \"value1\", Duration::from_secs(1));\n        assert_eq!(cache.get(\u0026\"key1\"), Some(\"value1\"));\n        \n        // Test expiration\n        thread::sleep(Duration::from_millis(1100));\n        assert_eq!(cache.get(\u0026\"key1\"), None);\n        \n        // Test remove\n        cache.insert(\"key2\", \"value2\", Duration::from_secs(10));\n        assert_eq!(cache.remove(\u0026\"key2\"), Some(\"value2\"));\n        assert_eq!(cache.get(\u0026\"key2\"), None);\n        \n        // Test clear\n        cache.insert(\"key3\", \"value3\", Duration::from_secs(10));\n        cache.clear();\n        assert_eq!(cache.get(\u0026\"key3\"), None);\n    }\n\n    #[test]\n    fn test_cleanup_expired() {\n        let cache = MemoryCache::new();\n        \n        cache.insert(\"key1\", \"value1\", Duration::from_millis(100));\n        cache.insert(\"key2\", \"value2\", Duration::from_secs(10));\n        \n        thread::sleep(Duration::from_millis(150));\n        cache.cleanup_expired();\n        \n        assert_eq!(cache.get(\u0026\"key1\"), None);\n        assert_eq!(cache.get(\u0026\"key2\"), Some(\"value2\"));\n    }\n\n    #[tokio::test]\n    async fn test_async_cache() {\n        let cache = new_async_cache(Duration::from_secs(1));\n        \n        cache.insert(\"key1\", \"value1\").await;\n        assert_eq!(cache.get(\u0026\"key1\").await, Some(\"value1\"));\n        \n        tokio::time::sleep(Duration::from_millis(1100)).await;\n        assert_eq!(cache.get(\u0026\"key1\").await, None);\n    }\n}\n\n/// Multi-level cache for YouTube data\n#[derive(Clone)]\npub struct MultiLevelCache {\n    /// Player.js cache (10 minutes)\n    player_js_cache: Arc\u003cCache\u003cString, String\u003e\u003e,\n    /// Signature cache (1 hour)\n    signature_cache: Arc\u003cCache\u003cString, String\u003e\u003e,\n    /// Visitor ID cache (10 hours)\n    visitor_id_cache: Arc\u003cCache\u003cString, String\u003e\u003e,\n    /// Botguard token cache (30 minutes)\n    botguard_cache: Arc\u003cCache\u003cString, String\u003e\u003e,\n}\n\nimpl MultiLevelCache {\n    /// Create a new multi-level cache\n    pub fn new() -\u003e Self {\n        Self {\n            player_js_cache: Arc::new(Cache::builder()\n                .time_to_live(Duration::from_secs(600)) // 10 minutes\n                .build()),\n            signature_cache: Arc::new(Cache::builder()\n                .time_to_live(Duration::from_secs(3600)) // 1 hour\n                .build()),\n            visitor_id_cache: Arc::new(Cache::builder()\n                .time_to_live(Duration::from_secs(36000)) // 10 hours\n                .build()),\n            botguard_cache: Arc::new(Cache::builder()\n                .time_to_live(Duration::from_secs(1800)) // 30 minutes\n                .build()),\n        }\n    }\n\n    /// Get player.js content\n    pub async fn get_player_js(\u0026self, url: \u0026str) -\u003e Option\u003cString\u003e {\n        self.player_js_cache.get(url).await\n    }\n\n    /// Set player.js content\n    pub async fn set_player_js(\u0026self, url: \u0026str, content: String) {\n        self.player_js_cache.insert(url.to_string(), content).await;\n    }\n\n    /// Get signature\n    pub async fn get_signature(\u0026self, signature: \u0026str) -\u003e Option\u003cString\u003e {\n        self.signature_cache.get(signature).await\n    }\n\n    /// Set signature\n    pub async fn set_signature(\u0026self, signature: \u0026str, deciphered: String) {\n        self.signature_cache.insert(signature.to_string(), deciphered).await;\n    }\n\n    /// Get visitor ID\n    pub async fn get_visitor_id(\u0026self, key: \u0026str) -\u003e Option\u003cString\u003e {\n        self.visitor_id_cache.get(key).await\n    }\n\n    /// Set visitor ID\n    pub async fn set_visitor_id(\u0026self, key: \u0026str, visitor_id: String) {\n        self.visitor_id_cache.insert(key.to_string(), visitor_id).await;\n    }\n\n    /// Get botguard token\n    pub async fn get_botguard_token(\u0026self, key: \u0026str) -\u003e Option\u003cString\u003e {\n        self.botguard_cache.get(key).await\n    }\n\n    /// Set botguard token\n    pub async fn set_botguard_token(\u0026self, key: \u0026str, token: String) {\n        self.botguard_cache.insert(key.to_string(), token).await;\n    }\n\n    /// Clear all caches\n    pub async fn clear_all(\u0026self) {\n        self.player_js_cache.invalidate_all();\n        self.signature_cache.invalidate_all();\n        self.visitor_id_cache.invalidate_all();\n        self.botguard_cache.invalidate_all();\n    }\n\n    /// Get cache statistics\n    pub fn get_stats(\u0026self) -\u003e CacheStats {\n        CacheStats {\n            player_js_entries: self.player_js_cache.entry_count(),\n            signature_entries: self.signature_cache.entry_count(),\n            visitor_id_entries: self.visitor_id_cache.entry_count(),\n            botguard_entries: self.botguard_cache.entry_count(),\n        }\n    }\n}\n\n/// Cache statistics\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct CacheStats {\n    pub player_js_entries: u64,\n    pub signature_entries: u64,\n    pub visitor_id_entries: u64,\n    pub botguard_entries: u64,\n}\n\nimpl Default for MultiLevelCache {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n","traces":[{"line":26,"address":[],"length":0,"stats":{"Line":5}},{"line":28,"address":[],"length":0,"stats":{"Line":10}},{"line":32,"address":[],"length":0,"stats":{"Line":6}},{"line":33,"address":[],"length":0,"stats":{"Line":18}},{"line":34,"address":[],"length":0,"stats":{"Line":15}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":36,"address":[],"length":0,"stats":{"Line":2}},{"line":38,"address":[],"length":0,"stats":{"Line":1}},{"line":41,"address":[],"length":0,"stats":{"Line":4}},{"line":44,"address":[],"length":0,"stats":{"Line":5}},{"line":45,"address":[],"length":0,"stats":{"Line":15}},{"line":46,"address":[],"length":0,"stats":{"Line":15}},{"line":47,"address":[],"length":0,"stats":{"Line":10}},{"line":48,"address":[],"length":0,"stats":{"Line":5}},{"line":49,"address":[],"length":0,"stats":{"Line":10}},{"line":50,"address":[],"length":0,"stats":{"Line":5}},{"line":55,"address":[],"length":0,"stats":{"Line":1}},{"line":56,"address":[],"length":0,"stats":{"Line":3}},{"line":57,"address":[],"length":0,"stats":{"Line":3}},{"line":60,"address":[],"length":0,"stats":{"Line":1}},{"line":61,"address":[],"length":0,"stats":{"Line":3}},{"line":62,"address":[],"length":0,"stats":{"Line":1}},{"line":65,"address":[],"length":0,"stats":{"Line":1}},{"line":66,"address":[],"length":0,"stats":{"Line":3}},{"line":67,"address":[],"length":0,"stats":{"Line":2}},{"line":68,"address":[],"length":0,"stats":{"Line":6}},{"line":77,"address":[],"length":0,"stats":{"Line":0}},{"line":78,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":4}},{"line":91,"address":[],"length":0,"stats":{"Line":4}},{"line":92,"address":[],"length":0,"stats":{"Line":8}},{"line":97,"address":[],"length":0,"stats":{"Line":0}},{"line":102,"address":[],"length":0,"stats":{"Line":0}},{"line":103,"address":[],"length":0,"stats":{"Line":0}},{"line":104,"address":[],"length":0,"stats":{"Line":0}},{"line":179,"address":[],"length":0,"stats":{"Line":3}},{"line":181,"address":[],"length":0,"stats":{"Line":9}},{"line":184,"address":[],"length":0,"stats":{"Line":9}},{"line":187,"address":[],"length":0,"stats":{"Line":9}},{"line":190,"address":[],"length":0,"stats":{"Line":9}},{"line":197,"address":[],"length":0,"stats":{"Line":0}},{"line":198,"address":[],"length":0,"stats":{"Line":0}},{"line":202,"address":[],"length":0,"stats":{"Line":0}},{"line":203,"address":[],"length":0,"stats":{"Line":0}},{"line":207,"address":[],"length":0,"stats":{"Line":0}},{"line":208,"address":[],"length":0,"stats":{"Line":0}},{"line":212,"address":[],"length":0,"stats":{"Line":0}},{"line":213,"address":[],"length":0,"stats":{"Line":0}},{"line":217,"address":[],"length":0,"stats":{"Line":0}},{"line":218,"address":[],"length":0,"stats":{"Line":0}},{"line":222,"address":[],"length":0,"stats":{"Line":0}},{"line":223,"address":[],"length":0,"stats":{"Line":0}},{"line":227,"address":[],"length":0,"stats":{"Line":0}},{"line":228,"address":[],"length":0,"stats":{"Line":0}},{"line":232,"address":[],"length":0,"stats":{"Line":0}},{"line":233,"address":[],"length":0,"stats":{"Line":0}},{"line":237,"address":[],"length":0,"stats":{"Line":0}},{"line":238,"address":[],"length":0,"stats":{"Line":0}},{"line":239,"address":[],"length":0,"stats":{"Line":0}},{"line":240,"address":[],"length":0,"stats":{"Line":0}},{"line":241,"address":[],"length":0,"stats":{"Line":0}},{"line":245,"address":[],"length":0,"stats":{"Line":0}},{"line":247,"address":[],"length":0,"stats":{"Line":0}},{"line":248,"address":[],"length":0,"stats":{"Line":0}},{"line":249,"address":[],"length":0,"stats":{"Line":0}},{"line":250,"address":[],"length":0,"stats":{"Line":0}},{"line":265,"address":[],"length":0,"stats":{"Line":0}},{"line":266,"address":[],"length":0,"stats":{"Line":0}}],"covered":33,"coverable":68},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","utils","filename.rs"],"content":"//! Safe filename generation utilities\n\nuse std::path::Path;\nuse regex::Regex;\n\n/// Convert a title to a safe filename by removing/replacing invalid characters\npub fn to_safe_filename(title: \u0026str, extension: \u0026str) -\u003e String {\n    // Remove or replace invalid characters for filenames\n    let invalid_chars = Regex::new(r#\"[\u003c\u003e:\"/\\\\|?*\\x00-\\x1f]\"#).unwrap();\n    let mut safe_title = invalid_chars.replace_all(title, \"_\").to_string();\n    \n    // Remove leading/trailing dots and spaces\n    safe_title = safe_title.trim_matches(|c: char| c == '.' || c == ' ').to_string();\n    \n    // Limit length (Windows has 255 char limit, be conservative)\n    if safe_title.len() \u003e 200 {\n        safe_title.truncate(200);\n        safe_title = safe_title.trim_end().to_string();\n    }\n    \n    // Ensure it's not empty\n    if safe_title.is_empty() {\n        safe_title = \"video\".to_string();\n    }\n    \n    // Add extension if provided\n    if !extension.is_empty() {\n        let ext = if extension.starts_with('.') {\n            extension.to_string()\n        } else {\n            format!(\".{}\", extension)\n        };\n        format!(\"{}{}\", safe_title, ext)\n    } else {\n        safe_title\n    }\n}\n\n/// Check if a filename is safe for the current filesystem\npub fn is_safe_filename(filename: \u0026str) -\u003e bool {\n    if filename.is_empty() || filename.len() \u003e 255 {\n        return false;\n    }\n    \n    // Check for invalid characters\n    let invalid_chars = Regex::new(r#\"[\u003c\u003e:\"/\\\\|?*\\x00-\\x1f]\"#).unwrap();\n    if invalid_chars.is_match(filename) {\n        return false;\n    }\n    \n    // Check for reserved names on Windows\n    let reserved_names = [\n        \"CON\", \"PRN\", \"AUX\", \"NUL\",\n        \"COM1\", \"COM2\", \"COM3\", \"COM4\", \"COM5\", \"COM6\", \"COM7\", \"COM8\", \"COM9\",\n        \"LPT1\", \"LPT2\", \"LPT3\", \"LPT4\", \"LPT5\", \"LPT6\", \"LPT7\", \"LPT8\", \"LPT9\",\n    ];\n    \n    if let Some(name_without_ext) = Path::new(filename).file_stem() {\n        if let Some(name_str) = name_without_ext.to_str() {\n            let upper_name = name_str.to_uppercase();\n            if reserved_names.contains(\u0026upper_name.as_str()) {\n                return false;\n            }\n        }\n    }\n    \n    // Check for leading/trailing dots or spaces\n    if filename.starts_with('.') || filename.ends_with('.') ||\n       filename.starts_with(' ') || filename.ends_with(' ') {\n        return false;\n    }\n    \n    true\n}\n\n/// Generate a unique filename by appending a number if the file already exists\npub fn generate_unique_filename(base_path: \u0026Path, filename: \u0026str) -\u003e std::io::Result\u003cString\u003e {\n    let mut counter = 1;\n    let mut final_filename = filename.to_string();\n    \n    while base_path.join(\u0026final_filename).exists() {\n        let path = Path::new(filename);\n        let stem = path.file_stem().unwrap_or_default();\n        let extension = path.extension().map(|ext| format!(\".{}\", ext.to_string_lossy())).unwrap_or_default();\n        \n        final_filename = format!(\"{} ({}){}\", stem.to_string_lossy(), counter, extension);\n        counter += 1;\n        \n        // Prevent infinite loop\n        if counter \u003e 10000 {\n            return Err(std::io::Error::new(\n                std::io::ErrorKind::AlreadyExists,\n                \"Too many files with similar names\"\n            ));\n        }\n    }\n    \n    Ok(final_filename)\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_to_safe_filename() {\n        assert_eq!(\n            to_safe_filename(\"Test Video: Title\", \"mp4\"),\n            \"Test Video_ Title.mp4\"\n        );\n        \n        assert_eq!(\n            to_safe_filename(\"Video with \u003cinvalid\u003e chars\", \"mp4\"),\n            \"Video with _invalid_ chars.mp4\"\n        );\n        \n        assert_eq!(\n            to_safe_filename(\"\", \"mp4\"),\n            \"video.mp4\"\n        );\n        \n        assert_eq!(\n            to_safe_filename(\"Very long title that exceeds the maximum length limit and should be truncated to prevent filesystem issues\", \"mp4\"),\n            \"Very long title that exceeds the maximum length limit and should be truncated to prevent filesystem issues.mp4\"\n        );\n    }\n\n    #[test]\n    fn test_is_safe_filename() {\n        assert!(is_safe_filename(\"normal_file.mp4\"));\n        assert!(is_safe_filename(\"video with spaces.mp4\"));\n        assert!(!is_safe_filename(\"file\u003cwith\u003einvalid:chars.mp4\"));\n        assert!(!is_safe_filename(\"\"));\n        assert!(!is_safe_filename(\".hidden_file.mp4\"));\n        // Note: \"file with trailing space .mp4\" is actually safe because the space is before the dot, not at the end\n        assert!(is_safe_filename(\"file with trailing space .mp4\"));\n        assert!(!is_safe_filename(\"file with trailing space .mp4 \"));\n    }\n\n    #[test]\n    fn test_generate_unique_filename() {\n        let temp_dir = std::env::temp_dir();\n        let base_path = \u0026temp_dir;\n        \n        // This test might fail if the temp directory has existing files\n        // In a real scenario, we'd use a dedicated test directory\n        let result = generate_unique_filename(base_path, \"test_file.mp4\");\n        assert!(result.is_ok());\n    }\n}\n","traces":[{"line":7,"address":[],"length":0,"stats":{"Line":4}},{"line":9,"address":[],"length":0,"stats":{"Line":16}},{"line":10,"address":[],"length":0,"stats":{"Line":16}},{"line":13,"address":[],"length":0,"stats":{"Line":28}},{"line":16,"address":[],"length":0,"stats":{"Line":4}},{"line":17,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":0}},{"line":22,"address":[],"length":0,"stats":{"Line":9}},{"line":23,"address":[],"length":0,"stats":{"Line":2}},{"line":27,"address":[],"length":0,"stats":{"Line":4}},{"line":28,"address":[],"length":0,"stats":{"Line":4}},{"line":29,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":4}},{"line":35,"address":[],"length":0,"stats":{"Line":0}},{"line":40,"address":[],"length":0,"stats":{"Line":7}},{"line":41,"address":[],"length":0,"stats":{"Line":20}},{"line":42,"address":[],"length":0,"stats":{"Line":1}},{"line":48,"address":[],"length":0,"stats":{"Line":1}},{"line":58,"address":[],"length":0,"stats":{"Line":5}},{"line":59,"address":[],"length":0,"stats":{"Line":5}},{"line":62,"address":[],"length":0,"stats":{"Line":0}},{"line":68,"address":[],"length":0,"stats":{"Line":9}},{"line":69,"address":[],"length":0,"stats":{"Line":8}},{"line":70,"address":[],"length":0,"stats":{"Line":2}},{"line":77,"address":[],"length":0,"stats":{"Line":1}},{"line":78,"address":[],"length":0,"stats":{"Line":2}},{"line":79,"address":[],"length":0,"stats":{"Line":3}},{"line":81,"address":[],"length":0,"stats":{"Line":2}},{"line":82,"address":[],"length":0,"stats":{"Line":0}},{"line":83,"address":[],"length":0,"stats":{"Line":0}},{"line":84,"address":[],"length":0,"stats":{"Line":0}},{"line":86,"address":[],"length":0,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":90,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[],"length":0,"stats":{"Line":0}},{"line":92,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":0}},{"line":98,"address":[],"length":0,"stats":{"Line":1}}],"covered":24,"coverable":38},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","utils","mime.rs"],"content":"//! MIME type utilities for determining file extensions\n\n/// Get file extension from MIME type\npub fn ext_from_mime(mime_type: \u0026str) -\u003e \u0026'static str {\n    match mime_type {\n        // Video formats\n        \"video/mp4\" =\u003e \"mp4\",\n        \"video/webm\" =\u003e \"webm\",\n        \"video/3gpp\" =\u003e \"3gp\",\n        \"video/x-flv\" =\u003e \"flv\",\n        \"video/quicktime\" =\u003e \"mov\",\n        \"video/x-msvideo\" =\u003e \"avi\",\n        \"video/x-ms-wmv\" =\u003e \"wmv\",\n        \"video/mp2t\" =\u003e \"ts\",\n        \"video/mp2p\" =\u003e \"mpeg\",\n        \"video/mpeg\" =\u003e \"mpeg\",\n        \"video/ogg\" =\u003e \"ogv\",\n        \"video/x-matroska\" =\u003e \"mkv\",\n        \n        // Audio formats\n        \"audio/mp4\" =\u003e \"m4a\",\n        \"audio/webm\" =\u003e \"webm\",\n        \"audio/mpeg\" =\u003e \"mp3\",\n        \"audio/ogg\" =\u003e \"ogg\",\n        \"audio/wav\" =\u003e \"wav\",\n        \"audio/x-wav\" =\u003e \"wav\",\n        \"audio/flac\" =\u003e \"flac\",\n        \"audio/aac\" =\u003e \"aac\",\n        \"audio/x-aac\" =\u003e \"aac\",\n        \"audio/vorbis\" =\u003e \"ogg\",\n        \"audio/opus\" =\u003e \"opus\",\n        \n        // Default fallback\n        _ =\u003e \"bin\",\n    }\n}\n\n/// Get MIME type from file extension\npub fn mime_from_ext(extension: \u0026str) -\u003e \u0026'static str {\n    let ext = extension.trim_start_matches('.').to_lowercase();\n    match ext.as_str() {\n        // Video formats\n        \"mp4\" =\u003e \"video/mp4\",\n        \"webm\" =\u003e \"video/webm\",\n        \"3gp\" =\u003e \"video/3gpp\",\n        \"flv\" =\u003e \"video/x-flv\",\n        \"mov\" =\u003e \"video/quicktime\",\n        \"avi\" =\u003e \"video/x-msvideo\",\n        \"wmv\" =\u003e \"video/x-ms-wmv\",\n        \"ts\" =\u003e \"video/mp2t\",\n        \"mpeg\" | \"mpg\" =\u003e \"video/mpeg\",\n        \"ogv\" =\u003e \"video/ogg\",\n        \"mkv\" =\u003e \"video/x-matroska\",\n        \n        // Audio formats\n        \"m4a\" =\u003e \"audio/mp4\",\n        \"mp3\" =\u003e \"audio/mpeg\",\n        \"ogg\" =\u003e \"audio/ogg\",\n        \"wav\" =\u003e \"audio/wav\",\n        \"flac\" =\u003e \"audio/flac\",\n        \"aac\" =\u003e \"audio/aac\",\n        \"opus\" =\u003e \"audio/opus\",\n        \n        // Default fallback\n        _ =\u003e \"application/octet-stream\",\n    }\n}\n\n/// Check if MIME type is a video format\npub fn is_video_mime(mime_type: \u0026str) -\u003e bool {\n    mime_type.starts_with(\"video/\")\n}\n\n/// Check if MIME type is an audio format\npub fn is_audio_mime(mime_type: \u0026str) -\u003e bool {\n    mime_type.starts_with(\"audio/\")\n}\n\n/// Check if MIME type is a progressive format (video+audio combined)\npub fn is_progressive_mime(mime_type: \u0026str) -\u003e bool {\n    matches!(\n        mime_type,\n        \"video/mp4\" | \"video/webm\" | \"video/3gpp\" | \"video/x-flv\"\n    )\n}\n\n/// Check if MIME type is an adaptive format (video or audio only)\npub fn is_adaptive_mime(mime_type: \u0026str) -\u003e bool {\n    is_video_mime(mime_type) || is_audio_mime(mime_type)\n}\n\n/// Get container format from MIME type\npub fn get_container_format(mime_type: \u0026str) -\u003e \u0026'static str {\n    match mime_type {\n        \"video/mp4\" | \"audio/mp4\" =\u003e \"mp4\",\n        \"video/webm\" | \"audio/webm\" =\u003e \"webm\",\n        \"video/3gpp\" =\u003e \"3gp\",\n        \"video/x-flv\" =\u003e \"flv\",\n        \"video/quicktime\" =\u003e \"mov\",\n        \"video/x-msvideo\" =\u003e \"avi\",\n        \"video/x-ms-wmv\" =\u003e \"wmv\",\n        \"video/mp2t\" =\u003e \"ts\",\n        \"video/mpeg\" =\u003e \"mpeg\",\n        \"video/ogg\" | \"audio/ogg\" =\u003e \"ogg\",\n        \"video/x-matroska\" =\u003e \"mkv\",\n        \"audio/mpeg\" =\u003e \"mp3\",\n        \"audio/wav\" | \"audio/x-wav\" =\u003e \"wav\",\n        \"audio/flac\" =\u003e \"flac\",\n        \"audio/aac\" | \"audio/x-aac\" =\u003e \"aac\",\n        \"audio/opus\" =\u003e \"opus\",\n        _ =\u003e \"unknown\",\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_ext_from_mime() {\n        assert_eq!(ext_from_mime(\"video/mp4\"), \"mp4\");\n        assert_eq!(ext_from_mime(\"video/webm\"), \"webm\");\n        assert_eq!(ext_from_mime(\"audio/mp4\"), \"m4a\");\n        assert_eq!(ext_from_mime(\"audio/mpeg\"), \"mp3\");\n        assert_eq!(ext_from_mime(\"unknown/type\"), \"bin\");\n    }\n\n    #[test]\n    fn test_mime_from_ext() {\n        assert_eq!(mime_from_ext(\"mp4\"), \"video/mp4\");\n        assert_eq!(mime_from_ext(\".mp4\"), \"video/mp4\");\n        assert_eq!(mime_from_ext(\"MP4\"), \"video/mp4\");\n        assert_eq!(mime_from_ext(\"m4a\"), \"audio/mp4\");\n        assert_eq!(mime_from_ext(\"mp3\"), \"audio/mpeg\");\n        assert_eq!(mime_from_ext(\"unknown\"), \"application/octet-stream\");\n    }\n\n    #[test]\n    fn test_is_video_mime() {\n        assert!(is_video_mime(\"video/mp4\"));\n        assert!(is_video_mime(\"video/webm\"));\n        assert!(!is_video_mime(\"audio/mp4\"));\n        assert!(!is_video_mime(\"text/plain\"));\n    }\n\n    #[test]\n    fn test_is_audio_mime() {\n        assert!(is_audio_mime(\"audio/mp4\"));\n        assert!(is_audio_mime(\"audio/mpeg\"));\n        assert!(!is_audio_mime(\"video/mp4\"));\n        assert!(!is_audio_mime(\"text/plain\"));\n    }\n\n    #[test]\n    fn test_is_progressive_mime() {\n        assert!(is_progressive_mime(\"video/mp4\"));\n        assert!(is_progressive_mime(\"video/webm\"));\n        assert!(!is_progressive_mime(\"video/quicktime\"));\n        assert!(!is_progressive_mime(\"audio/mp4\"));\n    }\n\n    #[test]\n    fn test_get_container_format() {\n        assert_eq!(get_container_format(\"video/mp4\"), \"mp4\");\n        assert_eq!(get_container_format(\"audio/mp4\"), \"mp4\");\n        assert_eq!(get_container_format(\"video/webm\"), \"webm\");\n        assert_eq!(get_container_format(\"audio/mpeg\"), \"mp3\");\n        assert_eq!(get_container_format(\"unknown/type\"), \"unknown\");\n    }\n}\n\n","traces":[{"line":4,"address":[],"length":0,"stats":{"Line":5}},{"line":5,"address":[],"length":0,"stats":{"Line":5}},{"line":7,"address":[],"length":0,"stats":{"Line":6}},{"line":8,"address":[],"length":0,"stats":{"Line":5}},{"line":9,"address":[],"length":0,"stats":{"Line":3}},{"line":10,"address":[],"length":0,"stats":{"Line":3}},{"line":11,"address":[],"length":0,"stats":{"Line":3}},{"line":12,"address":[],"length":0,"stats":{"Line":3}},{"line":13,"address":[],"length":0,"stats":{"Line":3}},{"line":14,"address":[],"length":0,"stats":{"Line":3}},{"line":15,"address":[],"length":0,"stats":{"Line":3}},{"line":16,"address":[],"length":0,"stats":{"Line":3}},{"line":17,"address":[],"length":0,"stats":{"Line":3}},{"line":18,"address":[],"length":0,"stats":{"Line":3}},{"line":21,"address":[],"length":0,"stats":{"Line":4}},{"line":22,"address":[],"length":0,"stats":{"Line":2}},{"line":23,"address":[],"length":0,"stats":{"Line":3}},{"line":24,"address":[],"length":0,"stats":{"Line":1}},{"line":25,"address":[],"length":0,"stats":{"Line":1}},{"line":26,"address":[],"length":0,"stats":{"Line":1}},{"line":27,"address":[],"length":0,"stats":{"Line":1}},{"line":28,"address":[],"length":0,"stats":{"Line":1}},{"line":29,"address":[],"length":0,"stats":{"Line":1}},{"line":30,"address":[],"length":0,"stats":{"Line":1}},{"line":31,"address":[],"length":0,"stats":{"Line":1}},{"line":34,"address":[],"length":0,"stats":{"Line":1}},{"line":39,"address":[],"length":0,"stats":{"Line":6}},{"line":40,"address":[],"length":0,"stats":{"Line":18}},{"line":41,"address":[],"length":0,"stats":{"Line":6}},{"line":43,"address":[],"length":0,"stats":{"Line":9}},{"line":44,"address":[],"length":0,"stats":{"Line":3}},{"line":45,"address":[],"length":0,"stats":{"Line":3}},{"line":46,"address":[],"length":0,"stats":{"Line":3}},{"line":47,"address":[],"length":0,"stats":{"Line":3}},{"line":48,"address":[],"length":0,"stats":{"Line":3}},{"line":49,"address":[],"length":0,"stats":{"Line":3}},{"line":50,"address":[],"length":0,"stats":{"Line":3}},{"line":51,"address":[],"length":0,"stats":{"Line":6}},{"line":52,"address":[],"length":0,"stats":{"Line":3}},{"line":53,"address":[],"length":0,"stats":{"Line":3}},{"line":56,"address":[],"length":0,"stats":{"Line":4}},{"line":57,"address":[],"length":0,"stats":{"Line":3}},{"line":58,"address":[],"length":0,"stats":{"Line":1}},{"line":59,"address":[],"length":0,"stats":{"Line":1}},{"line":60,"address":[],"length":0,"stats":{"Line":1}},{"line":61,"address":[],"length":0,"stats":{"Line":1}},{"line":62,"address":[],"length":0,"stats":{"Line":1}},{"line":65,"address":[],"length":0,"stats":{"Line":1}},{"line":70,"address":[],"length":0,"stats":{"Line":4}},{"line":71,"address":[],"length":0,"stats":{"Line":8}},{"line":75,"address":[],"length":0,"stats":{"Line":4}},{"line":76,"address":[],"length":0,"stats":{"Line":8}},{"line":80,"address":[],"length":0,"stats":{"Line":4}},{"line":81,"address":[],"length":0,"stats":{"Line":2}},{"line":82,"address":[],"length":0,"stats":{"Line":4}},{"line":88,"address":[],"length":0,"stats":{"Line":0}},{"line":89,"address":[],"length":0,"stats":{"Line":0}},{"line":93,"address":[],"length":0,"stats":{"Line":5}},{"line":94,"address":[],"length":0,"stats":{"Line":5}},{"line":95,"address":[],"length":0,"stats":{"Line":11}},{"line":96,"address":[],"length":0,"stats":{"Line":6}},{"line":97,"address":[],"length":0,"stats":{"Line":2}},{"line":98,"address":[],"length":0,"stats":{"Line":2}},{"line":99,"address":[],"length":0,"stats":{"Line":2}},{"line":100,"address":[],"length":0,"stats":{"Line":2}},{"line":101,"address":[],"length":0,"stats":{"Line":2}},{"line":102,"address":[],"length":0,"stats":{"Line":2}},{"line":103,"address":[],"length":0,"stats":{"Line":2}},{"line":104,"address":[],"length":0,"stats":{"Line":4}},{"line":105,"address":[],"length":0,"stats":{"Line":2}},{"line":106,"address":[],"length":0,"stats":{"Line":3}},{"line":107,"address":[],"length":0,"stats":{"Line":2}},{"line":108,"address":[],"length":0,"stats":{"Line":1}},{"line":109,"address":[],"length":0,"stats":{"Line":2}},{"line":110,"address":[],"length":0,"stats":{"Line":1}},{"line":111,"address":[],"length":0,"stats":{"Line":1}}],"covered":74,"coverable":76},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","utils","mod.rs"],"content":"//! Utility functions for ryt\n\npub mod cache;\npub mod filename;\npub mod mime;\npub mod url;\n\npub use cache::*;\npub use filename::*;\npub use mime::*;\npub use url::*;\n\n","traces":[],"covered":0,"coverable":0},{"path":["/","Users","r","wks","src","github.com","romanitalian","ytget","ryt","src","utils","url.rs"],"content":"//! URL utilities for extracting video IDs and parsing video platform URLs\n\nuse crate::error::RytError;\nuse url::Url;\n\n/// Extract video ID from various video platform URL formats\npub fn extract_video_id(url: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n    let parsed = Url::parse(url)?;\n    \n    match parsed.host_str() {\n        Some(\"youtu.be\") =\u003e {\n            let path = parsed.path().trim_start_matches('/');\n            if path.is_empty() {\n                return Err(RytError::InvalidUrl(\"Missing video ID\".to_string()));\n            }\n            Ok(path.to_string())\n        }\n        Some(\"youtube.com\") | Some(\"www.youtube.com\") =\u003e {\n            if parsed.path().starts_with(\"/watch\") {\n                parsed.query_pairs()\n                    .find(|(key, _)| key == \"v\")\n                    .map(|(_, value)| value.to_string())\n                    .ok_or_else(|| RytError::InvalidUrl(\"Missing v parameter\".to_string()))\n            } else if parsed.path().starts_with(\"/shorts/\") {\n                let video_id = parsed.path().trim_start_matches(\"/shorts/\");\n                if video_id.is_empty() {\n                    return Err(RytError::InvalidUrl(\"Missing video ID in shorts path\".to_string()));\n                }\n                Ok(video_id.to_string())\n            } else {\n                Err(RytError::InvalidUrl(\"Unsupported video URL format\".to_string()))\n            }\n        }\n        _ =\u003e Err(RytError::InvalidUrl(\"Not a supported video platform URL\".to_string()))\n    }\n}\n\n/// Extract playlist ID from video platform playlist URL\npub fn extract_playlist_id(url: \u0026str) -\u003e Result\u003cString, RytError\u003e {\n    // Accept raw playlist IDs as-is\n    if !url.is_empty() \u0026\u0026 (url.starts_with(\"PL\") || url.starts_with(\"UU\") || url.starts_with(\"OLAK5uy_\")) {\n        return Ok(url.to_string());\n    }\n    \n    let parsed = Url::parse(url)?;\n    if let Some(id) = parsed.query_pairs().find(|(key, _)| key == \"list\").map(|(_, value)| value.to_string()) {\n        Ok(id)\n    } else {\n        Err(RytError::InvalidUrl(\"Playlist ID not found\".to_string()))\n    }\n}\n\n/// Check if URL is a supported video platform URL\npub fn is_video_url(url: \u0026str) -\u003e bool {\n    if let Ok(parsed) = Url::parse(url) {\n        matches!(\n            parsed.host_str(),\n            Some(\"youtube.com\") | Some(\"www.youtube.com\") | Some(\"youtu.be\")\n        )\n    } else {\n        false\n    }\n}\n\n/// Check if URL is a playlist URL\npub fn is_playlist_url(url: \u0026str) -\u003e bool {\n    if let Ok(parsed) = Url::parse(url) {\n        parsed.path().contains(\"/playlist\") || \n        parsed.query_pairs().any(|(key, _)| key == \"list\")\n    } else {\n        // If URL parsing fails, check if it's a raw playlist ID\n        url.starts_with(\"PL\") || url.starts_with(\"UU\") || url.starts_with(\"OLAK5uy_\")\n    }\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n\n    #[test]\n    fn test_extract_video_id() {\n        assert_eq!(\n            extract_video_id(\"https://www.youtube.com/watch?v=dQw4w9WgXcQ\").unwrap(),\n            \"dQw4w9WgXcQ\"\n        );\n        \n        assert_eq!(\n            extract_video_id(\"https://youtu.be/dQw4w9WgXcQ\").unwrap(),\n            \"dQw4w9WgXcQ\"\n        );\n        \n        assert_eq!(\n            extract_video_id(\"https://www.youtube.com/shorts/brZCOVlyPPo\").unwrap(),\n            \"brZCOVlyPPo\"\n        );\n        \n        // Test error cases\n        assert!(extract_video_id(\"https://www.youtube.com/watch\").is_err());\n        assert!(extract_video_id(\"https://example.com\").is_err());\n    }\n\n    #[test]\n    fn test_extract_playlist_id() {\n        assert_eq!(\n            extract_playlist_id(\"https://www.youtube.com/playlist?list=PLxxxx\").unwrap(),\n            \"PLxxxx\"\n        );\n        \n        assert_eq!(\n            extract_playlist_id(\"PLxxxx\").unwrap(),\n            \"PLxxxx\"\n        );\n        \n        assert!(extract_playlist_id(\"https://www.youtube.com/watch?v=xxx\").is_err());\n    }\n\n    #[test]\n    fn test_is_video_url() {\n        assert!(is_video_url(\"https://www.youtube.com/watch?v=xxx\"));\n        assert!(is_video_url(\"https://youtu.be/xxx\"));\n        assert!(!is_video_url(\"https://example.com\"));\n    }\n\n    #[test]\n    fn test_is_playlist_url() {\n        assert!(is_playlist_url(\"https://www.youtube.com/playlist?list=PLxxxx\"));\n        assert!(is_playlist_url(\"PLxxxx\"));\n        assert!(!is_playlist_url(\"https://www.youtube.com/watch?v=xxx\"));\n    }\n}\n","traces":[{"line":7,"address":[],"length":0,"stats":{"Line":5}},{"line":8,"address":[],"length":0,"stats":{"Line":15}},{"line":11,"address":[],"length":0,"stats":{"Line":5}},{"line":12,"address":[],"length":0,"stats":{"Line":3}},{"line":13,"address":[],"length":0,"stats":{"Line":2}},{"line":14,"address":[],"length":0,"stats":{"Line":0}},{"line":18,"address":[],"length":0,"stats":{"Line":8}},{"line":19,"address":[],"length":0,"stats":{"Line":6}},{"line":20,"address":[],"length":0,"stats":{"Line":2}},{"line":21,"address":[],"length":0,"stats":{"Line":4}},{"line":22,"address":[],"length":0,"stats":{"Line":4}},{"line":23,"address":[],"length":0,"stats":{"Line":4}},{"line":24,"address":[],"length":0,"stats":{"Line":1}},{"line":25,"address":[],"length":0,"stats":{"Line":3}},{"line":26,"address":[],"length":0,"stats":{"Line":2}},{"line":27,"address":[],"length":0,"stats":{"Line":0}},{"line":31,"address":[],"length":0,"stats":{"Line":0}},{"line":34,"address":[],"length":0,"stats":{"Line":1}},{"line":39,"address":[],"length":0,"stats":{"Line":3}},{"line":41,"address":[],"length":0,"stats":{"Line":10}},{"line":42,"address":[],"length":0,"stats":{"Line":1}},{"line":45,"address":[],"length":0,"stats":{"Line":2}},{"line":46,"address":[],"length":0,"stats":{"Line":7}},{"line":49,"address":[],"length":0,"stats":{"Line":1}},{"line":54,"address":[],"length":0,"stats":{"Line":3}},{"line":55,"address":[],"length":0,"stats":{"Line":6}},{"line":56,"address":[],"length":0,"stats":{"Line":2}},{"line":58,"address":[],"length":0,"stats":{"Line":8}},{"line":61,"address":[],"length":0,"stats":{"Line":0}},{"line":66,"address":[],"length":0,"stats":{"Line":4}},{"line":67,"address":[],"length":0,"stats":{"Line":7}},{"line":69,"address":[],"length":0,"stats":{"Line":3}},{"line":72,"address":[],"length":0,"stats":{"Line":2}}],"covered":29,"coverable":33}]};
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      },
    };
  });

  return [...folders, ...files.filter(file => file.path.length === 1)];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener('hashchange', () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.slice(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(
      ({current}) => {
        return {current: [...current, file.path[0]]};
      },
      () => this.updateHash(),
    );
  }

  back(file) {
    this.setState(
      ({current}) => {
        return {current: current.slice(0, current.length - 1)};
      },
      () => this.updateHash(),
    );
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e(
    'div',
    {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e(
      'table',
      {className: 'files-list'},
      e('thead', {className: 'files-list__head'}, e('tr', null, e('th', null, 'Path'), e('th', null, 'Coverage'))),
      e(
        'tbody',
        {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile})),
      ),
    ),
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? (file.covered / file.coverable) * 100 : -1;
  const coverageDelta =
    file.prevRun && (file.covered / file.coverable) * 100 - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'tr',
    {
      className:
        'files-list__file' +
        (coverage >= 0 && coverage < 50 ? ' files-list__file_low' : '') +
        (coverage >= 50 && coverage < 80 ? ' files-list__file_medium' : '') +
        (coverage >= 80 ? ' files-list__file_high' : '') +
        (file.is_folder ? ' files-list__file_folder' : ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e(
      'td',
      null,
      file.covered + ' / ' + file.coverable + (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
    ),
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'}, e(FileHeader, {file, onBack}), e(FileContent, {file}));
}

function FileHeader({file, onBack}) {
  const coverage = (file.covered / file.coverable) * 100;
  const coverageDelta = file.prevRun && coverage - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'div',
    {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e(
      'div',
      {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable + (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
      e('input', {id: 'theme-toggle', type: 'checkbox', hidden: true}),
      e('label', {for: 'theme-toggle', id: 'theme-toggle-label'}, '🌙'),
    ),
  );
}

function FileContent({file}) {
  return e(
    'pre',
    {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      return e(
        'code',
        {
          className: 'code-line' + (covered ? ' code-line_covered' : '') + (uncovered ? ' code-line_uncovered' : ''),
          title: trace ? JSON.stringify(trace.stats, null, 2) : null,
        },
        line,
      );
    }),
  );
}

(function () {
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData &&
    previousData.files.forEach(file => {
      const path = file.path.slice(commonPath.length).join('/');
      prevFilesMap.set(path, file);
    });

  const files = data.files.map(file => {
    const path = file.path.slice(commonPath.length);
    const {covered = 0, coverable = 0} = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: {covered, coverable},
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    },
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));

  const toggle = document.getElementById('theme-toggle');
  const label = document.getElementById('theme-toggle-label');
  label.textContent = '🌙';

  toggle.addEventListener('change', () => {
    if (toggle.checked) {
      document.documentElement.setAttribute('data-theme', 'dark');
      label.textContent = '☀️';
    } else {
      document.documentElement.removeAttribute('data-theme');
      label.textContent = '🌙';
    }
  });
})();
</script>
</body>
</html>